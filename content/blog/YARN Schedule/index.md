---
title: YARN中的调度
date: "2020-04-12"
description: 调度器根据既定策略为应用分配资源。YARN提供了三种调度器：FIFO调度器（FIFO Scheduler）、容量调度器（Capacity Scheduler）和公平调度器（Fair Scheduler）。另外YARN调度器还支持可配置策略。
tags: YARN Scheduler
---

YARN调度器由属性`yarn.resourcemanager.scheduler.class`设置，位于`yarn-site.xml`文件中，默认是使用容量调度器。

三种调度器的完全限定名：

+ 公平调度器：`org.apache.hadoop.yarn.server.resourcemanager.scheduler.fair.FairScheduler`

## FIFO调度器

FIFO调度器将应用放置在一个队列中，然后按照提交的顺序（先进先出）运行应用。首先为队列中第一个应用的请求分配资源，第一个应用的请求被满足后再依次为队列中下一个应用服务。

## 容量调度器

容量调度器允许多个组织共享一个Hadoop集群，每个组织可以分配到全部集群资源的一部分。每个组织被配置一个专门的队列，每个队列被配置为可以使用一定的集群资源。队列可以进一步按层次划分，这样每个组织内的不同用户能够共享该组织队列所分配的资源。在一个队列内，使用FIFO调度策略对应用进行调度。

单个作业使用的资源不会超过其队列容量。然而，如果队列中有多个作业，并且队列资源不够用时，如果仍有可用的空闲资源，那么容量调度器可能会将空闲的资源分配给队列中的作业，即使超出队列容量，这被称为弹性队列（属性`yarn.scheduler.capacity.<queue-path>.user-limit-factor`大于1（1为默认值）时，表示一个作业可以使用超过其队列容量的资源）。

正常操作时，容量调度器不会通过强行中止来抢占容器，这会导致一个刚开始资源够用的队列在资源不够用时只能等待其他队列释放容器资源。可以为队列设置一个最大容量限制（属性`yarn.scheduler.capacity.<queue-path>.maximum-capacity`设置），使其不能过多侵占其他队列的容量，但是这样是以牺牲队列弹性为代价的，需要不断尝试找到一个合理的折中。

`capacity-scheduler.xml`是容量调度器的配置文件，可以配置队列层次和容量、控制单个用户或应用能被分配到的最大资源数量、同时运行的应用数量以及队列的ACL认证等。队列层次由属性`yarn.scheduler.capacity.<queue-path>.queues`配置，值为逗号分隔的子队列名，根队列为root队列。容量由属性`yarn.scheduler.capacity.<queue-path>.capacity`配置，值为队列占用父队列资源的百分比。

将应用放置在哪个队列中，取决于应用本身。如在MapReduce中，可以通过设置属性`mapreduce.job.queuename`来指定要用的队列，默认为`default`。

## 公平调度器

公平调度器旨在为所有运行的应用公平分配资源。

`fair-scheduler.xml`是公平调度器的配置文件（由属性`yarn.scheduler.fair.allocation.file`配置）。当没有该分配文件时，每个应用放置在一个以用户名命名的队列中，队列是在用户提交第一个应用时动态创建的。

队列的层次使用嵌套`queu`元素来定义。所有队列都是root队列的子队列。队列有`weight`元素，用于公平共享计算。没有指定`weight`时，子队列们平均分配父队列资源。每个队列可以有不同的调度策略，支持FIFO策略、DRF策略、公平策略。队列的默认调度策略通过顶层元素`defaultQueueSchedulingPolicy`进行设置，如果省略，默认使用公平调度。队列的调度策略可以被该队列的`schedulingPolicy`元素指定的策略覆盖。每个队列可配置最大和最小资源数量，及最大可运行的应用的数量。最小资源数量不是一个硬性的限制，常用于对资源分配进行优先排序，如果两个队列的资源都低于它们的公平共享额度，那么远低于最小资源数量的那个队列优先被分配资源。最小资源数量也会用于抢占行为。

公平调度器使用一个基于规则的系统来确定应用应该放到哪个队列，规则列表放置在元素`queuePlacementPolicy`中（由元素`rule`表示），每条规则会被依次尝试直到匹配成功。包含以下规则：

+ `specified`：表示把应用放进指定的队列中
+ `primaryGroup`：表示把应用放在以用户的主Unix组名命名的队列中
+ `default`：表示前述规则都不匹配时，启用该条规则

公平调度器支持抢占（preemption）功能。抢占是指允许调度器终止那些占用资源超过了其公平共享份额的队列的容器，这些容器资源释放后可以分配给资源数量低于应得份额的队列。抢占会降低整个集群的效率。通过将`yarn.scheduler.fair.preemption`设置为`true`，可以全面启用抢占功能。有两个相关的抢占超时设置：一个用于最小共享，另一个用于公平共享。默认情况下，两个超时参数均不设置，为了允许抢占容器，需要至少设置其中一个超时参数。如果队列在最小共享时间内（或公平共享时间内）未获得被承诺的最小共享资源，调度器就会抢占其他容器。可以通过分配文件中的顶层元素`defaultMinSharePreemptionTimeout`（或`defaultFairSharePreemptionTimeout`）为所有队列设置默认的超时时间，还可以通过设置每个队列的`minSharePreemptionTimeout`（或`fairSharePreemptionTimeout`）元素来为单个队列指定超时时间。

延迟调度（delay scheduling）是指应用请求一个容器数目已满的节点时等待一小段时间（不超过几秒）来增加在所请求节点上分配到一个容器的机会。容量调度器和公平调度器都支持延迟调度。当使用延迟调度时，调度器不会简单的使用它收到的第一个调度机会，而是等待设定的最大数目的调度机会发生，然后才降低本地化级别并接收下一个调度机会。对于容量调度器，可以通过设置属性`yarn.scheduler.capacity.node-locality-delay`来配置延迟调度。设置为正整数，表示调度器在放松节点限制、改为匹配同一机架上的其他节点前，准备错过的调度机会的数量。公平调度器使用集群规模的比例表示延迟时间，属性`yarn.scheduler.fair.locality.threshold.node`表示调度器在接受同一机架中的其他节点之间，将一值等待直到集群中的指定比例的节点都已经给过调度机会，属性`yarn.scheduler.fair.locality.threshold.rack`表示在接受另一个机架替代所申请的机架之前需要等待的时长阈值。

## 三种调度器比较

FIFO调度器简单易懂，不需要任何配置，但是不适合共享集群，大的应用会占用集群中的所有资源，每个应用必须等待直到轮到自己运行。

在一个共享集群中，更适合使用容量调度器或公平调度器，这两种调度器都允许长时间运行的作业能及时完成，同时也运行正在进行较小临时查询的用户能够在合理时间内得到返回结果。

使用容量调度器时，一个专门的队列保证小作业一提交就可以启动，但是这种策略是以整个集群的利用率为代价的，和FIFO调度器相比，大作业执行的时间要长。

使用公平调度器时，调度器会在所有运行的作业之间动态平衡资源，不需要预留一定量的资源，既得到了较高的集群利用率，又能保证小作业能及时完成。但是从后来作业的启动到获得公平共享资源之间会有时间滞后，因为它必须等待前面的作业使用的容器用完并释放出资源。
