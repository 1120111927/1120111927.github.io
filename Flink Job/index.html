<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 5.13.4"/><meta name="description" content="Flink作业经过DataStream API -&gt; Transformation -&gt; StreamGraph -&gt; JobGraph -&gt; ExecutionGraph转换过程后，经过Flink的调度执行，在Flink集群中启动计算任务" data-gatsby-head="true"/><meta property="og:title" content="Flink作业提交、调度与执行" data-gatsby-head="true"/><meta property="og:description" content="Flink作业经过DataStream API -&gt; Transformation -&gt; StreamGraph -&gt; JobGraph -&gt; ExecutionGraph转换过程后，经过Flink的调度执行，在Flink集群中启动计算任务" data-gatsby-head="true"/><meta property="og:type" content="website" data-gatsby-head="true"/><meta name="twitter:card" content="summary" data-gatsby-head="true"/><meta name="twitter:creator" content="" data-gatsby-head="true"/><meta name="twitter:title" content="Flink作业提交、调度与执行" data-gatsby-head="true"/><meta name="twitter:description" content="Flink作业经过DataStream API -&gt; Transformation -&gt; StreamGraph -&gt; JobGraph -&gt; ExecutionGraph转换过程后，经过Flink的调度执行，在Flink集群中启动计算任务" data-gatsby-head="true"/><style data-href="/styles.7560649a7903f9a04540.css" data-identity="gatsby-global-css">@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:400;src:url(/static/fira-code-cyrillic-ext-400-normal-8ae7ba46c49a0347ea6509bb42c4bfeb.woff2) format("woff2"),url(/static/fira-code-all-400-normal-c050f0ce726c76d279c879401b2dbd63.woff) format("woff");unicode-range:u+0460-052f,u+1c80-1c88,u+20b4,u+2de0-2dff,u+a640-a69f,u+fe2e-fe2f}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:400;src:url(data:font/woff2;base64,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) format("woff2"),url(/static/fira-code-all-400-normal-c050f0ce726c76d279c879401b2dbd63.woff) format("woff");unicode-range:u+0301,u+0400-045f,u+0490-0491,u+04b0-04b1,u+2116}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:400;src:url(data:font/woff2;base64,d09GMgABAAAAABHcABAAAAAANVQAABF/AAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGkYbIByDYgZgP1NUQVQuAIQgEQgKy3DDCwuELgABNgIkA4g2BCAFhEgHIAwHG6ctE+5wS7pegVFROiVlwX+VwM2Bq4M6zhRUHKeWcQ3VEsc67NTNrtqEgcDV4iFqrKm4u7uqp/oRw4s2DOVZnRFe8XvwD9n9e+7s7DztBxGKJVURdUp3IDq6Ttq8HZ62+Q8dO3JFGBjF+u7sr4hgNHZhAwZY9Tdwgr1uXLsCV+0qMJpFBcAX7pdvA3s9VUChXBWgsnW+SgIm+TMU4O1+JFMZ2CAJKKXQiqTudXtM+OFL7kJSE1+2JkBFjdwC/RtsNZ/6unazvVsdqRDYboKT7rMSK0ktSgK18nn3e7XvFgAkoTFlXVvjqvLzMU2JUkRwMEI9ReimgFCzmnCzO1OismdCzsoJ7ea/TUvq8fNPG5+80qzztSitEfIn6R4yUggJgN6NveXuJq35xFMq6pXVCngHqKDA4AAc8eP590/UwjvJhw/VEtWbS8USFpsUNtDhzIY1nA3HOqX55k/lSYwOIFN1hNEZxYy64z+fBMKQCgB0ZHDEWAbDel9g5MtHiigFKUMZSFnKQggDBECAAAFxMmVT/4GhsYAEgAUI9TqX1jpzpaxdU1o4OByluSKHk19e7HgJigssampqTkDz5hSWA2M+lVVq1L61bA1uwB1nNevpInpgwHawZD7XAZXKPKT8S5eWgCijUr/tqY1qMWTI5EFMhlTdaXvI1C2GPTxxZsNf+BcPeiIwgX8pYaWSFvT0n23wyNIKjBLP3GQZmIQIMBiNkxBpMEjjKhYOBO2sy1t7qf2wYP+JgwAHWy/mFMexJj8RjflxG21vwNmH2G/5+YDzU9k/uPrVA9EV3u/ZwNGnA2yJPwdAOR8hogjIJqCYWb2ooBwDYPAAI6P9gLkqxOmysnnRH5c1AdCsnCVwXrazPLQ8VzTDEiZBkhRpGsgdc9lDIz74aim9AShjXtTySKq6KUhk1C8nwyIKKlf1G/PZ8kdv7XotUfusNdoNwJexdqC9mdRPJt8NXwA8zuwFoSv970p/gE36fS5QrrqqJ9BaG221014HHXVyxjHHqaj1OuEkX378BQgUJFiIFGPGTZik9dgTT2Xiy5ItR648+WSarLfBTrucctp1N2j0e+Y5KxUqValWo1adk/bZ74CDDulxmIfueuipl968+XjjrXfe++CjTz4TKVSkWAkxiVLN5FootFpiBXOlihQry/EvXzlK5zilPXY7AtFKZ110Laq4Aq4757wLzrgoTDie0GJKKIXXhgwbcdMtA0aly5AqTUKpSlMGf7z02gtfxIlXQEBYliIIhZYGoFwA0wxMBOwxwD0FBKkQmQ8ALAYhhMEgTFj97SmsVLmqhD9DSAlss8VjCZTbEKMtUcm9NIqu94WW16sUbvBqQizAYQ8RDQKODC6epVfNnmiiGesQxcQBU03EjLKpM4TQ91oKM1UYLdggmpqBKBqiuAaalE0kMtn5vFuWeznvOl70y/LY4gf3n0Jxt4NK07D8kdtTnIPqDMtPy/IsRXskQSavqUMUKIZGM0MT3IQwEv01CR1CRgyjihmuRsgpH6xl2f+PFyPzPuC/bjwsy8Hg7hBUI1T0t1IKqAa6NH9USxlIUpX2tpChh7PngZZBbaSWPFwnLh+xXDON3HXsp/LRUYZihoIkJ2L5oAOG6v7zltq0jvfDgb0vz2xx7+lJUlvOGe7V5MwgbVNIyqlpnJanN9SexSZKJV1cBRuOHxWB0nq1kOG9U29Mnx5uZnQdYar681ntij9UcqqGgkzq7Q7cYDzSJAe3GtLInCtURTwE4Ys8YDycsME6MmH6nHEpCHQhcm0R52lwj85HphlU96V7ez/gxUOUDrB/rzt20Ftv5RgVFU58JDkg13DQj1ZSwr5yIzJOr0426th/QnV3XVw/OoNBe5zUzX7QS53UycnD6Hhye+drd9Qdo/hIcrGru3W2k+nbg++DSpJPx9Kj0zTEhe3CtCklzZtmLCXX/ZpPEdeK9CR9H2GxKa6lq6WcA8vlTjeXxe8eUbxnG+rvXxzL5NV2D+v3un3JstRf9VXTGcbsg5r7IiX9lsNO9Di33y2JSWmP8MKhaTvo4x3sPg7nYdHnvVAYfjEsW5qdptOrAGDTXS/vttKQ/msW5RW9W4QN9ovwQMJ5lq/XPyPS11MYF+Omz4nP9JpdwBYkluVMq8JbVFnUcZa17yeuBa4OGdZF6fvMsPxxukoV//017QQwXfnwnq5L96q0zQpg+dMoHSC1A9dxQMo/EIALuD0F4DD5bY48xzYq3zng73jonthLe6xb+bhH7Km5L/Z+rFJ2aw+Lucc1lNW2Bw+uZlIoGyz24E2yAizDXlFM/TLX9Guh5/krnOOkJyq3KS58SNjYoz8IsPzM72Z3wKFZlJ6Z5pTI84WHxYePAeZOp1V9zTnflNvyf/S1r1x5XZ73fdcOPt6N1hUKRWvfo3uK6yCXd+bBA3kfYDY9Fy4rCfrS934JuY69eHv7h0bvJdPGtPVuT7av3/B4O/5NacdaSPW+n9q3Lq7zlJHe9wV/WVYCLJ86JcnYiV3Uelen9Xn2TjNa2otZHSHEjBRS3EyxaWSsoiE6+egN4owdCX8OdHY1F5YP3rlfdFHEDLMKSfTdZdxkui38UJ4vsNc+PtZcGZWUuErYVHacG+SYXMJz/xSzbvFtXtUyYbWipnFGEb24Jj6ttO4cpzxnxCHSLbbAd94224ia5ojYoLo44VmwcIrT+o4dy5cqqfMK6U1h7GiPQpe4iBP67stC6x50I20Zd7qfiW/cuURgQenKoXT8NAnje4fOT6ZsXVhr02kT1Ll3cxeYHev07I751JVJv1Rr2hLa2SnflNQr0OC0W02dJeO38Zsb/XhSxcNrba5qSTLglJsbyRhg/anW14PF1Vvv7Tsw0n1LXFTEdy1gxqc4b6kuoeMZq4F3jrldNtfy9Mt1xLX59eXTyujFdTVZ65YbfDrtYTU7a5WNxPYM4VCm0HiHTwqbzeUbbUr+u5VGyTXewE1gs71TTHYIM8g9zLN2YmAfd87+PQJ/sEcmYGRcBLMFjOq/J10i/JLh7034ceTHM66mXzkXl9aH6ihej77XQt5DcEGuwU4FeNO8u1pGzgPoW/jcM4qMovBosQGMauz5twh+2+rmEop62zNtdA0CF+sAAT/YLQT9yLQg7Bc4z44RRVIWWac4+udEvXi8qxDBLgSVRkn4zAHe+B/rBOv8ovGucxaT1/OLkQU4OD8X/9T3jtrtNbHLdRymXSWwVFIv72uxGaGLzVM/+JzmZ4xKVsuEc9K2PQD9zgrruv1HTkkgvR1+i5je+5ytyXN/hTYykLfAeNVM+xEEHbWH36LImxJEmoOg0wT2saMrTiR1it8Y/QnT+W1yQ6x/fX2ZCTUkPjUgOCWVSvqR+qD6/2PBQg0zgzgT+pbL7Oi/Aq7+QaaLTAEz913oIo8oIRRYZhwSHxwYkBYc0pfifxArlHqAnOr8MnFqxurU2Dg7zCGfhBdpMLBeJb1m1SmXUgGTzkPeIoxG1P11Xnb/53umyFtgP9UhfaXYQt6+1yHPVbI0+axX3IFm93GH+CF3nMrP0uDwgmaHdbPbcnj0pi000Jyxdxv8FzVF/LqlNUFPt4pdPLvusqcwPdR+FDVKt/We458b7bwBW7L2F/BD/uNFhafNXynLne0/5UC6MRL7OdC/iKcmqL/uFW6M2mi0Mv8Z763A1b1v5d0qt98y78gJXrGV2nmBgQPBDQoqGjpS7cZrwxG7LCkZxFE1OjsirK4zdOuWQTpx6L4M92/SsI//N+gTdLN8os5yGenfb90pQ9YB8GWzFAwwVEnU6AMnIDAGA+YYNspJcrKcIqfKaXK6nCFnTspt0f9eVcTQv74eEEzyOviEfwWG+K8SwbJZ2zgY6vYlQFqsIkBFAvrv9wQGqAAqwaQNqmPQfz8koP9+Tnp6aw09T3JrYwgeyV5vb7A32pvszfYWe6u9LeCG4AzhxOWCJEQDIcQBAQ9CBAcE6AnqfyZBACMkcO1ehMSgvEJDCu2J0n+/JGogVsACUnAPoR/UUQh1iBJNHE9LGolBQz2txXki/j3RO3q00QAZNAB7UmeseopWuDFM9CgiNUIXGXwlM6BrYZtgDgUwGTiQQR2Ze9VkDMGzfYSO4uX+Y5r7j8M+YZ+0T8nTjQMHIXX9AyfsDIkhBYy7DOM3wwQzmPgBJr0nIw95jFdibiTaxiyhuTKs+2StZr71q6cUYmcUQopC3OVC/OZCglkh8UMh6X0heYgN7qNulGBsJgwNwDgqjH8HEwrJiByPUY4Z3/SE9WToGIz7BBh/AyYEw0QGkpSRp3qM/2KmolXF1uh7MFTH95AttCaKA+vpgI45cJ8c+BsOQrCDyFgTyUGeer+Bd3UrcvdYSwythXEaGH8QJsAwUQ+TdCAjv/YYX8TcSLSNWVB82xOWy5Aaxn0BjL8NE3hkRAuPAWZ8xxM2dA50+d4svcxkJjOZUXYNmGRORsZ5DMTMRPMdC7rXe5Reeumll1566aWXnnwfxyMyBPdd9Su5WWhNFAeW64DUDtwXB/62g8BzEC0cJHMHGZcZgA5Ohh3HZs7gPzT4cAuVw5zf5Ik/cK8xeoOJ78hLf8A4zBSA/gM23/ks15bpu3eia7/8pYWkAhpgdlvn86dWRUqpYtGd2d7X89P8ysb0Kl6wmqrQbVt1TfYjl1zbBRlMky1zgc0oCplGZJKRmGzKYExIMcBYfovUu5JyvzUSWS9dKnkNikJmF6nkW9GU+Va+UzIfgJYiF6iDlFAbkXtyqS+p6sUxrMzJWi65QO4Ug2wjEsaUCphyp7alLumglLzFd3Vln0qeSl6DYpDdRZqUa22b2HJsjcx7yDTpdC7QUapFqxFprinVHFPuA22pV9fHHL6hUbu3HBqZJTBNcsyr5ErCpFY7LJdaPrG+jIzMnk2T5sAItt9GtK01ZXZoS02cA1pyjWNqqwA/C8oBdrxxggU3kJBqiRtxKn8aMNkM2ZM0ycN3FQ77LnmX/AShWtzi/IwVfmXNmxM3/cJ6Ja9K2DhUejGxQEVrva9J3pvTWrKWeAkbh0rvPgi8+pX1S17CxsHcx+KeEr2XyUvYOFR6MbEKumgu/B9p34PAjV9ZavIoYeNQ6cXEAhXt0fsom6vkIWHjYM5ZfFaiNUne7Q6/ZiBh41DpxcQCFW3qfXTYqktewsah0ouJNUAtKe/NfC1ZS7yEjUOld4QwrR+8uT7arM6sO+TvpgnqweyP4PyvZqc6poc72Fb6pG0oN1nG2HSi0BB2UPskK6oqjGh+tw4VbZfGvUAQgM/T+66//rMO2d84D7oH8G4EXweAD/HB658XLON95D4TgKMAIHh9iASJyuCnZy0YzurIn9JD5Dvm4Q+UuIM0vAA6+RU6haR7J2oeGdoSZohCJkiMTNqM3hhaLAFuSQcMpUAHlEzN6MElVCMZLnBHDMsGMAwAqVLJUlHGYAvbA5zGUdSiFXMxBweiVudNLw3dyyQER+YKCFktI4zJgfVRnhbx229Iaw3tIBFNQA2tYuWAU4yblYzAjeZYsuaYIKYZUGHIbml5Mg1HGH3KN3fRbfHLoOzersurkGwIygrdUyF5Z5u6VF6iFaClWI1M9i3EGIAEVYAxHSEwBZoWDIAjQDvF3XjSlz0LbvjRhb1jVpAxjLAIWgjjQVTpflQnhwiUaxyzVSP8u5R5WAh63cQQ2RhOKyQ3Ueq0myGVx24evQ26WVqW7+ZT2EA3R2OzXVNp304/gkDXFdbc9wU71FyJQL4C5ay01Vob7bUQ6KUoN16D3LoDCZTiEzXgOSExWqkEIc+2qdtHhXIFJEqVybzeXpQT9x1ZWmllEYGS6MuyIOZ1oghKokRxZyFSo0qobiee5yF2uP+yaLnye1GI3woXLYlmYdlNPw8/PjxUbS+TceBuKCnHs+oy4uXmzAWZjLJyMUyJ1VulaDOWyz4aIVYucSRFRiFka8+dDzVKgFAJcr0lGnIWsXAjRyDqXyx8ucUe) format("woff2"),url(/static/fira-code-all-400-normal-c050f0ce726c76d279c879401b2dbd63.woff) format("woff");unicode-range:u+1f??}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:400;src:url(data:font/woff2;base64,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) format("woff2"),url(/static/fira-code-all-400-normal-c050f0ce726c76d279c879401b2dbd63.woff) format("woff");unicode-range:u+0370-03ff}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:400;src:url(data:font/woff2;base64,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) format("woff2"),url(/static/fira-code-all-400-normal-c050f0ce726c76d279c879401b2dbd63.woff) format("woff");unicode-range:u+0100-024f,u+0259,u+1e??,u+2020,u+20a0-20ab,u+20ad-20cf,u+2113,u+2c60-2c7f,u+a720-a7ff}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:400;src:url(/static/fira-code-latin-400-normal-e662d57ce51fba1f46e32dff4dd23e4d.woff2) format("woff2"),url(/static/fira-code-all-400-normal-c050f0ce726c76d279c879401b2dbd63.woff) format("woff");unicode-range:u+00??,u+0131,u+0152-0153,u+02bb-02bc,u+02c6,u+02da,u+02dc,u+2000-206f,u+2074,u+20ac,u+2122,u+2191,u+2193,u+2212,u+2215,u+feff,u+fffd}@font-face{font-display:swap;font-family:MontserratVariable;font-style:normal;font-weight:100 900;src:url(/static/montserrat-cyrillic-variable-wghtOnly-normal-f41a9bc7688bda1e84508030cb5c18fe.woff2) format("woff2");unicode-range:u+0301,u+0400-045f,u+0490-0491,u+04b0-04b1,u+2116}@font-face{font-display:swap;font-family:MontserratVariable;font-style:normal;font-weight:100 900;src:url(/static/montserrat-cyrillic-ext-variable-wghtOnly-normal-639b3c91831427d83cd3984af014778c.woff2) format("woff2");unicode-range:u+0460-052f,u+1c80-1c88,u+20b4,u+2de0-2dff,u+a640-a69f,u+fe2e-fe2f}@font-face{font-display:swap;font-family:MontserratVariable;font-style:normal;font-weight:100 900;src:url(/static/montserrat-latin-variable-wghtOnly-normal-b66f2d18f66f15c3ac56a2f4d68b3be5.woff2) format("woff2");unicode-range:u+00??,u+0131,u+0152-0153,u+02bb-02bc,u+02c6,u+02da,u+02dc,u+2000-206f,u+2074,u+20ac,u+2122,u+2191,u+2193,u+2212,u+2215,u+feff,u+fffd}@font-face{font-display:swap;font-family:MontserratVariable;font-style:normal;font-weight:100 900;src:url(/static/montserrat-latin-ext-variable-wghtOnly-normal-9f73369162c4382215d4317ba362fe1e.woff2) format("woff2");unicode-range:u+0100-024f,u+0259,u+1e??,u+2020,u+20a0-20ab,u+20ad-20cf,u+2113,u+2c60-2c7f,u+a720-a7ff}@font-face{font-display:swap;font-family:MontserratVariable;font-style:normal;font-weight:100 900;src:url(data:font/woff2;base64,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) format("woff2");unicode-range:u+0102-0103,u+0110-0111,u+0128-0129,u+0168-0169,u+01a0-01a1,u+01af-01b0,u+1ea0-1ef9,u+20ab}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:400;src:url(/static/merriweather-cyrillic-ext-400-normal-2a880e22b1b888ab54652a36d43b7f16.woff2) format("woff2"),url(/static/merriweather-all-400-normal-5e7a0e6a9b864b89292d60ba5da59d4b.woff) format("woff");unicode-range:u+0460-052f,u+1c80-1c88,u+20b4,u+2de0-2dff,u+a640-a69f,u+fe2e-fe2f}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:400;src:url(/static/merriweather-cyrillic-400-normal-fde0b55efc50742fb57fbebbb11c572f.woff2) format("woff2"),url(/static/merriweather-all-400-normal-5e7a0e6a9b864b89292d60ba5da59d4b.woff) format("woff");unicode-range:u+0301,u+0400-045f,u+0490-0491,u+04b0-04b1,u+2116}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:400;src:url(data:font/woff2;base64,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) format("woff2"),url(/static/merriweather-all-400-normal-5e7a0e6a9b864b89292d60ba5da59d4b.woff) format("woff");unicode-range:u+0102-0103,u+0110-0111,u+0128-0129,u+0168-0169,u+01a0-01a1,u+01af-01b0,u+1ea0-1ef9,u+20ab}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:400;src:url(/static/merriweather-latin-ext-400-normal-4657f5ab02d5923d223f96a9155a9bdc.woff2) format("woff2"),url(/static/merriweather-all-400-normal-5e7a0e6a9b864b89292d60ba5da59d4b.woff) format("woff");unicode-range:u+0100-024f,u+0259,u+1e??,u+2020,u+20a0-20ab,u+20ad-20cf,u+2113,u+2c60-2c7f,u+a720-a7ff}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:400;src:url(/static/merriweather-latin-400-normal-e009f21405b4d7e893674b69deb4cf4a.woff2) format("woff2"),url(/static/merriweather-all-400-normal-5e7a0e6a9b864b89292d60ba5da59d4b.woff) format("woff");unicode-range:u+00??,u+0131,u+0152-0153,u+02bb-02bc,u+02c6,u+02da,u+02dc,u+2000-206f,u+2074,u+20ac,u+2122,u+2191,u+2193,u+2212,u+2215,u+feff,u+fffd}

/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{-webkit-text-size-adjust:100%;line-height:1.15}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden]{display:none}:root{--maxWidth-none:"none";--maxWidth-xs:20rem;--maxWidth-sm:24rem;--maxWidth-md:28rem;--maxWidth-lg:32rem;--maxWidth-xl:36rem;--maxWidth-2xl:42rem;--maxWidth-3xl:48rem;--maxWidth-4xl:56rem;--maxWidth-full:"100%";--maxWidth-wrapper:var(--maxWidth-4xl);--spacing-px:"1px";--spacing-0:0;--spacing-1:0.25rem;--spacing-2:0.5rem;--spacing-3:0.75rem;--spacing-4:1rem;--spacing-5:1.25rem;--spacing-6:1.5rem;--spacing-8:2rem;--spacing-10:2.5rem;--spacing-12:3rem;--spacing-16:4rem;--spacing-20:5rem;--spacing-24:6rem;--spacing-32:8rem;--fontFamily-sans:"Fira Code","MontserratVariable",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--fontFamily-serif:"Merriweather","Georgia",Cambria,"Times New Roman",Times,serif;--font-body:var(--fontFamily-serif);--font-heading:var(--fontFamily-sans);--fontWeight-normal:400;--fontWeight-bold:700;--fontWeight-black:900;--fontSize-root:16px;--lineHeight-none:1;--lineHeight-tight:1.1;--lineHeight-normal:1.5;--lineHeight-relaxed:1.625;--fontSize-0:0.833rem;--fontSize-1:1rem;--fontSize-2:1.2rem;--fontSize-3:1.44rem;--fontSize-4:1.728rem;--fontSize-5:2.074rem;--fontSize-6:2.488rem;--fontSize-7:2.986rem;--color-primary:#005b99;--color-text:#2e353f;--color-text-light:#4f5969;--color-heading:#1a202c;--color-heading-black:#000;--color-accent:#d1dce5}*,:after,:before{box-sizing:border-box}html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-size:var(--fontSize-root);line-height:var(--lineHeight-normal)}body{color:var(--color-text);font-family:var(--font-body);font-size:var(--fontSize-1);min-width:400px}footer{padding:var(--spacing-6) var(--spacing-0)}hr{background:var(--color-accent);border:0;height:1px}h1,h2,h3,h4,h5,h6{font-family:var(--font-heading);letter-spacing:-.025em;line-height:var(--lineHeight-tight);margin-bottom:var(--spacing-6);margin-top:var(--spacing-12)}h2,h3,h4,h5,h6{color:var(--color-heading);font-weight:var(--fontWeight-bold)}h1{color:var(--color-heading-black);font-size:var(--fontSize-6);font-weight:var(--fontWeight-black)}h2{font-size:var(--fontSize-5)}h3{font-size:var(--fontSize-4)}h4{font-size:var(--fontSize-3)}h5{font-size:var(--fontSize-2)}h6{font-size:var(--fontSize-1)}h1>a,h2>a,h3>a,h4>a,h5>a,h6>a{color:inherit;text-decoration:none}p{--baseline-multiplier:0.179;--x-height-multiplier:0.35;word-wrap:break-word;line-height:var(--lineHeight-relaxed);margin:var(--spacing-0) var(--spacing-0) var(--spacing-8) var(--spacing-0);padding:var(--spacing-0)}strong{color:var(--color-primary);font-size:var(--fontSize-2)}ol,ul{list-style-image:none;list-style-position:outside;margin-bottom:var(--spacing-8);margin-left:var(--spacing-0);margin-right:var(--spacing-0);padding:var(--spacing-0)}ol li,ul li{word-wrap:break-word;margin-left:var(--spacing-6);padding-left:var(--spacing-0)}li>p,ol li,ul li{margin-bottom:calc(var(--spacing-8)/2)}li :last-child{margin-bottom:var(--spacing-0)}li>ul{margin-left:var(--spacing-8);margin-top:calc(var(--spacing-8)/2)}blockquote{border-left:var(--spacing-1) solid var(--color-primary);color:var(--color-text-light);font-size:var(--fontSize-2);font-style:italic;margin-bottom:var(--spacing-8);margin-left:calc(var(--spacing-6)*-1);margin-right:var(--spacing-8);padding:var(--spacing-0) var(--spacing-0) var(--spacing-0) var(--spacing-6)}blockquote>:last-child{margin-bottom:var(--spacing-0)}blockquote>ol,blockquote>ul{list-style-position:inside}table{border:1px solid #000;border-collapse:collapse;border-spacing:.25rem}table :is(td,th){border:1px solid silver;padding:.3em;white-space:nowrap}a{color:var(--color-primary)}a:focus,a:hover{text-decoration:none}.global-wrapper{margin:var(--spacing-0) auto;margin-right:max(305px,30%);max-width:var(--maxWidth-wrapper);padding:var(--spacing-10) var(--spacing-5)}.global-wrapper[data-is-root-path=true] .bio{margin-bottom:var(--spacing-20)}.global-header{margin-bottom:var(--spacing-12)}.main-heading{font-size:var(--fontSize-7);margin:0}.post-list-item{margin-bottom:var(--spacing-8);margin-top:var(--spacing-8)}.post-list-item p{margin-bottom:var(--spacing-0)}.post-list-item h2{color:var(--color-primary);font-size:var(--fontSize-4);margin-bottom:var(--spacing-2);margin-top:var(--spacing-0)}.post-list-item header{margin-bottom:var(--spacing-4)}.header-link-home{font-family:var(--font-heading);font-size:var(--fontSize-2);font-weight:var(--fontWeight-bold);text-decoration:none}.bio{display:flex;margin-bottom:var(--spacing-16)}.bio p,.bio-avatar{margin-bottom:var(--spacing-0)}.bio-avatar{border-radius:100%;margin-right:var(--spacing-4);min-width:50px}.blog-post header h1{margin:var(--spacing-0) var(--spacing-0) var(--spacing-4) var(--spacing-0)}.blog-post header p{font-family:var(--font-heading);font-size:var(--fontSize-2)}.blog-post-nav ul{margin:var(--spacing-0)}.gatsby-highlight{margin-bottom:var(--spacing-8)}@media (max-width:42rem){blockquote{margin-left:var(--spacing-0);padding:var(--spacing-0) var(--spacing-0) var(--spacing-0) var(--spacing-4)}ol,ul{list-style-position:inside}}.gatsby-highlight{background-color:#f5f2f0;border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}.gatsby-highlight pre[class*=language-].line-numbers{overflow:initial;padding:0 0 0 2.8em}.remark-draw{overflow:auto}.table-of-contents{background-color:#fff;border-left:solid #000;border-width:1px;bottom:0;font-size:var(--fontSize-0);overflow:auto;padding-left:5px;padding-right:15px;position:fixed;right:0;top:0;width:300px;z-index:999}.table-of-contents a{color:var(--color-text);text-decoration:none}.table-of-contents a:hover{color:var(--color-primary);font-size:var(--fontSize-1)}@media (max-width:900px){.table-of-contents{display:none}.global-wrapper{margin-right:auto}}.wrapper{margin-bottom:var(--spacing-8);overflow-x:auto;text-align:center}details{margin-bottom:30px}code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#000;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;tab-size:4;text-align:left;text-shadow:0 1px #fff;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:#b3d4fc;text-shadow:none}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{background:hsla(0,0%,100%,.5);color:#9a6e3a}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}pre[class*=language-].line-numbers{counter-reset:linenumber;padding-left:3.8em;position:relative}pre[class*=language-].line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{border-right:1px solid #999;font-size:100%;left:-3.8em;letter-spacing:-1px;pointer-events:none;position:absolute;top:0;-webkit-user-select:none;user-select:none;width:3em}.line-numbers-rows>span{counter-increment:linenumber;display:block}.line-numbers-rows>span:before{color:#999;content:counter(linenumber);display:block;padding-right:.8em;text-align:right}.command-line-prompt{border-right:1px solid #999;display:block;float:left;font-size:100%;letter-spacing:-1px;margin-right:1em;pointer-events:none;text-align:right;-webkit-user-select:none;user-select:none}.command-line-prompt>span:before{content:" ";display:block;opacity:.7;padding-right:.8em}.command-line-prompt>span[data-user]:before{content:"[" attr(data-user) "@" attr(data-host) "] $"}.command-line-prompt>span[data-user=root]:before{content:"[" attr(data-user) "@" attr(data-host) "] #"}.command-line-prompt>span[data-prompt]:before{content:attr(data-prompt)}.command-line-prompt>span[data-continuation-prompt]:before{content:attr(data-continuation-prompt)}.command-line span.token.output{opacity:.7}</style><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="alternate" type="application/rss+xml" title="Gatsby Starter Blog RSS Feed" href="/rss.xml"/><link rel="icon" href="/favicon-32x32.png?v=0e268a0c61e073203f25a3c89d8e0fbf" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=0e268a0c61e073203f25a3c89d8e0fbf"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=0e268a0c61e073203f25a3c89d8e0fbf"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=0e268a0c61e073203f25a3c89d8e0fbf"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=0e268a0c61e073203f25a3c89d8e0fbf"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=0e268a0c61e073203f25a3c89d8e0fbf"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=0e268a0c61e073203f25a3c89d8e0fbf"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=0e268a0c61e073203f25a3c89d8e0fbf"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=0e268a0c61e073203f25a3c89d8e0fbf"/><title data-gatsby-head="true">Flink作业提交、调度与执行 | 知行合一</title></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="global-wrapper" data-is-root-path="false"><header class="global-header"><a class="header-link-home" href="/">知行合一</a></header><main><article class="blog-post" itemscope="" itemType="http://schema.org/Article"><header><h1 itemProp="headline">Flink作业提交、调度与执行</h1><p>December 24, 2022</p></header><section itemProp="articleBody"><div class="table-of-contents">
<ol>
<li>
<p><a href="#flink%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84">Flink集群架构</a></p>
<ol>
<li>
<p><a href="#jobmanager">JobManager</a></p>
</li>
<li>
<p><a href="#taskmanager">TaskManager</a></p>
<ol>
<li><a href="#mailbox%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B">Mailbox线程模型</a></li>
</ol>
</li>
<li>
<p><a href="#operatorchain">OperatorChain</a></p>
</li>
<li>
<p><a href="#task">Task</a></p>
<ol>
<li><a href="#%E7%BD%91%E7%BB%9C%E6%A0%88">网络栈</a></li>
</ol>
</li>
<li>
<p><a href="#%E9%9B%86%E7%BE%A4%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B">集群启动流程</a></p>
</li>
<li>
<p><a href="#minicluster%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B">MiniCluster启动流程</a></p>
</li>
<li>
<p><a href="#yarn-cluster%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B">Yarn Cluster启动流程</a></p>
</li>
</ol>
</li>
<li>
<p><a href="#flink-graph">Flink Graph</a></p>
<ol>
<li><a href="#datastream">DataStream</a></li>
<li><a href="#%E6%B5%81%E5%9B%BEstreamgraph">流图（StreamGraph）</a></li>
<li><a href="#%E4%BD%9C%E4%B8%9A%E5%9B%BEjobgraph">作业图（JobGraph）</a></li>
<li><a href="#%E6%89%A7%E8%A1%8C%E5%9B%BEexecutiongraph">执行图（ExecutionGraph）</a></li>
<li><a href="#%E7%89%A9%E7%90%86%E6%89%A7%E8%A1%8C%E5%9B%BEtask-dag">物理执行图（Task DAG）</a></li>
</ol>
</li>
<li>
<p><a href="#%E5%90%AF%E5%8A%A8flink%E9%9B%86%E7%BE%A4">启动Flink集群</a></p>
</li>
<li>
<p><a href="#%E4%BD%9C%E4%B8%9A%E6%8F%90%E4%BA%A4">作业提交</a></p>
<ol>
<li><a href="#datastream-api%E8%BD%AC%E6%8D%A2%E6%88%90transformation">DataStream API转换成Transformation</a></li>
<li><a href="#transformations%E8%BD%AC%E6%8D%A2%E6%88%90streamgraph">Transformations转换成StreamGraph</a></li>
<li><a href="#streamgraph%E8%BD%AC%E6%8D%A2%E6%88%90jobgraph">StreamGraph转换成JobGraph</a></li>
<li><a href="#jobgraph%E8%BD%AC%E6%8D%A2%E6%88%90executiongraph">JobGraph转换成ExecutionGraph</a></li>
</ol>
</li>
<li>
<p><a href="#%E4%BD%9C%E4%B8%9A%E8%B0%83%E5%BA%A6">作业调度</a></p>
</li>
<li>
<p><a href="#%E4%BD%9C%E4%B8%9A%E6%89%A7%E8%A1%8C">作业执行</a></p>
<ol>
<li>
<p><a href="#%E6%95%B0%E6%8D%AE%E4%BC%A0%E9%80%92">数据传递</a></p>
<ol>
<li><a href="#%E5%90%8C%E4%B8%80task%E5%86%85%E7%AE%97%E5%AD%90%E9%97%B4%E7%9A%84%E6%95%B0%E6%8D%AE%E4%BC%A0%E9%80%92">同一Task内算子间的数据传递</a></li>
<li><a href="#%E4%B8%8D%E5%90%8Ctask%E5%86%85%E7%AE%97%E5%AD%90%E9%97%B4%E7%9A%84%E6%95%B0%E6%8D%AE%E4%BC%A0%E9%80%92">不同Task内算子间的数据传递</a></li>
</ol>
</li>
<li>
<p><a href="#%E5%8F%8D%E5%8E%8B">反压</a></p>
</li>
<li>
<p><a href="#%E6%B0%B4%E5%8D%B0%E5%A4%84%E7%90%86">水印处理</a></p>
</li>
<li>
<p><a href="#%E5%BB%B6%E8%BF%9F%E6%A0%87%E8%AE%B0%E5%A4%84%E7%90%86">延迟标记处理</a></p>
</li>
</ol>
</li>
<li>
<p><a href="#checkpoint">Checkpoint</a></p>
</li>
<li>
<p><a href="#%E5%A4%84%E7%90%86%E6%97%B6%E9%97%B4%E5%AE%9A%E6%97%B6%E5%99%A8">处理时间定时器</a></p>
</li>
</ol>
</div>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/097023deaa79365a8704ee3b51d47d9c/54421/flink_submit.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 36.708860759493675%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAtUlEQVR42p2R2wqEMAxE+/9fWkWr1ltbtFlOliwiPsgGxsShnWRSJ39GjFH6vpe2bRX7vivv3lyutf7qUopM0yTjOMqyLBJC0P/jOL6C27aJYV1XSSlpnXPWg957vQSPAByixDzPOimwpo4DAHIYBrVBNs7ARE3TKGhGkOFpeJ6nijo+V0tW33mzy/Q0Y1oT7LpOm7JHdxW6CzztkbXgALtkhHgUGr1+lGuwfPaJTUSZDjAdlj+SKCN+Kk+h0QAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="flink submit"
        title=""
        src="/static/097023deaa79365a8704ee3b51d47d9c/f058b/flink_submit.png"
        srcset="/static/097023deaa79365a8704ee3b51d47d9c/c26ae/flink_submit.png 158w,
/static/097023deaa79365a8704ee3b51d47d9c/6bdcf/flink_submit.png 315w,
/static/097023deaa79365a8704ee3b51d47d9c/f058b/flink_submit.png 630w,
/static/097023deaa79365a8704ee3b51d47d9c/40601/flink_submit.png 945w,
/static/097023deaa79365a8704ee3b51d47d9c/78612/flink_submit.png 1260w,
/static/097023deaa79365a8704ee3b51d47d9c/54421/flink_submit.png 3009w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>当用户开始提交一个作业，首先会将用户编写的代码转化为一个JobGraph，在这个过程中，它会进行一些检查或优化相关的工作（如生成算子链）。然后，Client再将生成的JobGraph提交到集群中执行。对于Session模式，Client直接与Dispatcher建立连接并提交作业；对于PerJob模式，Client首先向资源管理系统（如Yarn）申请资源来启动ApplicationMaster，然后再向ApplicationMaster中的Dispatcher提交作业。当作业到Dispatcher后，Dispatcher会首先启动一个JobMster，然后 JobMaster向ResourceManager申请资源来启动作业中具体的任务。ResourceManager获取到空闲的Slot之后，就会通知相应的TaskManager将该Slot分配给指定的JobMaster。</p>
<p>Flink作业提交调度执行通用步骤：</p>
<ol>
<li>客户端通过Dispatcher提供的REST接口，将作业提交给JobManager</li>
<li>Dispathcer启动JobMaster，并将JobGraph提交给JobMaster</li>
<li>JobMaster将JobGraph转换为ExecutionGraph，得到所需资源数量，然后向ResourceManager请求资源Slot</li>
<li>ResourceManager判断当前是否有足够的可用资源，如果没有，启动新的TaskManager</li>
<li>TaskManager启动之后，向ResourceManager注册自己的可用Slot</li>
<li>ResourceManager通知TaskManager为新的作业提供Slot</li>
<li>TaskManager连接到对应的JobMaster，提供slot</li>
<li>JobMaster将需要执行的任务分发给TaskManager</li>
<li>TaskManager执行任务，互相之间可以交换数据</li>
</ol>
<p>按照作业是否独占Flink集群，作业运行模式分为：</p>
<ul>
<li>Session模式：一个Flink集群中运行多个作业。作业共享Dispatcher、ResourceManager、Flink集群资源。适合执行时间短，频繁执行的短任务</li>
<li>Per-Job模式：一个Flink集群中只运行一个作业，作业执行完毕则Flink集群销毁，作业之间相互隔离。作业独享Dispathcer、ResourceManager、Flink集群资源。适合长周期执行的任务</li>
</ul>
<p>YARN Session模式下，先启动一个YARN会话，这个会话创建一个Flink集群，仅启动JobManager，TaskManager根据需要动态启动。而在YARN Per-Job模式下，不会预先创建Flink集  群，而是在提交作业时才创建Flink集群。</p>
<p>YARN Per-Job模式作业提交调度执行具体流程为：</p>
<ol>
<li>Flink Client将作业提交给YARN ResourceManager，同时将Flink Jar和配置上传到HDFS</li>
<li>YARN ResourceManager分配Container，启动Flink JobManager</li>
<li>Dispatcher启动JobMaster</li>
<li>JobMaster向ResourceManager请求Slot</li>
<li>ResourceManager向YARN ResourceManager请求Container</li>
<li>YARN ResourceManager启动新的TaskManager容器</li>
<li>TaskManager启动之后，向ResourceManager注册自己的可用任务槽</li>
<li>ResourceManager通知TaskManager为新的作业提供Slot</li>
<li>TaskManager连接到对应的JobMaster，提供Slot</li>
<li>JobMaster将需要执行的任务分发给TaskManager，执行任务</li>
</ol>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/4b14a4eb301d7d380efee807450e35ec/f21a2/flink_yarn_perjob.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 103.16455696202532%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsTAAALEwEAmpwYAAACpUlEQVR42pWVCXPbIBCF8/9/X6edpHVs67JOQBKXDnhdkFInrp1MPLMDEuhj9+2T/IQvfn618KaL4YYEbky3cUjhraD1+cP+p/sUF0iAm+GnAX5WNNLD07iB+xPNe5oz2rN8DfSLgZcX+LGAVxUQgQMt+G1tNdu+mQ5wNxnaaYJSGtpYhPkyT3SqjSd73cKJA8XrVmZ/ppLzLfsoB4HX6QZoJKSooCgmxaFHKgNuWyX9sCi4oOEsaa5jVu+l8XRvv9iAZmjiqU4cYdkJ1tqrjvumDWZiE9yYAaH8N2BY2/eF8SkApByhtcRkDVbnYhle16RjsUUok7T0uonQDbQ3KKybdncCu23KnhE9tFJDlj7DzE8UR6yK9CRN/fyW3fqv5K3ba7x3F+g0g2IZLE9IBoqhghUFVHMkPcWHvWH0qtzt4+8DF9lgtookkOBtiUF0ZJ0RhqCLrN6ZnqSRZfRldMCQPQLWmCeLeV5QNzX6YYSbJAw5wJE/r37VdF1GHQPMyfxByaoBZy0ul5Ligqqq4pgcf6OvDmg7Hn0b3hbRVcjzHHVN1uPlgwxH0sxolGVFUSLLUkgyvxoYmuRnBHaMI/nzA1WRoaCDq6aFZMWjkgNQYRxHFEURM1TaUMkchqeYlxXGzuDlkYApydKibhnay+k+cCXgOIgITJIkApu2w+nwDFa8xDnnAmX6guTwC3l6RnI+os6eHwGpEYKh73sqN4tZth2LHTfBRtNCGhqE17avTxD1GYyyVV3yGCh4RzoxpGkaoSGjSQ9k+MuND/HZ5+uq4WQ1ZbZ1uK5rKp9so/r/gJ4+afGzto+f+rBtmk0/AjLKdhBttNS3MwzvrVISggydF8E2BZgYoCRlqNn3gY5e9iC+5jmGhkSvXjG2abz2i/30P+gv2l9h66AhpaUAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="flink yarn per-job submit"
        title=""
        src="/static/4b14a4eb301d7d380efee807450e35ec/f058b/flink_yarn_perjob.png"
        srcset="/static/4b14a4eb301d7d380efee807450e35ec/c26ae/flink_yarn_perjob.png 158w,
/static/4b14a4eb301d7d380efee807450e35ec/6bdcf/flink_yarn_perjob.png 315w,
/static/4b14a4eb301d7d380efee807450e35ec/f058b/flink_yarn_perjob.png 630w,
/static/4b14a4eb301d7d380efee807450e35ec/40601/flink_yarn_perjob.png 945w,
/static/4b14a4eb301d7d380efee807450e35ec/78612/flink_yarn_perjob.png 1260w,
/static/4b14a4eb301d7d380efee807450e35ec/f21a2/flink_yarn_perjob.png 2327w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h2 id="flink集群架构" style="position:relative;"><a href="#flink%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84" aria-label="flink集群架构 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Flink集群架构</h2>
<p>Flink集群采用主从架构（Master/Worker），由一个JobManager进程和一个或多个TaskManager进程组成，其中，JobManager是Master，TaskManager是Worker。Client是在集群外部执行的进程，不是集群的一部分。</p>
<p>Client是Flink提供的CLI命令行工具，用来提交作业到Flink集群，负责流图（StreamGraph）和作业图（JobGraph）的构建、Flink SQL的解析和优化。</p>
<p>JobManager是Flink集群的Master节点，负责集群和作业管理，根据并行度将Client提交的Flink作业分解为Task，从资源管理框架申请所需的计算资源，分发计算任务到TaskManager执行，并负责应用容错，跟踪作业的执行状态，协调Checkpoint。JobManager包含ResourceManager、JobMaster、Dispatcher三个组件</p>
<ul>
<li>
<p>JobMaster：负责执行具体某个作业，包括该作业相关的协调工作（如Task调度、Checkpoint触发、故障恢复）。Flink集群中可以同时运行多个作业，每个作业都有自己的JobMaster。狭义的JobManager就是指JobMaster。JobMaster根据并行度将Client提交的JobGraph转换为ExecutionGraph（包含了所有并发执行的Task），JobMaster向ResourceManager申请Slot执行Task，获取到Slot后将Task分发到TaskManager上运行</p>
<ul>
<li>SchedulerNG：负责创建ExecutionGraph并进行调度</li>
<li>SlotPool：负责向ResourceManager申请/释放Slot资源，并维护请求到的Slot信息，Slot通过AllocationID区分。</li>
</ul>
</li>
<li>
<p>ResourceManager：负责Slot的分配和管理，不同的环境和资源有不同的具体实现（YarnResourceManager、KubernetesResourceManager、StandaloneResourceManager、MesosResourceManager）。当新的作业申请Slot时，ResourceManager会将有空闲Slot的TaskManager分配给JobMaster，如果没有足够的Slot，它会向资源管理平台申请启动TaskManager进程的容器。还负责释放空闲的TaskManager</p>
<ul>
<li>SlotManager：维护所有TaskManager注册的Slot（包括它们的分配情况）以及所有待处理的Slot请求，负责提供Slot信息查询，释放Slot资源，处理、取消JobMaster发送的SlotRequest，注册、取消TaskManager，只要新增可用Slot（新Slot注册或Slot释放），SlotManager都会检查待处理的SlotRequest列表，确认是否有SlotRequest可以满足，如果可以满足，就会将资源分配给这个 SlotRequest。如果没有足够可用的Slot，SlotManager会尝试申请新的资源</li>
</ul>
</li>
<li>
<p>Dispathcer：主要处理作业相关的请求，负责提交、取消作业，触发、取消、清理作业的Savepoint，作业状态查询。接收用户提交的作业，并为新提交的作业启动一个新的JobMaster，还运行Flink WebUI来展示和监控作业执行的信息</p>
</li>
</ul>
<p>TaskManager是Flink集群的Worker节点，负责Slot的资源管理、Task的生命周期（启动、停止、销毁、异常恢复等）管理、Checkpoint相关处理。启动之后，TaskManager会向ResourceManager注册它的Slot，收到ResourceManager的指令后，TaskManager就会将一个或者多个Slot提供给JobMaster调用，JobMaster就可以分配Task来执行了。在Task执行过程中，TaskManager可以缓冲数据，跟同一作业的其他TaskManager交换数据。</p>
<h3 id="jobmanager" style="position:relative;"><a href="#jobmanager" aria-label="jobmanager permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>JobManager</h3>
<div class='wrapper' markdown='block'>
<p><img src="https://www.plantuml.com/plantuml/svg/ZLLDZzis4BthLx2tjCWUSjx0JRfkKY-GJM0la3D5FKciAOuo9EqkYlxtWfAeBzkBtCWtmz7Cu-FJ1-Sb-z2OBFl5rsWWt15UrIzt5BpH5bcj2mWqhNyH3PeSx39trBQLB1lnaPdEpxLMHmldnBiiKqOw9xRQjTAh6Yp-pOGGuejitpzIljk-5O-KVv5MLk1zi1Qy4HoirRPwfDpTTzaFP0oKrsJZeSyisteZ68fEO1HJdc98ZtN1Dx_sKHVoHlj7oXEWf5KmCy1e5-CkxHa_0ZheuAKFL_0zN31-XJ-Ou3puwmbyqZYFtw-3tzBP3k44UzPL1Jx84rhITYnMQDUImmB_Bn6wXwF02iEW0wi7GpuXRbhVlq8vAkqyoyZjHlnz5NTfk0Y1fyEfqngIVGxfFp4rb-52EqNMGldBM2hwBDtnpt-WWgVhPMF2pRfNWWwsY7JiqHAFd5hokdo9-CUJr4Rc1WjQvmJsb5RmJo7AV3zqYgxiA8LRyQ_bHSOd1gwV7IFJgJangz62VIN8tRons5AovV29j6-P59nBEjhZHz2C1dPgJnb8lfKmKjRTQMmcQL3LA881FtqMRbhVZmBzHcGwTSP53w_LpClzfD-K64Kybyncv0l5Z9H1kSapehwxHG__OIZ_pZgsde_BFlHNajuXFc45Duan8SD0TIXBWvw1zxzluYEVW85wgSsSUYfBy488jon0ggEbiq5HuQ66EYxz0IeQyZ8mNiiMfGp6ZxSntCuDAdeUDTa-YCNsVdwlsbRFr9AXwYLTxmnQfnwYXM2Hcg2Vvszihdktnf2IddXgSW6l7dCdjd7qtJRElIj6MVIVsHMzy_NheJ7ucTfUrrTKPkyrdVtlYhVY6soXRJKW6z4kzhVF3NDeil6ZPJ2bDWR5ybnoFLgzcqjZN2RyXBSm3AJ3bKZ_RntwmnLlbKDeTDQvveUwIwYRwGddHT6PEIugkPqjYPkEcz7Kf3OJOuF-9qFwxUxkuXsimaaZMRRse1GTzbds0RO8ZVaV" alt="plantuml"></p>
<p>JobManager的启动类是ClusterEntrypoint，启动入口方法是runClusterEntrypoint()，最终调用runCluster()方法启动集群。runCluster()方法主要包含两个步骤：初始化相关服务和创建DispatcherResourceManagerComponent对象。DispatcherResourceManagerComponent对象在创建时会创建并启动Dispatcher和ResourceManager。</p>
<p>JobManager相关服务有：</p>
<ul>
<li>RpcService：RPC服务</li>
<li>HighAvailabilityServices：用于Leader选举，如ResourceManager Leader、JobManager Leader</li>
<li>BlobServer：负责大文件上传，如作业Jar包、TaskManager的Log文件</li>
<li>HeartbeatService：心跳服务</li>
<li>ExecutionGraphInfoStore：存储ExecutionGraph</li>
</ul>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">ClusterEntrypoint</span> <span class="token punctuation">{</span>

    <span class="token class-name">Configuration</span> configuration<span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">runClusterEntrypoint</span><span class="token punctuation">(</span><span class="token class-name">ClusterEntrypoint</span> clusterEntrypoint<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> clusterEntrypointName <span class="token operator">=</span> clusterEntrypoint<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        clusterEntrypoint<span class="token punctuation">.</span><span class="token function">startCluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">startCluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Starting {}."</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PluginManager</span> pluginManager <span class="token operator">=</span> <span class="token class-name">PluginUtils</span><span class="token punctuation">.</span><span class="token function">createPluginManagerFromRootFolder</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">configureFileSystems</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> pluginManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">runCluster</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> pluginManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">runCluster</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> configuration<span class="token punctuation">,</span> <span class="token class-name">PluginManager</span> pluginManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 初始化相关服务</span>
        <span class="token function">initializeServices</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> pluginManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 向configuration中写入host信息</span>
        configuration<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token class-name">JobManagerOptions</span><span class="token punctuation">.</span><span class="token constant">ADDRESS</span><span class="token punctuation">,</span> commonRpcService<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        configuration<span class="token punctuation">.</span><span class="token function">setInteger</span><span class="token punctuation">(</span><span class="token class-name">JobManagerOptions</span><span class="token punctuation">.</span><span class="token constant">PORT</span><span class="token punctuation">,</span> commonRpcService<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 创建DispatcherResourceManagerComponent对象，这个对象创建时会启动Dispatcher和ResourceManager</span>
        <span class="token class-name">DispatcherResourceManagerComponentFactory</span> dispatcherResourceManagerComponentFactory <span class="token operator">=</span> <span class="token function">createDispatcherResourceManagerComponentFactory</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        clusterComponent <span class="token operator">=</span> dispatcherResourceManagerComponentFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>
            configuration<span class="token punctuation">,</span>
            ioExecutor<span class="token punctuation">,</span>
            commonRpcService<span class="token punctuation">,</span>
            haServices<span class="token punctuation">,</span>
            blobServer<span class="token punctuation">,</span>
            heartbeatServices<span class="token punctuation">,</span>
            metricRegistry<span class="token punctuation">,</span>
            executionGraphInfoStore<span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">RpcMetricQueryServiceRetriever</span><span class="token punctuation">(</span>metricRegistry<span class="token punctuation">.</span><span class="token function">getMetricQueryServiceRpcService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">initializeServices</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> configuration<span class="token punctuation">,</span> <span class="token class-name">PluginManager</span> pluginManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Initializing cluster services."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 创建RPC服务</span>
        rpcSystem <span class="token operator">=</span> <span class="token class-name">RpcSystem</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        commonRpcService <span class="token operator">=</span> <span class="token class-name">RpcUtils</span><span class="token punctuation">.</span><span class="token function">createRemoteRpcService</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JMXService</span><span class="token punctuation">.</span><span class="token function">startInstance</span><span class="token punctuation">(</span>configuration<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token class-name">JMXServerOptions</span><span class="token punctuation">.</span><span class="token constant">JMX_SERVER_PORT</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// update the configuration used to create the high availability services</span>
        <span class="token comment">// 根据创建的RPC服务信息进行相关配置</span>
        configuration<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token class-name">JobManagerOptions</span><span class="token punctuation">.</span><span class="token constant">ADDRESS</span><span class="token punctuation">,</span> commonRpcService<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        configuration<span class="token punctuation">.</span><span class="token function">setInteger</span><span class="token punctuation">(</span><span class="token class-name">JobManagerOptions</span><span class="token punctuation">.</span><span class="token constant">PORT</span><span class="token punctuation">,</span> commonRpcService<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建用于IO的线程池</span>
        ioExecutor <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span>
            <span class="token class-name">ClusterEntrypointUtils</span><span class="token punctuation">.</span><span class="token function">getPoolSize</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">ExecutorThreadFactory</span><span class="token punctuation">(</span><span class="token string">"cluster-io"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// HA Service</span>
        haServices <span class="token operator">=</span> <span class="token function">createHaServices</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> ioExecutor<span class="token punctuation">,</span> rpcSystem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建并启动BlobServer</span>
        blobServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BlobServer</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> haServices<span class="token punctuation">.</span><span class="token function">createBlobStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        blobServer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 心跳服务</span>
        heartbeatServices <span class="token operator">=</span> <span class="token function">createHeartbeatServices</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// metric reporter</span>
        metricRegistry <span class="token operator">=</span> <span class="token function">createMetricRegistry</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> pluginManager<span class="token punctuation">,</span> rpcSystem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RpcService</span> metricQueryServiceRpcService <span class="token operator">=</span> <span class="token class-name">MetricUtils</span><span class="token punctuation">.</span><span class="token function">startRemoteMetricsRpcService</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> commonRpcService<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rpcSystem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        metricRegistry<span class="token punctuation">.</span><span class="token function">startQueryService</span><span class="token punctuation">(</span>metricQueryServiceRpcService<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> hostname <span class="token operator">=</span> <span class="token class-name">RpcUtils</span><span class="token punctuation">.</span><span class="token function">getHostname</span><span class="token punctuation">(</span>commonRpcService<span class="token punctuation">)</span><span class="token punctuation">;</span>
        processMetricGroup <span class="token operator">=</span> <span class="token class-name">MetricUtils</span><span class="token punctuation">.</span><span class="token function">instantiateProcessMetricGroup</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建一个ExecutionGraphInfoStore对象，存储作业的ExecutionGraph</span>
        executionGraphInfoStore <span class="token operator">=</span> <span class="token function">createSerializableExecutionGraphStore</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> commonRpcService<span class="token punctuation">.</span><span class="token function">getScheduledExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">DefaultDispatcherResourceManagerComponentFactory</span> <span class="token keyword">implements</span> <span class="token class-name">DispatcherResourceManagerComponentFactory</span>
<span class="token punctuation">{</span>
    <span class="token class-name">DispatcherResourceManagerComponent</span> <span class="token function">create</span><span class="token punctuation">(</span>
        <span class="token class-name">Configuration</span> configuration<span class="token punctuation">,</span>
        <span class="token class-name">Executor</span> ioExecutor<span class="token punctuation">,</span>
        <span class="token class-name">RpcService</span> rpcService<span class="token punctuation">,</span>
        <span class="token class-name">HighAvailabilityServices</span> highAvailabilityServices<span class="token punctuation">,</span>
        <span class="token class-name">BlobServer</span> blobServer<span class="token punctuation">,</span>
        <span class="token class-name">HeartbeatServices</span> heartbeatServices<span class="token punctuation">,</span>
        <span class="token class-name">MetricRegistry</span> metricRegistry<span class="token punctuation">,</span>
        <span class="token class-name">ExecutionGraphInfoStore</span> executionGraphInfoStore<span class="token punctuation">,</span>
        <span class="token class-name">MetricQueryServiceRetriever</span> metricQueryServiceRetriever<span class="token punctuation">,</span>
        <span class="token class-name">FatalErrorHandler</span> fatalErrorHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">WebMonitorEndpoint</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> webMonitorEndpoint <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">ResourceManagerService</span> resourceManagerService <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">DispatcherRunner</span> dispatcherRunner <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token comment">// 用于Dispatcher Leader选举</span>
        <span class="token class-name">LeaderRetrievalService</span> dispatcherLeaderRetrievalService <span class="token operator">=</span> highAvailabilityServices<span class="token punctuation">.</span><span class="token function">getDispatcherLeaderRetriever</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 用于ResourceManager Leader选举</span>
        <span class="token class-name">LeaderRetrievalService</span> resourceManagerRetrievalService <span class="token operator">=</span> highAvailabilityServices<span class="token punctuation">.</span><span class="token function">getResourceManagerLeaderRetriever</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// DispatcherGateway</span>
        <span class="token class-name">LeaderGatewayRetriever</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DispatcherGateway</span><span class="token punctuation">></span></span> dispatcherGatewayRetriever <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcGatewayRetriever</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ResourceManagerGateway</span>
        <span class="token class-name">LeaderGatewayRetriever</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResourceManagerGateway</span><span class="token punctuation">></span></span> resourceManagerGatewayRetriever <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcGatewayRetriever</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Web UI</span>
        <span class="token class-name">ScheduledExecutorService</span> executor <span class="token operator">=</span> <span class="token class-name">WebMonitorEndpoint</span><span class="token punctuation">.</span><span class="token function">createExecutorService</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> updateInterval <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token class-name">MetricOptions</span><span class="token punctuation">.</span><span class="token constant">METRIC_FETCHER_UPDATE_INTERVAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MetricFetcher</span> metricFetcher <span class="token operator">=</span> updateInterval <span class="token operator">==</span> <span class="token number">0</span>
            <span class="token operator">?</span> <span class="token class-name">VoidMetricFetcher</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span>
            <span class="token operator">:</span> <span class="token class-name">MetricFetcherImpl</span><span class="token punctuation">.</span><span class="token function">fromConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">WebMonitorEndpoint</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> webMonitorEndpoint <span class="token operator">=</span> restEndpointFactory<span class="token punctuation">.</span><span class="token function">createRestEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动Dispatcher REST</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Starting Dispatcher REST endpoint."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        webMonitorEndpoint<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建ResourceManager</span>
        <span class="token class-name">String</span> hostname <span class="token operator">=</span> <span class="token class-name">RpcUtils</span><span class="token punctuation">.</span><span class="token function">getHostname</span><span class="token punctuation">(</span>rpcService<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ResourceManagerService</span> resourceManagerService <span class="token operator">=</span> <span class="token class-name">ResourceManagerServiceImpl</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HistoryServerArchivist</span> historyServerArchivist <span class="token operator">=</span> <span class="token class-name">HistoryServerArchivist</span><span class="token punctuation">.</span><span class="token function">createHistoryServerArchivist</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PartialDispatcherServices</span> partialDispatcherServices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PartialDispatcherServices</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动Dispatcher</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Starting Dispatcher."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dispatcherRunner <span class="token operator">=</span> dispatcherRunnerFactory<span class="token punctuation">.</span><span class="token function">createDispatcherRunner</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动ResourceManager</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Starting ResourceManagerService."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resourceManagerService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resourceManagerRetrievalService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>resourceManagerGatewayRetriever<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dispatcherLeaderRetrievalService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>dispatcherGatewayRetriever<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DispatcherResourceManagerComponent</span><span class="token punctuation">(</span>
            dispatcherRunner<span class="token punctuation">,</span>
            resourceManagerService<span class="token punctuation">,</span>
            dispatcherLeaderRetrievalService<span class="token punctuation">,</span>
            resourceManagerRetrievalService<span class="token punctuation">,</span>
            webMonitorEndpoint<span class="token punctuation">,</span>
            fatalErrorHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<h3 id="taskmanager" style="position:relative;"><a href="#taskmanager" aria-label="taskmanager permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>TaskManager</h3>
<div class='wrapper' markdown='block'>
<p><img src="https://www.plantuml.com/plantuml/svg/TOyzJWD138NxESNGGP6Hg8DG4882YGPo0U_a9JlQ-LbiZo12jDHSWGjmhLm3xOgGX8ZAUjzxpx9deiHQKpJcH5iaMEcWlbrFIjKOCamR5h18lQvjGch0OgGBkIUcPA-Oo_Ey3RxB4B7dnlX88dPEqjsym5SjR5-DjNP4Zx7ed9g8Yq5TMjrdqp4scOoZ1R4s8BtbakvASq-PLk3Ji-cn_G0fbJt-P1P1VCaPNe_xE--VidF3NPklpyt7ktCZOZnLY0vycw8OYoV5Fbio3hHpmwy7cwGsAUY0jo5FsIFk4-UkM_YkBo7hJqqvh5RW7VzjbxmCd8uDQWhh8NupPeQyg2b-0m00" alt="plantuml"></p>
</div>
<p>TaskManager的启动类是TaskManagerRunner，负责创建并启动相关服务（network, I/O manager, memory manager, RPC service, HA service）。TaskExecutor是TaskManager核心组件，负责具体处理工作，如与JobManager通信、Slot管理、Task管理、执行Checkpoint等，TaskManagerServices维护了TaskManager上的所有服务，TaskManagerGateway是外部与TaskManager交互的组件。</p>
<p>TaskManager启动入口方法是runTaskManager()，创建TaskManagerRunner对象，启动TaskManager。</p>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">TaskManagerRunner</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 执行回调方法的Executor</span>
    <span class="token class-name">ExecutorService</span> executor<span class="token punctuation">;</span>
    <span class="token class-name">TaskExecutorService</span> taskExecutorService<span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">runTaskManager</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> configuration<span class="token punctuation">,</span> <span class="token class-name">PluginManager</span> pluginManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 启动TaskManagerRunner</span>
        <span class="token class-name">TaskManagerRunner</span> taskManagerRunner <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">TaskManagerRunner</span><span class="token punctuation">(</span>
                configuration<span class="token punctuation">,</span>
                pluginManager<span class="token punctuation">,</span>
                <span class="token class-name">TaskManagerRunner</span><span class="token operator">::</span><span class="token function">createTaskExecutorService</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// taskExecutorServiceFactory</span>
        <span class="token comment">// 启动TaskExecutor</span>
        taskManagerRunner<span class="token punctuation">.</span>taskExecutorService<span class="token punctuation">.</span>taskExecutor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> taskManagerRunner<span class="token punctuation">.</span><span class="token function">getTerminationFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">getExitCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">static</span> <span class="token class-name">TaskExecutor</span> <span class="token function">startTaskManager</span><span class="token punctuation">(</span>
        <span class="token class-name">Configuration</span> configuration<span class="token punctuation">,</span>
        <span class="token class-name">ResourceID</span> resourceID<span class="token punctuation">,</span>
        <span class="token class-name">RpcService</span> rpcService<span class="token punctuation">,</span>
        <span class="token class-name">HighAvailabilityServices</span> highAvailabilityServices<span class="token punctuation">,</span>
        <span class="token class-name">HeartbeatServices</span> heartbeatServices<span class="token punctuation">,</span>
        <span class="token class-name">MetricRegistry</span> metricRegistry<span class="token punctuation">,</span>
        <span class="token class-name">BlobCacheService</span> blobCacheService<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> localCommunicationOnly<span class="token punctuation">,</span>
        <span class="token class-name">ExternalResourceInfoProvider</span> externalResourceInfoProvider<span class="token punctuation">,</span>
        <span class="token class-name">FatalErrorHandler</span> fatalErrorHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Starting TaskManager with ResourceID: {}"</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> externalAddress <span class="token operator">=</span> rpcService<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TaskExecutorResourceSpec</span> taskExecutorResourceSpec <span class="token operator">=</span> <span class="token class-name">TaskExecutorResourceUtils</span><span class="token punctuation">.</span><span class="token function">resourceSpecFromConfig</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// TaskManager服务相关配置</span>
        <span class="token class-name">TaskManagerServicesConfiguration</span> taskManagerServicesConfiguration <span class="token operator">=</span> <span class="token class-name">TaskManagerServicesConfiguration</span><span class="token punctuation">.</span><span class="token function">fromConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// TaskManagerMetricGroup</span>
        <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TaskManagerMetricGroup</span><span class="token punctuation">,</span> <span class="token class-name">MetricGroup</span><span class="token punctuation">></span></span> taskManagerMetricGroup <span class="token operator">=</span> <span class="token class-name">MetricUtils</span><span class="token punctuation">.</span><span class="token function">instantiateTaskManagerMetricGroup</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// TaskManagerService，初始化TaskManager相关服务</span>
        <span class="token class-name">ExecutorService</span> ioExecutor <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TaskManagerServices</span> taskManagerServices <span class="token operator">=</span> <span class="token class-name">TaskManagerServices</span><span class="token punctuation">.</span><span class="token function">fromConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// TaskManager相关配置，用于TaskExecutor初始化</span>
        <span class="token class-name">TaskManagerConfiguration</span> taskManagerConfiguration <span class="token operator">=</span> <span class="token class-name">TaskManagerConfiguration</span><span class="token punctuation">.</span><span class="token function">fromConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 创建TaskExecutor对象</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TaskExecutor</span><span class="token punctuation">(</span>
            rpcService<span class="token punctuation">,</span>
            taskManagerConfiguration<span class="token punctuation">,</span>
            highAvailabilityServices<span class="token punctuation">,</span>
            taskManagerServices<span class="token punctuation">,</span>
            externalResourceInfoProvider<span class="token punctuation">,</span>
            heartbeatServices<span class="token punctuation">,</span>
            taskManagerMetricGroup<span class="token punctuation">.</span>f0<span class="token punctuation">,</span>  <span class="token comment">// taskManagerMetricGroup</span>
            metricQueryServiceAddress<span class="token punctuation">,</span>
            blobCacheService<span class="token punctuation">,</span>
            fatalErrorHandler<span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">TaskExecutorPartitionTrackerImpl</span><span class="token punctuation">(</span>taskManagerServices<span class="token punctuation">.</span><span class="token function">getShuffleEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// partitionTracker</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">TaskManagerRunner</span><span class="token punctuation">(</span>
        <span class="token class-name">Configuration</span> configuration<span class="token punctuation">,</span>
        <span class="token class-name">PluginManager</span> pluginManager<span class="token punctuation">,</span>
        <span class="token class-name">TaskExecutorServiceFactory</span> taskExecutorServiceFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rpcSystem <span class="token operator">=</span> <span class="token class-name">RpcSystem</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        timeout <span class="token operator">=</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">fromDuration</span><span class="token punctuation">(</span>configuration<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">AkkaOptions</span><span class="token punctuation">.</span><span class="token constant">ASK_TIMEOUT_DURATION</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Executor</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>executor <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>Executors</span><span class="token punctuation">.</span><span class="token function">newScheduledThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// HA Service</span>
        highAvailabilityServices <span class="token operator">=</span> <span class="token class-name">HighAvailabilityServicesUtils</span><span class="token punctuation">.</span><span class="token function">createHighAvailabilityServices</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// JMXService</span>
        <span class="token class-name">JMXService</span><span class="token punctuation">.</span><span class="token function">startInstance</span><span class="token punctuation">(</span>configuration<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token class-name">JMXServerOptions</span><span class="token punctuation">.</span><span class="token constant">JMX_SERVER_PORT</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// RCP Service</span>
        rpcService <span class="token operator">=</span> <span class="token function">createRpcService</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> highAvailabilityServices<span class="token punctuation">,</span> rpcSystem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>resourceId <span class="token operator">=</span> <span class="token function">getTaskManagerResourceID</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> rpcService<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rpcService<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 心跳服务</span>
        <span class="token class-name">HeartbeatServices</span> heartbeatServices <span class="token operator">=</span> <span class="token class-name">HeartbeatServices</span><span class="token punctuation">.</span><span class="token function">fromConfiguration</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// metric服务</span>
        metricRegistry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MetricRegistryImpl</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RpcService</span> metricQueryServiceRpcService <span class="token operator">=</span> <span class="token class-name">MetricUtils</span><span class="token punctuation">.</span><span class="token function">startRemoteMetricsRpcService</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        metricRegistry<span class="token punctuation">.</span><span class="token function">startQueryService</span><span class="token punctuation">(</span>metricQueryServiceRpcService<span class="token punctuation">,</span> resourceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// bolb服务</span>
        blobCacheService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BlobCacheService</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ExternalResourceInfoProvider</span>
        <span class="token class-name">ExternalResourceInfoProvider</span> externalResourceInfoProvider <span class="token operator">=</span> <span class="token class-name">ExternalResourceUtils</span><span class="token punctuation">.</span><span class="token function">createStaticExternalResourceInfoProviderFromConfig</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 启动TaskManager</span>
        <span class="token class-name">TaskExecutor</span> taskExecutor <span class="token operator">=</span> <span class="token function">startTaskManager</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>configuration<span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>resourceId<span class="token punctuation">,</span>
            rpcService<span class="token punctuation">,</span>
            highAvailabilityServices<span class="token punctuation">,</span>
            heartbeatServices<span class="token punctuation">,</span>
            metricRegistry<span class="token punctuation">,</span>
            blobCacheService<span class="token punctuation">,</span>
            <span class="token boolean">false</span><span class="token punctuation">,</span>         <span class="token comment">// localCommunicationOnly</span>
            externalResourceInfoProvider<span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// fatalErrorHandler</span>
        <span class="token comment">// 将TaskExecutor包装成TaskExecutorService</span>
        taskExecutorService <span class="token operator">=</span> <span class="token class-name">TaskExecutorToServiceAdapter</span><span class="token punctuation">.</span><span class="token function">createFor</span><span class="token punctuation">(</span>taskExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// TaskManagerServices是TaskExecutor相关服务的容器，如MemoryManager、IOManager、ShuffleEnvironment，所有服务都是一个TaskExecutor独占的</span>
<span class="token keyword">class</span> <span class="token class-name">TaskManagerServices</span>
<span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token class-name">TaskManagerServices</span> <span class="token function">fromConfiguration</span><span class="token punctuation">(</span>
        <span class="token class-name">TaskManagerServicesConfiguration</span> taskManagerServicesConfiguration<span class="token punctuation">,</span>
        <span class="token class-name">PermanentBlobService</span> permanentBlobService<span class="token punctuation">,</span>
        <span class="token class-name">MetricGroup</span> taskManagerMetricGroup<span class="token punctuation">,</span>
        <span class="token class-name">ExecutorService</span> ioExecutor<span class="token punctuation">,</span>
        <span class="token class-name">FatalErrorHandler</span> fatalErrorHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// TaskEventDispatcher</span>
        <span class="token class-name">TaskEventDispatcher</span> taskEventDispatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TaskEventDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// IOManager</span>
        <span class="token class-name">IOManager</span> ioManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IOManagerAsync</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ShuffleEnvironment，默认是NettyShuffleEnvironment</span>
        <span class="token class-name">ShuffleEnvironment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">></span></span> shuffleEnvironment <span class="token operator">=</span> <span class="token function">createShuffleEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> listeningDataPort <span class="token operator">=</span> shuffleEnvironment<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// KvStateService</span>
        <span class="token class-name">KvStateService</span> kvStateService <span class="token operator">=</span> <span class="token class-name">KvStateService</span><span class="token punctuation">.</span><span class="token function">fromConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        kvStateService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// TaskManagerLocation</span>
        <span class="token class-name">UnresolvedTaskManagerLocation</span> unresolvedTaskManagerLocation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UnresolvedTaskManagerLocation</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// BroadcastVariableManager</span>
        <span class="token class-name">BroadcastVariableManager</span> broadcastVariableManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastVariableManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// TaskSlotTable</span>
        <span class="token comment">// TaskManager上的Slot数目，默认是1</span>
        <span class="token keyword">int</span> numberOfSlots <span class="token operator">=</span> taskManagerServicesConfiguration<span class="token punctuation">.</span>numberOfSlots<span class="token punctuation">;</span>
        <span class="token comment">// 超时检测服务，在TaskSlotTable中用于监控Slot分配是否超时</span>
        <span class="token class-name">TimerService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AllocationID</span><span class="token punctuation">></span></span> timerService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TimerService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ScheduledThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> taskManagerServicesConfiguration<span class="token punctuation">.</span>timerServiceShutdownTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// TaskManager资源信息</span>
        <span class="token class-name">TaskExecutorResourceSpec</span> taskExecutorResourceSpec <span class="token operator">=</span> taskManagerServicesConfiguration<span class="token punctuation">.</span>taskExecutorResourceSpec<span class="token punctuation">;</span>
        <span class="token class-name">ResourceProfile</span> totalResourceProfile <span class="token operator">=</span>
            <span class="token class-name">ResourceProfile</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setCpuCores</span><span class="token punctuation">(</span>taskExecutorResourceSpec<span class="token punctuation">.</span>cpuCores<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setTaskHeapMemory</span><span class="token punctuation">(</span>taskExecutorResourceSpec<span class="token punctuation">.</span>taskHeapSize<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setTaskOffHeapMemory</span><span class="token punctuation">(</span>taskExecutorResourceSpec<span class="token punctuation">.</span>taskOffHeapSize<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setManagedMemory</span><span class="token punctuation">(</span>taskExecutorResourceSpec<span class="token punctuation">.</span>managedMemorySize<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setNetworkMemory</span><span class="token punctuation">(</span>taskExecutorResourceSpec<span class="token punctuation">.</span>networkMemSize<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setExtendedResources</span><span class="token punctuation">(</span>taskExecutorResourceSpec<span class="token punctuation">.</span>extendedResources<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// TaskManager上单个Slot的资源信息</span>
        <span class="token class-name">ResourceProfile<span class="token punctuation">.</span>Builder</span> defaultSlotResourceBuilder <span class="token operator">=</span>
            <span class="token class-name">ResourceProfile</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setCpuCores</span><span class="token punctuation">(</span>taskExecutorResourceSpec<span class="token punctuation">.</span>cpuCores<span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span>numberOfSlots<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setTaskHeapMemory</span><span class="token punctuation">(</span>taskExecutorResourceSpec<span class="token punctuation">.</span>taskHeapSize<span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span>numberOfSlots<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setTaskOffHeapMemory</span><span class="token punctuation">(</span>taskExecutorResourceSpec<span class="token punctuation">.</span>taskOffHeapSize<span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span>numberOfSlots<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setManagedMemory</span><span class="token punctuation">(</span>taskExecutorResourceSpec<span class="token punctuation">.</span>managedMemorySize<span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span>numberOfSlots<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setNetworkMemory</span><span class="token punctuation">(</span>taskExecutorResourceSpec<span class="token punctuation">.</span>networkMemSize<span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span>numberOfSlots<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        taskExecutorResourceSpec
            <span class="token punctuation">.</span><span class="token function">getExtendedResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> resource<span class="token punctuation">)</span> <span class="token operator">-></span>
                defaultSlotResourceBuilder<span class="token punctuation">.</span><span class="token function">setExtendedResource</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span>numberOfSlots<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ResourceProfile</span> defaultSlotResourceProfile <span class="token operator">=</span> defaultSlotResourceBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建TaskSlotTable</span>
        <span class="token class-name">TaskSlotTable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">></span></span> taskSlotTable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TaskSlotTableImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>
            numberOfSlots<span class="token punctuation">,</span>
            totalAvailableResourceProfile<span class="token punctuation">,</span>
            taskExecutorResourceSpec<span class="token punctuation">,</span>
            taskManagerServicesConfiguration<span class="token punctuation">.</span>pageSize<span class="token punctuation">,</span>      <span class="token comment">// memoryPageSize</span>
            timerService<span class="token punctuation">,</span>
            ioExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// memoryVerificationExecutor</span>

        <span class="token comment">// JobTable，维护jobId与JobManager连接之间的关系</span>
        <span class="token class-name">JobTable</span> jobTable <span class="token operator">=</span> <span class="token class-name">DefaultJobTable</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 监控注册的Job的JobManager Leader</span>
        <span class="token class-name">JobLeaderService</span> jobLeaderService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultJobLeaderService</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> stateRootDirectoryStrings <span class="token operator">=</span> taskManagerServicesConfiguration<span class="token punctuation">.</span><span class="token function">getLocalRecoveryStateRootDirectories</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">File</span><span class="token punctuation">[</span><span class="token punctuation">]</span> stateRootDirectoryFiles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">[</span>stateRootDirectoryStrings<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> stateRootDirectoryStrings<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            stateRootDirectoryFiles<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>stateRootDirectoryStrings<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">LOCAL_STATE_SUB_DIRECTORY_ROOT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// TaskExecutorLocalStateStoresManager，维护状态信息</span>
        <span class="token class-name">TaskExecutorLocalStateStoresManager</span> taskStateManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TaskExecutorLocalStateStoresManager</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// TaskExecutorStateChangelogStoragesManager</span>
        <span class="token class-name">TaskExecutorStateChangelogStoragesManager</span> changelogStoragesManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TaskExecutorStateChangelogStoragesManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// LibraryCacheManager</span>
        <span class="token class-name">LibraryCacheManager</span> libraryCacheManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BlobLibraryCacheManager</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将上面的服务封装到TaskManagerServices中</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TaskManagerServices</span><span class="token punctuation">(</span>
            unresolvedTaskManagerLocation<span class="token punctuation">,</span>
            taskManagerServicesConfiguration<span class="token punctuation">.</span><span class="token function">getManagedMemorySize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            ioManager<span class="token punctuation">,</span>
            shuffleEnvironment<span class="token punctuation">,</span>
            kvStateService<span class="token punctuation">,</span>
            broadcastVariableManager<span class="token punctuation">,</span>
            taskSlotTable<span class="token punctuation">,</span>
            jobTable<span class="token punctuation">,</span>
            jobLeaderService<span class="token punctuation">,</span>
            taskStateManager<span class="token punctuation">,</span>
            changelogStoragesManager<span class="token punctuation">,</span>
            taskEventDispatcher<span class="token punctuation">,</span>
            ioExecutor<span class="token punctuation">,</span>
            libraryCacheManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">TaskExecutor</span> <span class="token keyword">extends</span> <span class="token class-name">RpcEndpoint</span> <span class="token keyword">implements</span> <span class="token class-name">TaskExecutorGateway</span>
<span class="token punctuation">{</span>
    <span class="token comment">// TaskSlotTable主要功能有以下几点：</span>
    <span class="token comment">// + 维护TaskSlot与Task及Job的关系</span>
    <span class="token comment">// + 维护TaskSlot的状态</span>
    <span class="token comment">// + TaskSlot在进行allocate/free操作时通过TimeService做超时检测</span>
    <span class="token class-name">TaskSlotTable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">></span></span> taskSlotTable<span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// startTaskExecutorServices，启动TaskManager相关服务</span>
        <span class="token comment">// 向ResourceManager注册TaskManager</span>
        <span class="token comment">// 与ResourceManager建立连接并创建一个Listener，监控ResourceManager的Leader变化，如果有新的Leader被选举出来，将会调用notifyLeaderAddress()方法去触发与 ResourceManager的重连</span>
        resourceManagerLeaderRetriever<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResourceManagerLeaderListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动TaskSlotTable</span>
        taskSlotTable<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SlotActionsImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getMainThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动JobLeaderService</span>
        <span class="token comment">// 向JobManager注册TaskManager，与JobManager建立连接并创建一个JobLeaderListener，监控JobManager的Leader变化</span>
        jobLeaderService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getRpcService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> haServices<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">JobLeaderListenerImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fileCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileCache</span><span class="token punctuation">(</span>
            taskManagerConfiguration<span class="token punctuation">.</span><span class="token function">getTmpDirectories</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            blobCacheService<span class="token punctuation">.</span><span class="token function">getPermanentBlobService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 注册超时检测，如果超时还未注册完成，就抛出错误，启动失败</span>
        <span class="token function">startRegistrationTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">class</span> <span class="token class-name">ResourceManagerLeaderListener</span> <span class="token keyword">implements</span> <span class="token class-name">LeaderRetrievalListener</span> <span class="token punctuation">{</span>
        <span class="token comment">// ResourceManager重新选举Leader后会调用这个方法通知TaskManager</span>
        <span class="token keyword">void</span> <span class="token function">notifyLeaderAddress</span><span class="token punctuation">(</span><span class="token class-name">String</span> leaderAddress<span class="token punctuation">,</span> <span class="token class-name">UUID</span> leaderSessionID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
                <span class="token comment">// notifyOfNewResourceManagerLeader</span>
                <span class="token comment">// 创建一个新的ResourceManagerAddress</span>
                resourceManagerAddress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResourceManagerAddress</span><span class="token punctuation">(</span>leaderAddress<span class="token punctuation">,</span> <span class="token class-name">ResourceManagerId</span><span class="token punctuation">.</span><span class="token function">fromUuidOrNull</span><span class="token punctuation">(</span>leaderSessionID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 注册超时检测，如果超时还未注册完成，就抛出错误，连接失败</span>
                <span class="token function">startRegistrationTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// ConnectToResourceManager，与ResourceManager建立连接</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Connecting to ResourceManager {}."</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">TaskExecutorRegistration</span> taskExecutorRegistration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TaskExecutorRegistration</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                resourceManagerConnection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TaskExecutorToResourceManagerConnection</span><span class="token punctuation">(</span>
                    log<span class="token punctuation">,</span>
                    <span class="token function">getRpcService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    taskManagerConfiguration<span class="token punctuation">.</span><span class="token function">getRetryingRegistrationConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    resourceManagerAddress<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    resourceManagerAddress<span class="token punctuation">.</span><span class="token function">getResourceManagerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">getMainThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">ResourceManagerRegistrationListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    taskExecutorRegistration<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// TaskExecutorToResourceManagerConnection对象启动后会向ResourceManager注册TaskManager</span>
                <span class="token comment">// ResourceManager接收到请求后，先从缓存中移除旧的TaskManager注册信息，然后更新缓存，并增加心跳监控</span>
                resourceManagerConnection<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">class</span> <span class="token class-name">JobLeaderListenerImpl</span> <span class="token keyword">implements</span> <span class="token class-name">JobLeaderListener</span> <span class="token punctuation">{</span>
        <span class="token keyword">void</span> <span class="token function">jobManagerGainedLeadership</span><span class="token punctuation">(</span>
            <span class="token class-name">JobID</span> jobId<span class="token punctuation">,</span>
            <span class="token class-name">JobMasterGateway</span> jobManagerGateway<span class="token punctuation">,</span>
            <span class="token class-name">JMTMRegistrationSuccess</span> registrationMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">jobManagerLostLeadership</span><span class="token punctuation">(</span><span class="token class-name">JobID</span> jobId<span class="token punctuation">,</span> <span class="token class-name">JobMasterId</span> jobMasterId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">jobManagerRejectedRegistration</span><span class="token punctuation">(</span>
            <span class="token class-name">JobID</span> jobId<span class="token punctuation">,</span>
            <span class="token class-name">String</span> targetAddress<span class="token punctuation">,</span>
            <span class="token class-name">JMTMRegistrationRejection</span> rejection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<h4 id="mailbox线程模型" style="position:relative;"><a href="#mailbox%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B" aria-label="mailbox线程模型 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Mailbox线程模型</h4>
<div class='wrapper' markdown='block'>
<p><img src="https://www.plantuml.com/plantuml/svg/bLDDRwCm5BpxLxoz4Qs2jET6sLPj3YjrfQhD7t3CQx7m1xMVMwBi_lSLc80XPAMUWF7mPkmPtthYZe9MZ7sZ4ZM2hv14ULpRG4eQPAKi453NT0ID-e3ECrz9KtF7DTmvPp_tfHILGU_X1sD2SU_XDvVgO9idPmLwRnsS6030dlkgNm8TdpVTGWy-u2iFYku4IMlEZ0aOwI_aaEjsMaHt3Of0rW6VV4Qo2wOV_sXjdQrks5_6f25qhrpWnDDfC0F4Ayoa8QYTj4xISHMdrO6oZj2wMmqAkqQeuEK7gcFs78pX1uKjthr4oNWoYTmlNQjUyXdHaEE67gseG5bHnSaF-1vmq_Aty1umO8JtfKDU08sp8ZBRMhysd4xKmkuJippFU_y-7BIa13XAL4MMsfwDIgnVpJGzl4dAOolq3FXYkakRdLReTCvd0cVtrf2pIg43CRpEY_4IV8t6ZsC-h2p0eGyQBrgKJ8nahbGKy_TMrme9kmEDnzqEBgQMdj19M-obHjSJMkK4_T_FywJEqPJEVahpTYxavYTWGsWA3xj6ODt-knrQUYsrhrwstir5sElrDYtBCc4fnKjcdaVczPMagvUax-lrcJJcjaoR61aRmTBMR_xa-VnUi_dTwqWBjuWjzhQLJjIkSXBxIGDJhOIH5BfZNDiRkqLJ1At-0G00" alt="plantuml"></p>
</div>
<p>Flink 1.10之前通过全局锁checkpointLock控制线程间的并发，确保线程安全地状态，代码复杂，暴露锁对象，容易引发线程安全问题。checkpointLock主要用在三个地方：</p>
<ul>
<li>事件处理：包括Event、Watermark、Barriers、LatencyMarker的处理和发送</li>
<li>Checkpoint触发：Source中通过RPC调用触发Checkpoint，通知Checkpoint的完成情况</li>
<li>处理时间定时器: 通过ScheduledExecutor异步执行</li>
</ul>
<p>Flink 1.10引入了类似Actor的Mailbox线程模型^[FLINK-12477: <a href="https://issues.apache.org/jira/browse/FLINK-12477%5D%E3%80%82Mailbox%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B%E5%80%9F%E9%89%B4%E4%BA%86Actor%E6%A8%A1%E5%9E%8B%EF%BC%8C%E6%A0%B8%E5%BF%83%E6%80%9D%E6%83%B3%E6%98%AF%E9%80%9A%E8%BF%87%E5%8D%95%E4%B8%AAMailbox%E7%BA%BF%E7%A8%8B%E9%85%8D%E5%90%88%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97%E7%9A%84%E6%96%B9%E5%BC%8F%EF%BC%8C%E6%89%80%E6%9C%89%E9%9C%80%E8%A6%81%E5%A4%84%E7%90%86%E7%9A%84%E4%BA%8B%E4%BB%B6%E9%83%BD%E5%B0%81%E8%A3%85%E6%88%90%E4%B8%80%E4%B8%AAMail%E6%8A%95%E9%80%92%E5%88%B0Mailbox%E4%B8%AD%EF%BC%8C%E7%84%B6%E5%90%8E%E6%8C%89%E5%85%88%E5%90%8E%E9%A1%BA%E5%BA%8F%E7%94%B1%E5%8D%95%E7%BA%BF%E7%A8%8B%E5%BE%AA%E7%8E%AF%E5%A4%84%E7%90%86%E4%BA%8B%E4%BB%B6%EF%BC%8C%E5%B0%86%E5%86%85%E9%83%A8%E7%8A%B6%E6%80%81%E7%9A%84%E4%BF%AE%E6%94%B9%E4%BA%A4%E7%94%B1%E5%8D%95%E4%B8%AA%E7%BA%BF%E7%A8%8B%E5%AE%8C%E6%88%90%EF%BC%8C%E4%BB%8E%E8%80%8C%E9%81%BF%E5%85%8D%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%8C%E5%8F%A6%E5%A4%96%E8%BF%98%E6%96%B9%E4%BE%BF%E6%8E%A7%E5%88%B6%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E7%9A%84%E4%BC%98%E5%85%88%E7%BA%A7%E3%80%82%E5%AF%B9%E4%BA%8ECheckpoint%E8%A7%A6%E5%8F%91%E5%92%8C%E5%A4%84%E7%90%86%E6%97%B6%E9%97%B4%E5%AE%9A%E6%97%B6%E5%99%A8%EF%BC%8C%E5%8F%AA%E9%9C%80%E8%A6%81%E5%B0%86%E5%AF%B9%E5%BA%94%E7%9A%84%E6%93%8D%E4%BD%9C%E5%B0%81%E8%A3%85%E4%B8%BAMail%E6%8A%95%E9%80%92%E5%88%B0Mailbox%E4%B8%AD%EF%BC%8C%E7%AD%89%E5%BE%85Mailbox%E7%BA%BF%E7%A8%8B%E8%BF%9B%E8%A1%8C%E5%A4%84%E7%90%86%E5%8D%B3%E5%8F%AF%E3%80%82">https://issues.apache.org/jira/browse/FLINK-12477]。Mailbox线程模型借鉴了Actor模型，核心思想是通过单个Mailbox线程配合阻塞队列的方式，所有需要处理的事件都封装成一个Mail投递到Mailbox中，然后按先后顺序由单线程循环处理事件，将内部状态的修改交由单个线程完成，从而避免多线程的问题，另外还方便控制事件处理的优先级。对于Checkpoint触发和处理时间定时器，只需要将对应的操作封装为Mail投递到Mailbox中，等待Mailbox线程进行处理即可。</a></p>
<p>Mailbox线程模型核心抽象：</p>
<ul>
<li>
<p>Mail：封装了需要处理的消息和相应的动作</p>
</li>
<li>
<p>Mailbox：用于存储需要处理的消息，即 Mail，对应接口TaskMailbox及其实现TaskMailboxImpl。使用一个Deque存储写入的Mail，对Deque读写通过一个ReentrantLock来加以保护。Mailbox支持优先级控制，每一个Mail都有其优先级，从TaskMailbox获取Mail时可以指定优先级，实际通过遍历队列元素比较优先级实现。</p>
</li>
<li>
<p>MailboxProcessor：从Mailbox中取出信件并处理。核心是事件的循环处理，循环中，除了处理 Mailbox中的事件外，还执行默认行为MailboxDefaultAction</p>
  <details>
  <summary>具体实现</summary>
  ```Java
  class MailboxProcessor
  {
      // 存储要处理的消息，如Checkpoint触发、处理时间定时器等
      TaskMailbox mailbox;
      // Mailbox中没有要处理消息时的默认执行动作，一般为记录处理processInput()
      MailboxDefaultAction mailboxDefaultAction;
      // 暂停事件处理循环标记
      boolean suspended;
      // 循环处理事件
      void runMailboxLoop() {
          suspended = !mailboxLoopRunning;
          TaskMailbox localMailbox = mailbox;
          // 确保当前调用必须发生在Mailbox的事件处理线程中
          assert localMailbox.isMailboxThread();
          MailboxController defaultActionContext = new MailboxController(this);
          // 事件处理循环
          while (!suspended) {
              // 处理事件，这是一个阻塞方法
              processMail(localMailbox, false);
              //  再做一次检查，因为上面的mail处理可能会改变运行状态
              if (!suspended) {
                  // 执行默认行为
                  mailboxDefaultAction.runDefaultAction(defaultActionContext);
              }
          }
      }
      // 处理消息
      boolean processMail(TaskMailbox mailbox, boolean singleStep) {
          boolean isBatchAvailable = mailbox.createBatch();
          boolean processed = isBatchAvailable && processMailsNonBlocking(singleStep);
          if (singleStep) {
              return processed;
          }
          processed |= processMailsWhenDefaultActionUnavailable();
          return processed;
      }
      boolean processMailsNonBlocking(boolean singleStep) {
          long processedMails = 0;
          Optional<Mail> maybeMail;
          while (!suspended && (maybeMail = Optional.ofNullable(mailbox.batch.pollFirst())).isPresent()) {
              if (processedMails++ == 0) {
                  maybePauseIdleTimer();
              }
              maybeMail.get().run();
              if (singleStep) {
                  break;
              }
          }
          if (processedMails > 0) {
              maybeRestartIdleTimer();
              return true;
          } else {
              return false;
          }
      }
      void maybePauseIdleTimer() {
          if (suspendedDefaultAction != null
              && suspendedDefaultAction.suspensionTimer != null) {
              suspendedDefaultAction.suspensionTimer.markEnd();
          }
      }
  }
  ```
  </details>
</li>
<li>
<p>MailboxExecutor：向Mailbox中投递信件，提交Mail的行为可以在任意线程中进行。不考虑优先级时，所有事件按FIFO顺序处理，对于一个事件处理需要依赖后续事件处理的情景，MailboxExecutor的yield()方法会暂时让出对当前事件的处理，从队列中取出下一个事件进行处理，这个方法必须在Mailbox事件处理线程中调用</p>
</li>
<li>
<p>MailboxDefaultAction：MailboxProcessor的默认动作，主要负责处理基础的StreamEvent、Barrier、Watermark等。在Mailbox主线程的循环中，处理完新的Mail后就会执行该动作。MailboxDefaultAction通过一个MailboxController和Mailbox进行交互，可以借此获悉所有的事件都处理完毕，或者临时暂停MailboxDefaultAction</p>
</li>
</ul>
<p>MailboxDefaultAction和Mail的区别在于，Mail用于控制类消息处理，例如Checkpoint触发，而MailboxDefaultAction用于数据流上的普通消息处理（如正常的数据记录，Barrier）等。数据流上的消息数据量比较大，通过邮箱内部队列进行处理开销比较大。</p>
<h3 id="operatorchain" style="position:relative;"><a href="#operatorchain" aria-label="operatorchain permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>OperatorChain</h3>
<p>Transformation转换为JobGraph时进行了算子链优化，即 将多个算子链接在一起，在执行层面上对应的是OperatorChain。无论是单个算子还是链接在一起的多个算子，都会被构造成OperatorChain。单个算子的OperatorChain输出计算结果时包含了两层Output，CountingOutput用来统计算子的输出数据元素个数，RecordWriterOutput用来序列化数据，写入NetworkBuffer，交给下游算子，同时计算 向下游发送的字节总数 和 向下游发送的Buffer总数两个监控指标。两个或两个以上算子构成的OperatorChain，算子之间包含了两层Output，CountingOutput用来统计上游算子输出的元素个数，ChainingOutput用来统计Watermark和校友算子的输入数据元素个数。</p>
<h3 id="task" style="position:relative;"><a href="#task" aria-label="task permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Task</h3>
<div class='wrapper' markdown='block'>
<p><img src="https://www.plantuml.com/plantuml/svg/dLJBRjim4BppAzXR2pG6qckC88vRj0PgoAWLvBoYDXOXFeJbAedHvDyBMPBrT0uzpknmkEGEUHSOY4jhXFZ46LgK8KTMsV7AbsoqGv7f52NQWe_IeasGWWYvTWKGMBaYyYznfbNkC0HvBOHsZFG42cKC8T-uPvz3Ob3-5L9AgIkCdx_Sd11XO4zdg0o2UoZE49n2Kw7tlkqwGvKNNZkkVAjD6cycVJWWTVLLE3hLkasgaRi78etKAfnd_NJi16jl2uEC0vknQ9Lu6cu45NDXctSX80bCe5Wg0o78FHE2xPsY9ZQkA7b7Nc48dgGUm7gVFwWyfO-a6Uax6Zm0utAnMDnAwbLgRRIJ5hIB2YJWrg15wmoqMqOFyLSPxMwbxzErCjOMQO_qh1LAxe6PSZW6HXjFH5lG9l6ltPdiY1Z8VhoYAhbMkH5tqzmJCDw3oj6bClH0NUu6i6TFS42fnapZKoOC8U-FtLEgNNK5CdnGh9SNTVkdUPrZNROjxncBAVlR-w99GnC2NvB2BWej7pay6Kz2qZNKXEiNkDGWzGuvBDGjF08ZMQ3y9vG7h5CrvEOYkcfW_EBdkvcplHxxNX9-cnDkjHjfhNQRkNPF7mKXC0wVpE1-BtR-7_TuDjsMXdLXnXCIOlZlBTyMYzuh5pFVrrZIQtFvTdKrZSTOCCt9H79vY1FffODza8FJkXbhSOSkBQtv1m00" alt="plantuml"></p>
<p>一个Flink Job提交到集群中运行时，会被调度为不同的Task。Task是TaskManager部署和执行的本地计算单元，提供任务执行基础组件：</p>
<ul>
<li>MemoryManager：负责申请和释放内存</li>
<li>IOManager</li>
<li>TaskStateManager：与JobMaster交互，汇报状态</li>
<li>ResultPartitionWriter</li>
</ul>
<p>TaskInvokable是Task执行的主要逻辑，也是所有被执行任务的基类，包括Streaming模式和Batch模式。在Streaming模式下，所有任务都继承自StreamTask，包括SourceStreamTask、OneInputStreamTask、TwoInputStreamTask以及迭代模式下的StreamIterationHead和 StreamIterationTail。</p>
<p>StreamTask是OperatorChain的执行容器，其输入流是头算子的输入流，输出流是算子链末尾算子的输出流（算子链可能存在多个末尾算子）。</p>
<p>每一个StreamNode在添加到StreamGraph时都会有一个关联的jobVertexClass属性，描述该StreamNode对应的StreamTask类型，OperatorChain对应的StreamTask就是其head operator对应的StreamTask。</p>
<p>StreamTask完整的生命周期包括：</p>
<ul>
<li>创建状态存储后端，为OperatorChain中的所有算子提供状态</li>
<li>加载OperatorChain中的所有算子</li>
<li>所有Operator调用setup()</li>
<li>Task相关的初始化操作</li>
<li>所有Operator调用initializeState()初始化状态</li>
<li>所有的Operator调用open()</li>
<li>run()方法循环处理数据：Task通过循环调用InputGate的getNextBufferOrEvent()方法获取输入数据，并将获取的数据交给它所封装的算子进行处理，这构成了一个Task的基本运行逻辑</li>
<li>所有Operator调用close()</li>
<li>所有Operator调用dispose()</li>
<li>通用的cleanup()操作</li>
<li>Task相关的cleanup()操作</li>
</ul>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">StreamTask</span><span class="token generics"><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">,</span> OP <span class="token keyword">extends</span> <span class="token class-name">StreamOperator</span><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">></span><span class="token punctuation">></span></span>
    <span class="token keyword">extends</span> <span class="token class-name">CheckpointableTask</span><span class="token punctuation">,</span> <span class="token class-name">CoordinatedTask</span>
<span class="token punctuation">{</span>
    <span class="token class-name">StreamInputProcessor</span> inputProcessor<span class="token punctuation">;</span>
    <span class="token class-name">RecordWriterDelegate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SerializationDelegate</span><span class="token punctuation">&lt;</span><span class="token class-name">StreamRecord</span><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">></span><span class="token punctuation">></span><span class="token punctuation">></span></span> recordWriter<span class="token punctuation">;</span>
    <span class="token class-name">OP</span> mainOperator<span class="token punctuation">;</span>
    <span class="token class-name">OperatorChain</span><span class="token generics"><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">,</span> OP<span class="token punctuation">></span></span> operatorChain<span class="token punctuation">;</span>
    <span class="token class-name">TimerService</span> timerService<span class="token punctuation">;</span>
    <span class="token class-name">MailboxProcessor</span> mailboxProcessor<span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Initializing {}."</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//创建OperatorChain，会加载每一个Operator，并调用setup()方法</span>
        operatorChain <span class="token operator">=</span> <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTaskStateManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isFinishedOnRestore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">FinishedOperatorChain</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> recordWriter<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">RegularOperatorChain</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> recordWriter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mainOperator <span class="token operator">=</span> operatorChain<span class="token punctuation">.</span><span class="token function">getMainOperator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">getTaskStateManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">getRestoreCheckpointId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>restoreId <span class="token operator">-></span> latestReportCheckpointId <span class="token operator">=</span> restoreId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 具体StreamTask子类相关的初始化操作</span>
        <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Invoking {}"</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        isRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">// 开始处理数据</span>
        mailboxProcessor<span class="token punctuation">.</span><span class="token function">runMailboxLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// afterInvoke</span>
        <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Finished task {}"</span><span class="token punctuation">,</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        timerService<span class="token punctuation">.</span><span class="token function">quiesce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        systemTimerService<span class="token punctuation">.</span><span class="token function">quiesce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mailboxProcessor<span class="token punctuation">.</span><span class="token function">prepareClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        mailboxProcessor<span class="token punctuation">.</span><span class="token function">drain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        isRunning <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        operatorChain<span class="token punctuation">.</span><span class="token function">flushOutputs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        subtaskCheckpointCoordinator<span class="token punctuation">.</span><span class="token function">waitForPendingCheckpoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">closeAllOperators</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">processInput</span><span class="token punctuation">(</span><span class="token class-name">MailboxDefaultAction<span class="token punctuation">.</span>Controller</span> controller<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DataInputStatus</span> status <span class="token operator">=</span> inputProcessor<span class="token punctuation">.</span><span class="token function">processInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token constant">MORE_AVAILABLE</span><span class="token operator">:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>recordWriter<span class="token punctuation">.</span><span class="token function">isAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">NOTHING_AVAILABLE</span><span class="token operator">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">END_OF_RECOVERY</span><span class="token operator">:</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"We should not receive this event here."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">END_OF_DATA</span><span class="token operator">:</span>
                <span class="token function">endData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">END_OF_INPUT</span><span class="token operator">:</span>
                controller<span class="token punctuation">.</span><span class="token function">suspendDefaultAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mailboxProcessor<span class="token punctuation">.</span><span class="token function">suspend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">PeriodTimer</span> timer<span class="token punctuation">;</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> resumeFuture<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>recordWriter<span class="token punctuation">.</span><span class="token function">isAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            timer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GaugePeriodTimer</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            resumeFuture <span class="token operator">=</span> recordWriter<span class="token punctuation">.</span><span class="token function">getAvailableFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            timer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThroughputPeriodTimer</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            resumeFuture <span class="token operator">=</span> inputProcessor<span class="token punctuation">.</span><span class="token function">getAvailableFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        resumeFuture<span class="token punctuation">.</span><span class="token function">thenRun</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResumeWrapper</span><span class="token punctuation">(</span>controller<span class="token punctuation">.</span><span class="token function">suspendDefaultAction</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">,</span> timer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<p>SourceStreamTask负责为下游任务生成数据，没有输入，只负责对外输出记录。</p>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">SourceStreamTask</span><span class="token generics"><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">,</span> SRC <span class="token keyword">extends</span> <span class="token class-name">SourceFunction</span><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">></span><span class="token punctuation">,</span> OP <span class="token keyword">extends</span> <span class="token class-name">StreamSource</span><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">,</span> SRC<span class="token punctuation">></span><span class="token punctuation">></span></span>
    <span class="token keyword">extends</span> <span class="token class-name">StreamTask</span><span class="token generics"><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">,</span> OP<span class="token punctuation">></span></span>
<span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SourceFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> source <span class="token operator">=</span> mainOperator<span class="token punctuation">.</span><span class="token function">userFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>source <span class="token keyword">instanceof</span> <span class="token class-name">ExternallyInducedSource</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果SourceFunction是ExternallyInducedSource，则需要创建一个CheckpointTrigger对象提供给ExternallyInducedSource</span>
            externallyInducedCheckpoints <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token class-name">ExternallyInducedSource<span class="token punctuation">.</span>CheckpointTrigger</span> triggerHook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExternallyInducedSource<span class="token punctuation">.</span>CheckpointTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">void</span> <span class="token function">triggerCheckpoint</span><span class="token punctuation">(</span><span class="token keyword">long</span> checkpointId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">CheckpointOptions</span> checkpointOptions <span class="token operator">=</span> <span class="token class-name">CheckpointOptions</span><span class="token punctuation">.</span><span class="token function">forConfig</span><span class="token punctuation">(</span>
                        <span class="token class-name">CheckpointType</span><span class="token punctuation">.</span><span class="token constant">CHECKPOINT</span><span class="token punctuation">,</span>
                        <span class="token class-name">CheckpointStorageLocationReference</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        configuration<span class="token punctuation">.</span><span class="token function">isExactlyOnceCheckpointMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        configuration<span class="token punctuation">.</span><span class="token function">isUnalignedCheckpointsEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        configuration<span class="token punctuation">.</span><span class="token function">getAlignedCheckpointTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">long</span> timestamp <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">CheckpointMetaData</span> checkpointMetaData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CheckpointMetaData</span><span class="token punctuation">(</span>checkpointId<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">SourceStreamTask</span><span class="token punctuation">.</span><span class="token keyword">super</span>
                        <span class="token punctuation">.</span><span class="token function">triggerCheckpointAsync</span><span class="token punctuation">(</span>checkpointMetaData<span class="token punctuation">,</span> checkpointOptions<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ExternallyInducedSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> source<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCheckpointTrigger</span><span class="token punctuation">(</span>triggerHook<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">getMetricGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">getIOMetricGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">gauge</span><span class="token punctuation">(</span><span class="token class-name">MetricNames</span><span class="token punctuation">.</span><span class="token constant">CHECKPOINT_START_DELAY_TIME</span><span class="token punctuation">,</span>
                   <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">getAsyncCheckpointStartDelayNanos</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">void</span> <span class="token function">processInput</span><span class="token punctuation">(</span><span class="token class-name">MailboxDefaultAction<span class="token punctuation">.</span>Controller</span> controller<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 对source而言，就是调用main operator的run()方法</span>
        <span class="token comment">// mainOperator就是一个StreamSource，最终会调用SourceFunction的run()方法，一般是一个循环</span>
        <span class="token comment">// mainOperator通过Output将数据传递给下游的算子</span>
        controller<span class="token punctuation">.</span><span class="token function">suspendDefaultAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mainOperator<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span> operatorChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mailboxProcessor<span class="token punctuation">.</span><span class="token function">suspend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<p>OneInputStreamTask主要执行逻辑是不断循环调用StreamInputProcessor的processInpt()方法，StreamInputProcessor从缓冲区中读取记录或Watermark等消息，然后调用streamOperator的processElement()交给head operator进行处理，并依次将处理结果交给下游算子。TwoInputStreamTask对两个上游的输入分别调用TwoInputStreamOperator的processElement1()和TwoInputStreamOperator的processElement2()进行处理。</p>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">OneInputStreamTask</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">,</span> OUT<span class="token punctuation">></span></span>
    <span class="token keyword">extends</span> <span class="token class-name">StreamTask</span><span class="token generics"><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">,</span> <span class="token class-name">OneInputStreamOperator</span><span class="token punctuation">&lt;</span>IN<span class="token punctuation">,</span> OUT<span class="token punctuation">></span><span class="token punctuation">></span></span>
<span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建一个StreamInputProcessor</span>
        <span class="token class-name">StreamConfig</span> configuration <span class="token operator">=</span> <span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> numberOfInputs <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getNumberOfNetworkInputs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>numberOfInputs <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// createCheckpointedInputGate</span>
            <span class="token class-name">IndexedInputGate</span><span class="token punctuation">[</span><span class="token punctuation">]</span> inputGates <span class="token operator">=</span> <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAllInputGates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            checkpointBarrierHandler <span class="token operator">=</span> <span class="token class-name">InputProcessorUtil</span><span class="token punctuation">.</span><span class="token function">createCheckpointBarrierHandler</span><span class="token punctuation">(</span>
                <span class="token keyword">this</span><span class="token punctuation">,</span>
                configuration<span class="token punctuation">,</span>
                <span class="token function">getCheckpointCoordinator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">getTaskNameWithSubtaskAndId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>inputGates<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                mainMailboxExecutor<span class="token punctuation">,</span>
                systemTimerService<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">CheckpointedInputGate</span><span class="token punctuation">[</span><span class="token punctuation">]</span> checkpointedInputGates <span class="token operator">=</span>
                <span class="token class-name">InputProcessorUtil</span><span class="token punctuation">.</span><span class="token function">createCheckpointedMultipleInputGate</span><span class="token punctuation">(</span>
                    mainMailboxExecutor<span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>inputGates<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMetricGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIOMetricGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    checkpointBarrierHandler<span class="token punctuation">,</span>
                    configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">CheckpointedInputGate</span> inputGate <span class="token operator">=</span> <span class="token class-name">Iterables</span><span class="token punctuation">.</span><span class="token function">getOnlyElement</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>checkpointedInputGates<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Counter</span> numRecordsIn <span class="token operator">=</span> mainOperator
                <span class="token punctuation">.</span><span class="token function">getMetricGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">getIOMetricGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">getNumRecordsInCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DataOutput</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">></span></span> output <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StreamTaskNetworkOutput</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>
                operatorChain<span class="token punctuation">.</span><span class="token function">getFinishedOnRestoreInputOrDefault</span><span class="token punctuation">(</span>mainOperator<span class="token punctuation">)</span><span class="token punctuation">,</span>
                inputWatermarkGauge<span class="token punctuation">,</span>
                numRecordsIn<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// createTaskInput</span>
            <span class="token keyword">int</span> numberOfInputChannels <span class="token operator">=</span> inputGate<span class="token punctuation">.</span><span class="token function">getNumberOfInputChannels</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">StatusWatermarkValve</span> statusWatermarkValve <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StatusWatermarkValve</span><span class="token punctuation">(</span>numberOfInputChannels<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TypeSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">></span></span> inSerializer <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getTypeSerializerIn1</span><span class="token punctuation">(</span><span class="token function">getUserCodeClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">StreamTaskInput</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">></span></span> input <span class="token operator">=</span> <span class="token class-name">StreamTaskNetworkInputFactory</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>
                inputGate<span class="token punctuation">,</span>
                inSerializer<span class="token punctuation">,</span>
                <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIOManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                statusWatermarkValve<span class="token punctuation">,</span>
                <span class="token number">0</span><span class="token punctuation">,</span>
                <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTaskStateManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputRescalingDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                gateIndex <span class="token operator">-></span> configuration<span class="token punctuation">.</span><span class="token function">getInPhysicalEdges</span><span class="token punctuation">(</span><span class="token function">getUserCodeClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>gateIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPartitioner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTaskInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">StreamConfig<span class="token punctuation">.</span>InputConfig</span><span class="token punctuation">[</span><span class="token punctuation">]</span> inputConfigs <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getInputs</span><span class="token punctuation">(</span><span class="token function">getUserCodeClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">StreamConfig<span class="token punctuation">.</span>InputConfig</span> inputConfig <span class="token operator">=</span> inputConfigs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">requiresSorting</span><span class="token punctuation">(</span>inputConfig<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                input <span class="token operator">=</span> <span class="token function">wrapWithSorted</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">getMetricGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">getIOMetricGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">reuseRecordsInputCounter</span><span class="token punctuation">(</span>numRecordsIn<span class="token punctuation">)</span><span class="token punctuation">;</span>
            inputProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StreamOneInputProcessor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> output<span class="token punctuation">,</span> operatorChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mainOperator
            <span class="token punctuation">.</span><span class="token function">getMetricGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">gauge</span><span class="token punctuation">(</span><span class="token class-name">MetricNames</span><span class="token punctuation">.</span><span class="token constant">IO_CURRENT_INPUT_WATERMARK</span><span class="token punctuation">,</span> inputWatermarkGauge<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">getMetricGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">gauge</span><span class="token punctuation">(</span><span class="token class-name">MetricNames</span><span class="token punctuation">.</span><span class="token constant">IO_CURRENT_INPUT_WATERMARK</span><span class="token punctuation">,</span> inputWatermarkGauge<span class="token operator">::</span><span class="token function">getValue</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<h4 id="网络栈" style="position:relative;"><a href="#%E7%BD%91%E7%BB%9C%E6%A0%88" aria-label="网络栈 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>网络栈</h4>
<p>NetworkEnvironment通过ConnectionManager来管理所有的网络的连接，NetworkEnvironment在启动时会创建并启动NettyClient和NettyServer，NettyServer会启动一个服务端监听，等待其它NettyClient的连接。NettyProtocal中提供了NettyClient和NettyServer引导启动注册的一系列ChannelHandler。</p>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">NettyConnectionManager</span> <span class="token keyword">implements</span> <span class="token class-name">ConnectionManager</span> <span class="token punctuation">{</span>
    <span class="token class-name">NettyServer</span> server<span class="token punctuation">;</span>
    <span class="token class-name">NettyClient</span> client<span class="token punctuation">;</span>
    <span class="token class-name">NettyBufferPool</span> bufferPool<span class="token punctuation">;</span>
    <span class="token class-name">NettyProtocol</span> nettyProtocol<span class="token punctuation">;</span>
    <span class="token class-name">PartitionRequestClientFactory</span> partitionRequestClientFactory<span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 初始化Netty Client</span>
        client<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>nettyProtocol<span class="token punctuation">,</span> bufferPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 初始化并启动Netty Server</span>
        <span class="token keyword">return</span> server<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>nettyProtocol<span class="token punctuation">,</span> bufferPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">NettyProtocol</span> <span class="token punctuation">{</span>
    <span class="token comment">// Netty Server端的ChannelHandler</span>
    <span class="token class-name">ChannelHandler</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getServerChannelHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// </span>
        <span class="token class-name">PartitionRequestQueue</span> queueOfPartitionQueues <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PartitionRequestQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PartitionRequestServerHandler</span> serverHandler <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">PartitionRequestServerHandler</span><span class="token punctuation">(</span>partitionProvider<span class="token punctuation">,</span> taskEventPublisher<span class="token punctuation">,</span> queueOfPartitionQueues<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ChannelHandler</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
            messageEncoder<span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">NettyMessage<span class="token punctuation">.</span>NettyMessageDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            serverHandler<span class="token punctuation">,</span>
            queueOfPartitionQueues
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Netty Client端的ChannelHandler</span>
    <span class="token class-name">ChannelHandler</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getClientChannelHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">NetworkClientHandler</span> networkClientHandler <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">CreditBasedPartitionRequestClientHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ChannelHandler</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
            messageEncoder<span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">NettyMessageClientDecoderDelegate</span><span class="token punctuation">(</span>networkClientHandler<span class="token punctuation">)</span><span class="token punctuation">,</span>
            networkClientHandler
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<h3 id="集群启动流程" style="position:relative;"><a href="#%E9%9B%86%E7%BE%A4%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B" aria-label="集群启动流程 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>集群启动流程</h3>
<div class='wrapper' markdown='block'>
<p><img src="https://www.plantuml.com/plantuml/svg/bLLDJzmm4BtdLxYtLYf8FNU5s2uBb0Ag5bIatXndIDnDx6WysMrK-j-hnFbqua1liVFUytoyiSyDSQGYIuFW7IMG0JDx896K9xgWL2e84Xa1WoodacMGXO0cC7kfSeuyOsj4VNnCfDWhC8Pz2WAf2F2P2s2tm2F07H1AEF3q0V0W1R0_0MECrSU-__2vMUYy-lwxGB-LXa01DdobIJwN5hEE8WHZ9WfNdE38oqQYeyP0bmKL2EtnCT2zFZPqaN9ZneTtJBjhoImTB3eTYsZK-ZZluJWNAWyD8HV4XeTweXO8dA3vQVcMjSk5XxBBHLjqx3vjM9kAkdeyOx6bFfOvr27vghvwEJrrgnAuLLgzd9nuiWWcCGuK9s1F9MhzcNodjjcc84XgzGRJrSNLwbbYPhacaTsFX9lnven5DreHgAZt5t95Koc4Wzx3WjgrZ9FrWSkKXpALL3QnczwsEp2wG05tNF4Oq2d_mCwpGASc0_Y5D3adaIn9kXY_seqENmtGnVZLdY2yqqgINb1pCNwrJG9YdskfQ0T27m3BIov8OpcExGfvdZoG7jqHkq8fgU8R7PeTnD9GpxB3-INLOKSQjvRtVQ_iWZeTciMjxTGsIuXQeYwe8R_20g0McBNCL6OHDhtIritocZjktlu6KP169dNxsTnCrIZ61VAgWNOmsvK5T5LkPpjqDYnifbiCftl3_YsQPmXntxGnvbMFMTYipUol1QTrRyntJicbHgSVFbZl7n-YdyY5ewXAs2BylRxNQjBk7rf6NUFOORZwptPrJ_Gs2o6A8F9R2qR6Ql4sf-vXdFFpo4ZplCWPo17bcflaZkUh6nr-lVWuht36VZbtO9l6qh4YBQePhbgnLL5jCkVyhZu_jVu6a0Fs1VANxabIChcYWi3x9DMFztIutqWOEIIOkIFgXtukWNcFrV1fKi6CHJnGJ_xdeA8YI_y1" alt="plantuml"></p>
</div>
<p>Flink内部组件（如ResourceManager、JobMaster）都可以配置HA模式，集群启动时会大量涉及到Leader选举、Leader地址获取等相关的操作。</p>
<p>Leader地址获取通过LeaderRetriverService和LeaderRetrievalListener两个接口来完成。LeaderRetriverService由服务实现，启动Leader选举，并注册监听器监听Leader选举完成事件。LeaderRetrievalLister由监听Leader变动的类实现。</p>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">interface</span> <span class="token class-name">LeaderRetrievalService</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 启动Leader选举，并注册监听器监听Leader选举完成事件</span>
    <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token class-name">LeaderRetrievalListener</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">interface</span> <span class="token class-name">LeaderRetrievalListener</span>
<span class="token punctuation">{</span>
    <span class="token comment">// Leader选举完成后由LeaderRetriverService调用</span>
    <span class="token keyword">void</span> <span class="token function">notifyLeaderAddress</span><span class="token punctuation">(</span><span class="token class-name">String</span> leaderAddress<span class="token punctuation">,</span> <span class="token class-name">UUID</span> leaderSessionID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">handleError</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<p>抽象类LeaderGatewayRetriever继承了LeaderRetriever（实现了LeaderRetrievalListener）并实现了GatewayRetriever（用于获取RpcGateway），可以在Leader选举完成后得到Leader地址，进而获取到Leader的RpcGateway。RpcGatewayRetriever 是LeaderGatewayRetriver的具体实现，根据Leader的地址通过RpcService的connect()方法获得对应Leader的RpcGateway。</p>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">RpcGatewayRetriever</span> <span class="token keyword">extends</span> <span class="token class-name">LeaderGatewayRetriever</span>
<span class="token punctuation">{</span>
    <span class="token class-name">RpcService</span> rpcService<span class="token punctuation">;</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> gatewayType<span class="token punctuation">;</span>
    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">createGateway</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> UUID<span class="token punctuation">></span><span class="token punctuation">></span></span> leaderFuture<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">FutureUtils</span><span class="token punctuation">.</span><span class="token function">retryWithDelay</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span>
            leaderFuture<span class="token punctuation">.</span><span class="token function">thenCompose</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> UUID<span class="token punctuation">></span></span> addressLeaderTuple<span class="token punctuation">)</span> <span class="token operator">-></span>
                rpcService<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>
                    addressLeaderTuple<span class="token punctuation">.</span>f0<span class="token punctuation">,</span>
                    fencingTokenMapper<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>addressLeaderTuple<span class="token punctuation">.</span>f1<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    gatewayType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            retryStrategy<span class="token punctuation">,</span>
            rpcService<span class="token punctuation">.</span><span class="token function">getScheduledExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<p>Leader选举是通过LeaderElectionService（选举服务）和LeaderContender（参与竞选的对象）共同完成的，每一次选举成功后都会有唯一的leaderSessionID来作为RpcGateway通信的fence token。当一个LeaderContender竞选成功时，会通过其grantLeadership()方法得到通知。LeaderElectionService有StandaloneLeaderElectionService（无需选举过程）、EmbeddedLeaderElectionService等多种实现。</p>
<p>EmbeddedHaServices不具备高可用的特性，适用于ResourceMangaer、TaksManager、JobManager等所有组件都运行在同一个进程的情况。EmbeddedHaServices为各组件创建的选举服务为EmbeddedLeaderElectionService，一旦有参与选举的LeaderContender加入，该竞选对象就被选择为Leader。</p>
<p>HighAvailabilityServices接口提供了获取HA相关所有服务的方法，包括：</p>
<ul>
<li>ResourceManager选举服务及Leader获取</li>
<li>Dispatcher选举服务及Leader获取</li>
<li>任务状态的注册表（RunningJobsRegistry）</li>
<li>CheckpointRecovery、BlobStore、JobGraphStore等相关的服务</li>
</ul>
<h3 id="minicluster启动流程" style="position:relative;"><a href="#minicluster%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B" aria-label="minicluster启动流程 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>MiniCluster启动流程</h3>
<p>MiniCluster是一个内嵌的Flink运行时环境，所有组件都在独立的本地线程中运行。MiniCluster的启动入口在LocalStreamEnvironment中，启动流程大致分为三个阶段：</p>
<ul>
<li>创建RpcService、HighAvailabilityServices、BlobServer等辅助服务</li>
<li>创建并启动TaskManager，TaskManagerRunner的startTaskManager()方法会创建一个TaskExecutor。TaskExecutor通过HighAvailabilityServices获得ResourceManager等组件的服务地址并与它们进行通信，其启动的回调函数中会启动一系列服务。当ResourceManagerLeaderListener的监听被回调时，TaskExecutor会试图建立和ResourceManager的连接，连接被封装为TaskExecutorToResourceManagerConnection，一旦获取ResourceManager Leader后，就可以获取到ResourceManager对应的RpcGateway，接下来就可以通过RPC调用ResourceManager的registerTaskExecutor()方法进行注册流程，注册成功后，TaskExecutor向ResourceManager报告其资源（slots）情况。</li>
<li>启动Dispatcher、ResourceManager等。MiniCluster模式下，会创建一个SessionDispatcherResourceManagerComponent对象（继承自 DispatcherResourceManagerComponent），用来启动Dispatcher、ResourceManager和 WebMonitorEndpoint，这些组件都在同一个进程中运行（MiniCluster模式下启动的是StandaloneDispatcher和StandaloneResourceManager）。工厂类创建DispatcherResourceManagerComponent时会启动Dispatcher、ResourceManager等组件。在ResourceManager的启动回调函数中，会通过HighAvailabilityServices获取到选举服务，从而参与到选举之中，并启动JobLeaderIdService，管理向当前ResourceManager注册的作业的leader id。在Dispatcher的启动回调函数中，当前Dispatcher也会通过LeaderElectionService参与选举。</li>
</ul>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">MiniCluster</span>
<span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TaskExecutor</span><span class="token punctuation">></span></span> taskManagers<span class="token punctuation">;</span>
    <span class="token class-name">RpcService</span> commonRpcService<span class="token punctuation">;</span>
    <span class="token class-name">RpcSystem</span> rpcSystem<span class="token punctuation">;</span>
    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RpcService</span><span class="token punctuation">></span></span> rpcServices<span class="token punctuation">;</span>
    ighAvailabilityServices haServices<span class="token punctuation">;</span>
    <span class="token class-name">ExecutorService</span> ioExecutor<span class="token punctuation">;</span>
    <span class="token class-name">BlobServer</span> blobServer<span class="token punctuation">;</span>
    <span class="token class-name">HeartbeatServices</span> heartbeatServices<span class="token punctuation">;</span>
    <span class="token class-name">BlobCacheService</span> blobCacheService<span class="token punctuation">;</span>
    <span class="token class-name">LeaderRetrievalService</span> resourceManagerLeaderRetriever<span class="token punctuation">;</span>
    <span class="token class-name">RpcGatewayRetriever</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResourceManagerId</span><span class="token punctuation">,</span> <span class="token class-name">ResourceManagerGateway</span><span class="token punctuation">></span></span> resourceManagerGatewayRetriever<span class="token punctuation">;</span>
    <span class="token class-name">LeaderRetrievalService</span> dispatcherLeaderRetriever<span class="token punctuation">;</span>
    <span class="token class-name">RpcGatewayRetriever</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DispatcherId</span><span class="token punctuation">,</span> <span class="token class-name">DispatcherGateway</span><span class="token punctuation">></span></span> dispatcherGatewayRetriever<span class="token punctuation">;</span>
    <span class="token class-name">LeaderRetriever</span> webMonitorLeaderRetriever<span class="token punctuation">;</span>
    <span class="token class-name">RpcServiceFactory</span> taskManagerRpcServiceFactory<span class="token punctuation">;</span>
    <span class="token class-name">LeaderRetrievalService</span> clusterRestEndpointLeaderRetrievalService<span class="token punctuation">;</span>
    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DispatcherResourceManagerComponent</span><span class="token punctuation">></span></span> dispatcherResourceManagerComponents<span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Starting Flink Mini Cluster"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> miniClusterConfiguration<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> useSingleRpcService <span class="token operator">=</span> miniClusterConfiguration<span class="token punctuation">.</span><span class="token function">getRpcServiceSharing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">RpcServiceSharing</span><span class="token punctuation">.</span><span class="token constant">SHARED</span><span class="token punctuation">;</span>
        <span class="token function">initializeIOFormatClasses</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rpcSystem <span class="token operator">=</span> <span class="token class-name">RpcSystem</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Starting Metrics Registry"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        metricRegistry <span class="token operator">=</span> <span class="token function">createMetricRegistry</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Starting RPC Service(s)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RpcServiceFactory</span> dispatcherResourceManagerComponentRpcServiceFactory<span class="token punctuation">;</span>
        <span class="token class-name">RpcService</span> metricQueryServiceRpcService<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>useSingleRpcService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            commonRpcService <span class="token operator">=</span> <span class="token function">createLocalRpcService</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> rpcSystem<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">CommonRpcServiceFactory</span> commonRpcServiceFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommonRpcServiceFactory</span><span class="token punctuation">(</span>commonRpcService<span class="token punctuation">)</span><span class="token punctuation">;</span>
            taskManagerRpcServiceFactory <span class="token operator">=</span> commonRpcServiceFactory<span class="token punctuation">;</span>
            dispatcherResourceManagerComponentRpcServiceFactory <span class="token operator">=</span> commonRpcServiceFactory<span class="token punctuation">;</span>
            metricQueryServiceRpcService <span class="token operator">=</span> <span class="token class-name">MetricUtils</span><span class="token punctuation">.</span><span class="token function">startLocalMetricsRpcService</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> rpcSystem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> jobManagerExternalAddress <span class="token operator">=</span> miniClusterConfiguration<span class="token punctuation">.</span><span class="token function">getJobManagerExternalAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> taskManagerExternalAddress <span class="token operator">=</span> miniClusterConfiguration<span class="token punctuation">.</span><span class="token function">getTaskManagerExternalAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> jobManagerExternalPortRange <span class="token operator">=</span> miniClusterConfiguration<span class="token punctuation">.</span><span class="token function">getJobManagerExternalPortRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> taskManagerExternalPortRange <span class="token operator">=</span> miniClusterConfiguration<span class="token punctuation">.</span><span class="token function">getTaskManagerExternalPortRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> jobManagerBindAddress <span class="token operator">=</span> miniClusterConfiguration<span class="token punctuation">.</span><span class="token function">getJobManagerBindAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> taskManagerBindAddress <span class="token operator">=</span> miniClusterConfiguration<span class="token punctuation">.</span><span class="token function">getTaskManagerBindAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dispatcherResourceManagerComponentRpcServiceFactory <span class="token operator">=</span>
                <span class="token keyword">new</span> <span class="token class-name">DedicatedRpcServiceFactory</span><span class="token punctuation">(</span>
                    configuration<span class="token punctuation">,</span>
                    jobManagerExternalAddress<span class="token punctuation">,</span>
                    jobManagerExternalPortRange<span class="token punctuation">,</span>
                    jobManagerBindAddress<span class="token punctuation">,</span>
                    rpcSystem<span class="token punctuation">)</span><span class="token punctuation">;</span>
            taskManagerRpcServiceFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DedicatedRpcServiceFactory</span><span class="token punctuation">(</span>
                configuration<span class="token punctuation">,</span>
                taskManagerExternalAddress<span class="token punctuation">,</span>
                taskManagerExternalPortRange<span class="token punctuation">,</span>
                taskManagerBindAddress<span class="token punctuation">,</span>
                rpcSystem<span class="token punctuation">)</span><span class="token punctuation">;</span>
            commonRpcService <span class="token operator">=</span> <span class="token function">createRemoteRpcService</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            metricQueryServiceRpcService <span class="token operator">=</span> <span class="token class-name">MetricUtils</span><span class="token punctuation">.</span><span class="token function">startRemoteMetricsRpcService</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        metricRegistry<span class="token punctuation">.</span><span class="token function">startQueryService</span><span class="token punctuation">(</span>metricQueryServiceRpcService<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        processMetricGroup <span class="token operator">=</span> <span class="token class-name">MetricUtils</span><span class="token punctuation">.</span><span class="token function">instantiateProcessMetricGroup</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        ioExecutor <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span>
            <span class="token class-name">ClusterEntrypointUtils</span><span class="token punctuation">.</span><span class="token function">getPoolSize</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">ExecutorThreadFactory</span><span class="token punctuation">(</span><span class="token string">"mini-cluster-io"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建HighAvailabilityServices</span>
        haServices <span class="token operator">=</span> <span class="token function">createHighAvailabilityServices</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> ioExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        blobServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BlobServer</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> haServices<span class="token punctuation">.</span><span class="token function">createBlobStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        blobServer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        heartbeatServices <span class="token operator">=</span> <span class="token class-name">HeartbeatServices</span><span class="token punctuation">.</span><span class="token function">fromConfiguration</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        blobCacheService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BlobCacheService</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动TaskManager</span>
        <span class="token function">startTaskManagers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MetricQueryServiceRetriever</span> metricQueryServiceRetriever <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcMetricQueryServiceRetriever</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// setupDispatcherResourceManagerComponents，启动DispatcherResourceManagerComponent</span>
        dispatcherResourceManagerComponents<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>
            <span class="token function">createDispatcherResourceManagerComponentFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        resourceManagerLeaderRetriever <span class="token operator">=</span> haServices<span class="token punctuation">.</span><span class="token function">getResourceManagerLeaderRetriever</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dispatcherLeaderRetriever <span class="token operator">=</span> haServices<span class="token punctuation">.</span><span class="token function">getDispatcherLeaderRetriever</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        clusterRestEndpointLeaderRetrievalService <span class="token operator">=</span> haServices<span class="token punctuation">.</span><span class="token function">getClusterRestEndpointLeaderRetriever</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dispatcherGatewayRetriever <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcGatewayRetriever</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>
            commonRpcService<span class="token punctuation">,</span>
            <span class="token class-name">DispatcherGateway</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
            <span class="token class-name">DispatcherId</span><span class="token operator">::</span><span class="token function">fromUuid</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">ExponentialBackoffRetryStrategy</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resourceManagerGatewayRetriever <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcGatewayRetriever</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>
            commonRpcService<span class="token punctuation">,</span>
            <span class="token class-name">ResourceManagerGateway</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
            <span class="token class-name">ResourceManagerId</span><span class="token operator">::</span><span class="token function">fromUuid</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">ExponentialBackoffRetryStrategy</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        webMonitorLeaderRetriever <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LeaderRetriever</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resourceManagerLeaderRetriever<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>resourceManagerGatewayRetriever<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dispatcherLeaderRetriever<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>dispatcherGatewayRetriever<span class="token punctuation">)</span><span class="token punctuation">;</span>
        clusterRestEndpointLeaderRetrievalService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>webMonitorLeaderRetriever<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// create a new termination future</span>
        terminationFuture <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        running <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Flink Mini Cluster started successfully"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">HighAvailabilityServices</span> <span class="token function">createHighAvailabilityServices</span><span class="token punctuation">(</span>
        <span class="token class-name">Configuration</span> configuration<span class="token punctuation">,</span>
        <span class="token class-name">Executor</span> executor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Starting high-availability services"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HaServices</span> haServices <span class="token operator">=</span> miniClusterConfiguration<span class="token punctuation">.</span><span class="token function">getHaServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>haServices<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token constant">WITH_LEADERSHIP_CONTROL</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EmbeddedHaServicesWithLeadershipControl</span><span class="token punctuation">(</span>executor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">CONFIGURED</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token class-name">HighAvailabilityServicesUtils</span><span class="token punctuation">.</span><span class="token function">createAvailableOrEmbeddedServices</span><span class="token punctuation">(</span>
                        configuration<span class="token punctuation">,</span> executor<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ShutDownFatalErrorHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalConfigurationException</span><span class="token punctuation">(</span><span class="token string">"Unknown HA Services "</span> <span class="token operator">+</span> haServices<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">startTaskManagers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> numTaskManagers <span class="token operator">=</span> miniClusterConfiguration<span class="token punctuation">.</span><span class="token function">getNumTaskManagers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Starting {} TaskManger(s)"</span><span class="token punctuation">,</span> numTaskManagers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numTaskManagers<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// startTaskManager</span>
            <span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> miniClusterConfiguration<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">TaskExecutor</span> taskExecutor <span class="token operator">=</span> <span class="token class-name">TaskManagerRunner</span><span class="token punctuation">.</span><span class="token function">startTaskManager</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            taskExecutor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            taskManagers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>taskExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">TaskExecutor</span> <span class="token keyword">extends</span> <span class="token class-name">RpcEndpoint</span> <span class="token keyword">implements</span> <span class="token class-name">TaskExecutorGateway</span>
<span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/// 启动服务</span>
        <span class="token function">startTaskExecutorServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">startTaskExecutorServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        resourceManagerLeaderRetriever<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResourceManagerLeaderListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        taskSlotTable<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SlotActionsImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getMainThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jobLeaderService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getRpcService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> haServices<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">JobLeaderListenerImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fileCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileCache</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">notifyOfNewResourceManagerLeader</span><span class="token punctuation">(</span><span class="token class-name">String</span> newLeaderAddress<span class="token punctuation">,</span> <span class="token class-name">ResourceManagerId</span> newResourceManagerId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        resourceManagerAddress <span class="token operator">=</span> <span class="token function">createResourceManagerAddress</span><span class="token punctuation">(</span>newLeaderAddress<span class="token punctuation">,</span> newResourceManagerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// connectToResourceManager</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Connecting to ResourceManager {}."</span><span class="token punctuation">,</span> resourceManagerAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TaskExecutorRegistration</span> taskExecutorRegistration <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">TaskExecutorRegistration</span><span class="token punctuation">(</span>
                <span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">getResourceID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                unresolvedTaskManagerLocation<span class="token punctuation">.</span><span class="token function">getDataPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">JMXService</span><span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                hardwareDescription<span class="token punctuation">,</span>
                memoryConfiguration<span class="token punctuation">,</span>
                taskManagerConfiguration<span class="token punctuation">.</span><span class="token function">getDefaultSlotResourceProfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                taskManagerConfiguration<span class="token punctuation">.</span><span class="token function">getTotalResourceProfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resourceManagerConnection <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">TaskExecutorToResourceManagerConnection</span><span class="token punctuation">(</span>
                log<span class="token punctuation">,</span>
                <span class="token function">getRpcService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                taskManagerConfiguration<span class="token punctuation">.</span><span class="token function">getRetryingRegistrationConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                resourceManagerAddress<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                resourceManagerAddress<span class="token punctuation">.</span><span class="token function">getResourceManagerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">getMainThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ResourceManagerRegistrationListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                taskExecutorRegistration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        resourceManagerConnection<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">class</span> <span class="token class-name">ResourceManagerRegistrationListener</span>
        <span class="token keyword">implements</span> <span class="token class-name">RegistrationConnectionListener</span><span class="token generics"><span class="token punctuation">&lt;</span>
            <span class="token class-name">TaskExecutorToResourceManagerConnection</span><span class="token punctuation">,</span>
            <span class="token class-name">TaskExecutorRegistrationSuccess</span><span class="token punctuation">,</span>
            <span class="token class-name">TaskExecutorRegistrationRejection</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onRegistrationSuccess</span><span class="token punctuation">(</span>
            <span class="token class-name">TaskExecutorToResourceManagerConnection</span> connection<span class="token punctuation">,</span>
            <span class="token class-name">TaskExecutorRegistrationSuccess</span> success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ResourceID</span> resourceManagerId <span class="token operator">=</span> success<span class="token punctuation">.</span><span class="token function">getResourceManagerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">InstanceID</span> taskExecutorRegistrationId <span class="token operator">=</span> success<span class="token punctuation">.</span><span class="token function">getRegistrationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ClusterInformation</span> clusterInformation <span class="token operator">=</span> success<span class="token punctuation">.</span><span class="token function">getClusterInformation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ResourceManagerGateway</span> resourceManagerGateway <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">getTargetGateway</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>resourceManagerConnection <span class="token operator">==</span> connection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">establishResourceManagerConnection</span><span class="token punctuation">(</span>
                        resourceManagerGateway<span class="token punctuation">,</span>
                        resourceManagerId<span class="token punctuation">,</span>
                        taskExecutorRegistrationId<span class="token punctuation">,</span>
                        clusterInformation<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">final</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Acknowledge</span><span class="token punctuation">></span></span> slotReportResponseFuture <span class="token operator">=</span>
                    <span class="token comment">// establishResourceManagerConnection</span>
                    resourceManagerGateway<span class="token punctuation">.</span><span class="token function">sendSlotReport</span><span class="token punctuation">(</span>
                        <span class="token function">getResourceID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        taskExecutorRegistrationId<span class="token punctuation">,</span>
                        taskSlotTable<span class="token punctuation">.</span><span class="token function">createSlotReport</span><span class="token punctuation">(</span><span class="token function">getResourceID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        taskManagerConfiguration<span class="token punctuation">.</span><span class="token function">getRpcTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    slotReportResponseFuture<span class="token punctuation">.</span><span class="token function">whenCompleteAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span>acknowledge<span class="token punctuation">,</span> throwable<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>throwable <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token function">reconnectToResourceManager</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token function">getMainThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// monitor the resource manager as heartbeat target</span>
                    resourceManagerHeartbeatManager<span class="token punctuation">.</span><span class="token function">monitorTarget</span><span class="token punctuation">(</span>
                        resourceManagerResourceId<span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">ResourceManagerHeartbeatTarget</span><span class="token punctuation">(</span>resourceManagerGateway<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// set the propagated blob server address</span>
                    <span class="token class-name">InetSocketAddress</span> blobServerAddress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    blobCacheService<span class="token punctuation">.</span><span class="token function">setBlobServerAddress</span><span class="token punctuation">(</span>blobServerAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    establishedResourceManagerConnection <span class="token operator">=</span>
                        <span class="token keyword">new</span> <span class="token class-name">EstablishedResourceManagerConnection</span><span class="token punctuation">(</span>
                                resourceManagerGateway<span class="token punctuation">,</span>
                                resourceManagerResourceId<span class="token punctuation">,</span>
                                taskExecutorRegistrationId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
                    <span class="token function">stopRegistrationTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">class</span> <span class="token class-name">ResourceManagerLeaderListener</span> <span class="token keyword">implements</span> <span class="token class-name">LeaderRetrievalListener</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获得ResourceManager地址，和ResourceManager建立连接</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">void</span> <span class="token function">notifyLeaderAddress</span><span class="token punctuation">(</span><span class="token class-name">String</span> leaderAddress<span class="token punctuation">,</span> <span class="token class-name">UUID</span> leaderSessionID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span>
                <span class="token function">notifyOfNewResourceManagerLeader</span><span class="token punctuation">(</span>leaderAddress<span class="token punctuation">,</span> <span class="token class-name">ResourceManagerId</span><span class="token punctuation">.</span><span class="token function">fromUuidOrNull</span><span class="token punctuation">(</span>leaderSessionID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">establishJobManagerConnection</span><span class="token punctuation">(</span>
        <span class="token class-name">JobTable<span class="token punctuation">.</span>Job</span> job<span class="token punctuation">,</span>
        <span class="token class-name">JobMasterGateway</span> jobMasterGateway<span class="token punctuation">,</span>
        <span class="token class-name">JMTMRegistrationSuccess</span> registrationSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">JobID</span> jobId <span class="token operator">=</span> job<span class="token punctuation">.</span><span class="token function">getJobId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JobTable<span class="token punctuation">.</span>Connection</span><span class="token punctuation">></span></span> connection <span class="token operator">=</span> job<span class="token punctuation">.</span><span class="token function">asConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Establish JobManager connection for job {}."</span><span class="token punctuation">,</span> jobId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ResourceID</span> jobManagerResourceID <span class="token operator">=</span> registrationSuccess<span class="token punctuation">.</span><span class="token function">getResourceID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// associateWithJobManager</span>
        <span class="token class-name">TaskManagerActions</span> taskManagerActions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TaskManagerActionsImpl</span><span class="token punctuation">(</span>jobMasterGateway<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CheckpointResponder</span> checkpointResponder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcCheckpointResponder</span><span class="token punctuation">(</span>jobMasterGateway<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">GlobalAggregateManager</span> aggregateManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcGlobalAggregateManager</span><span class="token punctuation">(</span>jobMasterGateway<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ResultPartitionConsumableNotifier</span> resultPartitionConsumableNotifier <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">RpcResultPartitionConsumableNotifier</span><span class="token punctuation">(</span>
                jobMasterGateway<span class="token punctuation">,</span>
                <span class="token function">getRpcService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getScheduledExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                taskManagerConfiguration<span class="token punctuation">.</span><span class="token function">getRpcTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PartitionProducerStateChecker</span> partitionStateChecker <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">RpcPartitionStateChecker</span><span class="token punctuation">(</span>jobMasterGateway<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">registerQueryableState</span><span class="token punctuation">(</span>job<span class="token punctuation">.</span><span class="token function">getJobId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> jobMasterGateway<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JobTable<span class="token punctuation">.</span>Connection</span> establishedConnection <span class="token operator">=</span> job<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>
            jobManagerResourceID<span class="token punctuation">,</span>
            jobMasterGateway<span class="token punctuation">,</span>
            taskManagerActions<span class="token punctuation">,</span>
            checkpointResponder<span class="token punctuation">,</span>
            aggregateManager<span class="token punctuation">,</span>
            resultPartitionConsumableNotifier<span class="token punctuation">,</span>
            partitionStateChecker<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// monitor the job manager as heartbeat target</span>
        jobManagerHeartbeatManager<span class="token punctuation">.</span><span class="token function">monitorTarget</span><span class="token punctuation">(</span>
            jobManagerResourceID<span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">JobManagerHeartbeatTarget</span><span class="token punctuation">(</span>jobMasterGateway<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">internalOfferSlotsToJobManager</span><span class="token punctuation">(</span>establishedConnection<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// internalOfferSlotsToJobManager</span>
        <span class="token class-name">JobID</span> jobId <span class="token operator">=</span> establishedConnection<span class="token punctuation">.</span><span class="token function">getJobId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Offer reserved slots to the leader of job {}."</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JobMasterGateway</span> jobMasterGateway <span class="token operator">=</span> establishedConnection<span class="token punctuation">.</span><span class="token function">getJobManagerGateway</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TaskSlot</span><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">></span><span class="token punctuation">></span></span> reservedSlotsIterator <span class="token operator">=</span> taskSlotTable<span class="token punctuation">.</span><span class="token function">getAllocatedSlots</span><span class="token punctuation">(</span>jobId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JobMasterId</span> jobMasterId <span class="token operator">=</span> establishedConnection<span class="token punctuation">.</span><span class="token function">getJobMasterId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SlotOffer</span><span class="token punctuation">></span></span> reservedSlots <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>reservedSlotsIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">SlotOffer</span> offer <span class="token operator">=</span> reservedSlotsIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">generateSlotOffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            reservedSlots<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>offer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">UUID</span> slotOfferId <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        currentSlotOfferPerJob<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>jobId<span class="token punctuation">,</span> slotOfferId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Collection</span><span class="token punctuation">&lt;</span><span class="token class-name">SlotOffer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> acceptedSlotsFuture <span class="token operator">=</span>
            jobMasterGateway<span class="token punctuation">.</span><span class="token function">offerSlots</span><span class="token punctuation">(</span>
                <span class="token function">getResourceID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                reservedSlots<span class="token punctuation">,</span>
                taskManagerConfiguration<span class="token punctuation">.</span><span class="token function">getRpcTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        acceptedSlotsFuture<span class="token punctuation">.</span><span class="token function">whenCompleteAsync</span><span class="token punctuation">(</span>
            <span class="token function">handleAcceptedSlotOffers</span><span class="token punctuation">(</span>jobId<span class="token punctuation">,</span> jobMasterGateway<span class="token punctuation">,</span> jobMasterId<span class="token punctuation">,</span> reservedSlots<span class="token punctuation">,</span> slotOfferId<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">getMainThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">class</span> <span class="token class-name">JobLeaderListenerImpl</span> <span class="token keyword">implements</span> <span class="token class-name">JobLeaderListener</span> <span class="token punctuation">{</span>
        <span class="token comment">//和JobManager建立连接</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">void</span> <span class="token function">jobManagerGainedLeadership</span><span class="token punctuation">(</span>
            <span class="token class-name">JobID</span> jobId<span class="token punctuation">,</span>
            <span class="token class-name">JobMasterGateway</span> jobManagerGateway<span class="token punctuation">,</span>
            <span class="token class-name">JMTMRegistrationSuccess</span> registrationMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span>
                jobTable<span class="token punctuation">.</span><span class="token function">getJob</span><span class="token punctuation">(</span>jobId<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>job <span class="token operator">-></span>
                            <span class="token function">establishJobManagerConnection</span><span class="token punctuation">(</span>
                                job<span class="token punctuation">,</span>
                                jobManagerGateway<span class="token punctuation">,</span>
                                registrationMessage<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">void</span> <span class="token function">jobManagerLostLeadership</span><span class="token punctuation">(</span><span class="token class-name">JobID</span> jobId<span class="token punctuation">,</span> <span class="token class-name">JobMasterId</span> jobMasterId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"JobManager for job {} with leader id {} lost leadership."</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span>
                jobTable<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span>jobId<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>jobManagerConnection <span class="token operator">-></span>
                        <span class="token function">disconnectJobManagerConnection</span><span class="token punctuation">(</span>
                            jobManagerConnection<span class="token punctuation">,</span>
                            <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">DefaultDispatcherResourceManagerComponentFactory</span>
    <span class="token keyword">implements</span> <span class="token class-name">DispatcherResourceManagerComponentFactory</span>
<span class="token punctuation">{</span>
    <span class="token class-name">DispatcherResourceManagerComponent</span> <span class="token function">create</span><span class="token punctuation">(</span>
        <span class="token class-name">Configuration</span> configuration<span class="token punctuation">,</span>
        <span class="token class-name">Executor</span> ioExecutor<span class="token punctuation">,</span>
        <span class="token class-name">RpcService</span> rpcService<span class="token punctuation">,</span>
        <span class="token class-name">HighAvailabilityServices</span> highAvailabilityServices<span class="token punctuation">,</span>
        <span class="token class-name">BlobServer</span> blobServer<span class="token punctuation">,</span>
        <span class="token class-name">HeartbeatServices</span> heartbeatServices<span class="token punctuation">,</span>
        <span class="token class-name">MetricRegistry</span> metricRegistry<span class="token punctuation">,</span>
        <span class="token class-name">ExecutionGraphInfoStore</span> executionGraphInfoStore<span class="token punctuation">,</span>
        <span class="token class-name">MetricQueryServiceRetriever</span> metricQueryServiceRetriever<span class="token punctuation">,</span>
        <span class="token class-name">FatalErrorHandler</span> fatalErrorHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">LeaderRetrievalService</span> dispatcherLeaderRetrievalService <span class="token operator">=</span> highAvailabilityServices<span class="token punctuation">.</span><span class="token function">getDispatcherLeaderRetriever</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LeaderRetrievalService</span> resourceManagerRetrievalService <span class="token operator">=</span> highAvailabilityServices<span class="token punctuation">.</span><span class="token function">getResourceManagerLeaderRetriever</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">WebMonitorEndpoint</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> webMonitorEndpoint <span class="token operator">=</span> restEndpointFactory<span class="token punctuation">.</span><span class="token function">createRestEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Starting Dispatcher REST endpoint."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        webMonitorEndpoint<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> hostname <span class="token operator">=</span> <span class="token class-name">RpcUtils</span><span class="token punctuation">.</span><span class="token function">getHostname</span><span class="token punctuation">(</span>rpcService<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ResourceManagerService</span> resourceManagerService <span class="token operator">=</span> <span class="token class-name">ResourceManagerServiceImpl</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PartialDispatcherServices</span> partialDispatcherServices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PartialDispatcherServices</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Starting Dispatcher."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DispatcherRunner</span> dispatcherRunner <span class="token operator">=</span> dispatcherRunnerFactory<span class="token punctuation">.</span><span class="token function">createDispatcherRunner</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Starting ResourceManagerService."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resourceManagerService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resourceManagerRetrievalService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>resourceManagerGatewayRetriever<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dispatcherLeaderRetrievalService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DispatcherResourceManagerComponent</span><span class="token punctuation">(</span>
            dispatcherRunner<span class="token punctuation">,</span>
            resourceManagerService<span class="token punctuation">,</span>
            dispatcherLeaderRetrievalService<span class="token punctuation">,</span>
            resourceManagerRetrievalService<span class="token punctuation">,</span>
            webMonitorEndpoint<span class="token punctuation">,</span>
            fatalErrorHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ResourceManager</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WorkerType</span> <span class="token keyword">extends</span> <span class="token class-name">ResourceIDRetrievable</span><span class="token punctuation">></span></span>
    <span class="token keyword">extends</span> <span class="token class-name">FencedRpcEndpoint</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResourceManagerId</span><span class="token punctuation">></span></span>
    <span class="token keyword">implements</span> <span class="token class-name">ResourceManagerGateway</span>
<span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">void</span> <span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Starting the resource manager."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// startResourceManagerServices</span>
        jobLeaderIdService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JobLeaderIdActionsImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">registerMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">startHeartbeatServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        slotManager<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>
            <span class="token function">getFencingToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token comment">// newResourceManagerId</span>
            <span class="token function">getMainThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token comment">// newMainThreadExecutor</span>
            <span class="token keyword">new</span> <span class="token class-name">ResourceActionsImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// newResourceActions</span>
        <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        startedFuture<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Dispatcher</span>
    <span class="token keyword">extends</span> <span class="token class-name">PermanentlyFencedRpcEndpoint</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DispatcherId</span><span class="token punctuation">></span></span>
    <span class="token keyword">implements</span> <span class="token class-name">DispatcherGateway</span>
<span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">void</span> <span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// startDispatcherService</span>
        <span class="token function">registerDispatcherMetrics</span><span class="token punctuation">(</span>jobManagerMetricGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// startRecoveredJobs</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">JobGraph</span> recoveredJob <span class="token operator">:</span> recoveredJobs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// runRecoveredJob</span>
            <span class="token function">runJob</span><span class="token punctuation">(</span>recoveredJob<span class="token punctuation">,</span> <span class="token class-name">ExecutionType</span><span class="token punctuation">.</span><span class="token constant">RECOVERY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        recoveredJobs<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dispatcherBootstrap <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dispatcherBootstrapFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<p>JobGraph提交入口是MiniCluster的executeJobBlocking()方法，提交JobGraph和请求运行结果都是通过RPC调用来实现。</p>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">MiniCluster</span>
<span class="token punctuation">{</span>
    <span class="token class-name">JobExecutionResult</span> <span class="token function">executeJobBlocking</span><span class="token punctuation">(</span><span class="token class-name">JobGraph</span> job<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JobSubmissionResult</span><span class="token punctuation">></span></span> submissionFuture <span class="token operator">=</span> <span class="token function">submitJob</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JobResult</span><span class="token punctuation">></span></span> jobResultFuture <span class="token operator">=</span> submissionFuture<span class="token punctuation">.</span><span class="token function">thenCompose</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">JobSubmissionResult</span> ignored<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token function">requestJobResult</span><span class="token punctuation">(</span>job<span class="token punctuation">.</span><span class="token function">getJobID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JobResult</span> jobResult <span class="token operator">=</span> jobResultFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> jobResult<span class="token punctuation">.</span><span class="token function">toJobExecutionResult</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JobSubmissionResult</span><span class="token punctuation">></span></span> <span class="token function">submitJob</span><span class="token punctuation">(</span><span class="token class-name">JobGraph</span> jobGraph<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DispatcherGateway</span><span class="token punctuation">></span></span> dispatcherGatewayFuture <span class="token operator">=</span> dispatcherGatewayRetriever<span class="token punctuation">.</span><span class="token function">getFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InetSocketAddress</span><span class="token punctuation">></span></span> blobServerAddressFuture <span class="token operator">=</span> dispatcherGatewayFuture
            <span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>dispatcherGateway <span class="token operator">-></span>
                dispatcherGateway<span class="token punctuation">.</span><span class="token function">getBlobServerPort</span><span class="token punctuation">(</span>rpcTimeout<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>blobServerPort <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span>dispatcherGateway<span class="token punctuation">.</span><span class="token function">getHostname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> blobServerPort<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">thenCompose</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token punctuation">.</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> jarUploadFuture <span class="token operator">=</span> <span class="token function">uploadAndSetJobFiles</span><span class="token punctuation">(</span>blobServerAddressFuture<span class="token punctuation">,</span> jobGraph<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Acknowledge</span><span class="token punctuation">></span></span> acknowledgeCompletableFuture <span class="token operator">=</span> jarUploadFuture
            <span class="token punctuation">.</span><span class="token function">thenCombine</span><span class="token punctuation">(</span>dispatcherGatewayFuture<span class="token punctuation">,</span>
                         <span class="token punctuation">(</span><span class="token class-name">Void</span> ack<span class="token punctuation">,</span> <span class="token class-name">DispatcherGateway</span> dispatcherGateway<span class="token punctuation">)</span> <span class="token operator">-></span> dispatcherGateway<span class="token punctuation">.</span><span class="token function">submitJob</span><span class="token punctuation">(</span>jobGraph<span class="token punctuation">,</span> rpcTimeout<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">thenCompose</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token punctuation">.</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> acknowledgeCompletableFuture
            <span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Acknowledge</span> ignored<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">JobSubmissionResult</span><span class="token punctuation">(</span>jobGraph<span class="token punctuation">.</span><span class="token function">getJobID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<p>Dispatcher在接收到提交JobGraph的请求后，会将提交的JobGraph保存在SubmittedJobGraphStore中（用于故障恢复），并为提交的JobGraph启动JobManager。启动的JobManagerRunner会竞争leader，一旦被选举为leader，就会启动一个JobMaster。</p>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Dispatcher</span>
    <span class="token keyword">extends</span> <span class="token class-name">PermanentlyFencedRpcEndpoint</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DispatcherId</span><span class="token punctuation">></span></span>
    <span class="token keyword">implements</span> <span class="token class-name">DispatcherGateway</span>
<span class="token punctuation">{</span>
    <span class="token class-name">JobManagerRunner</span> <span class="token function">createJobManagerRunner</span><span class="token punctuation">(</span><span class="token class-name">JobGraph</span> jobGraph<span class="token punctuation">,</span> <span class="token keyword">long</span> initializationTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RpcService</span> rpcService <span class="token operator">=</span> <span class="token function">getRpcService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JobManagerRunner</span> runner <span class="token operator">=</span>
            jobManagerRunnerFactory<span class="token punctuation">.</span><span class="token function">createJobManagerRunner</span><span class="token punctuation">(</span>
                jobGraph<span class="token punctuation">,</span>
                configuration<span class="token punctuation">,</span>
                rpcService<span class="token punctuation">,</span>
                highAvailabilityServices<span class="token punctuation">,</span>
                heartbeatServices<span class="token punctuation">,</span>
                jobManagerSharedServices<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">DefaultJobManagerJobMetricGroupFactory</span><span class="token punctuation">(</span>jobManagerMetricGroup<span class="token punctuation">)</span><span class="token punctuation">,</span>
                fatalErrorHandler<span class="token punctuation">,</span>
                initializationTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        runner<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> runner<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">JobMasterServiceLeadershipRunner</span>
    <span class="token keyword">implements</span> <span class="token class-name">JobManagerRunner</span><span class="token punctuation">,</span> <span class="token class-name">LeaderContender</span>
<span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        leaderElectionService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">void</span> <span class="token function">grantLeadership</span><span class="token punctuation">(</span><span class="token class-name">UUID</span> leaderSessionID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// startJobMasterServiceProcess，启动JobMaster</span>
        <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Create new JobMasterServiceProcess because we were granted leadership under {}."</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        runningJobsRegistry<span class="token punctuation">.</span><span class="token function">setJobRunning</span><span class="token punctuation">(</span>jobMasterServiceProcessFactory<span class="token punctuation">.</span><span class="token function">getJobId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jobMasterServiceProcess <span class="token operator">=</span> jobMasterServiceProcessFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>leaderSessionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// forwardLeader</span>
        jobMasterServiceProcess
            <span class="token punctuation">.</span><span class="token function">getJobMasterGatewayFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">thenAccept</span><span class="token punctuation">(</span>t <span class="token operator">-></span> jobMasterGatewayFuture<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// forwardResultFuture</span>
        jobMasterServiceProcess
            <span class="token punctuation">.</span><span class="token function">getResultFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">thenAccept</span><span class="token punctuation">(</span>jobManagerRunnerResult <span class="token operator">-></span> <span class="token punctuation">{</span>
                <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Completing the result for job {}."</span><span class="token punctuation">,</span> <span class="token function">getJobID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                runningJobsRegistry<span class="token punctuation">.</span><span class="token function">setJobFinished</span><span class="token punctuation">(</span><span class="token function">getJobID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                resultFuture<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>jobManagerRunnerResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// confirmLeadership</span>
        jobMasterServiceProcess
            <span class="token punctuation">.</span><span class="token function">getLeaderAddressFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">thenAccept</span><span class="token punctuation">(</span>address <span class="token operator">-></span> leaderElectionService<span class="token punctuation">.</span><span class="token function">confirmLeadership</span><span class="token punctuation">(</span>leaderSessionId<span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<p>JobMaster启动后会和ResourceManager建立连接，连接被封装为ResourceManagerConnection。连接建立之后，JobMaster就可以通过RPC调用和ResourceManager进行通信了。</p>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">JobMaster</span>
    <span class="token keyword">extends</span> <span class="token class-name">PermanentlyFencedRpcEndpoint</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JobMasterId</span><span class="token punctuation">></span></span>
    <span class="token keyword">implements</span> <span class="token class-name">JobMasterGateway</span><span class="token punctuation">,</span> <span class="token class-name">JobMasterService</span>
<span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">startJobMasterServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>taskManagerHeartbeatManager <span class="token operator">=</span> <span class="token function">createTaskManagerHeartbeatManager</span><span class="token punctuation">(</span>heartbeatServices<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>resourceManagerHeartbeatManager <span class="token operator">=</span> <span class="token function">createResourceManagerHeartbeatManager</span><span class="token punctuation">(</span>heartbeatServices<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// start the slot pool make sure the slot pool now accepts messages for this leader</span>
        slotPoolService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token function">getFencingToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getMainThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resourceManagerLeaderRetriever<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResourceManagerLeaderListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">class</span> <span class="token class-name">ResourceManagerLeaderListener</span> <span class="token keyword">implements</span> <span class="token class-name">LeaderRetrievalListener</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notifyLeaderAddress</span><span class="token punctuation">(</span><span class="token class-name">String</span> leaderAddress<span class="token punctuation">,</span> <span class="token class-name">UUID</span> leaderSessionID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
                <span class="token comment">// notifyOfNewResourceManagerLeader</span>
                resourceManagerAddress <span class="token operator">=</span> <span class="token function">createResourceManagerAddress</span><span class="token punctuation">(</span>leaderAddress<span class="token punctuation">,</span> leaderSessionID<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// connectToResourceManager</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Connecting to ResourceManager {}"</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                resourceManagerConnection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResourceManagerConnection</span><span class="token punctuation">(</span>
                    log<span class="token punctuation">,</span>
                    jobGraph<span class="token punctuation">.</span><span class="token function">getJobID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    resourceId<span class="token punctuation">,</span>
                    <span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">getFencingToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    resourceManagerAddress<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    resourceManagerAddress<span class="token punctuation">.</span><span class="token function">getResourceManagerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    futureExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                resourceManagerConnection<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<p>之后进入任务调度执行流程。</p>
<h3 id="yarn-cluster启动流程" style="position:relative;"><a href="#yarn-cluster%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B" aria-label="yarn cluster启动流程 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Yarn Cluster启动流程</h3>
<p>Yarn Cluster的启动入口在FlinkYarnSessionCli中：首先根据命令行参数创建YarnClusterDescriptor，接着调用YarnClusterDescriptor的deploySessionCluster()触发集群的部署。实际启动的逻辑在AbstractYarnClusterDescriptor的deployInternal()方法中，主要就是通过YarnClient向YARN集群提交应用，启动ApplicationMaster。</p>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">YarnClusterDescriptor</span>
    <span class="token keyword">implements</span> <span class="token class-name">ClusterDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApplicationId</span><span class="token punctuation">></span></span>
<span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token class-name">ClusterClientProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApplicationId</span><span class="token punctuation">></span></span> <span class="token function">deploySessionCluster</span><span class="token punctuation">(</span><span class="token class-name">ClusterSpecification</span> clusterSpecification<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">deployInternal</span><span class="token punctuation">(</span>
            clusterSpecification<span class="token punctuation">,</span>
            <span class="token string">"Flink session cluster"</span><span class="token punctuation">,</span>
            <span class="token class-name">YarnSessionClusterEntrypoint</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">null</span><span class="token punctuation">,</span>
            <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">ClusterClientProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApplicationId</span><span class="token punctuation">></span></span> <span class="token function">deployInternal</span><span class="token punctuation">(</span>
        <span class="token class-name">ClusterSpecification</span> clusterSpecification<span class="token punctuation">,</span>
        <span class="token class-name">String</span> applicationName<span class="token punctuation">,</span>
        <span class="token class-name">String</span> yarnClusterEntrypoint<span class="token punctuation">,</span>
        <span class="token class-name">JobGraph</span> jobGraph<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> detached<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">YarnClientApplication</span> yarnApplication <span class="token operator">=</span> yarnClient<span class="token punctuation">.</span><span class="token function">createApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">GetNewApplicationResponse</span> appResponse <span class="token operator">=</span> yarnApplication<span class="token punctuation">.</span><span class="token function">getNewApplicationResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Resource</span> maxRes <span class="token operator">=</span> appResponse<span class="token punctuation">.</span><span class="token function">getMaximumResourceCapability</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClusterResourceDescription</span> freeClusterMem <span class="token operator">=</span> <span class="token function">getCurrentFreeClusterResources</span><span class="token punctuation">(</span>yarnClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> yarnMinAllocationMB <span class="token operator">=</span> yarnConfiguration<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClusterSpecification</span> validClusterSpecification <span class="token operator">=</span> <span class="token function">validateClusterResources</span><span class="token punctuation">(</span>clusterSpecification<span class="token punctuation">,</span> yarnMinAllocationMB<span class="token punctuation">,</span> maxRes<span class="token punctuation">,</span> freeClusterMem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClusterEntrypoint<span class="token punctuation">.</span>ExecutionMode</span> executionMode <span class="token operator">=</span> detached
            <span class="token operator">?</span> <span class="token class-name">ClusterEntrypoint<span class="token punctuation">.</span>ExecutionMode</span><span class="token punctuation">.</span><span class="token constant">DETACHED</span>
            <span class="token operator">:</span> <span class="token class-name">ClusterEntrypoint<span class="token punctuation">.</span>ExecutionMode</span><span class="token punctuation">.</span><span class="token constant">NORMAL</span><span class="token punctuation">;</span>
        flinkConfiguration<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token class-name">ClusterEntrypoint</span><span class="token punctuation">.</span><span class="token constant">INTERNAL_CLUSTER_EXECUTION_MODE</span><span class="token punctuation">,</span> executionMode<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ApplicationReport</span> report <span class="token operator">=</span> <span class="token function">startAppMaster</span><span class="token punctuation">(</span>
            flinkConfiguration<span class="token punctuation">,</span>
            applicationName<span class="token punctuation">,</span>
            yarnClusterEntrypoint<span class="token punctuation">,</span>
            jobGraph<span class="token punctuation">,</span>
            yarnClient<span class="token punctuation">,</span>
            yarnApplication<span class="token punctuation">,</span>
            validClusterSpecification<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setClusterEntrypointInfoToConfig</span><span class="token punctuation">(</span>report<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestClusterClient</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>flinkConfiguration<span class="token punctuation">,</span> report<span class="token punctuation">.</span><span class="token function">getApplicationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<p>SessionCluster和JobCluster两种启动方式对应Yarn ApplicationMatser入口类分别为YarnSessionClusterEntrypoint和YarnJobClusterEntrypoint, 区别在于Dispatcher分别为StandaloneDispatcher和MiniDispatcher。ResoureManager的具体实现类为YarnResourceManagerDriver。Yarn Cluster模式下启动的Flink集群，其TaskManager是由YarnResourceManagerDriver根据JobMaster的请求动态向Yarn ResourceManager进行申请的。在JobMaster向ResourceManager申请资源时，如果当前没有足够的资源分配，则YarnResourceManagerDriver会向Yarn集群的ResourceManager申请新的Container，并启动 TaskManager。</p>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">YarnResourceManagerDriver</span>
    <span class="token keyword">extends</span> <span class="token class-name">AbstractResourceManagerDriver</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">YarnWorkerNode</span><span class="token punctuation">></span></span>
<span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">YarnWorkerNode</span><span class="token punctuation">></span></span> <span class="token function">requestResource</span><span class="token punctuation">(</span><span class="token class-name">TaskExecutorProcessSpec</span> taskExecutorProcessSpec<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">YarnWorkerNode</span><span class="token punctuation">></span></span> requestResourceFuture <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TaskExecutorProcessSpecContainerResourcePriorityAdapter<span class="token punctuation">.</span>PriorityAndResource</span><span class="token punctuation">></span></span> priorityAndResourceOpt <span class="token operator">=</span> taskExecutorProcessSpecContainerResourcePriorityAdapter<span class="token punctuation">.</span><span class="token function">getPriorityAndResource</span><span class="token punctuation">(</span>taskExecutorProcessSpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Priority</span> priority <span class="token operator">=</span> priorityAndResourceOpt<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Resource</span> resource <span class="token operator">=</span> priorityAndResourceOpt<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resourceManagerClient<span class="token punctuation">.</span><span class="token function">addContainerRequest</span><span class="token punctuation">(</span><span class="token function">getContainerRequest</span><span class="token punctuation">(</span>resource<span class="token punctuation">,</span> priority<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resourceManagerClient<span class="token punctuation">.</span><span class="token function">setHeartbeatInterval</span><span class="token punctuation">(</span>containerRequestHeartbeatIntervalMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        requestResourceFutures
            <span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>taskExecutorProcessSpec<span class="token punctuation">,</span> ignore <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>requestResourceFuture<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Requesting new TaskExecutor container with resource {}, priority {}."</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> requestResourceFuture<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">ContainerLaunchContext</span> <span class="token function">createTaskExecutorLaunchContext</span><span class="token punctuation">(</span>
        <span class="token class-name">ResourceID</span> containerId<span class="token punctuation">,</span>
        <span class="token class-name">String</span> host<span class="token punctuation">,</span>
        <span class="token class-name">TaskExecutorProcessSpec</span> taskExecutorProcessSpec<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// init the ContainerLaunchContext</span>
        <span class="token class-name">String</span> currDir <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getCurrentDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ContaineredTaskManagerParameters</span> taskManagerParameters <span class="token operator">=</span> <span class="token class-name">ContaineredTaskManagerParameters</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>flinkConfig<span class="token punctuation">,</span> taskExecutorProcessSpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"TaskExecutor {} will be started on {} with {}."</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Configuration</span> taskManagerConfig <span class="token operator">=</span> <span class="token class-name">BootstrapTools</span><span class="token punctuation">.</span><span class="token function">cloneConfiguration</span><span class="token punctuation">(</span>flinkConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
        taskManagerConfig<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">TaskManagerOptions</span><span class="token punctuation">.</span><span class="token constant">TASK_MANAGER_RESOURCE_ID</span><span class="token punctuation">,</span> containerId<span class="token punctuation">.</span><span class="token function">getResourceIdString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        taskManagerConfig<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">TaskManagerOptionsInternal</span><span class="token punctuation">.</span><span class="token constant">TASK_MANAGER_RESOURCE_ID_METADATA</span><span class="token punctuation">,</span> containerId<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> taskManagerDynamicProperties <span class="token operator">=</span> <span class="token class-name">BootstrapTools</span><span class="token punctuation">.</span><span class="token function">getDynamicPropertiesAsString</span><span class="token punctuation">(</span>flinkClientConfig<span class="token punctuation">,</span> taskManagerConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"TaskManager configuration: {}"</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ContainerLaunchContext</span> taskExecutorLaunchContext <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">createTaskExecutorContext</span><span class="token punctuation">(</span>
            flinkConfig<span class="token punctuation">,</span>
            yarnConfig<span class="token punctuation">,</span>
            configuration<span class="token punctuation">,</span>
            taskManagerParameters<span class="token punctuation">,</span>
            taskManagerDynamicProperties<span class="token punctuation">,</span>
            currDir<span class="token punctuation">,</span>
            <span class="token class-name">YarnTaskExecutorRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>       <span class="token comment">// 入口类</span>
            log<span class="token punctuation">)</span><span class="token punctuation">;</span>
        taskExecutorLaunchContext<span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token constant">ENV_FLINK_NODE_ID</span><span class="token punctuation">,</span> host<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> taskExecutorLaunchContext<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">class</span> <span class="token class-name">YarnContainerEventHandler</span>
        <span class="token keyword">implements</span> <span class="token class-name">AMRMClientAsync<span class="token punctuation">.</span>CallbackHandler</span><span class="token punctuation">,</span> <span class="token class-name">NMClientAsync<span class="token punctuation">.</span>CallbackHandler</span>
    <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onContainersAllocated</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Container</span><span class="token punctuation">></span></span> containers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Received {} containers."</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Priority</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Container</span><span class="token punctuation">></span><span class="token punctuation">></span></span> entry <span class="token operator">:</span> <span class="token function">groupContainerByPriority</span><span class="token punctuation">(</span>containers<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// onContainersOfPriorityAllocated</span>
                <span class="token class-name">Priority</span> priority <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Container</span><span class="token punctuation">></span></span> containers <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TaskExecutorProcessSpecContainerResourcePriorityAdapter<span class="token punctuation">.</span>TaskExecutorProcessSpecAndResource</span><span class="token punctuation">></span></span> taskExecutorProcessSpecAndResourceOpt <span class="token operator">=</span> taskExecutorProcessSpecContainerResourcePriorityAdapter<span class="token punctuation">.</span><span class="token function">getTaskExecutorProcessSpecAndResource</span><span class="token punctuation">(</span>priority<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">TaskExecutorProcessSpec</span> taskExecutorProcessSpec <span class="token operator">=</span> taskExecutorProcessSpecAndResourceOpt<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTaskExecutorProcessSpec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Resource</span> resource <span class="token operator">=</span> taskExecutorProcessSpecAndResourceOpt<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">&lt;</span><span class="token class-name">YarnWorkerNode</span><span class="token punctuation">></span><span class="token punctuation">></span></span> pendingRequestResourceFutures <span class="token operator">=</span> requestResourceFutures<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span>taskExecutorProcessSpec<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Received {} containers with priority {}, {} pending container requests."</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Container</span><span class="token punctuation">></span></span> containerIterator <span class="token operator">=</span> containers<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AMRMClient<span class="token punctuation">.</span>ContainerRequest</span><span class="token punctuation">></span></span> pendingContainerRequestIterator <span class="token operator">=</span> <span class="token function">getPendingRequestsAndCheckConsistency</span><span class="token punctuation">(</span>priority<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> pendingRequestResourceFutures<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> numAccepted <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>containerIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                       <span class="token operator">&amp;&amp;</span> pendingContainerRequestIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Container</span> container <span class="token operator">=</span> containerIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">AMRMClient<span class="token punctuation">.</span>ContainerRequest</span> pendingRequest <span class="token operator">=</span> pendingContainerRequestIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">ResourceID</span> resourceId <span class="token operator">=</span> <span class="token function">getContainerResourceId</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">YarnWorkerNode</span><span class="token punctuation">></span></span> requestResourceFuture <span class="token operator">=</span> pendingRequestResourceFutures<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingRequestResourceFutures<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        requestResourceFutures<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>taskExecutorProcessSpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// startTaskExecutorInContainer</span>
                    <span class="token class-name">ContainerLaunchContext</span> containerLaunchContext <span class="token operator">=</span> <span class="token function">createTaskExecutorLaunchContext</span><span class="token punctuation">(</span>resourceId<span class="token punctuation">,</span> container<span class="token punctuation">.</span><span class="token function">getNodeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> taskExecutorProcessSpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    nodeManagerClient<span class="token punctuation">.</span><span class="token function">startContainerAsync</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> containerLaunchContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Removing container request {}."</span><span class="token punctuation">,</span> pendingRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    resourceManagerClient<span class="token punctuation">.</span><span class="token function">removeContainerRequest</span><span class="token punctuation">(</span>pendingRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    numAccepted<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">int</span> numExcess <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>containerIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">returnExcessContainer</span><span class="token punctuation">(</span>containerIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    numExcess<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Accepted {} requested containers, returned {} excess containers, {} pending container requests of resource {}."</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getNumRequestedNotAllocatedWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                resourceManagerClient<span class="token punctuation">.</span><span class="token function">setHeartbeatInterval</span><span class="token punctuation">(</span>yarnHeartbeatIntervalMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<h2 id="flink-graph" style="position:relative;"><a href="#flink-graph" aria-label="flink graph permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Flink Graph</h2>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/b84b856589233a080ed9cc2598c5f855/65e17/graph.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 91.13924050632912%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAABpUlEQVR42qWU67KDIAyEef9X7agVRcBLc/hot0O151edyVAS2CS7oW6ZRhv6zuYQbFkWO47DfvlcjsG8H23fd3s8Hvbr56ahszD5WhmgWrF5ni2UyrdtqyY/hp+4YvxOKZnbciyO9Ws2Hf72retqMcbaFcaesy7N3nJcjGZzzpXH9hCmPQBKoBh3qEx7F8tmKQfLjdoKQbUOOK2JBgCVAL/3/g3KWeJuC3c7tlyznkVh/5/q+AEATOdI6uISLBZ0AiKWbKpWxLMCIBAqU0yUVJXTMtua09NZsrRBLgEugdpq2U/TVBN/jE3wgzGLaqGdRyrkEjE4U3X4WcdxrEk/AV8vBOOAhFBL+ABgRYSu6+qKDcNwGSuXc3op9cyKqVKAqRDf/X6voH3f11UqXwABa1/I8eJRHHKRvV6KOBaHF8A0Dbav6T0K7ei0Y9OK1Y7O2eeO45mhJbkdB1Z8tEpFalvDfJ7T0vJWArG2JoHgiwuAIQh2u92qCMQAVOwCKO4AgmQE4YLerUYFdfFjgOOjgMscamAxWjv/jekfBRpIKgo0m2dR/gBgkYX1TYXdBwAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="graph"
        title=""
        src="/static/b84b856589233a080ed9cc2598c5f855/f058b/graph.png"
        srcset="/static/b84b856589233a080ed9cc2598c5f855/c26ae/graph.png 158w,
/static/b84b856589233a080ed9cc2598c5f855/6bdcf/graph.png 315w,
/static/b84b856589233a080ed9cc2598c5f855/f058b/graph.png 630w,
/static/b84b856589233a080ed9cc2598c5f855/40601/graph.png 945w,
/static/b84b856589233a080ed9cc2598c5f855/78612/graph.png 1260w,
/static/b84b856589233a080ed9cc2598c5f855/65e17/graph.png 6836w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>图的节点表示数据的处理逻辑，图的边表示数据的流传。从数据源读取数据开始，上游的数据处理完毕之后，交给下游继续处理，直到数据输出到外部存储中，整个过程用图来表示。</p>
<p>Flink中图可以分为四层，StreamGraph -> JobGraph -> ExecutionGraph -> 物理执行图，分层的目的是为了解耦。StreamGraph是最原始的，更贴近用户逻辑的拓扑结构；JobGraph对StreamGraph进行优化，将能够合并的算子合并为一个节点以降低运行时数据传输的开销；ExecutionGraph是并行化的JobGraph，是作业运行时基本调度单元的拓扑结构；物理执行图就是最终任务分布式并行执行的拓扑结构。</p>
<p>TODO:
JobGraph在JobManager中进一步被转换为可供调度的并行化版本的ExecutionGraph，其中JobVertex被展开为并行化版本的ExecutionVertex，每一个ExecutionVertex对应JobVertex的一个并行子任务，它的每一次调度对应一个Execution，即TaskManager中的一个Task。所以，一个Task运行期间的主要处理逻辑对应一个OperatorChain，这个OperatorChain可能包含多个Operator，也可能只有一个Operator。</p>
<h3 id="datastream" style="position:relative;"><a href="#datastream" aria-label="datastream permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>DataStream</h3>
<div class='wrapper' markdown='block'>
<p><img src="https://www.plantuml.com/plantuml/svg/dLPDR-Cs4BthLx0twU0rijSi5kjDaoBzG8BQGSzZQYnpJGs58HMlqFQ_5nIbM64enzkJoE6RDsy-IFkBTS2khNMM_UJsMAEm1tHotorCwxGYpFQgH85rupfHOxr5jfazA6g0eHOhPdFSx9Ky45ehhh9CQh1M_0mEreuHQl5t9eGGBIb3UR4yOFUroukbD4GeNLxqfqT5fJckjCwBwzvGQRC5dHVBBHie9LYN5ykTuIDmcHTBksztEurviMJSWWQIOMqbU6jFKKEJ5yk6ZKHhysBvpIZAY-pVKU9DK81bq6a7eM5t-nrbwvIXMtfMRAX6SW9Fww1oagMYfdLXVNNkyEFrIS5VVTQZW27-RzYzM7g_m1Qm3mqoECDVMwLBPB4DtmddIkiVfrrPgof27limR0Damwgga8KBts2yVLRI6HOOli6e3LK2jFR1VmU7VYJ2oKFhcjPje18Q7FhAl5XwxR2rZa4w4PBOC93T6Qx1js38G94JghmUcwIe4csq9wXn4DqrU4yd2XF2TSrmxidy16kDMjdwPApX-sDi_nEjQLdYka4fQaNZtYQE6yOTCcCPWTRQkFKUlCnVsBIDi94XLOV7VMUL19siXqLtimT5YggrOt1OTNbi47PO59CHUI2yznEGP8sCar49mpDEu1tuldV2lDvFmcoEviV2N5tF7dtyVnBMVGUI0iAH23qQxW8uv1huC5RlqyFJvhCunkQ0VbDg6Hbw7OeSyWuaHjhZJg-6ROGwkOzDcmMCvRuipbEvUmqSod8dMejyrvBqjV8PJ9wnnU9pr9tfwQT_5WknLbHf39SxKX939ozIDkyMi2VVqBTt7UwTtwbd7094Cz1ZqhShcxbqlKlwwfnrIL-3iowfiJtleEWGmPC90plbjnTWd-WjxasXFtoO6znKJsP6E0MT6UPqiE0oEzbdlOBjaSqtb2vBAmo9laREtwC9xJ2hbs4L7Iw8tyCk8lm3cWluFEeYkZkb7V85Z0Fm7TBNVsVEqaRGTuXlp2cnz1G5rYdk7Sfx_yO-W_xLA7gHSOuxwJ3pg-lVr6XUPtuu4yZi2rBPrle_" alt="plantuml"></p>
</div>
<p>通过DataStream –> Transformation –> StreamOperator这样的依赖关系，就可以完成DataStream的转换，并且保留数据流和应用在流上的算子之间的关系。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/6a831e639bd1de7f8a7c0f7be75e7a29/c65fa/datastream.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 43.67088607594937%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABH0lEQVR42oWS2aqDUAxF/f//0yKC1tlW6zxPKStw3i69gU2OGXcSLflHuq6Tvu9lXVdpmkbe77eUZSlVVen3OI4yTZPG7fsu1q9i13XJ5/ORYRi0aJIk4vu+BEEgnudJURQyz7MWxA9+FjzPU5OO41DAKs9zBUyzLFNmCE1fr9ffBe/7Vr0siyYbG2AsGOFDwxAb7NI0FYuPbdsUvGECM4S9xXGshbCjicMWRZGCN6sIw1C11bat7gmwZEZgNIDPcRwdhzcaZvhgRA6aPMbXgqYAxrquNQjH4/HQ/bmuq5c0xwHEIeyMKQAFWY9lrkQS3UjAZo5CEOxoTFP8z+dT94VmbGLQNLXMsg3MAfhlENjA1PwyANa2bes6eFMMP0y/MW2xAhyq5gYAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Transformation"
        title=""
        src="/static/6a831e639bd1de7f8a7c0f7be75e7a29/f058b/datastream.png"
        srcset="/static/6a831e639bd1de7f8a7c0f7be75e7a29/c26ae/datastream.png 158w,
/static/6a831e639bd1de7f8a7c0f7be75e7a29/6bdcf/datastream.png 315w,
/static/6a831e639bd1de7f8a7c0f7be75e7a29/f058b/datastream.png 630w,
/static/6a831e639bd1de7f8a7c0f7be75e7a29/40601/datastream.png 945w,
/static/6a831e639bd1de7f8a7c0f7be75e7a29/78612/datastream.png 1260w,
/static/6a831e639bd1de7f8a7c0f7be75e7a29/c65fa/datastream.png 1434w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>DataStream表示由同一种类型元素构成的数据流，是最基本的数据流。通过对DataStream应用map/filter等操作，可以将一个DataStream转换为另一个DataStream，这个转换的过程就是根据不同的操作生成不同的 Transformation，并将其加入StreamExecutionEnvironment的transformations列表中。DataStream子类有SingleOutputStreamOperator、DataStreamSource、KeyedStream等。</p>
<p>ConnectedStream表示两个流混合形成的新流，允许用户对两个流中的记录分别指定不同的处理逻辑，处理结果形成一个新流，由于两个流的处理是在同一个算子中进行的，因此可以共享状态信息，Join操作也是依赖ConnectedStreams实现的。</p>
<p>WindowedStream表示按键分组且分组内元素根据WindowAssigner划分窗口的数据流。AllWindowedStream表示元素根据WindowAssigner划分窗口的数据流。</p>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">DataStream</span> <span class="token punctuation">{</span>
    <span class="token class-name">StreamExecutionEnvironment</span> environment<span class="token punctuation">;</span>
    <span class="token class-name">Transformation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> transformation<span class="token punctuation">;</span>
    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">union</span><span class="token punctuation">(</span><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> streams<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Transformation</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span><span class="token punctuation">></span></span> unionedTransforms <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        unionedTransforms<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>transformation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> newStream <span class="token operator">:</span> streams<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">assert</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>newStream<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            unionedTransforms<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>newStream<span class="token punctuation">.</span><span class="token function">getTransformation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>environment<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">UnionTransformation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>unionedTransforms<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">></span></span> <span class="token class-name">ConnectedStreams</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">></span></span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">></span></span> dataStream<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ConnectedStreams</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>environment<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> dataStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">></span></span> <span class="token class-name">KeyedStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">></span></span> <span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token class-name">KeySelector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">></span></span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">KeyedStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">clean</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">W</span> <span class="token keyword">extends</span> <span class="token class-name">Window</span><span class="token punctuation">></span></span> <span class="token class-name">AllWindowedStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">></span></span> <span class="token function">windowAll</span><span class="token punctuation">(</span><span class="token class-name">WindowAssigner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">W</span><span class="token punctuation">></span></span> assigner<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AllWindowedStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> assigner<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">forward</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">setConnectionType</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ForwardPartitioner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">setConnectionType</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BroadcastPartitioner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">rebalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">setConnectionType</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RebalancePartitioner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">rescale</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">setConnectionType</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RescalePartitioner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">shuffle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">setConnectionType</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ShufflePartitioner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">setConnectionType</span><span class="token punctuation">(</span><span class="token class-name">StreamPartitioner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> partitioner<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">PartitionTransformation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTransformation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> partitioner<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// join操作</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>T2<span class="token punctuation">></span></span> <span class="token class-name">JoinedStreams</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> T2<span class="token punctuation">></span></span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span>T2<span class="token punctuation">></span></span> otherStream<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JoinedStreams</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> otherStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">DataStreamSink</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">addSink</span><span class="token punctuation">(</span><span class="token class-name">SinkFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> sinkFunction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        transformation<span class="token punctuation">.</span><span class="token function">getOutputType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sinkFunction <span class="token keyword">instanceof</span> <span class="token class-name">InputTypeConfigurable</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">InputTypeConfigurable</span><span class="token punctuation">)</span> sinkFunction<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setInputType</span><span class="token punctuation">(</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getExecutionConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">StreamSink</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> sinkOperator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StreamSink</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token function">clean</span><span class="token punctuation">(</span>sinkFunction<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DataStreamSink</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> sink <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataStreamSink</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> sinkOperator<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addOperator</span><span class="token punctuation">(</span>sink<span class="token punctuation">.</span><span class="token function">getTransformation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sink<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<p>Transformation表示生成DataStream的操作，Flink作业运行时对DataStream API的调用都会被转换成Transformation。</p>
<p>Transformation包含了Flink运行时的一些关键参数：</p>
<ul>
<li>id: 基于静态累加器生成</li>
<li>uid: 由用户指定，主要用于在作业重启时再次分配跟之前相同的uid，可以持久保存状态</li>
<li>name: Transformation名称，用于可视化</li>
<li>outputType: 输出类型，用来序列化数据</li>
<li>parallelism: 并行度</li>
<li>slotSharingGroup: Slot共享组</li>
<li>input：Transformation实例，可选，记录输入Transformation</li>
<li>operatorFactory：StreamOperatorFactory实例，可选，用于创建算子（StreamOperator）的工厂</li>
</ul>
<p>Transformation子类对应了DataStream上的不同转换操作，按照是否被转换为运行时的物理操作分为物理Transformation和虚拟Transformation。虚拟Transformation（如PartitionTransformation、UnionTransformation）都不包含StreamOperator成员变量，而物理Transformation（如SourceTransformation、SinkTransformation、OneInputTransformation、TwoInputTransformation，都是PhysicalTransformation子类）基本上都包含StreamOperator成员变量。另外，Transformation中通常保留了其输入Transformation，进而表示程序的拓扑结构。</p>
<p>StreamOperator是Transformation运行时的具体实现，决定UDF的调用方式。所有StreamOperator实现类都要继承AbstractStreamOperator<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup>，包含UDF的StreamOperator只需继承AbstractUdfStreamOperator（AbstractStreamOperator子类）。处理元素的StreamOperator都需实现OneInputStreamOperator接口或TwoInputStreamOperator接口。</p>
<h3 id="流图streamgraph" style="position:relative;"><a href="#%E6%B5%81%E5%9B%BEstreamgraph" aria-label="流图streamgraph permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>流图（StreamGraph）</h3>
<div class='wrapper' markdown='block'>
<p><img src="https://www.plantuml.com/plantuml/svg/ZLHDRzim3BtxLsYt3MWAR3l6SBfrRH6iROevwvsn65kBB0aIrIJO-jy7-LDfiY4dM-yzIYGVfIj7OCdNCadUKOKrChT1AghzH7kIGc5I2OuCQqDxLcEzGkiIjn7AW8MQVR5MRvULA3OAdMCVawIGu1pBoIBKTnPCnNudZB6025MoNthr23Ksq0EOTAu8IxGNNSIZvfWnD_oxDXQf5sRCQM-BauHG6tUyyT8RYP_IoylBB6Clmf87cGkE2q_6qtZ8ST3dmw0di2H8Q3N60ETXyVx3j5y-dphWc3_OAw9lUDaiNmyR6LHT7uKY9lXq-0y-I8bIk7e4QzWzlSNlXQEqtIwSaZ6XmjUT9hMdaUsyqmOjaBR1m6bF8DIB3h-5WhJTfxDia7PG8xuE1QKpXZj2nHrRWjlCrOlUm4fY5YRZ6ItXhj4r4J-mDJitMB1Qg7xjfiUqiRX6Qv6_4NMvEwafho3ytrdjpG5Pw7jTGB0ZukRAUBhLjWPAPnTi5Xes8AsaTRZND4rxem3EvwetjGCMRMjFs1pWm-k2lCHvv7PRMemGs1AfHzgCbb1skIoXZ9qQnWxjc6y47hQiEMjnolH0jmSl_Z4JDxkY0bNYGvXSZ1PDqR1oPA4W5bSVvH7DklBXpLcihojG2cNdgaFofk-fS5-j1bw0en5wqaBHLhYXyoNIJzE-BBbV4RXDJa3u0CQWZKJVz5RzJ_QQ9F7hDfbaqILDeliwCi7N9B9uPAAQa-Ckf7ycap3b1KWyIxa22QeuHtidzIfwXluj_8xxvbASdU-jjbkm_0nbNldr-gpA1dzZxHKgxclv5m00" alt="plantuml"></p>
</div>
<p>流图（StreamGraph）是根据DataStream API编写的代码生成的最初的图，与具体执行无关，核心是表达计算逻辑，由StreamNode和StreamEdge构成：</p>
<ul>
<li>StreamNode是StreamGraph中的顶点，从Transformation转换而来，保存了对应的StreamOperator（变量operatorFactory），并且还引入了变量jobVertexClass来表示该节点在TaskManager中运行时的实际任务类型。StreamNode分为实体StreamNode和虚拟StreamNode，实体StreamNode会最终变成物理算子，虚拟StreamNode会附着在StreamEdge上</li>
<li>StreamEdge是StreamGraph中的边，用来连接两个StreamNode，包含了旁路输出、分区器、字段筛选输出等信息</li>
</ul>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">StreamGraph</span> <span class="token keyword">implements</span> <span class="token class-name">Pipeline</span>
<span class="token punctuation">{</span>
    <span class="token class-name">StreamNode</span> <span class="token function">addNode</span><span class="token punctuation">(</span>
        <span class="token class-name">Integer</span> vertexID<span class="token punctuation">,</span>
        <span class="token class-name">String</span> slotSharingGroup<span class="token punctuation">,</span>
        <span class="token class-name">String</span> coLocationGroup<span class="token punctuation">,</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">TaskInvokable</span><span class="token punctuation">></span></span> vertexClass<span class="token punctuation">,</span>
        <span class="token class-name">StreamOperatorFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> operatorFactory<span class="token punctuation">,</span>
        <span class="token class-name">String</span> operatorName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">assert</span> <span class="token operator">!</span>streamNodes<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>vertexID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">StreamNode</span> vertex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StreamNode</span><span class="token punctuation">(</span>
            vertexID<span class="token punctuation">,</span>
            slotSharingGroup<span class="token punctuation">,</span>
            coLocationGroup<span class="token punctuation">,</span>
            operatorFactory<span class="token punctuation">,</span>
            operatorName<span class="token punctuation">,</span>
            vertexClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        streamNodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>vertexID<span class="token punctuation">,</span> vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> vertex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">addVirtualSideOutputNode</span><span class="token punctuation">(</span>
        <span class="token class-name">Integer</span> originalId<span class="token punctuation">,</span>
        <span class="token class-name">Integer</span> virtualId<span class="token punctuation">,</span>
        <span class="token class-name">OutputTag</span> outputTag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">assert</span> <span class="token operator">!</span>virtualSideOutputNodes<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>virtualId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        virtualSideOutputNodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>virtualId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>originalId<span class="token punctuation">,</span> outputTag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">addVirtualPartitionNode</span><span class="token punctuation">(</span>
        <span class="token class-name">Integer</span> originalId<span class="token punctuation">,</span>
        <span class="token class-name">Integer</span> virtualId<span class="token punctuation">,</span>
        <span class="token class-name">StreamPartitioner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> partitioner<span class="token punctuation">,</span>
        <span class="token class-name">StreamExchangeMode</span> exchangeMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">assert</span> <span class="token operator">!</span>virtualPartitionNodes<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>virtualId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        virtualPartitionNodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>virtualId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Tuple3</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>originalId<span class="token punctuation">,</span> partitioner<span class="token punctuation">,</span> exchangeMode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">addEdge</span><span class="token punctuation">(</span>
        <span class="token class-name">Integer</span> upStreamVertexID<span class="token punctuation">,</span>
        <span class="token class-name">Integer</span> downStreamVertexID<span class="token punctuation">,</span>
        <span class="token keyword">int</span> typeNumber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">addEdgeInternal</span><span class="token punctuation">(</span>
            upStreamVertexID<span class="token punctuation">,</span>
            downStreamVertexID<span class="token punctuation">,</span>
            typeNumber<span class="token punctuation">,</span>
            <span class="token keyword">null</span><span class="token punctuation">,</span>                     <span class="token comment">// partitioner</span>
            <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// outputNames</span>
            <span class="token keyword">null</span><span class="token punctuation">,</span>                     <span class="token comment">// outputTag</span>
            <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// exchangeMode</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">addEdgeInternal</span><span class="token punctuation">(</span>
        <span class="token class-name">Integer</span> upStreamVertexID<span class="token punctuation">,</span>
        <span class="token class-name">Integer</span> downStreamVertexID<span class="token punctuation">,</span>
        <span class="token keyword">int</span> typeNumber<span class="token punctuation">,</span>
        <span class="token class-name">StreamPartitioner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> partitioner<span class="token punctuation">,</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> outputNames<span class="token punctuation">,</span>
        <span class="token class-name">OutputTag</span> outputTag<span class="token punctuation">,</span>
        <span class="token class-name">StreamExchangeMode</span> exchangeMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 添加StreamEdge时，如果上游节点是虚拟节点，则向上游递归调用并将虚拟节点的信息附着在StreamEdge上</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>virtualSideOutputNodes<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>upStreamVertexID<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 当上游节点是虚拟旁路输出节点时，获取outputTag并向上递归调用</span>
            <span class="token keyword">int</span> virtualId <span class="token operator">=</span> upStreamVertexID<span class="token punctuation">;</span>
            <span class="token comment">// 虚拟旁路输出节点的上游节点id</span>
            upStreamVertexID <span class="token operator">=</span> virtualSideOutputNodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>virtualId<span class="token punctuation">)</span><span class="token punctuation">.</span>f0<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>outputTag <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                outputTag <span class="token operator">=</span> virtualSideOutputNodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>virtualId<span class="token punctuation">)</span><span class="token punctuation">.</span>f1<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">addEdgeInternal</span><span class="token punctuation">(</span>
                upStreamVertexID<span class="token punctuation">,</span>
                downStreamVertexID<span class="token punctuation">,</span>
                typeNumber<span class="token punctuation">,</span>
                partitioner<span class="token punctuation">,</span>
                <span class="token keyword">null</span><span class="token punctuation">,</span>              <span class="token comment">// outputNames</span>
                outputTag<span class="token punctuation">,</span>
                exchangeMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>virtualPartitionNodes<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>upStreamVertexID<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 当上游节点是虚拟分区节点时，向上递归调用并传入partitiner和exchangeMode</span>
            <span class="token keyword">int</span> virtualId <span class="token operator">=</span> upStreamVertexID<span class="token punctuation">;</span>
            <span class="token comment">// 虚拟分区节点的上游节点id</span>
            upStreamVertexID <span class="token operator">=</span> virtualPartitionNodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>virtualId<span class="token punctuation">)</span><span class="token punctuation">.</span>f0<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>partitioner <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                partitioner <span class="token operator">=</span> virtualPartitionNodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>virtualId<span class="token punctuation">)</span><span class="token punctuation">.</span>f1<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            exchangeMode <span class="token operator">=</span> virtualPartitionNodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>virtualId<span class="token punctuation">)</span><span class="token punctuation">.</span>f2<span class="token punctuation">;</span>
            <span class="token function">addEdgeInternal</span><span class="token punctuation">(</span>
                    upStreamVertexID<span class="token punctuation">,</span>
                    downStreamVertexID<span class="token punctuation">,</span>
                    typeNumber<span class="token punctuation">,</span>
                    partitioner<span class="token punctuation">,</span>
                    outputNames<span class="token punctuation">,</span>
                    outputTag<span class="token punctuation">,</span>
                    exchangeMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 不是以上逻辑转换的情况，真正构造StreamEdge</span>
            <span class="token class-name">StreamNode</span> upstreamNode <span class="token operator">=</span> streamNodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>vertexID<span class="token punctuation">)</span><span class="token punctuation">(</span>upStreamVertexID<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">StreamNode</span> downstreamNode <span class="token operator">=</span> streamNodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>vertexID<span class="token punctuation">)</span><span class="token punctuation">(</span>downStreamVertexID<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 未指定partitioner时选择forward或rebalance分区</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>partitioner <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> upstreamNode<span class="token punctuation">.</span><span class="token function">getParallelism</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> downstreamNode<span class="token punctuation">.</span><span class="token function">getParallelism</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                partitioner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForwardPartitioner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>partitioner <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                partitioner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RebalancePartitioner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>exchangeMode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                exchangeMode <span class="token operator">=</span> <span class="token class-name">StreamExchangeMode</span><span class="token punctuation">.</span><span class="token constant">UNDEFINED</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 创建StreamEdge</span>
            <span class="token class-name">StreamEdge</span> edge <span class="token operator">=</span>
                <span class="token keyword">new</span> <span class="token class-name">StreamEdge</span><span class="token punctuation">(</span>
                    upstreamNode<span class="token punctuation">,</span>
                    downstreamNode<span class="token punctuation">,</span>
                    typeNumber<span class="token punctuation">,</span>
                    partitioner<span class="token punctuation">,</span>
                    outputTag<span class="token punctuation">,</span>
                    exchangeMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 将StreamEdge添加到上游结点的出边，下游节点的入边</span>
            streamNodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>edge<span class="token punctuation">.</span><span class="token function">getSourceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>outEdges<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>edge<span class="token punctuation">)</span><span class="token punctuation">;</span>
            streamNodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>edge<span class="token punctuation">.</span><span class="token function">getTargetId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>inEdges<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>edge<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">StreamNode</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> id<span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StreamEdge</span><span class="token punctuation">></span></span> inEdges<span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StreamEdge</span><span class="token punctuation">></span></span> outEdges<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">addInEdge</span><span class="token punctuation">(</span><span class="token class-name">StreamEdge</span> inEdge<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 入边的终点必须是该顶点</span>
        <span class="token keyword">assert</span> inEdge<span class="token punctuation">.</span>targetId <span class="token operator">==</span> id<span class="token punctuation">;</span>
        inEdges<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>inEdge<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">addOutEdge</span><span class="token punctuation">(</span><span class="token class-name">StreamEdge</span> outEdge<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 出边的起点必须是该顶点</span>
        <span class="token keyword">assert</span> outEdge<span class="token punctuation">.</span><span class="token function">sourceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> id<span class="token punctuation">;</span>
        outEdges<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>outEdge<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<h3 id="作业图jobgraph" style="position:relative;"><a href="#%E4%BD%9C%E4%B8%9A%E5%9B%BEjobgraph" aria-label="作业图jobgraph permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>作业图（JobGraph）</h3>
<div class='wrapper' markdown='block'>
<p><img src="https://www.plantuml.com/plantuml/svg/ZLJBRjim4BphAzXR2zG1UdPXnBRIG86R297H7WEQt5Yi-S9osSOe-ky5zR1iHGrwaSIPMNBsGLq7uaZHw2nxHpKOOE409EhZp4NIoa9MAmaCZASZCs1sW24B1sKzHsxO4j7zsjPA72o4m3vbcT0y17RdThV8VSr-Puonj2nozYCzvmrG4IgxJyWzDp3lHTkZXmIcTmj-vVxpdTjz0oHuAVAFxBHOCEBXaBwLWD2gkPGj-Vv32pmhso6hOv7tw1weZwiS4iYjyqwxlH9Sw-CNTAPo4GM45F3dBATsgo6ftXPJyY8lUqfgYSYF6nKePN4Zzx1Wolf8OKmNbW0DICK9Sawy0bemX11rh-tsLlQdE_2TXdLoDPIlevq7vEHm89hj7pguo4kkS76I5Vah9rTNLmE_TWwbikcp4ofBB3LVQz0gc04q_AKSuvLsLDKyERj55pqB8w2LhTt62KxAsGOiZDTCN6Ajy152qvdAWs16sNuT9cYFy0o88Cz4vyrCtUXQEL7y8cTjLD6rTaBJAUQNuy28unweHNCL2DKkfZnAJWHecNoDdJcREkSjb_te3UTxT38AmBFsduPFE1kY0HmA5ZML74abDytzQuTkk89SodKNrTq7iD5CXhO-Tyvfu9QfK2eFwIVIMUo9ceSL5uSI8OI8C1z5hLoqSXoZGWaOL22mD6OUGJXhGL2w5eF3gTgt3fURpTFsuMcvsRHRbG_5_VPxKTqqmQUVrsos6CgQ3GNky5JH4JhHegmVjV_XBquxeHE9P5DZShd36uh6-R_uYSPcrs1bDFel" alt="plantuml"></p>
</div>
<p>JobGraph是提交给JobManager的数据结构，对StreamGraph进行了一些优化（如通过OperatorChain机制将多个StreamNode合并成一个JobVertex，即 将多个算子合并成一个Task，避免数据跨线程、跨网络传递）。由JobVertex、JobEdge和IntermediateDataSet组成。</p>
<ul>
<li>JobVertex是JobGraph中的顶点，多个符合条件的StreamNode链接在一起形成一个JobVertex，其输入是JobEdge，输出是IntermediateDataSet</li>
<li>JobEdge是JobGraph中的边，对应StreamGraph中的StreamEdge，表示一条数据传输通道，上游数据源是IntermediateDataSet，下游消费者是JobVertex，即数据通过JobEdge由IntermediateDataSet传递给目标JobVertex。JobEdge中的数据分发模式（distributionPattern）会直接影响执行时上下游Task之间是点对点连接还是全连接</li>
<li>IntermediateDataSet表示JobVertex的输出，即经过算子处理产生的数据，其个数与该JobVertex对应的StreamNode的出边数量相同。IntermediateDateSet生产者是JobVertex，消费者是JobEdge。</li>
</ul>
<p>InterMediateDataSet的ResultPartitionType决定了执行时的数据交换模式。不同执行模式下，IntermediateDataSet的ResultPartitionType不同。ResultPartitionType其实是一个五元组(isPipelined, hasBackPressure, isBounded, isPersistent, isReconnectable)，包含BLOCKING、BLOCKING_PERSISTENT、PIPELINED、PIPELINED_BOUNDED、PIPELINED_APPROXIMATE五个值：</p>
<ul>
<li>BLOCKING：等待数据完全处理完毕后才会与下游进行数据交换，可以被多次消费，由调度器负责销毁，适用于批处理</li>
<li>BLOCKING_PERSISTENT：与BLOCKING相似，但是由用户调用相关API进行销毁</li>
<li>PIPELINED：只能被1个消费者消费1次，数据被消费之后自动销毁，可以保留任意数量的数据，当数据量太大内存无法容纳时可以写入磁盘中，适用于流处理和批处理</li>
<li>PIPELINED_BOUNDED：是带有有限容量本地缓冲池的PIPELINED</li>
<li>PIPELINED_APPROXIMATE：支持单点恢复（Approximate Task-local Recovery）的PIPELINED_BOUNDED，下游任务失败恢复后可以重新消费</li>
</ul>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">JobGraph</span> <span class="token punctuation">{</span>
    <span class="token comment">// 对JobVertex进行拓扑排序</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JobVertex</span><span class="token punctuation">></span></span> <span class="token function">getVerticesSortedTopologicallyFromSources</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JobVertex</span><span class="token punctuation">></span></span> sorted <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JobVertex</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>taskVertices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JobVertex</span><span class="token punctuation">></span></span> remaining <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JobVertex</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>taskVertices<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JobVertex</span><span class="token punctuation">></span></span> iter <span class="token operator">=</span> remaining<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">JobVertex</span> vertex <span class="token operator">=</span> iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>vertex<span class="token punctuation">.</span><span class="token function">hasNoConnectedInputs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sorted<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                iter<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> startNodePos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>remaining<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">assert</span> startNodePos <span class="token operator">&lt;=</span> sorted<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">JobVertex</span> current <span class="token operator">=</span> sorted<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>startNodePos<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">addNodesThatHaveNoNewPredecessors</span><span class="token punctuation">(</span>
                current<span class="token punctuation">,</span>       <span class="token comment">// start</span>
                sorted<span class="token punctuation">,</span>        <span class="token comment">// target</span>
                remaining<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// remaining</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> sorted<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">addNodesThatHaveNoNewPredecessors</span><span class="token punctuation">(</span><span class="token class-name">JobVertex</span> start<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JobVertex</span><span class="token punctuation">></span></span> target<span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JobVertex</span><span class="token punctuation">></span></span> remaining<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">IntermediateDataSet</span> dataSet <span class="token operator">:</span> start<span class="token punctuation">.</span>results<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">JobEdge</span> edge <span class="token operator">:</span> dataSet<span class="token punctuation">.</span>consumers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 当节点的上游节点都不在remaining中时添加它</span>
                <span class="token class-name">JobVertex</span> v <span class="token operator">=</span> edge<span class="token punctuation">.</span>target<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>remaining<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">boolean</span> hasNewPredecessors <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">JobEdge</span> e <span class="token operator">:</span> v<span class="token punctuation">.</span>inputs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> edge<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token class-name">IntermediateDataSet</span> source <span class="token operator">=</span> e<span class="token punctuation">.</span>source<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>remaining<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>source<span class="token punctuation">.</span>producer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        hasNewPredecessors <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasNewPredecessors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    target<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    remaining<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">addNodesThatHaveNoNewPredecessors</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> target<span class="token punctuation">,</span> remaining<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">JobVertex</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OperatorIDPair</span><span class="token punctuation">></span></span> operatorIDs<span class="token punctuation">;</span>  <span class="token comment">// 节点包含的所有算子Id</span>
    <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IntermediateDataSet</span><span class="token punctuation">></span></span> results<span class="token punctuation">;</span> <span class="token comment">// 生成的中间数据集，每个对应一个writer</span>
    <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JobEdge</span><span class="token punctuation">></span></span> inputs<span class="token punctuation">;</span>   <span class="token comment">// 输入数据源，每个对应要给reader</span>
    <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SerializedValue</span><span class="token punctuation">&lt;</span><span class="token class-name">OperatorCoordinator<span class="token punctuation">.</span>Provider</span><span class="token punctuation">></span><span class="token punctuation">></span></span> operatorCoordinators<span class="token punctuation">;</span>
                                 <span class="token comment">// 算子协调器工厂</span>

    <span class="token class-name">JobEdge</span> <span class="token function">connectNewDataSetAsInput</span><span class="token punctuation">(</span><span class="token class-name">JobVertex</span> input<span class="token punctuation">,</span> <span class="token class-name">DistributionPattern</span> distPattern<span class="token punctuation">,</span> <span class="token class-name">ResultPartitionType</span> partitionType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建JobEdge的输入IntermediateDataSet</span>
        <span class="token class-name">IntermediateDataSet</span> dataSet <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">createAndAddResultDataSet</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IntermediateDataSetID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> partitionType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JobEdge</span> edge <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JobEdge</span><span class="token punctuation">(</span>
            dataSet<span class="token punctuation">,</span>           <span class="token comment">// source: IntermediateDataSet</span>
            <span class="token keyword">this</span><span class="token punctuation">,</span>              <span class="token comment">// target: JobVertex</span>
            distPattern<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// distributionPattern</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>inputs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>edge<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSet<span class="token punctuation">.</span>consumers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>edge<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> edge<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">IntermediateDataSet</span> <span class="token function">createAndAddResultDataSet</span><span class="token punctuation">(</span><span class="token class-name">IntermediateDataSetID</span> id<span class="token punctuation">,</span> <span class="token class-name">ResultPartitionType</span> partitionType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">IntermediateDataSet</span> result <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">IntermediateDataSet</span><span class="token punctuation">(</span>
                id<span class="token punctuation">,</span>               <span class="token comment">// id: IntermediateDataSetID</span>
                partitionType<span class="token punctuation">,</span>    <span class="token comment">// resultType: ResultPartitionType</span>
                <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// producer: JobVertex</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>results<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<h3 id="执行图executiongraph" style="position:relative;"><a href="#%E6%89%A7%E8%A1%8C%E5%9B%BEexecutiongraph" aria-label="执行图executiongraph permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>执行图（ExecutionGraph）</h3>
<div class='wrapper' markdown='block'>
<p><img src="https://www.plantuml.com/plantuml/svg/hLN1Rjim3BthAxJxUjWvWT6k6LeFNLSqnNOeUb0aTjOYImP5RGs6_lkWs5PYMp4wO3U9UY8V7v_bSqy2ATI6iNTKGGtSRu5ajJjpWOosm2gjW4FTq8xNK6y0FVDRRHk1ekONYExtGwNbreBt_0DZsXBWiv30Fxs03AITlKBHLFmFuvppBw9PVdQRRu04B-Ng_G6LeWKduRS-mHCYSwc_0SS1BS5_t9KgPIWZfngK5WGhGM8D5BCSX-_11qC5rvEOpwPfp-u4aevby-dISS5n61ZoI-rS44Mb1oqMN0P4i9GYdhqoQOJt6V4wcG_xd_rgiJyOAVVuj1UxLwt5J1jvVE8DEXKag4w_3dgZFItpEZQX1xMbxWGAOy1eNvVssM4j8WtU3CFjZRLnjAu4QllZ2brek1y5MjYbkt5Ij1QBA3dSjw1xy2wWX3jqpzf0dCJnliza3CXuS_cr0HJayD8vLDh6vRKp2h3WRdha5zDX32OnSU_Gg_1Igj5aJixkVtjmyMy4jINkm-P1-6rfLKzgJN4eUnVTYXg-QwhMOHEte_GJ6n-KcxBknCj-k5ohKu9r9iKJDawjHpyd6NgN70CUTWrqUiNb3DDq9KEvwuKS2TEkSug_cNMvEh0krTHtOyUbruIBRgMo8-U_9W-4myu53W_3xxBSXlWNUBCbHw4LDCRjQh2q0YzHD-ImIA_BiJbVsUWFSdPMP8O-YpeDcR9-6oendAtBCkQS9JQ4pP7BPSk8CPijqqGkBSkO-KJT4yYvqdFVKauhTWvMXThy1G00" alt="plantuml"></p>
</div>
<p>ExecutionGraph是JobGraph的并行化版本，是调度层最核心的数据结构，真正可调度的图结构，包含了作业中所有并行执行的Task信息、Task之间的关联关系、数据流转关系。由ExecutionJobVertex）与ExecutionVertex、IntermediateResult和IntermediateResultPartition、ExecutionEdge、Execution组成</p>
<ul>
<li>ExecutionJobVertex：和JobGraph中的JobVertex一一对应，包含JobVertex并行度数目个ExecutionVertex，以及JobVertex出边数目个IntermediateResult</li>
<li>ExecutionVertex：表示ExecutionJobVertex的一个并发子任务，输入时ExecutionEdge，输出时IntermediateResultPartition</li>
<li>Execution：是ExecutionVertex的一次执行尝试，通过ExecutionAttemptID来唯一标识，JobManager和TaskManager之间Task的部署和状态更新都是通过ExecutionAttemptID来确定消息接收者。在发生故障或者数据需要重算情况下，ExecutionVertex会有多个ExecutionAttemptID</li>
<li>IntermediateResult：和JobGraph中的IntermediateDataSet一一对应，表示ExecutionJobVertex的输出，包含ExecutionJobVertex并行度数目个IntermediateResultPartition</li>
<li>IntermediateResultPartition：表示ExecutionVertex的一个输出分区，生产者是ExecutionVertex，消费者是一个或多个ExecutionEdge</li>
<li>ExecutionEdge：表示ExecutionVertex的输入，主要作用是连接ExecutionVertex和IntermediateResultPartition。一个ExecutionEdge对应唯一一组IntermediateResultPartition和ExecutionVertex</li>
</ul>
<h3 id="物理执行图task-dag" style="position:relative;"><a href="#%E7%89%A9%E7%90%86%E6%89%A7%E8%A1%8C%E5%9B%BEtask-dag" aria-label="物理执行图task dag permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>物理执行图（Task DAG）</h3>
<p>物理执行图是JobManager根据ExecutionGraph调度作业后，在各个TaskManager上部署Task后形成的图，并不是一个具体的数据结构，是物理上各个Task对象的关系拓扑，包含上下游的连接关系、内存中数据的存储、数据的交换等。由任务（Task）、结果分区（ResultPartition）和结果子分区（ResultSubpartition）、输入门（InputGate）和输入通道（InputChannel）组成</p>
<p>TaskInvokable表示TaskManager中运行的任务，包括流式任务和批任务。StreamTask是所有流式任务的基础类，其具体的子类包括SourceStreamTask, OneInputStreamTask, TwoInputStreamTask 等。</p>
<ul>
<li>
<p>Task：Execution被调度后在分配的TaskManager中启动对应的Task，Task包含了具有业务逻辑的Operator</p>
</li>
<li>
<p>ResultPartition：表示由一个Task生成的数据，和是ExecutionGraph中IntermediateResultPartition的运行时实体，二者一一对应。一个结果分区是一组Buffer，这些Buffer根据直接下游子任务并行度和数据分发模式（DistributionPattern）组织成一个或多个ResultSubpartition。有以下几种数据交换模式</p>
  <details>
  <summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ResultPartition</span> <span class="token keyword">implements</span> <span class="token class-name">ResultPartitionWriter</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 结果分区类型，决定使用的结果子分区具体实现</span>
    <span class="token class-name">ResultPartitionType</span> partitionType<span class="token punctuation">;</span>
    <span class="token comment">// 所在TaskManager的ResultPartitionManager，管理其所有ResultPartition</span>
    <span class="token class-name">ResultPartitionManager</span> partitionManager<span class="token punctuation">;</span>
    <span class="token class-name">BufferPool</span> bufferPool<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
  </details>
</li>
<li>
<p>ResultSubPartition：负责存储实际的Buffer，用来进一步切分ResultPartition，每个ResultPartition包含多个ResultSubPartition，其数目由下游Task数目和DistributionPattern决定。下游子任务消费上游子任务产生的结果分区时，实际请求的是结果子分区，请求的方式有远程请求和本地请求两种</p>
<ul>
<li>PipelinedSubpartition对应流模式数据消费，是纯内存型结果子分区，只能被消费一次，当向Pipelinedsubpartition中添加1个完成的BufferConsumer或者添加下一个BufferConsumer时，会通知PipelinedSubpartitionView新数据到达，可以消费了</li>
<li>BoundedBlockingSubpartition批模式数据消费，用作对批处理任务计算结果的数据存储，是阻塞式的，需要等待上游所有的数据处理完毕，然后下游才开始消费数据，可以消费1次或多次，可以保存在文件中或内存映射文件中。</li>
</ul>
</li>
<li>
<p>InputGate：表示Task的输入，用于读取上游任务产生的一个或多个ResultPartition，和JobGraph中JobEdge一一对应，每个InputGate消费一个或多个ResultPartition</p>
<ul>
<li>
<p>SingleInputGate消费ResultPartition，对应于一个IntermediateResult。SingleInputGate内部维护一个队列，形成一个生产者-消费者模型，当InputChannel中有数据时就加入到该队列中，在需要获取数据时从队列中取出一个InputChannel，获取该InputChannel中的数据</p>
</li>
<li>
<p>UnionInputGate将多个InputGate联合起来当作一个InputGate，对应于上游多个输出类型相同的IntermediateResult</p>
</li>
<li>
<p>InputGateWithMetrics是一个InputGate+监控统计，统计InputGate读取的数据量，单位为byte</p>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">SingleInputGate</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> gateIndex<span class="token punctuation">;</span>
    <span class="token class-name">IntermediateDataSetID</span> consumedResultId<span class="token punctuation">;</span>
    <span class="token class-name">ResultPartitionType</span> consumedPartitionType<span class="token punctuation">;</span>
    <span class="token comment">// InputGate包含的InputChannel与对应的IntermediateResultPartition</span>
    <span class="token keyword">int</span> numberOfInputChannels<span class="token punctuation">;</span>
    <span class="token keyword">int</span> consumedSubpartitionIndex<span class="token punctuation">;</span>
    <span class="token class-name">InputChannel</span><span class="token punctuation">[</span><span class="token punctuation">]</span> channels<span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IntermediateResultPartitionID</span><span class="token punctuation">,</span> <span class="token class-name">InputChannel</span><span class="token punctuation">></span></span> inputChannels<span class="token punctuation">;</span>
    <span class="token comment">// 有数据可供消费的InputChannel</span>
    <span class="token class-name">PrioritizedDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InputChannel</span><span class="token punctuation">></span></span> inputChannelsWithData<span class="token punctuation">;</span>
    <span class="token class-name">BitSet</span> enqueuedInputChannelsWithData<span class="token punctuation">;</span>
    <span class="token class-name">BitSet</span> channelsWithEndOfPartitionEvents<span class="token punctuation">;</span>
    <span class="token class-name">BitSet</span> channelsWithEndOfUserRecords<span class="token punctuation">;</span>
    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> lastPrioritySequenceNumber<span class="token punctuation">;</span>
    <span class="token comment">// 用于接收输入的缓冲池</span>
    <span class="token class-name">BufferPool</span> bufferPool<span class="token punctuation">;</span>

    <span class="token comment">// InputChannel有数据时的回调方法</span>
    <span class="token keyword">void</span> <span class="token function">notifyChannelNonEmpty</span><span class="token punctuation">(</span><span class="token class-name">InputChannel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">queueChannel</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">notifyPriorityEvent</span><span class="token punctuation">(</span><span class="token class-name">InputChannel</span> inputChannel<span class="token punctuation">,</span> <span class="token keyword">int</span> prioritySequenceNumber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">queueChannel</span><span class="token punctuation">(</span>inputChannel<span class="token punctuation">,</span> prioritySequenceNumber<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 将新的InputChannel加入队列</span>
    <span class="token keyword">void</span> <span class="token function">queueChannel</span><span class="token punctuation">(</span><span class="token class-name">InputChannel</span> channel<span class="token punctuation">,</span> <span class="token class-name">Integer</span> prioritySequenceNumber<span class="token punctuation">,</span> <span class="token keyword">boolean</span> forcePriority<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// GateNotificationHelper数据可用通知的抽象</span>
        <span class="token class-name">GateNotificationHelper</span> notification <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GateNotificationHelper</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> inputChannelsWithData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> priority <span class="token operator">=</span> prioritySequenceNumber <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> forcePriority<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>forcePriority <span class="token operator">&amp;&amp;</span> priority <span class="token operator">&amp;&amp;</span> prioritySequenceNumber <span class="token operator">&lt;=</span> lastPrioritySequenceNumber<span class="token punctuation">[</span>channel<span class="token punctuation">.</span>channelIndex<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>channelsWithEndOfPartitionEvents<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span>channelIndex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">boolean</span> alreadyEnqueued <span class="token operator">=</span> enqueuedInputChannelsWithData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span>channelIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>alreadyEnqueued <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>priority <span class="token operator">||</span> inputChannelsWithData<span class="token punctuation">.</span><span class="token function">containsPriorityElement</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 已经添加过则忽略</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        inputChannelsWithData<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> priority<span class="token punctuation">,</span> alreadyEnqueued<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>alreadyEnqueued<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            enqueuedInputChannelsWithData<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span>channelIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>priority <span class="token operator">&amp;&amp;</span> inputChannelsWithData<span class="token punctuation">.</span>numPriorityElements <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            notification<span class="token punctuation">.</span><span class="token function">notifyPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>inputChannelsWithData<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果之前inputChannelsWithData队列中没有InputChannel，新加入InputChannel后通知等待的线程</span>
            notification<span class="token punctuation">.</span><span class="token function">notifyDataAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
</li>
</ul>
</li>
<li>
<p>InputChannel：负责实际数据消费，每个InputGate包含多个InputChannel，和ExecutionGraph中的ExecutionEdge一一对应，和ResultSubPartition一对一相连，即一个InputChannel接收一个ResultSubPartition输出。其生命周期按照requestSubpartition(int subpartitionIndex)，getNextBuffer()和releaseAllResources()的顺序进行。根据其消费ResultPartition的位置，分为LocalInputChannel和RemoteInputChannel两种实现</p>
<ul>
<li>
<p>LocalInputChannel对应本地ResultSubpartition，用来在本地进程内不同线程之间的数据交换。LocalInputChannel调用SingleInputGate的notifyChannelNonEmpty(inputChannel)方法，这个方法调用inputChannelsWithData对象的notifyAll()方法，唤醒阻塞在inputChannelsWithData对象的所有实例</p>
</li>
<li>
<p>RemoteInputChannel对应远程ResultSubpartition，用来表示跨网络的数据交换，底层基于Netty</p>
</li>
<li>
<p>UnknownInputCHannel是还未确定ResultSubpartition位置时的占位符，最终会更新为RemoteInputChannel或LocalInputChannel</p>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">InputChannel</span> <span class="token punctuation">{</span>
    <span class="token class-name">InputChannelInfo</span> channelInfo<span class="token punctuation">;</span>
    <span class="token comment">// 对应的ResultPartition</span>
    <span class="token class-name">ResultPartitionID</span> partitionId<span class="token punctuation">;</span>
    <span class="token class-name">SingleInputGate</span> inputGate<span class="token punctuation">;</span>
    <span class="token comment">// 通知所属InputGate该InputChannel有可用数据</span>
    <span class="token comment">// 仅当向空InputChannel添加Buffer时调用</span>
    <span class="token keyword">void</span> <span class="token function">notifyChannelNonEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        inputGate<span class="token punctuation">.</span><span class="token function">notifyChannelNonEmpty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">notifyPriorityEvent</span><span class="token punctuation">(</span><span class="token keyword">int</span> priorityBufferNumber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        inputGate<span class="token punctuation">.</span><span class="token function">notifyPriorityEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> priorityBufferNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 请求ResultSubpartition</span>
    <span class="token keyword">void</span> <span class="token function">requestSubpartition</span><span class="token punctuation">(</span><span class="token keyword">int</span> subpartitionIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取对应ResultSubpartition的下一个Buffer</span>
    <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BufferAndAvailability</span><span class="token punctuation">></span></span> <span class="token function">getNextBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 向对应ResultSubpartition所属的任务发送事件</span>
    <span class="token keyword">void</span> <span class="token function">sendTaskEvent</span><span class="token punctuation">(</span><span class="token class-name">TaskEvent</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Checkpoint开始时调用</span>
    <span class="token keyword">void</span> <span class="token function">checkpointStarted</span><span class="token punctuation">(</span><span class="token class-name">CheckpointBarrier</span> barrier<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token comment">// Checkpoint取消/完成时调用来清理临时数据</span>
    <span class="token keyword">void</span> <span class="token function">checkpointStopped</span><span class="token punctuation">(</span><span class="token keyword">long</span> checkpointId<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
</li>
</ul>
</li>
</ul>
<h2 id="启动flink集群" style="position:relative;"><a href="#%E5%90%AF%E5%8A%A8flink%E9%9B%86%E7%BE%A4" aria-label="启动flink集群 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>启动Flink集群</h2>
<p>Flink Client通过YARN Client向YARN ResourceManager申请创建YARN ApplicationMaster，即JobManager。具体流程为：</p>
<ol>
<li>Flink Client将Flink配置文件（flink-conf.yaml、logback.xml、log4j.properties）上传至分布式存储的应用暂存目录（/user/${user.name}/.flink），准备ApplicationSubmissionContext（包括应用的名称、类型、队列、标签等信息和ApplicationMaster容器的环境变量、classpath、资源大小等），注册处理部署失败的钩子函数（清理对应的HDFS目录），然后通过YARN Client向YARN ResourceManager提交应用</li>
<li>YARN ResourceManager中的ClientRMService<sup id="fnref-2"><a href="#fn-2" class="footnote-ref">2</a></sup>接收到应用提交请求，简单校验后将请求转交给RMAppManager<sup id="fnref-3"><a href="#fn-3" class="footnote-ref">3</a></sup></li>
<li>RMAppManager根据应用提交上下文内容创建初始状态为NEW的应用，将应用持久化到ResourceManager状态存储服务<sup id="fnref-4"><a href="#fn-4" class="footnote-ref">4</a></sup>，应用状态变为NEW_SAVING</li>
<li>应用状态存储完成后，应用状态变为SUBMITTED，RMAppManager开始向ResourceScheduler<sup id="fnref-5"><a href="#fn-5" class="footnote-ref">5</a></sup>提交应用，如果无法正常提交则拒绝该应用，应用状态先变为FINAL_SAVING触发应用状态存储流程并在完成后变为FAILED；如果提交成功，应用状态变为ACCEPTED</li>
<li>开始创建应用运行实例，初始状态为NEW</li>
<li>初始化应用运行实例信息，并向ApplicationMasterService<sup id="fnref-6"><a href="#fn-6" class="footnote-ref">6</a></sup>注册，应用实例状态变为SUBMITTED</li>
<li>RMAppManager维护的应用实例开始初始化ApplicationMaster资源申请信息，向ResourceScheduler申请ApplicationMaster Container，应用实例状态变为ACCEPTED</li>
<li>ResourceScheduler会根据优先级从根队列开始层层递进，先后选择当前优先级最高的子队列、应用直至具体某个请求，然后结合集群资源分布等情况作出分配决策，ApplicationMaster Container分配成功后，应用实例状态变为ALLOCATED_SAVING，并触发应用实例状态存储流程，存储成功后应用实例状态变为ALLOCATED</li>
<li>ResourceManager维护的应用实例开始通知ApplicationMasterLauncher<sup id="fnref-7"><a href="#fn-7" class="footnote-ref">7</a></sup>启动ApplicationMaster Container，ApplicationMasterLauncher与YARN NodeManager<sup id="fnref-8"><a href="#fn-8" class="footnote-ref">8</a></sup>建立通信并请求启动ApplicationMaster Container</li>
<li>ContainerManager<sup id="fnref-9"><a href="#fn-9" class="footnote-ref">9</a></sup>接收到ApplicationMaster Container启动请求，YARN NodeManager开始校验Container Token及资源文件，创建应用实例和Container实例并存储至本地，结果返回后应用实例变为LAUNCHED</li>
<li>ResourceLocalization<sup id="fnref-10"><a href="#fn-10" class="footnote-ref">10</a></sup>初始化各种服务组件、创建工作目录、从HDFS下载运行所需的各种资源至Container工作目录</li>
<li>ContainersLauncher<sup id="fnref-11"><a href="#fn-11" class="footnote-ref">11</a></sup>将待运行Container所需的环境变量和运行命令写到Container工作目录下的launch_container.sh脚本中，然后运行该脚本启动Container</li>
<li>Container进程加载并运行ClusterEntrypoint，ClusterEntrypoint初始化相关运行环境，如从运行目录加载flink配置、初始化文件系统、创建并启动各类内部服务（包括RpcService、HAService、BlobService、HeartbeatService、MetricRegistry、ExecutionGraphStore等）、将RPC地址和端口更新到Flink配置。ClusterEntrypoint是Flink JobManager入口类，每种集群部署模式和应用运行模式都有相应的实现，如YARN Per-Job模式下为YarnJobClusterEntrypoint，YARN Session模式下为YarnSessionClusterEntrypoint</li>
<li>启动ResourceManager及相关服务，创建异步AMRM Client，开始注册AM，注册成功后每隔一段时间（心跳间隔yarn.heartbeat.interval，默认为5s）向YARN ResourceManager发送心跳来发送资源更新请求和接受资源变更结果，YARN ResourceManager内部该应用和应用运行实例的状态都变为RUNNING，并通知AMLivelinessMonitor服务监控ApplicationMaster是否存活状态，当心跳超过一定时间（默认10min）触发ApplicaitonMaster failover流程。ResourceManager是Flink资源管理核心组件，包括YarnResourceManager和SlotManager两个子组件，YarnResourceManager负责外部资源管理，与YARN ResourceManager建立通信并保持心跳，申请或释放TaskManager资源，SlotManager负责内部资源管理，维护全部Slot信息和状态</li>
<li>启动Dispatcher及相关服务。Dispatcher负责接收用户提供的作业，并且负责为这个新提交的作业创建并启动一个新的JobMaster</li>
</ol>
<h2 id="作业提交" style="position:relative;"><a href="#%E4%BD%9C%E4%B8%9A%E6%8F%90%E4%BA%A4" aria-label="作业提交 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>作业提交</h2>
<p>在Flink Client中经过DataStream API -> Transformation -> StreamGraph -> JobGraph的转换，将JobGraph提交到Dispatcher。</p>
<p>作业提交入口为CliFrontend，其通过反射机制触发Flink应用Jar文件中的main()方法，Stream API组装成Transformation树，最后调用StreamExecutionEnvironment的execute()方法提交Flink作业运行。</p>
<p>按照Flink客户端提交作业之后客户端进程是否结束，作业提交模式分为：</p>
<ul>
<li>Detached模式：Flink客户端创建完Flink集群后结束，Flink集群独立运行</li>
<li>Attached模式：Flink客户端创建完Flink集群后继续运行，需要与Flink集群之间维持连接</li>
</ul>
<p>YARN PerJob模式下，Flink作业提交的具体步骤为：</p>
<ol>
<li>bin/flink run提交作业，脚本内执行Java类CliFrontend</li>
<li>CliFrontend加载配置和命令行参数，生成Configuration和PackagedProgram对象
<ol>
<li>获取配置文件目录</li>
<li>从配置文件目录中加载配置文件并解析命令行参数融合生成Configuration，由Configuration构建PackagedProgram（包含Flink作业的Jar文件、入口类等信息）</li>
<li>通过ClientUtils设置用户程序的执行环境ContextEnvironment和StreamContextEnvironment，包括PipelineExecutorServiceLoader（用于找到PipelineExecutorFactory）、Configuration和ClassLoader（用户指定的ClassLoader）</li>
<li>设置当前线程ClassLoader为用户指定的ClassLoader，执行PackagedProgram，执行完后重置当前线程ClassLoader</li>
</ol>
</li>
<li>PackagedProgram通过反射方式调用Flink作业入口类的main方法，执行用户程序</li>
<li>用户程序执行，构建Pipeline（流模式Pipeline实现类是StreamGraph），触发StreamExecutionEnvironment的execute()方法</li>
<li>找到匹配的流水线执行器（PipelineExecutor）。PipelineExecutor用于将作业提交给Flink集群，不同的实现对应不同的集群模式。StreamExecutionEnvironment通过PipelineExecutorServiceLoader找到PipelineExecutorFactory，PipelineExecutorServiceLoader先以SPI的方式加载PipelineExecutorFactory，再选择与Configuration配置兼容的Factory
<ul>
<li>AbstractSessionClusterExecutor对应Session模式，具体实现包括YarnSessionClusterExecutor、KubernetesSessionClusterExecutor</li>
<li>AbstractJobClusterExecutor对应Per-Job模式，具体实现有YarnJobClusterExecutor</li>
<li>LocalExecutor对应本地模式（MiniCluster）</li>
</ul>
</li>
<li>执行Pipeline。先构建JobGraph，再创建ClusterDescriptor来部署Flink集群，接着向Flink集群提交JobGraph，Flink集群开始调度执行JobGraph。调用StreamGraph的getJobGraph()方法获取JobGraph（并设置Jar文件、类路径、保存点恢复配置信息），通过ClientFactory创建对应的ClusterDescriptor并从Configuration中获取ClusterSpecification（集群描述信息，包括JobManager和TaskManager内存大小以及Slot个数），ClusterDescriptor根据JobGraph、ClusterSpecification、作业提交模式部署集群。</li>
</ol>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">CliFrontend</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 获取配置文件目录</span>
        <span class="token class-name">String</span> configurationDirectory <span class="token operator">=</span> <span class="token function">getConfigurationDirectoryFromEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 加载全局配置</span>
        <span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> <span class="token class-name">GlobalConfiguration</span><span class="token punctuation">.</span><span class="token function">loadConfiguration</span><span class="token punctuation">(</span>configurationDirectory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 加载自定义命令行</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CustomCommandLine</span><span class="token punctuation">></span></span> customCommandLines <span class="token operator">=</span> <span class="token function">loadCustomCommandLines</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> configurationDirectory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CliFrontend</span> cli <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CliFrontend</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> customCommandLines<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> retCode <span class="token operator">=</span> cli<span class="token punctuation">.</span><span class="token function">parseAndRun</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span>retCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> <span class="token function">parseAndRun</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> action <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> params <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOfRange</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token constant">ACTION_RUN</span><span class="token operator">:</span> <span class="token function">run</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Options</span> commandOptions <span class="token operator">=</span> <span class="token class-name">CliFrontendParser</span><span class="token punctuation">.</span><span class="token function">getRunCommandOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CommandLine</span> commandLine <span class="token operator">=</span> <span class="token function">getCommandLine</span><span class="token punctuation">(</span>commandOptions<span class="token punctuation">,</span> args<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CustomCommandLine</span> activeCommandLine <span class="token operator">=</span> <span class="token function">validateAndGetActiveCommandLine</span><span class="token punctuation">(</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>commandLine<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ProgramOptions</span> programOptions <span class="token operator">=</span> <span class="token class-name">ProgramOptions</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>commandLine<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">></span></span> jobJars <span class="token operator">=</span> <span class="token function">getJobJarAndDependencies</span><span class="token punctuation">(</span>programOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Configuration</span> effectiveConfiguration <span class="token operator">=</span> <span class="token function">getEffectiveConfiguration</span><span class="token punctuation">(</span>activeCommandLine<span class="token punctuation">,</span> commandLine<span class="token punctuation">,</span> programOptions<span class="token punctuation">,</span> jobJars<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PackagedProgram</span> program <span class="token operator">=</span> <span class="token function">getPackagedProgram</span><span class="token punctuation">(</span>programOptions<span class="token punctuation">,</span> effectiveConfiguration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClientUtils</span><span class="token punctuation">.</span><span class="token function">executeProgram</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">DefaultExecutorServiceLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// executorServiceLoader</span>
            effectiveConfiguration<span class="token punctuation">,</span>              <span class="token comment">// configuration</span>
            program<span class="token punctuation">,</span>
            <span class="token boolean">false</span><span class="token punctuation">,</span>                               <span class="token comment">// enforceSingleJobExecution</span>
            <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                              <span class="token comment">// suppressSysout</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">enum</span> <span class="token class-name">ClientUtils</span> <span class="token punctuation">{</span>
<span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">executeProgram</span><span class="token punctuation">(</span>
        <span class="token class-name">PipelineExecutorServiceLoader</span> executorServiceLoader<span class="token punctuation">,</span>
        <span class="token class-name">Configuration</span> configuration<span class="token punctuation">,</span>
        <span class="token class-name">PackagedProgram</span> program<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> enforceSingleJobExecution<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> suppressSysout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ClassLoader</span> userCodeClassLoader <span class="token operator">=</span> program<span class="token punctuation">.</span><span class="token function">getUserCodeClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClassLoader</span> contextClassLoader <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置当前线程ClassLoader为用户指定ClassLoader</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setContextClassLoader</span><span class="token punctuation">(</span>userCodeClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置ContextEnvironment和StreamContextEnvironment，包括PipelineExecutorServiceLoader、Configuration、ClassLoader</span>
        <span class="token class-name">ContextEnvironment</span><span class="token punctuation">.</span><span class="token function">setAsContext</span><span class="token punctuation">(</span>executorServiceLoader<span class="token punctuation">,</span> configuration<span class="token punctuation">,</span> userCodeClassLoader<span class="token punctuation">,</span> enforceSingleJobExecution<span class="token punctuation">,</span> suppressSysout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">StreamContextEnvironment</span><span class="token punctuation">.</span><span class="token function">setAsContext</span><span class="token punctuation">(</span>executorServiceLoader<span class="token punctuation">,</span> configuration<span class="token punctuation">,</span> userCodeClassLoader<span class="token punctuation">,</span> enforceSingleJobExecution<span class="token punctuation">,</span> suppressSysout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// PackagedProgram通过反射调用Flink作业入口类的main()方法执行用户程序</span>
        program<span class="token punctuation">.</span><span class="token function">callMainMethod</span><span class="token punctuation">(</span>
            program<span class="token punctuation">.</span>mainClass<span class="token punctuation">,</span>      <span class="token comment">// entryClass</span>
            program<span class="token punctuation">.</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// args</span>
        <span class="token class-name">ContextEnvironment</span><span class="token punctuation">.</span><span class="token function">unsetAsContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">StreamContextEnvironment</span><span class="token punctuation">.</span><span class="token function">unsetAsContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setContextClassLoader</span><span class="token punctuation">(</span>contextClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">PackagedProgram</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">callMainMethod</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> entryClass<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Method</span> mainMethod<span class="token punctuation">;</span>
        mainMethod <span class="token operator">=</span> entryClass<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"main"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mainMethod<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">)</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">StreamExecutionEnvironment</span>
<span class="token punctuation">{</span>
    <span class="token class-name">JobExecutionResult</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">String</span> jobName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StreamGraph</span> streamGraph <span class="token operator">=</span> <span class="token function">getStreamGraph</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        streamGraph<span class="token punctuation">.</span><span class="token function">setJobName</span><span class="token punctuation">(</span>jobName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">execute</span><span class="token punctuation">(</span>streamGraph<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">JobExecutionResult</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">StreamGraph</span> streamGraph<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">JobClient</span> jobClient <span class="token operator">=</span> <span class="token function">executeAsync</span><span class="token punctuation">(</span>streamGraph<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JobExecutionResult</span> jobExecutionResult<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>configuration<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token class-name">DeploymentOptions</span><span class="token punctuation">.</span><span class="token constant">ATTACHED</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            jobExecutionResult <span class="token operator">=</span> jobClient<span class="token punctuation">.</span><span class="token function">getJobExecutionResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            jobExecutionResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DetachedJobExecutionResult</span><span class="token punctuation">(</span>jobClient<span class="token punctuation">.</span>jobID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        jobListeners<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>jobListener <span class="token operator">-></span> jobListener<span class="token punctuation">.</span><span class="token function">onJobExecuted</span><span class="token punctuation">(</span>jobExecutionResult<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> jobExecutionResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">JobClient</span> <span class="token function">executeAsync</span><span class="token punctuation">(</span><span class="token class-name">StreamGraph</span> streamGraph<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 通过PipelineExecutorServiceLoader找到流水线执行器（PipelineExecutor），PipelineExecutorServiceLoader先以SPI的方式加载PipelineExecutorFactory，再选择与Configuration配置兼容的Factory</span>
        <span class="token comment">// 流水线执行器用于将作业提交给Flink集群</span>
        <span class="token comment">// AbstractSessionClusterExecutor对应Session模式</span>
        <span class="token comment">// AbstractJobClusterExecutor对应Per-Job模式</span>
        <span class="token comment">// LocalExecutor对应本地模式（MiniCluster）</span>
        <span class="token class-name">PipelineExecutorFactory</span> executorFactory <span class="token operator">=</span> executorServiceLoader<span class="token punctuation">.</span><span class="token function">getExecutorFactory</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JobClient</span> jobClient <span class="token operator">=</span> executorFactory
            <span class="token punctuation">.</span><span class="token function">getExecutor</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>streamGraph<span class="token punctuation">,</span> configuration<span class="token punctuation">,</span> userClassloader<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jobListeners<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>jobListener <span class="token operator">-></span> jobListener<span class="token punctuation">.</span><span class="token function">onJobSubmitted</span><span class="token punctuation">(</span>jobClient<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> jobClient<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">AbstractJobClusterExecutor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClusterID</span><span class="token punctuation">,</span> <span class="token class-name">ClientFactory</span> <span class="token keyword">extends</span> <span class="token class-name">ClusterClientFactory</span><span class="token punctuation">&lt;</span><span class="token class-name">ClusterID</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">PipelineExecutor</span>
<span class="token punctuation">{</span>
    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JobClient</span><span class="token punctuation">></span></span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Pipeline</span> pipeline<span class="token punctuation">,</span> <span class="token class-name">Configuration</span> configuration<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> userCodeClassloader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 生成JobGraph</span>
        <span class="token class-name">JobGraph</span> jobGraph <span class="token operator">=</span> <span class="token class-name">PipelineExecutorUtils</span><span class="token punctuation">.</span><span class="token function">getJobGraph</span><span class="token punctuation">(</span>pipeline<span class="token punctuation">,</span> configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 构建YARN ClusterDescriptor</span>
        <span class="token class-name">ClusterDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClusterID</span><span class="token punctuation">></span></span> clusterDescriptor <span class="token operator">=</span> clusterClientFactory<span class="token punctuation">.</span><span class="token function">createClusterDescriptor</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ExecutionConfigAccessor</span> configAccessor <span class="token operator">=</span> <span class="token class-name">ExecutionConfigAccessor</span><span class="token punctuation">.</span><span class="token function">fromConfiguration</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClusterSpecification</span> clusterSpecification <span class="token operator">=</span> clusterClientFactory<span class="token punctuation">.</span><span class="token function">getClusterSpecification</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClusterClientProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClusterID</span><span class="token punctuation">></span></span> clusterClientProvider <span class="token operator">=</span> clusterDescriptor<span class="token punctuation">.</span><span class="token function">deployJobCluster</span><span class="token punctuation">(</span>clusterSpecification<span class="token punctuation">,</span> jobGraph<span class="token punctuation">,</span> configAccessor<span class="token punctuation">.</span><span class="token function">getDetachedMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClusterClientJobClientAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>clusterClientProvider<span class="token punctuation">,</span> jobGraph<span class="token punctuation">.</span><span class="token function">getJobID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userCodeClassloader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">YarnClusterDescriptor</span> <span class="token keyword">implements</span> <span class="token class-name">ClusterDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApplicationId</span><span class="token punctuation">></span></span>
<span class="token punctuation">{</span>
    <span class="token class-name">ClusterClientProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApplicationId</span><span class="token punctuation">></span></span> <span class="token function">deployJobCluster</span><span class="token punctuation">(</span><span class="token class-name">ClusterSpecification</span> clusterSpecification<span class="token punctuation">,</span> <span class="token class-name">JobGraph</span> jobGraph<span class="token punctuation">,</span> <span class="token keyword">boolean</span> detached<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">deployInternal</span><span class="token punctuation">(</span>
                clusterSpecification<span class="token punctuation">,</span>              <span class="token comment">// clusterSpecification</span>
                <span class="token string">"Flink per-job cluster"</span><span class="token punctuation">,</span>           <span class="token comment">// applicationName</span>
                <span class="token class-name">YarnJobClusterEntrypoint</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                   <span class="token comment">// yarnClusterEntrypoint</span>
                jobGraph<span class="token punctuation">,</span>
                detached<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">ClusterClientProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApplicationId</span><span class="token punctuation">></span></span> <span class="token function">deployInternal</span><span class="token punctuation">(</span>
        <span class="token class-name">ClusterSpecification</span> clusterSpecification<span class="token punctuation">,</span>
        <span class="token class-name">String</span> applicationName<span class="token punctuation">,</span>
        <span class="token class-name">String</span> yarnClusterEntrypoint<span class="token punctuation">,</span>
        <span class="token class-name">JobGraph</span> jobGraph<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> detached<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">UserGroupInformation</span> currentUser <span class="token operator">=</span> <span class="token class-name">UserGroupInformation</span><span class="token punctuation">.</span><span class="token function">getCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Create application via yarnClient</span>
        <span class="token comment">// 通过YARN Client创建YARN应用</span>
        <span class="token class-name">YarnClientApplication</span> yarnApplication <span class="token operator">=</span> yarnClient<span class="token punctuation">.</span><span class="token function">createApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">GetNewApplicationResponse</span> appResponse <span class="token operator">=</span> yarnApplication<span class="token punctuation">.</span><span class="token function">getNewApplicationResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Resource</span> maxRes <span class="token operator">=</span> appResponse<span class="token punctuation">.</span><span class="token function">getMaximumResourceCapability</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ClusterResourceDescription</span> freeClusterMem <span class="token operator">=</span> <span class="token function">getCurrentFreeClusterResources</span><span class="token punctuation">(</span>yarnClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> yarnMinAllocationMB <span class="token operator">=</span> yarnConfiguration<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token class-name">YarnConfiguration</span><span class="token punctuation">.</span><span class="token constant">RM_SCHEDULER_MINIMUM_ALLOCATION_MB</span><span class="token punctuation">,</span> <span class="token class-name">YarnConfiguration</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_RM_SCHEDULER_MINIMUM_ALLOCATION_MB</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClusterSpecification</span> validClusterSpecification <span class="token operator">=</span> <span class="token function">validateClusterResources</span><span class="token punctuation">(</span>clusterSpecification<span class="token punctuation">,</span> yarnMinAllocationMB<span class="token punctuation">,</span> maxRes<span class="token punctuation">,</span> freeClusterMem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClusterEntrypoint<span class="token punctuation">.</span>ExecutionMode</span> executionMode <span class="token operator">=</span> detached
            <span class="token operator">?</span> <span class="token class-name">ClusterEntrypoint<span class="token punctuation">.</span>ExecutionMode</span><span class="token punctuation">.</span><span class="token constant">DETACHED</span>
            <span class="token operator">:</span> <span class="token class-name">ClusterEntrypoint<span class="token punctuation">.</span>ExecutionMode</span><span class="token punctuation">.</span><span class="token constant">NORMAL</span><span class="token punctuation">;</span>

        flinkConfiguration<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token class-name">ClusterEntrypoint</span><span class="token punctuation">.</span><span class="token constant">INTERNAL_CLUSTER_EXECUTION_MODE</span><span class="token punctuation">,</span> executionMode<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 将JobGraph、应用配置文件（flink-conf.yaml、logback.xml、log4j.properties）和相关文件（Flink Jar文件、配置类文件、用户Jar文件、JobGraph对象等）上传至分布式存储的应用暂存目录</span>
        <span class="token comment">// 设置集群HA信息</span>
        <span class="token comment">// 设置ApplicationSubmissionContext</span>
        <span class="token comment">// 提交YARN Application</span>
        <span class="token comment">// 循环等待提交结果</span>
        <span class="token class-name">ApplicationReport</span> report <span class="token operator">=</span> <span class="token function">startAppMaster</span><span class="token punctuation">(</span>
            flinkConfiguration<span class="token punctuation">,</span>
            applicationName<span class="token punctuation">,</span>
            yarnClusterEntrypoint<span class="token punctuation">,</span>
            jobGraph<span class="token punctuation">,</span>
            yarnClient<span class="token punctuation">,</span>
            yarnApplication<span class="token punctuation">,</span>
            validClusterSpecification<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 从ApplicationReport中获取RPC和REST的地址和端口信息、ApplicationID设置到Configuration</span>
        <span class="token function">setClusterEntrypointInfoToConfig</span><span class="token punctuation">(</span>report<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestClusterClient</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>flinkConfiguration<span class="token punctuation">,</span> report<span class="token punctuation">.</span><span class="token function">getApplicationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<h3 id="datastream-api转换成transformation" style="position:relative;"><a href="#datastream-api%E8%BD%AC%E6%8D%A2%E6%88%90transformation" aria-label="datastream api转换成transformation permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>DataStream API转换成Transformation</h3>
<p>以Map转换为例说明DataStream API转换为Transformation的过程。DataStream的map()方法将用户自定义函数MapFunction包装到StreamOperator中（具体为StreamMap的成员变量userFunction），再将StreamOperator包装到OneInputTransformation中（operatorFactory成员变量），最后将该Transformation保存到ExecutionEnvironment中，当调用ExecutionEnvironment的execute()方法时，遍历其transformations构造StreamGraph。</p>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span>
<span class="token punctuation">{</span>
    <span class="token comment">// map转换</span>
    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">></span></span> <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">></span></span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">MapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">></span></span> mapper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 通过Java反射抽出mapper的返回值类型</span>
        <span class="token class-name">TypeInformation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">></span></span> outputType <span class="token operator">=</span> <span class="token class-name">TypeExtractor</span><span class="token punctuation">.</span><span class="token function">getMapReturnTypes</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 返回一个新的DataStream，StreamMap为StreamOperator实现类</span>
        <span class="token keyword">return</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token string">"Map"</span><span class="token punctuation">,</span> outputType<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StreamMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token function">clean</span><span class="token punctuation">(</span>mapper<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 转换操作</span>
    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">></span></span> <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">></span></span> <span class="token function">transform</span><span class="token punctuation">(</span>
        <span class="token class-name">String</span> operatorName<span class="token punctuation">,</span>
        <span class="token class-name">TypeInformation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">></span></span> outTypeInfo<span class="token punctuation">,</span>
        <span class="token class-name">OneInputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">></span></span> operator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">doTransform</span><span class="token punctuation">(</span>
            operatorName<span class="token punctuation">,</span>
            outTypeInfo<span class="token punctuation">,</span>
            <span class="token class-name">SimpleOperatorFactory</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>operator<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">></span></span> <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">></span></span> <span class="token function">doTransform</span><span class="token punctuation">(</span>
        <span class="token class-name">String</span> operatorName<span class="token punctuation">,</span>
        <span class="token class-name">TypeInformation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">></span></span> outTypeInfo<span class="token punctuation">,</span>
        <span class="token class-name">StreamOperatorFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">></span></span> operatorFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        transformation<span class="token punctuation">.</span><span class="token function">getOutputType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 新Transformation会连接上当前DataStream中的Transformation，从而构建成一棵树</span>
        <span class="token class-name">OneInputTransformation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">></span></span> resultTransform <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">OneInputTransformation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>transformation<span class="token punctuation">,</span>                 <span class="token comment">// input</span>
                operatorName<span class="token punctuation">,</span>                        <span class="token comment">// name</span>
                operatorFactory<span class="token punctuation">,</span>                     <span class="token comment">// operatorFactory</span>
                outTypeInfo<span class="token punctuation">,</span>                         <span class="token comment">// outputType</span>
                environment<span class="token punctuation">.</span><span class="token function">getParallelism</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// parallelism</span>
        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">></span></span> returnStream <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">SingleOutputStreamOperator</span><span class="token punctuation">(</span>
                environment<span class="token punctuation">,</span>                         <span class="token comment">// environment</span>
                resultTransform<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// transformation</span>
        <span class="token comment">// 所有Transformation都会存到StreamExecutionEnvironment中，调用StreamExecutionEnvironment的execute()方法时遍历该list生成StreamGraph</span>
        <span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>transformations<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>resultTransform<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> returnStream<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<h3 id="transformations转换成streamgraph" style="position:relative;"><a href="#transformations%E8%BD%AC%E6%8D%A2%E6%88%90streamgraph" aria-label="transformations转换成streamgraph permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Transformations转换成StreamGraph</h3>
<p>StreamGraph在Flink Client（CliFrontend）生成，具体生成逻辑在StreamGraphGenerator的generate()方法中。generate()方法递归调用transform()方法自下（SinkTransformation）向上（SourceTransformation）遍历transformations，同时构建StreamGraph。遍历transformations时，对不同类型的Transformation分别调用对应的转换方法。对于不包含物理转换操作的Transformation（如PartitionTransformation、UnionTransformation、SideOutputTransformation），并不会生成StreamNode，而是生成一个带有特定属性的虚拟顶点。对于包含物理转换操作的Transformation，会转换为StreamNode，并构造出StreamEdge与上游顶点进行连接，如果上游顶点是虚拟顶点，则会递归取上游顶点并把虚拟转换操作的相关信息写入StreamEdge中。这样就构造了StreamGraph。</p>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">StreamExecutionEnvironment</span> <span class="token punctuation">{</span>
    <span class="token class-name">StreamGraphGenerator</span> <span class="token function">getStreamGraphGenerator</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Transformation</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">></span></span> transformations<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StreamGraphGenerator</span><span class="token punctuation">(</span>transformations<span class="token punctuation">,</span> config<span class="token punctuation">,</span> checkpointCfg<span class="token punctuation">,</span> configuration<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setStateBackend</span><span class="token punctuation">(</span>defaultStateBackend<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setChangelogStateBackendEnabled</span><span class="token punctuation">(</span>changelogStateBackendEnabled<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setSavepointDir</span><span class="token punctuation">(</span>defaultSavepointDirectory<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setChaining</span><span class="token punctuation">(</span>isChainingEnabled<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setUserArtifacts</span><span class="token punctuation">(</span>cacheFile<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setTimeCharacteristic</span><span class="token punctuation">(</span>timeCharacteristic<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setDefaultBufferTimeout</span><span class="token punctuation">(</span>bufferTimeout<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setSlotSharingGroupResource</span><span class="token punctuation">(</span>slotSharingGroupResources<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">StreamGraphGenerator</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Transformation</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">></span></span> transformations<span class="token punctuation">;</span>
    <span class="token class-name">StreamGraph</span> streamGraph<span class="token punctuation">;</span>
    <span class="token comment">// 存储不同Transformation的转换类</span>
    <span class="token comment">//  translatorMap.put(OneInputTransformation.class, new OneInputTransformationTranslator&lt;>());</span>
    <span class="token comment">//  translatorMap.put(TwoInputTransformation.class, new TwoInputTransformationTranslator&lt;>());</span>
    <span class="token comment">//  translatorMap.put(MultipleInputTransformation.class, new MultiInputTransformationTranslator&lt;>());</span>
    <span class="token comment">//  translatorMap.put(KeyedMultipleInputTransformation.class, new MultiInputTransformationTranslator&lt;>());</span>
    <span class="token comment">//  translatorMap.put(SourceTransformation.class, new SourceTransformationTranslator&lt;>());</span>
    <span class="token comment">//  translatorMap.put(SinkTransformation.class, new SinkTransformationTranslator&lt;>());</span>
    <span class="token comment">//  translatorMap.put(LegacySinkTransformation.class, new LegacySinkTransformationTranslator&lt;>());</span>
    <span class="token comment">//  translatorMap.put(LegacySourceTransformation.class, new LegacySourceTransformationTranslator&lt;>());</span>
    <span class="token comment">//  translatorMap.put(UnionTransformation.class, new UnionTransformationTranslator&lt;>());</span>
    <span class="token comment">//  translatorMap.put(PartitionTransformation.class, new PartitionTransformationTranslator&lt;>());</span>
    <span class="token comment">//  translatorMap.put(SideOutputTransformation.class, new SideOutputTransformationTranslator&lt;>());</span>
    <span class="token comment">//  translatorMap.put(ReduceTransformation.class, new ReduceTransformationTranslator&lt;>());</span>
    <span class="token comment">//  translatorMap.put(TimestampsAndWatermarksTransformation.class, new TimestampsAndWatermarksTransformationTranslator&lt;>());</span>
    <span class="token comment">//  translatorMap.put(BroadcastStateTransformation.class, new BroadcastStateTransformationTranslator&lt;>());</span>
    <span class="token comment">//  translatorMap.put(KeyedBroadcastStateTransformation.class, new KeyedBroadcastStateTransformationTranslator&lt;>());</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Transformation</span><span class="token punctuation">></span><span class="token punctuation">,</span> <span class="token class-name">TransformationTranslator</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Transformation</span><span class="token punctuation">></span><span class="token punctuation">></span></span> translatorMap<span class="token punctuation">;</span>
    <span class="token comment">// 从sink到source对所有Transformation进行转换</span>
    <span class="token class-name">StreamGraph</span> <span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        streamGraph <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StreamGraph</span><span class="token punctuation">(</span>executionConfig<span class="token punctuation">,</span> checkpointConfig<span class="token punctuation">,</span> savepointRestoreSettings<span class="token punctuation">)</span><span class="token punctuation">;</span>
        alreadyTransformed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Transformation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> transformation <span class="token operator">:</span> transformations<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">transform</span><span class="token punctuation">(</span>transformation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> streamGraph<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 对一个具体的Transformation进行转换，转换成StreamGraph中的StreamNode和StreamEdge</span>
    <span class="token comment">// 返回值为该Transformation的id集合，一般大小为1（除FeedbackTransformation）</span>
    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">Transformation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> transform<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 跳过已经转换过的Transformation</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>alreadyTransformed<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>transform<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> alreadyTransformed<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>transform<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 获取对应的Translator</span>
        <span class="token class-name">TransformationTranslator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token class-name">Transformation</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">></span></span> translator <span class="token operator">=</span>
            <span class="token punctuation">(</span><span class="token class-name">TransformationTranslator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token class-name">Transformation</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token punctuation">)</span> translatorMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>transform<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> transformedIds<span class="token punctuation">;</span>
        <span class="token comment">// 递归对该Transform的直接上游Transform进行转换，获得直接上游id集合</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Collection</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span><span class="token punctuation">></span></span> allInputIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Transformation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> transformation <span class="token operator">:</span> parentTransformations<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            allInputIds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">transform</span><span class="token punctuation">(</span>transformation<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 防止重复转换，如果已经递归转换过了则直接返回转换的结果</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>alreadyTransformed<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>transform<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            transformedIds <span class="token operator">=</span> alreadyTransformed<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>transform<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 确定slotSharingGroup，默认是DEFAULT_SLOT_SHARING_GROUP</span>
            <span class="token class-name">String</span> specifiedGroup <span class="token operator">=</span>
                transform<span class="token punctuation">.</span>slotSharingGroup<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">?</span> transform<span class="token punctuation">.</span>slotSharingGroup<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> inputIds <span class="token operator">=</span>
                allInputIds<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token operator">::</span><span class="token function">stream</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> slotSharingGroup <span class="token operator">=</span> <span class="token function">determineSlotSharingGroup</span><span class="token punctuation">(</span>specifiedGroup<span class="token punctuation">,</span> inputIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TransformationTranslator<span class="token punctuation">.</span>Context</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ContextImpl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> streamGraph<span class="token punctuation">,</span> slotSharingGroup<span class="token punctuation">,</span> configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
            transformedIds <span class="token operator">=</span> translator<span class="token punctuation">.</span><span class="token function">translateForStreaming</span><span class="token punctuation">(</span>transform<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>alreadyTransformed<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>transform<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            alreadyTransformed<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>transform<span class="token punctuation">,</span> transformedIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> transformedIds<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">String</span> <span class="token function">determineSlotSharingGroup</span><span class="token punctuation">(</span><span class="token class-name">String</span> specifiedGroup<span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> inputIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>specifiedGroup <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> specifiedGroup<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> inputGroup <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> id <span class="token operator">:</span> inputIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> inputGroupCandidate <span class="token operator">=</span> streamGraph<span class="token punctuation">.</span><span class="token function">getSlotSharingGroup</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>inputGroup <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    inputGroup <span class="token operator">=</span> inputGroupCandidate<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inputGroup<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>inputGroupCandidate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token constant">DEFAULT_SLOT_SHARING_GROUP</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> inputGroup <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token constant">DEFAULT_SLOT_SHARING_GROUP</span> <span class="token operator">:</span> inputGroup<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 以OneInputTransformation为例说明物理Transformation的转换</span>
<span class="token keyword">class</span> <span class="token class-name">OneInputTransformationTranslator</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">,</span> OUT<span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractOneInputTransformationTranslator</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">,</span> OUT<span class="token punctuation">,</span> <span class="token class-name">OneInputTransformation</span><span class="token punctuation">&lt;</span>IN<span class="token punctuation">,</span> OUT<span class="token punctuation">></span><span class="token punctuation">></span></span>
<span class="token punctuation">{</span>
    <span class="token comment">// 继承自SimpleTransformationTranslator</span>
    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> <span class="token function">translateForStreaming</span><span class="token punctuation">(</span><span class="token class-name">OneInputTransformation</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">,</span> OUT<span class="token punctuation">></span></span> transformation<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> transformedIds <span class="token operator">=</span> <span class="token function">translateForStreamingInternal</span><span class="token punctuation">(</span>transformation<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> transformedIds<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> <span class="token function">translateForStreamingInternal</span><span class="token punctuation">(</span><span class="token class-name">OneInputTransformation</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">,</span> OUT<span class="token punctuation">></span></span> transformation<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">translateInternal</span><span class="token punctuation">(</span>
            transformation<span class="token punctuation">,</span>
            transformation<span class="token punctuation">.</span><span class="token function">getOperatorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            transformation<span class="token punctuation">.</span><span class="token function">getInputType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            transformation<span class="token punctuation">.</span><span class="token function">getStateKeySelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            transformation<span class="token punctuation">.</span><span class="token function">getStateKeyType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 继承自AbstractOneInputTransformationTranslator</span>
    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> <span class="token function">translateInternal</span><span class="token punctuation">(</span>
        <span class="token class-name">Transformation</span><span class="token generics"><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">></span></span> transformation<span class="token punctuation">,</span>
        <span class="token class-name">StreamOperatorFactory</span><span class="token generics"><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">></span></span> operatorFactory<span class="token punctuation">,</span>
        <span class="token class-name">TypeInformation</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">></span></span> inputType<span class="token punctuation">,</span>
        <span class="token class-name">KeySelector</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">></span></span> stateKeySelector<span class="token punctuation">,</span>
        <span class="token class-name">TypeInformation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> stateKeyType<span class="token punctuation">,</span>
        <span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StreamGraph</span> streamGraph <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStreamGraph</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建StreamNode并添加到StreamGraph中，StreamNode中封装了运行时所需的关键信息（如执行算子的容器类invokableClass和实例化算子的工厂operatorFactory）</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">TaskInvokable</span><span class="token punctuation">></span></span> invokableClass <span class="token operator">=</span> operatorFactory<span class="token punctuation">.</span><span class="token function">isStreamSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token class-name">SourceStreamTask</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">:</span> <span class="token class-name">OneInputStreamTask</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
        streamGraph<span class="token punctuation">.</span>streamNodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>
            transformation<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                  <span class="token comment">// vertexID</span>
            <span class="token keyword">new</span> <span class="token class-name">StreamNode</span><span class="token punctuation">(</span>
                transformation<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                  <span class="token comment">// vertexID</span>
                context<span class="token punctuation">.</span><span class="token function">getSlotSharingGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>           <span class="token comment">// slotSharingGroup</span>
                transformation<span class="token punctuation">.</span><span class="token function">getCoLocationGroupKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// coLocationGroup</span>
                operatorFactory<span class="token punctuation">,</span>
                transformation<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// operatorName</span>
                invokableClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 依次连接到上游顶点，创建StreamEdge</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span> inputId <span class="token operator">:</span> context<span class="token punctuation">.</span><span class="token function">getStreamNodeIds</span><span class="token punctuation">(</span>transformation<span class="token punctuation">.</span><span class="token function">getInputs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            streamGraph<span class="token punctuation">.</span><span class="token function">addEdge</span><span class="token punctuation">(</span>
                inputId<span class="token punctuation">,</span>             <span class="token comment">// upStreamVertexID</span>
                transformationId<span class="token punctuation">,</span>    <span class="token comment">// downStreamVertexID</span>
                <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// typeNumber</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singleton</span><span class="token punctuation">(</span>transformationId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 以PartitionTransformation为例说明虚拟Transformation转换过程</span>
<span class="token keyword">class</span> <span class="token class-name">PartitionTransformationTranslator</span><span class="token generics"><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">SimpleTransformationTranslator</span><span class="token generics"><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">,</span> <span class="token class-name">PartitionTransformation</span><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">></span><span class="token punctuation">></span></span>
<span class="token punctuation">{</span>
    <span class="token comment">// 继承自SimpleTransformationTranslator</span>
    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> <span class="token function">translateForStreaming</span><span class="token punctuation">(</span><span class="token class-name">OneInputTransformation</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">,</span> OUT<span class="token punctuation">></span></span> transformation<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> transformedIds <span class="token operator">=</span> <span class="token function">translateForStreamingInternal</span><span class="token punctuation">(</span>transformation<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> transformedIds<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> <span class="token function">translateForStreamingInternal</span><span class="token punctuation">(</span><span class="token class-name">PartitionTransformation</span><span class="token generics"><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">></span></span> transformation<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StreamGraph</span> streamGraph <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStreamGraph</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Transformation</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">></span></span> parentTransformations <span class="token operator">=</span> transformation<span class="token punctuation">.</span><span class="token function">getInputs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Transformation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> input <span class="token operator">=</span> parentTransformations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> resultIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span> inputId <span class="token operator">:</span> context<span class="token punctuation">.</span><span class="token function">getStreamNodeIds</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 生成一个新的虚拟id</span>
            <span class="token keyword">int</span> virtualId <span class="token operator">=</span> <span class="token class-name">Transformation</span><span class="token punctuation">.</span><span class="token function">getNewNodeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 添加虚拟分区节点，不会生成StreamNode</span>
            streamGraph<span class="token punctuation">.</span>virtualPartitionNodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>
                virtualId<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Tuple3</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>
                    inputId<span class="token punctuation">,</span>                            <span class="token comment">// originalId</span>
                    transformation<span class="token punctuation">.</span><span class="token function">getPartitioner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment">// partitioner</span>
                    transformation<span class="token punctuation">.</span><span class="token function">getExchangeMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// exchangeMode</span>
            resultIds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>virtualId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> resultIds<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<h3 id="streamgraph转换成jobgraph" style="position:relative;"><a href="#streamgraph%E8%BD%AC%E6%8D%A2%E6%88%90jobgraph" aria-label="streamgraph转换成jobgraph permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>StreamGraph转换成JobGraph</h3>
<p>JobGraph在Flink Client（CliFrontend）生成，入口是StreamGraph的getJobGraph()方法，具体生成逻辑在StreamingJobGraphGenerator的createJobGraph()方法中。</p>
<p>关键在于将多个StreamNode融合为一个JobVertex，StreamEdge则转化为JobEdge，并且JobVertex和JobEdge之间通过IntermediateDataSet形成一个生产者和消费者的连接关系。</p>
<p>首先为所有顶点生成一个唯一的确定的hashId，用于故障恢复，确定是指如果顶点在多次提交中没有改变（包括并发度、上下游等），那么其hashId就不会改变<sup id="fnref-12"><a href="#fn-12" class="footnote-ref">12</a></sup>。然后是最关键的chaining处理，从读取数据的StreamNode开始递归遍历StreamGraph，执行具体的算子融合和JobVertex构建，StreamNode转换成JobVertex，StreamEdge转换成JobEdge，JobEdge和JobVertex之间创建IntermediateDataSet连接，逐步构建JobGraph。最后写入各种配置信息。转换过程的关键点在将多个StreamNode链成一个JobVertex。</p>
<p>setChaining()方法会对Source调用createChain()方法，该方法会递归调用下游顶点构建出OperatorChain。createChain()分析当前顶点的出边，根据算子融合条件，将出边分成chainable和noChainable两类，并分别递归调用createChain()方法，之后会将StreamNode中的配置信息序列化到StreamConfig中，如果当前顶点不是OperatorChain中的内部节点，则会构建JobVertex和JobEdge相连。如果是OperatorChain中的内部节点，则会将SteamConfig添加到该OperatorChain的config集合中，一个OperatorChain除了起点（headOfChain）会生成对应的JobVertex，其余节点都是以序列化的形式写入到StreamConfig中，并保存到headOfChain的CHAINED_TASK_CONFIG配置中，直到部署时，才会取出并生成对应的ChainOperator。</p>
<p>StreamingJobGraphGenerator的vertexConfigs中保存了每个JobVertex对应的可序列化的StreamConfig。StreamConfig保存算子运行时需要的所有配置信息，通过key/value的形式存储在Configuration中，用来发送给JobManager和TaskManager，在TaskManager中运行Task时，需要从中反序列化出所需要的配置信息（如含有用户代码的StreamOperator）。</p>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">StreamingJobGraphGenerator</span> <span class="token punctuation">{</span>

    <span class="token class-name">StreamGraph</span> streamGraph<span class="token punctuation">;</span>
    <span class="token class-name">JobGraph</span> jobGraph<span class="token punctuation">;</span>        <span class="token comment">// 构造方法中初始化为new JobGraph(jobID, streamGraph.getJobName())</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">JobVertex</span><span class="token punctuation">></span></span> jobVertices<span class="token punctuation">;</span>
    <span class="token comment">// 已经构建的JobVertex</span>
    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> builtVertices<span class="token punctuation">;</span>
    <span class="token comment">// StreamEdge集合, 按创建顺序排序</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StreamEdge</span><span class="token punctuation">></span></span> physicalEdgesInOrder<span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">StreamConfig</span><span class="token punctuation">></span><span class="token punctuation">></span></span> chainedConfigs<span class="token punctuation">;</span>
    <span class="token comment">// 所有顶点的配置信息</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">StreamConfig</span><span class="token punctuation">></span></span> vertexConfigs<span class="token punctuation">;</span>
    <span class="token comment">// 所有节点的名字</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> chainedNames<span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">ResourceSpec</span><span class="token punctuation">></span></span> chainedMinResources<span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">ResourceSpec</span><span class="token punctuation">></span></span> chainedPreferredResources<span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">InputOutputFormatContainer</span><span class="token punctuation">></span></span> chainedInputOutputFormats<span class="token punctuation">;</span>
    <span class="token class-name">StreamGraphHasher</span> defaultStreamGraphHasher<span class="token punctuation">;</span>

    <span class="token class-name">JobGraph</span> <span class="token function">createJobGraph</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 设置执行模式，BATCH或STREAMING</span>
        jobGraph<span class="token punctuation">.</span><span class="token function">setJobType</span><span class="token punctuation">(</span>streamGraph<span class="token punctuation">.</span><span class="token function">getJobType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// traverseStreamGraphAndGenerateHashes，广度优先遍历StreamGraph并且为每个StreamNode生成确定的hashId作为唯一标识</span>
        <span class="token comment">// 保证如果提交的拓扑没有改变，则每次生成的hashId都是一样的</span>
        <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> hashes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HashFunction</span> hashFunction <span class="token operator">=</span> <span class="token class-name">Hashing</span><span class="token punctuation">.</span><span class="token function">murmur3_128</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> visited <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StreamNode</span><span class="token punctuation">></span></span> remaining <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> sources <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>streamGraph<span class="token punctuation">.</span>sources<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>sources<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span> sourceNodeId <span class="token operator">:</span> sources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            remaining<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>streamGraph<span class="token punctuation">.</span><span class="token function">getStreamNode</span><span class="token punctuation">(</span>sourceNodeId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            visited<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>sourceNodeId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">StreamNode</span> currentNode<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>currentNode <span class="token operator">=</span> remaining<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 生成hashId，由于图的每个顶点可能有多条路径，遍历时它的输入不一定都可用</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">generateNodeHash</span><span class="token punctuation">(</span>currentNode<span class="token punctuation">,</span> hashFunction<span class="token punctuation">,</span> hashes<span class="token punctuation">,</span> streamGraph<span class="token punctuation">.</span><span class="token function">isChainingEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> streamGraph<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 添加所有子结点</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">StreamEdge</span> outEdge <span class="token operator">:</span> currentNode<span class="token punctuation">.</span><span class="token function">getOutEdges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">StreamNode</span> child <span class="token operator">=</span> streamGraph<span class="token punctuation">.</span>streamNodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>outEdge<span class="token punctuation">.</span><span class="token function">getTargetId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>visited<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        remaining<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        visited<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 当顶点存在不可用输入时晚点再遍历</span>
                visited<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>currentNode<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 主要的转换逻辑，将StreamGraph转换成JobGraph，尽可能地将多个StreamNode链接在一起，生成JobVertex、JobEdge等</span>
        <span class="token function">setChaining</span><span class="token punctuation">(</span>hashes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将每个JobVertex的入边集合也序列化到该JobVertex的StreamConfig中（出边集合已经在setChaining()中写入了）</span>
        <span class="token function">setPhysicalEdges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置SlotSharingGroup和ColocationGroup</span>
        <span class="token comment">// 根据group name为每个JobVertex指定所属的SlotSharingGroup）</span>
        <span class="token comment">// 为迭代的首尾设置CoLocationGroup</span>
        <span class="token function">setSlotSharingAndCoLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 配置Checkpoint</span>
        <span class="token function">configureCheckpointing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 配置保存点恢复</span>
        jobGraph<span class="token punctuation">.</span>savepointRestoreSettings <span class="token operator">=</span> streamGraph<span class="token punctuation">.</span>savepointRestoreSettings<span class="token punctuation">;</span>
        <span class="token comment">// 配置执行环境，将StreamGraph的ExecutionConfig序列化到JobGraph的配置中</span>
        jobGraph<span class="token punctuation">.</span><span class="token function">setExecutionConfig</span><span class="token punctuation">(</span>streamGraph<span class="token punctuation">.</span><span class="token function">getExecutionConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> jobGraph<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">boolean</span> <span class="token function">generateNodeHash</span><span class="token punctuation">(</span><span class="token class-name">StreamNode</span> node<span class="token punctuation">,</span> <span class="token class-name">HashFunction</span> hashFunction<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> hashes<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isChainingEnabled<span class="token punctuation">,</span> <span class="token class-name">StreamGraph</span> streamGraph<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取用户通过SingleOutputStreamOperator的uid()方法为算子指定的hashId</span>
        <span class="token class-name">String</span> userSpecifiedHash <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">getTransformationUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userSpecifiedHash <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 检查节点的所有输入节点是否都已计算它们的hashId</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">StreamEdge</span> inEdge <span class="token operator">:</span> node<span class="token punctuation">.</span><span class="token function">getInEdges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 存在未计算hashId的输入节点时，稍后在访问该结点</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hashes<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>inEdge<span class="token punctuation">.</span><span class="token function">getSourceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">Hasher</span> hasher <span class="token operator">=</span> hashFunction<span class="token punctuation">.</span><span class="token function">newHasher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 根据节点本地属性（并行度等）、入边、出边生成确定的hashId</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hash <span class="token operator">=</span> <span class="token function">generateDeterministicHash</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> hasher<span class="token punctuation">,</span> hashes<span class="token punctuation">,</span> isChainingEnabled<span class="token punctuation">,</span> streamGraph<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 保存hashId必须成功</span>
            <span class="token keyword">assert</span> hashes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">Hasher</span> hasher <span class="token operator">=</span> hashFunction<span class="token punctuation">.</span><span class="token function">newHasher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            hasher<span class="token punctuation">.</span><span class="token function">putString</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">getTransformationUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Charset</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hash <span class="token operator">=</span> hasher<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 用户指定的hashId不能与已经生成的重复</span>
            <span class="token keyword">assert</span> <span class="token operator">!</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>hashes<span class="token punctuation">.</span>values<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>previousHash<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 保存hashId必须成功</span>
            <span class="token keyword">assert</span> hashes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">setChaining</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> hashes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取起始算子（不可融合算子和可融合算子的下游算子）同时构建可融合Source算子</span>
        <span class="token comment">// Source算子为SourceOperator且其出边为1时，如果其出边可进行算子融合（除下游算子的连接策略也可为HEAD_WITH_SOURCES外，其他与非Source算子出边是否可进行算子融合判断相同），则该算子是可融合Source算子</span>
        <span class="token comment">// OperatorChainInfo用于维护算子链信息，包含以下信息：</span>
        <span class="token comment">// + 算子链起始节点（startNodeId）</span>
        <span class="token comment">// + 流图（StreamGraph）</span>
        <span class="token comment">// + 流图中节点与其hashId的映射（hashes）</span>
        <span class="token comment">// + 流图中可融合Source算子节点与其ChainedSourceInfo的映射（chainedSources）</span>
        <span class="token comment">// + 流图中算子链与其包含节点hashId的映射（chainedOperatorHashes）</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">OperatorChainInfo</span><span class="token punctuation">></span></span> chainEntryPoints <span class="token operator">=</span> <span class="token function">buildChainedInputsAndGetHeadInputs</span><span class="token punctuation">(</span>hashes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">OperatorChainInfo</span> info <span class="token operator">:</span> chainEntryPoints<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">createChain</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>startNodeId<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> info<span class="token punctuation">,</span> chainEntryPoints<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 从1开始，0用于可融合Source算子</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 构建OperatorChain（可能包含一个或多个StreamNode），返回值是OperatorChain最终的输出边</span>
    <span class="token comment">// 如果currentNodeId != startNodeId, 说明当前节点在OperatorChain内部</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StreamEdge</span><span class="token punctuation">></span></span> <span class="token function">createChain</span><span class="token punctuation">(</span>
        <span class="token class-name">Integer</span> currentNodeId<span class="token punctuation">,</span>
        <span class="token keyword">int</span> chainIndex<span class="token punctuation">,</span>
        <span class="token class-name">OperatorChainInfo</span> chainInfo<span class="token punctuation">,</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">OperatorChainInfo</span><span class="token punctuation">></span></span> chainEntryPoints<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Integer</span> startNodeId <span class="token operator">=</span> chainInfo<span class="token punctuation">.</span>startNodeId<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>builtVertices<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>startNodeId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 算子链出边集合，用来生成JobEdge</span>
            <span class="token comment">// OperatorChain最终的输出边，不包括内部的边</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StreamEdge</span><span class="token punctuation">></span></span> transitiveOutEdges <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StreamEdge</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 将当前顶点的出边分为两组，即 chainable和nonChainable</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StreamEdge</span><span class="token punctuation">></span></span> chainableOutputs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StreamEdge</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StreamEdge</span><span class="token punctuation">></span></span> nonChainableOutputs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StreamEdge</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">StreamNode</span> currentNode <span class="token operator">=</span> streamGraph<span class="token punctuation">.</span>streamNodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>currentNodeId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">StreamEdge</span> outEdge <span class="token operator">:</span> currentNode<span class="token punctuation">.</span>outEdges<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 判断当前StreamEdge的上下游是否可以融合在一起</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isChainable</span><span class="token punctuation">(</span>outEdge<span class="token punctuation">,</span> streamGraph<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    chainableOutputs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>outEdge<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    nonChainableOutputs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>outEdge<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 将chainable边对应的下游顶点作为算子链内部节点并递归调用createChain()，将返回值添加到OperatorChain出边集合中</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">StreamEdge</span> chainable <span class="token operator">:</span> chainableOutputs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                transitiveOutEdges<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>
                    <span class="token function">createChain</span><span class="token punctuation">(</span>
                        chainable<span class="token punctuation">.</span>targetId<span class="token punctuation">,</span>     <span class="token comment">// currentNodeId</span>
                        chainIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>         <span class="token comment">// chainIndex</span>
                        chainInfo<span class="token punctuation">,</span>              <span class="token comment">// chainInfo</span>
                        chainEntryPoints<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// chainEntryPoints</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 直接将nonChainable边添加到OperatorChain的出边集合中，将其下游顶点作为OperatorChain起点并递归调用createChain()</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">StreamEdge</span> nonChainable <span class="token operator">:</span> nonChainableOutputs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                transitiveOutEdges<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>nonChainable<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">createChain</span><span class="token punctuation">(</span>
                    nonChainable<span class="token punctuation">.</span>targetId<span class="token punctuation">,</span>    <span class="token comment">// currentNodeId</span>
                    <span class="token number">1</span><span class="token punctuation">,</span>                        <span class="token comment">// chainIndex</span>
                    chainEntryPoints<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>nonChainable<span class="token punctuation">.</span><span class="token function">targetId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token operator">-></span> chainInfo<span class="token punctuation">.</span><span class="token function">newChain</span><span class="token punctuation">(</span>nonChainable<span class="token punctuation">.</span><span class="token function">getTargetId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                              <span class="token comment">// chainInfo</span>
                    chainEntryPoints<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// chainEntryPoints</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// OperatorChain的名称，资源要求等信息</span>
            chainedNames<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>
                currentNodeId<span class="token punctuation">,</span>
                <span class="token function">createChainedName</span><span class="token punctuation">(</span>
                    currentNodeId<span class="token punctuation">,</span>
                    chainableOutputs<span class="token punctuation">,</span>
                    <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>chainEntryPoints<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>currentNodeId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            chainedMinResources<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>
                currentNodeId<span class="token punctuation">,</span>
                <span class="token function">createChainedMinResources</span><span class="token punctuation">(</span>currentNodeId<span class="token punctuation">,</span> chainableOutputs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            chainedPreferredResources<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>
                currentNodeId<span class="token punctuation">,</span>
                <span class="token function">createChainedPreferredResources</span><span class="token punctuation">(</span>currentNodeId<span class="token punctuation">,</span> chainableOutputs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 生成算子id并将该顶点添加到所在OperatorChain的顶点（chainedOperatorHashes）中</span>
            <span class="token class-name">OperatorID</span> currentOperatorId <span class="token operator">=</span> chainInfo<span class="token punctuation">.</span><span class="token function">addNodeToChain</span><span class="token punctuation">(</span>currentNodeId<span class="token punctuation">,</span> chainedNames<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>currentNodeId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 如果当前节点是起始节点，则直接创建JobVertex</span>
            <span class="token comment">//createJobVertex()根据StreamNode创建对应的JobVertex, 并返回空的StreamConfig</span>
            <span class="token class-name">StreamConfig</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StreamConfig</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>currentNodeId<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>startNodeId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                config <span class="token operator">=</span> <span class="token function">createJobVertex</span><span class="token punctuation">(</span>startNodeId<span class="token punctuation">,</span> chainInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 设置JobVertex的StreamConfig</span>
            <span class="token comment">// 将StreamNode中的配置信息序列化到StreamConfig中，包括序列化器、StreamOperator、Checkpoint等相关配置</span>
            <span class="token function">setVertexConfig</span><span class="token punctuation">(</span>currentNodeId<span class="token punctuation">,</span> config<span class="token punctuation">,</span> chainableOutputs<span class="token punctuation">,</span> nonChainableOutputs<span class="token punctuation">,</span> chainInfo<span class="token punctuation">.</span><span class="token function">getChainedSources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>currentNodeId<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>startNodeId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果是OperatorChain的起点，执行connect()方法创建JobEdge和IntermediateDataSet</span>
                config<span class="token punctuation">.</span><span class="token function">setChainStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                config<span class="token punctuation">.</span><span class="token function">setChainIndex</span><span class="token punctuation">(</span>chainIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                config<span class="token punctuation">.</span><span class="token function">setOperatorName</span><span class="token punctuation">(</span>streamGraph<span class="token punctuation">.</span>streamNodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>currentNodeId<span class="token punctuation">)</span><span class="token punctuation">.</span>operatorName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 将OperatorChain的起点（headOfChain）与所有出边相连</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">StreamEdge</span> edge <span class="token operator">:</span> transitiveOutEdges<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 通过StreamEdge构建出JobEdge，创建IntermediateDataSet，将JobVertex和JobEdge相连</span>
                    <span class="token function">connect</span><span class="token punctuation">(</span>startNodeId<span class="token punctuation">,</span> edge<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 把最终的输出边写入配置, 部署时会用到</span>
                config<span class="token punctuation">.</span><span class="token function">setOutEdgesInOrder</span><span class="token punctuation">(</span>transitiveOutEdges<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 将OperatorChain中所有内部节点的StreamConfig写入到OperatorChain起点（headOfChain）的CHAINED_TASK_CONFIG配置中</span>
                config<span class="token punctuation">.</span><span class="token function">setTransitiveChainedTaskConfigs</span><span class="token punctuation">(</span>chainedConfigs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>startNodeId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 对于OperatorChain中的内部节点，将当前节点的StreamConfig添加到该OperatorChain的config集合中</span>
                chainedConfigs<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>startNodeId<span class="token punctuation">,</span> k <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">StreamConfig</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                config<span class="token punctuation">.</span><span class="token function">setChainIndex</span><span class="token punctuation">(</span>chainIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">StreamNode</span> node <span class="token operator">=</span> streamGraph<span class="token punctuation">.</span>streamNodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>currentNodeId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                config<span class="token punctuation">.</span><span class="token function">setOperatorName</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>operatorName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                chainedConfigs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>startNodeId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>currentNodeId<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 设置当前operator的OperatorID</span>
            config<span class="token punctuation">.</span><span class="token function">setOperatorID</span><span class="token punctuation">(</span>currentOperatorId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>chainableOutputs<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                config<span class="token punctuation">.</span><span class="token function">setChainEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 返回算子链的出边集合</span>
            <span class="token keyword">return</span> transitiveOutEdges<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// StreamEdge两端的顶点是否能够被融合到同一个JobVertex中</span>
    <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isChainable</span><span class="token punctuation">(</span><span class="token class-name">StreamEdge</span> edge<span class="token punctuation">,</span> <span class="token class-name">StreamGraph</span> streamGraph<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取边的上下游顶点及它们对应的算子</span>
        <span class="token class-name">StreamNode</span> upStreamVertex <span class="token operator">=</span> streamGraph<span class="token punctuation">.</span>streamNodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>edge<span class="token punctuation">.</span><span class="token function">getSourceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">StreamNode</span> downStreamVertex <span class="token operator">=</span> streamGraph<span class="token punctuation">.</span>streamNodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>edge<span class="token punctuation">.</span><span class="token function">getTargetId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">StreamOperatorFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> upStreamOperator <span class="token operator">=</span> upStreamVertex<span class="token punctuation">.</span><span class="token function">getOperatorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">StreamOperatorFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> downStreamOperator <span class="token operator">=</span> downStreamVertex<span class="token punctuation">.</span><span class="token function">getOperatorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 算子出边可算子融合的条件：</span>
        <span class="token comment">// + 下游顶点的入度为1</span>
        <span class="token comment">// boolean isChainable = downStreamVertex.getInEdges().size() == 1;</span>
        <span class="token comment">// + 上、下游顶点在同一个SlotSharingGroup中</span>
        isChainable <span class="token operator">&amp;=</span> <span class="token punctuation">(</span>upStreamVertex<span class="token punctuation">.</span>slotSharingGroup <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> downstreamVertex<span class="token punctuation">.</span>slotSharingGroup <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>upStreamVertex<span class="token punctuation">.</span>slotSharingGroup <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> upStreamVertex<span class="token punctuation">.</span>slotSharingGroup<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>downstreamVertex<span class="token punctuation">.</span>slotSharingGroup<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// + 上游算子不为null</span>
        isChainable <span class="token operator">&amp;=</span> upStreamOperator <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">// + 下游算子不为null</span>
        isChainable <span class="token operator">&amp;=</span> downStreamOperator <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">// + 上游算子的连接策略为ALWAYS或HEAD</span>
        isChainable <span class="token operator">&amp;=</span> upStreamOperator<span class="token punctuation">.</span><span class="token function">getChainingStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">ALWAYS</span>
            <span class="token operator">||</span> upStreamOperator<span class="token punctuation">.</span><span class="token function">getChainingStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">HEAD</span><span class="token punctuation">;</span>
        <span class="token comment">// + 下游算子的连接策略为ALWAYS</span>
        isChainable <span class="token operator">&amp;=</span> downStreamOperator<span class="token punctuation">.</span><span class="token function">getChainingStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">ALWAYS</span><span class="token punctuation">;</span>
        <span class="token comment">// + StreamEdge的分区器为ForwardPartitioner</span>
        isChainable <span class="token operator">&amp;=</span> edge<span class="token punctuation">.</span>outputPartitioner <span class="token keyword">instanceof</span> <span class="token class-name">ForwardPartitioner</span><span class="token punctuation">;</span>
        <span class="token comment">// + StreamEdge的数据交换模式不为BATCH</span>
        isChainable <span class="token operator">&amp;=</span> edge<span class="token punctuation">.</span>exchangeMode <span class="token operator">!=</span> <span class="token class-name">StreamExchangeMode</span><span class="token punctuation">.</span><span class="token constant">BATCH</span><span class="token punctuation">;</span>
        <span class="token comment">// + 上下游顶点的并行度一致</span>
        isChainable <span class="token operator">&amp;=</span> upStreamVertex<span class="token punctuation">.</span>parallelism <span class="token operator">==</span> downStreamVertex<span class="token punctuation">.</span>parallelism<span class="token punctuation">;</span>
        <span class="token comment">// + 启用算子融合</span>
        isChainable <span class="token operator">&amp;=</span> streamGraph<span class="token punctuation">.</span>chaining<span class="token punctuation">;</span>
        <span class="token comment">// 通过检查每个输入位置只被使用一次确认没有union操作</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">StreamEdge</span> inEdge <span class="token operator">:</span> downStreamVertex<span class="token punctuation">.</span>inEdges<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>inEdge <span class="token operator">!=</span> edge <span class="token operator">&amp;&amp;</span> inEdge<span class="token punctuation">.</span>typeNumber <span class="token operator">==</span> edge<span class="token punctuation">.</span>typeNumber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> isChainable<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">StreamConfig</span> <span class="token function">createJobVertex</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> streamNodeId<span class="token punctuation">,</span> <span class="token class-name">OperatorChainInfo</span> chainInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 构建JobVertex时需要将StreamNode中的配置信息复制到JobVertex中</span>
        <span class="token class-name">JobVertex</span> jobVertex<span class="token punctuation">;</span>
        <span class="token class-name">StreamNode</span> streamNode <span class="token operator">=</span> streamGraph<span class="token punctuation">.</span>streamNodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>streamNodeId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hash <span class="token operator">=</span> chainInfo<span class="token punctuation">.</span><span class="token function">getHash</span><span class="token punctuation">(</span>streamNodeId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JobVertexID</span> jobVertexId <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JobVertexID</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OperatorID</span><span class="token punctuation">></span></span> operatorIDs <span class="token operator">=</span> chainInfo<span class="token punctuation">.</span>chainedOperatorHashes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>streamNodeId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>chainedInputOutputFormats<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>streamNodeId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            jobVertex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InputOutputFormatVertex</span><span class="token punctuation">(</span>chainedNames<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>streamNodeId<span class="token punctuation">)</span><span class="token punctuation">,</span> jobVertexId<span class="token punctuation">,</span> operatorIDs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            chainedInputOutputFormats<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>streamNodeId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TaskConfig</span><span class="token punctuation">(</span>jobVertex<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            jobVertex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JobVertex</span><span class="token punctuation">(</span>chainedNames<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>streamNodeId<span class="token punctuation">)</span><span class="token punctuation">,</span> jobVertexId<span class="token punctuation">,</span> operatorIDs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        chainInfo<span class="token punctuation">.</span><span class="token function">coordinatorProviders</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>provider <span class="token operator">-></span>
                jobVertex<span class="token punctuation">.</span><span class="token function">addCoordinatorProvider</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SerializedValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>coordinatorProvider<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jobVertex<span class="token punctuation">.</span><span class="token function">setResources</span><span class="token punctuation">(</span>chainedMinResources<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>streamNodeId<span class="token punctuation">)</span><span class="token punctuation">,</span> chainedPreferredResources<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>streamNodeId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jobVertex<span class="token punctuation">.</span><span class="token function">setInvokableClass</span><span class="token punctuation">(</span>streamNode<span class="token punctuation">.</span>jobVertexClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> parallelism <span class="token operator">=</span> streamNode<span class="token punctuation">.</span>parallelism<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parallelism <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            jobVertex<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span>parallelism<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        jobVertex<span class="token punctuation">.</span><span class="token function">setMaxParallelism</span><span class="token punctuation">(</span>streamNode<span class="token punctuation">.</span>maxParallelism<span class="token punctuation">)</span><span class="token punctuation">;</span>
        jobVertices<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>streamNodeId<span class="token punctuation">,</span> jobVertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        builtVertices<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>streamNodeId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        jobGraph<span class="token punctuation">.</span>taskVertices<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>jobVertex<span class="token punctuation">.</span>id<span class="token punctuation">,</span> jobVertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StreamConfig</span><span class="token punctuation">(</span>jobVertex<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 为OperatorChain所有的实际输出边创建对应的JobEdge，并和JobVertex连接</span>
    <span class="token keyword">void</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> headOfChain<span class="token punctuation">,</span> <span class="token class-name">StreamEdge</span> edge<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        physicalEdgesInOrder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>edge<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Integer</span> downStreamVertexID <span class="token operator">=</span> edge<span class="token punctuation">.</span>targetId<span class="token punctuation">;</span>
        <span class="token comment">// 上下游顶点</span>
        <span class="token class-name">JobVertex</span> headVertex <span class="token operator">=</span> jobVertices<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>headOfChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JobVertex</span> downStreamVertex <span class="token operator">=</span> jobVertices<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>downStreamVertexID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">StreamConfig</span> downStreamConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StreamConfig</span><span class="token punctuation">(</span>downStreamVertex<span class="token punctuation">.</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 下游顶点增加一个输入</span>
        downStreamConfig<span class="token punctuation">.</span><span class="token function">setNumberOfNetworkInputs</span><span class="token punctuation">(</span>downStreamConfig<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span><span class="token constant">NUMBER_OF_NETWORK_INPUTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 确定上游JobVertex和下游JobVertex的数据交换方式</span>
        <span class="token comment">// 根据exchangeMode来确定上游JobVertex输出的IntermediateDataSet的ResultPartitionType</span>
        <span class="token class-name">StreamPartitioner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> partitioner <span class="token operator">=</span> edge<span class="token punctuation">.</span>outputPartitioner<span class="token punctuation">;</span>
        <span class="token class-name">ResultPartitionType</span> resultPartitionType<span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>edge<span class="token punctuation">.</span>exchangeMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token constant">PIPELINED</span><span class="token operator">:</span>
                resultPartitionType <span class="token operator">=</span> <span class="token class-name">ResultPartitionType</span><span class="token punctuation">.</span><span class="token constant">PIPELINED_BOUNDED</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">BATCH</span><span class="token operator">:</span>
                resultPartitionType <span class="token operator">=</span> <span class="token class-name">ResultPartitionType</span><span class="token punctuation">.</span><span class="token constant">BLOCKING</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">UNDEFINED</span><span class="token operator">:</span>
                resultPartitionType <span class="token operator">=</span> <span class="token function">determineResultPartitionType</span><span class="token punctuation">(</span>partitioner<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">checkAndResetBufferTimeout</span><span class="token punctuation">(</span>resultPartitionType<span class="token punctuation">,</span> edge<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建JobEdge和IntermediateDataSet</span>
        <span class="token comment">// 根据StreamPartitioner类型确定JobEdge的分发模式，部署时确定上游顶点的Task和下游顶点的Task之间的连接模式</span>
        <span class="token comment">// ForwardPartitioner和RescalePartitioner两种类型的Partitioner转换为DistributionPattern.POINTWISE分发模式</span>
        <span class="token comment">// 其他类型的partitioner统一转换为DistributionPattern.ALL_TO_ALL分发模式</span>
        <span class="token class-name">JobEdge</span> jobEdge<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>partitioner<span class="token punctuation">.</span><span class="token function">isPointwise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            jobEdge <span class="token operator">=</span> downStreamVertex<span class="token punctuation">.</span><span class="token function">connectNewDataSetAsInput</span><span class="token punctuation">(</span>
                headVertex<span class="token punctuation">,</span>                    <span class="token comment">// input</span>
                <span class="token class-name">DistributionPattern</span><span class="token punctuation">.</span><span class="token constant">POINTWISE</span><span class="token punctuation">,</span> <span class="token comment">// distPattern</span>
                resultPartitionType<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// partitionType</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            jobEdge <span class="token operator">=</span> downStreamVertex<span class="token punctuation">.</span><span class="token function">connectNewDataSetAsInput</span><span class="token punctuation">(</span>
                headVertex<span class="token punctuation">,</span>                        <span class="token comment">// input</span>
                <span class="token class-name">DistributionPattern</span><span class="token punctuation">.</span><span class="token constant">ALL_TO_ALL</span><span class="token punctuation">,</span>    <span class="token comment">// distPattern</span>
                resultPartitionType<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">// partitionType</span>
        <span class="token punctuation">}</span>
        jobEdge<span class="token punctuation">.</span><span class="token function">setShipStrategyName</span><span class="token punctuation">(</span>partitioner<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jobEdge<span class="token punctuation">.</span><span class="token function">setDownstreamSubtaskStateMapper</span><span class="token punctuation">(</span>partitioner<span class="token punctuation">.</span><span class="token function">getDownstreamSubtaskStateMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jobEdge<span class="token punctuation">.</span><span class="token function">setUpstreamSubtaskStateMapper</span><span class="token punctuation">(</span>partitioner<span class="token punctuation">.</span><span class="token function">getUpstreamSubtaskStateMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">OperatorChainInfo</span><span class="token punctuation">></span></span> <span class="token function">buildChainedInputsAndGetHeadInputs</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> hashes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">ChainedSourceInfo</span><span class="token punctuation">></span></span> chainedSources <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">OperatorChainInfo</span><span class="token punctuation">></span></span> chainEntryPoints <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span> sourceNodeId <span class="token operator">:</span> streamGraph<span class="token punctuation">.</span>sourceIDs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">StreamNode</span> sourceNode <span class="token operator">=</span> streamGraph<span class="token punctuation">.</span>streamNodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>sourceNodeId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sourceNode<span class="token punctuation">.</span>operatorFactory <span class="token keyword">instanceof</span> <span class="token class-name">SourceOperatorFactory</span>
                <span class="token operator">&amp;&amp;</span> sourceNode<span class="token punctuation">.</span>outEdges<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">StreamEdge</span> sourceOutEdge <span class="token operator">=</span> sourceNode<span class="token punctuation">.</span>outEdges<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">StreamNode</span> target <span class="token operator">=</span> streamGraph<span class="token punctuation">.</span>streamNodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>sourceOutEdge<span class="token punctuation">.</span>targetId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">ChainingStrategy</span> targetChainingStrategy <span class="token operator">=</span> target<span class="token punctuation">.</span>operatorFactory<span class="token punctuation">.</span>chainingStrategy<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>targetChainingStrategy <span class="token operator">==</span> <span class="token class-name">ChainingStrategy</span><span class="token punctuation">.</span><span class="token constant">HEAD_WITH_SOURCES</span>
                    <span class="token operator">&amp;&amp;</span> <span class="token function">isChainableInput</span><span class="token punctuation">(</span>sourceOutEdge<span class="token punctuation">,</span> streamGraph<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">OperatorID</span> opId <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OperatorID</span><span class="token punctuation">(</span>hashes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>sourceNodeId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">StreamConfig<span class="token punctuation">.</span>SourceInputConfig</span> inputConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StreamConfig<span class="token punctuation">.</span>SourceInputConfig</span><span class="token punctuation">(</span>sourceOutEdge<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">StreamConfig</span> operatorConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StreamConfig</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">setVertexConfig</span><span class="token punctuation">(</span>
                        sourceNodeId<span class="token punctuation">,</span>                    <span class="token comment">// vertexID</span>
                        operatorConfig<span class="token punctuation">,</span>                  <span class="token comment">// config</span>
                        <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token comment">// chainableOutputs</span>
                        <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token comment">// nonChainableOutputs</span>
                        <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// chainedSources</span>
                    operatorConfig<span class="token punctuation">.</span><span class="token function">setChainIndex</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    operatorConfig<span class="token punctuation">.</span><span class="token function">setOperatorID</span><span class="token punctuation">(</span>opId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    operatorConfig<span class="token punctuation">.</span><span class="token function">setOperatorName</span><span class="token punctuation">(</span>sourceNode<span class="token punctuation">.</span>operatorName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    chainedSources<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>sourceNodeId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ChainedSourceInfo</span><span class="token punctuation">(</span>operatorConfig<span class="token punctuation">,</span> inputConfig<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">SourceOperatorFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> sourceOpFact <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SourceOperatorFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> sourceNode<span class="token punctuation">.</span><span class="token function">getOperatorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">OperatorCoordinator<span class="token punctuation">.</span>Provider</span> coord <span class="token operator">=</span> sourceOpFact<span class="token punctuation">.</span><span class="token function">getCoordinatorProvider</span><span class="token punctuation">(</span>sourceNode<span class="token punctuation">.</span><span class="token function">getOperatorName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> opId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">OperatorChainInfo</span> chainInfo <span class="token operator">=</span> chainEntryPoints<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>
                        sourceOutEdge<span class="token punctuation">.</span>targetId<span class="token punctuation">,</span>
                        <span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">OperatorChainInfo</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    chainInfo<span class="token punctuation">.</span><span class="token function">addCoordinatorProvider</span><span class="token punctuation">(</span>coord<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            chainEntryPoints<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>sourceNodeId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OperatorChainInfo</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> chainEntryPoints<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<h3 id="jobgraph转换成executiongraph" style="position:relative;"><a href="#jobgraph%E8%BD%AC%E6%8D%A2%E6%88%90executiongraph" aria-label="jobgraph转换成executiongraph permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>JobGraph转换成ExecutionGraph</h3>
<p>ExecutionGraph在JobManager中生成，入口是SchedulerBase的构造方法（JobMaster初始化Scheduler时触发），具体生成逻辑是在DefaultExecutionGraphBuilder的buildGraph()方法中。转换过程中的重要变化如下：</p>
<ul>
<li>加入了并行度的概念</li>
<li>生成了与JobVertex对应的ExecutionJobVertex和ExecutionVertex，与IntermediateDataSet对应的IntermediateResult和IntermediateResultPartition，并行执行将通过这些类实现</li>
</ul>
<p>JobVertex转换成ExecutionJobVertex，ExecutionJobVertex又展开成并行度数目个ExecutionVertex；IntermediateDataSet转换成IntermediateResult，IntermediateResult又展开成并行度数目个IntermediateResultPartition；根据IntermediateResult和ExecutionJobVertex关系创建ExectuionEdge。依次从Source开始遍历，把IntermediateResult、ExecutionEdge、ExecutionJobVertex连接起来。</p>
<p>构建ExecutionJobVertex核心逻辑如下：</p>
<ol>
<li>设置并行度</li>
<li>设置SlotSharingGroup和CoLocationGroup</li>
<li>构建ExecutionJobVertex的输出，即 中间结果（IntermediateResult）及其中间结果分区（IntermediateResultPartition）。IntermediateResult数目与对应JobVertex的中间数据集（IntermediateDataSet）数目相同，每个IntermediateResult包含ExecutionJobVertex并行度数目个IntermediateResultPartition。</li>
<li>构建ExecutionJobVertex并行度数目个ExecutionVertex</li>
<li>检查IntermediateResultPartition和ExecutionVertex之间有没有重复的引用</li>
</ol>
<p>ExecutionJobVertex构建完成后调用其connectToPredecessors()方法将ExecutionVertex和上游的IntermediateResultPartition连接起来，连接策略分为全连接（DistributionPattern.POINTWISE）和点对点连接（DistributionPattern.ALL_TO_ALL），由对应JobVertex入边JobEdge的DistributionPattern属性确定</p>
<ul>
<li>全连接：下游ExecutionVertex与上游所有IntermediateResultPartition建立连接，消费其产生的数据。一般全连接意味着数据Shuffle</li>
<li>点对点连接：根据上游IntermediateResult分区数和ExecutionJobVertex并发数大小关系又分为一对一连接、一对多连接、多对一连接</li>
</ul>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">DefaultExecutionGraphBuilder</span> <span class="token punctuation">{</span>

    <span class="token keyword">static</span> <span class="token class-name">DefaultExecutionGraph</span> <span class="token function">buildGraph</span><span class="token punctuation">(</span>
        <span class="token class-name">JobGraph</span> jobGraph<span class="token punctuation">,</span>
        <span class="token class-name">Configuration</span> jobManagerConfig<span class="token punctuation">,</span>
        <span class="token class-name">ScheduledExecutorService</span> futureExecutor<span class="token punctuation">,</span>
        <span class="token class-name">Executor</span> ioExecutor<span class="token punctuation">,</span>
        <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">,</span>
        <span class="token class-name">CompletedCheckpointStore</span> completedCheckpointStore<span class="token punctuation">,</span>
        <span class="token class-name">CheckpointsCleaner</span> checkpointsCleaner<span class="token punctuation">,</span>
        <span class="token class-name">CheckpointIDCounter</span> checkpointIdCounter<span class="token punctuation">,</span>
        <span class="token class-name">Time</span> rpcTimeout<span class="token punctuation">,</span>
        <span class="token class-name">MetricGroup</span> metrics<span class="token punctuation">,</span>
        <span class="token class-name">BlobWriter</span> blobWriter<span class="token punctuation">,</span>
        <span class="token class-name">Logger</span> log<span class="token punctuation">,</span>
        <span class="token class-name">ShuffleMaster</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> shuffleMaster<span class="token punctuation">,</span>
        <span class="token class-name">JobMasterPartitionTracker</span> partitionTracker<span class="token punctuation">,</span>
        <span class="token class-name">TaskDeploymentDescriptorFactory<span class="token punctuation">.</span>PartitionLocationConstraint</span> partitionLocationConstraint<span class="token punctuation">,</span>
        <span class="token class-name">ExecutionDeploymentListener</span> executionDeploymentListener<span class="token punctuation">,</span>
        <span class="token class-name">ExecutionStateUpdateListener</span> executionStateUpdateListener<span class="token punctuation">,</span>
        <span class="token keyword">long</span> initializationTimestamp<span class="token punctuation">,</span>
        <span class="token class-name">VertexAttemptNumberStore</span> vertexAttemptNumberStore<span class="token punctuation">,</span>
        <span class="token class-name">VertexParallelismStore</span> vertexParallelismStore<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">String</span> jobName <span class="token operator">=</span> jobGraph<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JobID</span> jobId <span class="token operator">=</span> jobGraph<span class="token punctuation">.</span><span class="token function">getJobID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">JobInformation</span> jobInformation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JobInformation</span><span class="token punctuation">(</span>
            jobId<span class="token punctuation">,</span>
            jobName<span class="token punctuation">,</span>
            jobGraph<span class="token punctuation">.</span><span class="token function">getSerializedExecutionConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// serializedExecutionConfig</span>
            jobGraph<span class="token punctuation">.</span><span class="token function">getJobConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>           <span class="token comment">// jobConfiguration</span>
            jobGraph<span class="token punctuation">.</span><span class="token function">getUserJarBlobKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token comment">// requiredJarFileBlobKeys</span>
            jobGraph<span class="token punctuation">.</span><span class="token function">getClasspaths</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// requiredClasspathURLs</span>
        <span class="token keyword">int</span> maxPriorAttemptsHistoryLength <span class="token operator">=</span> jobManagerConfig<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span><span class="token class-name">JobManagerOptions</span><span class="token punctuation">.</span><span class="token constant">MAX_ATTEMPTS_HISTORY_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PartitionGroupReleaseStrategy<span class="token punctuation">.</span>Factory</span> partitionGroupReleaseStrategyFactory <span class="token operator">=</span> <span class="token class-name">PartitionGroupReleaseStrategyFactoryLoader</span><span class="token punctuation">.</span><span class="token function">loadPartitionGroupReleaseStrategyFactory</span><span class="token punctuation">(</span>jobManagerConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1. 创建ExecutionGraph并设置相关属性</span>
        <span class="token class-name">DefaultExecutionGraph</span> executionGraph <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">DefaultExecutionGraph</span><span class="token punctuation">(</span>
                jobInformation<span class="token punctuation">,</span>
                futureExecutor<span class="token punctuation">,</span>
                ioExecutor<span class="token punctuation">,</span>
                rpcTimeout<span class="token punctuation">,</span>
                maxPriorAttemptsHistoryLength<span class="token punctuation">,</span>
                classLoader<span class="token punctuation">,</span>
                blobWriter<span class="token punctuation">,</span>
                partitionGroupReleaseStrategyFactory<span class="token punctuation">,</span>
                shuffleMaster<span class="token punctuation">,</span>
                partitionTracker<span class="token punctuation">,</span>
                partitionLocationConstraint<span class="token punctuation">,</span>
                executionDeploymentListener<span class="token punctuation">,</span>
                executionStateUpdateListener<span class="token punctuation">,</span>
                initializationTimestamp<span class="token punctuation">,</span>
                vertexAttemptNumberStore<span class="token punctuation">,</span>
                vertexParallelismStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置jsonPlan</span>
        executionGraph<span class="token punctuation">.</span>jsonPlan <span class="token operator">=</span> <span class="token class-name">JsonPlanGenerator</span><span class="token punctuation">.</span><span class="token function">generatePlan</span><span class="token punctuation">(</span>jobGraph<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. JobVertex初始化</span>
        <span class="token comment">// 检查JobVertex的executableClass（即Operator类）</span>
        <span class="token comment">// 触发JobVertex的JobMaster初始化钩子函数（initializeOnMaster()），OutputFormatVertex创建输出目录，InputFormatVertex创建输入分片</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">JobVertex</span> vertex <span class="token operator">:</span> jobGraph<span class="token punctuation">.</span>taskVertices<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> executableClass <span class="token operator">=</span> vertex<span class="token punctuation">.</span>invokableClassName<span class="token punctuation">;</span>
            <span class="token keyword">assert</span> executableClass <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>executableClass<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            vertex<span class="token punctuation">.</span><span class="token function">initializeOnMaster</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 3. 生成ExecutionGraph内部的顶点和连接</span>
        <span class="token comment">// 对JobGraph中的JobVertex节点进行拓扑排序</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JobVertex</span><span class="token punctuation">></span></span> sortedTopology <span class="token operator">=</span> jobGraph<span class="token punctuation">.</span><span class="token function">getVerticesSortedTopologicallyFromSources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 构建ExecutionGraph，按照拓扑排序的结果依次为每个JobVertex创建对应的ExecutionJobVertex</span>
        executionGraph<span class="token punctuation">.</span><span class="token function">attachJobGraph</span><span class="token punctuation">(</span>sortedTopology<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> executionGraph<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">DefaultExecutionGraph</span> <span class="token keyword">implements</span> <span class="token class-name">ExecutionGraph</span> <span class="token punctuation">{</span>

    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JobVertexID</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionJobVertex</span><span class="token punctuation">></span></span> tasks
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IntermediateDataSetID</span><span class="token punctuation">,</span> <span class="token class-name">IntermediateResult</span><span class="token punctuation">></span></span> intermediateResults<span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExecutionJobVertex</span><span class="token punctuation">></span></span> verticesInCreationOrder<span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExecutionVertexID</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionVertex</span><span class="token punctuation">></span></span> executionVerticesById<span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IntermediateResultPartitionID</span><span class="token punctuation">,</span> <span class="token class-name">IntermediateResultPartition</span><span class="token punctuation">></span></span> resultPartitionsById<span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> isStoppable <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token comment">// 当所有source都是stoppable时为true</span>
    <span class="token class-name">VertexParallelismStore</span> parallelismStore<span class="token punctuation">;</span>
    <span class="token keyword">int</span> numVerticesTotal<span class="token punctuation">;</span>

    <span class="token comment">// 在创建ExecutionJobVertex的时候会创建对应的ExecutionVertex、IntermediateResult、ExecutionEdge、IntermediateResultPartition等对象</span>
    <span class="token comment">// + 每一个JobVertex对应一个ExecutionJobVertex</span>
    <span class="token comment">// + 每一个ExecutionJobVertex有并行度数目个ExecutionVertex</span>
    <span class="token comment">// + 每一个JobVertex可能有n个IntermediateDataSet，在ExecutionJobVertex中，一个IntermediateDataSet对应一个IntermediateResult，每一个IntermediateResult都有并行度数目个生产者, 对应并行度数目个IntermediateResultPartition</span>
    <span class="token comment">// + 每一个ExecutionJobVertex都会和前向的IntermediateResult连接，实际上是ExecutionVertex和IntermediateResult建立连接，生成ExecutionEdge</span>
    <span class="token keyword">void</span> <span class="token function">attachJobGraph</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JobVertex</span><span class="token punctuation">></span></span> topologicallySorted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> createTimestamp <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 遍历拓扑排序的JobVertex</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">JobVertex</span> jobVertex <span class="token operator">:</span> topologicallySorted<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>jobVertex<span class="token punctuation">.</span>inputs<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>jobVertex<span class="token punctuation">.</span>isStoppable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                isStoppable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">VertexParallelismInformation</span> parallelismInfo <span class="token operator">=</span> parallelismStore<span class="token punctuation">.</span><span class="token function">getParallelismInfo</span><span class="token punctuation">(</span>jobVertex<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 创建ExecutionJobVertex并添加到ExecutionGraph中</span>
            <span class="token class-name">ExecutionJobVertex</span> ejv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExecutionJobVertex</span><span class="token punctuation">(</span>
                <span class="token keyword">this</span><span class="token punctuation">,</span>               <span class="token comment">// graph</span>
                jobVertex<span class="token punctuation">,</span>
                maxPriorAttemptsHistoryLength<span class="token punctuation">,</span>
                rpcTimeout<span class="token punctuation">,</span>
                createTimestamp<span class="token punctuation">,</span>
                parallelismInfo<span class="token punctuation">,</span>
                initialAttemptCounts<span class="token punctuation">.</span><span class="token function">getAttemptCounts</span><span class="token punctuation">(</span>jobVertex<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token comment">// initialAttemptCounts</span>

            <span class="token comment">// 构建ExecutionEdge，将创建的ExecutionJobVertex与前置的IntermediateResult连接起来，为运行时建立Task之间的数据交换是以此为基础建立数据的物理传输通道</span>
            ejv<span class="token punctuation">.</span><span class="token function">connectToPredecessors</span><span class="token punctuation">(</span>intermediateResults<span class="token punctuation">)</span><span class="token punctuation">;</span>
            tasks<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>jobVertex<span class="token punctuation">.</span>id<span class="token punctuation">,</span> ejv<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ejv<span class="token punctuation">.</span>producedDataSets<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>intermeidateResult <span class="token operator">-></span> intermediateResults<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> intermediateResult<span class="token punctuation">)</span><span class="token punctuation">)</span>
            verticesInCreationOrder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ejv<span class="token punctuation">)</span><span class="token punctuation">;</span>
            numVerticesTotal <span class="token operator">+=</span> ejv<span class="token punctuation">.</span><span class="token function">getParallelism</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 注册ExecutionVertices和ResultPartitions</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ExecutionJobVertex</span> executionJobVertex <span class="token operator">:</span> verticesInCreationOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ExecutionVertex</span> executionVertex <span class="token operator">:</span> executionJobVertex<span class="token punctuation">.</span>taskVertices<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                executionVerticesById<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>executionVertex<span class="token punctuation">.</span><span class="token function">getID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> executionVertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                resultPartitionsById<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>executionVertex<span class="token punctuation">.</span><span class="token function">getProducedPartitions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        executionTopology <span class="token operator">=</span> <span class="token class-name">DefaultExecutionTopology</span><span class="token punctuation">.</span><span class="token function">fromExecutionGraph</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        partitionGroupReleaseStrategy <span class="token operator">=</span> partitionGroupReleaseStrategyFactory<span class="token punctuation">.</span><span class="token function">createInstance</span><span class="token punctuation">(</span>executionTopology<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">ExecutionJobVertex</span> <span class="token keyword">implements</span> <span class="token class-name">AccessExecutionJobVertex</span> <span class="token punctuation">{</span>

    <span class="token class-name">InternalExecutionGraphAccessor</span> graph<span class="token punctuation">;</span>
    <span class="token class-name">JobVertex</span> jobVertex<span class="token punctuation">;</span>
    <span class="token class-name">ExecutionVertex</span><span class="token punctuation">[</span><span class="token punctuation">]</span> taskVertices<span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IntermediateResult</span><span class="token punctuation">></span></span> inputs<span class="token punctuation">;</span>
    <span class="token class-name">IntermediateResult</span><span class="token punctuation">[</span><span class="token punctuation">]</span> producedDataSets<span class="token punctuation">;</span>
    <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OperatorCoordinatorHolder</span><span class="token punctuation">></span></span> operatorCoordinators<span class="token punctuation">;</span>
    <span class="token class-name">VertexParallelismInformation</span> parallelismInfo<span class="token punctuation">;</span>

    <span class="token class-name">ExecutionJobVertex</span><span class="token punctuation">(</span>
        <span class="token class-name">InternalExecutionGraphAccessor</span> graph<span class="token punctuation">,</span>
        <span class="token class-name">JobVertex</span> jobVertex<span class="token punctuation">,</span>
        <span class="token keyword">int</span> maxPriorAttemptsHistoryLength<span class="token punctuation">,</span>
        <span class="token class-name">Time</span> timeout<span class="token punctuation">,</span>
        <span class="token keyword">long</span> createTimestamp<span class="token punctuation">,</span>
        <span class="token class-name">VertexParallelismInformation</span> parallelismInfo<span class="token punctuation">,</span>
        <span class="token class-name">SubtaskAttemptNumberStore</span> initialAttemptCounts<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>graph <span class="token operator">=</span> graph<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>jobVertex <span class="token operator">=</span> jobVertex<span class="token punctuation">;</span>
        <span class="token comment">// 设置并行度</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>parallelismInfo <span class="token operator">=</span> parallelismInfo<span class="token punctuation">;</span>
        <span class="token comment">// ExecutionVertex列表，按照JobVertex并行度设置</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>taskVertices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExecutionVertex</span><span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>parallelismInfo<span class="token punctuation">.</span><span class="token function">getParallelism</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>inputs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>jobVertex<span class="token punctuation">.</span><span class="token function">getInputs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置SlotSharingGroup和CoLocationGroup</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>slotSharingGroup <span class="token operator">=</span> jobVertex<span class="token punctuation">.</span>slotSharingGroup<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>coLocationGroup <span class="token operator">=</span> jobVertex<span class="token punctuation">.</span>coLocationGroup<span class="token punctuation">;</span>
        <span class="token comment">// 中间结果（IntermediateResult）数目与对应JobVertex的中间数据集（IntermediateDataSet）数目相同</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>producedDataSets <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntermediateResult</span><span class="token punctuation">[</span>jobVertex<span class="token punctuation">.</span>results<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>resourceProfile <span class="token operator">=</span> <span class="token class-name">ResourceProfile</span><span class="token punctuation">.</span><span class="token function">fromResourceSpec</span><span class="token punctuation">(</span>jobVertex<span class="token punctuation">.</span><span class="token function">getMinResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">MemorySize</span><span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 构建ExecutionJobVertex的输出中间结果及其中间结果分区</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> jobVertex<span class="token punctuation">.</span>results<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">IntermediateDataSet</span> result <span class="token operator">=</span> jobVertex<span class="token punctuation">.</span>results<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>producedDataSets<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntermediateResult</span><span class="token punctuation">(</span>
                result<span class="token punctuation">.</span>id<span class="token punctuation">,</span>                 <span class="token comment">// id</span>
                <span class="token keyword">this</span><span class="token punctuation">,</span>                      <span class="token comment">// producer</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>parallelismInfo<span class="token punctuation">.</span><span class="token function">getParallelism</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                           <span class="token comment">// numParallelProducers</span>
                result<span class="token punctuation">.</span><span class="token function">getResultType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// resultType</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 构建ExecutionVertex，创建ExecutionJobVertex并行度数目的ExecutionVertex</span>
        <span class="token comment">// 一个JobVertex/ExecutionJobVertex代表一个算子或算子链，而具体的ExecutionVertex则代表了一个Task</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parallelismInfo<span class="token punctuation">.</span><span class="token function">getParallelism</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>taskVertices<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExecutionVertex</span><span class="token punctuation">(</span>
                <span class="token keyword">this</span><span class="token punctuation">,</span>               <span class="token comment">// jobVertex</span>
                i<span class="token punctuation">,</span>                  <span class="token comment">// subTaskIndex</span>
                producedDataSets<span class="token punctuation">,</span>
                timeout<span class="token punctuation">,</span>
                createTimestamp<span class="token punctuation">,</span>
                maxPriorAttemptsHistoryLength<span class="token punctuation">,</span>
                initialAttemptCounts<span class="token punctuation">.</span><span class="token function">getAttemptCount</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// initialAttemptCount</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SerializedValue</span><span class="token punctuation">&lt;</span><span class="token class-name">OperatorCoordinator<span class="token punctuation">.</span>Provider</span><span class="token punctuation">></span><span class="token punctuation">></span></span> coordinatorProviders <span class="token operator">=</span> <span class="token function">jobVertex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>operatorCoordinators<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SerializedValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OperatorCoordinator<span class="token punctuation">.</span>Provider</span><span class="token punctuation">></span></span> provider <span class="token operator">:</span> coordinatorProviders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            operatorCoordinators<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
                <span class="token class-name">OperatorCoordinatorHolder</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>
                    provider<span class="token punctuation">,</span>                   <span class="token comment">// serializedProvider</span>
                    <span class="token keyword">this</span><span class="token punctuation">,</span>                       <span class="token comment">// jobVertex</span>
                    graph<span class="token punctuation">.</span><span class="token function">userClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// classLoader</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 对可切分数据源进行输入切分，BATCH模式相关代码</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">connectToPredecessors</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IntermediateDataSetID</span><span class="token punctuation">,</span> <span class="token class-name">IntermediateResult</span><span class="token punctuation">></span></span> intermediateDataSets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取入边列表</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JobEdge</span><span class="token punctuation">></span></span> inputs <span class="token operator">=</span> jobVertex<span class="token punctuation">.</span>inputs<span class="token punctuation">;</span>
        <span class="token comment">// 遍历每条入边</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> num <span class="token operator">&lt;</span> inputs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> num<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">JobEdge</span> edge <span class="token operator">=</span> inputs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 获取入边对应的中间结果集</span>
            <span class="token class-name">IntermediateResult</span> ires <span class="token operator">=</span> intermediateDataSets<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>edge<span class="token punctuation">.</span>sourceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 将中间结果加入到ExecutionJobVertex的输入中</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>inputs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ires<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 根据JobEdge的distributionPattern属性创建ExecutionEdge，将ExecutionVertex和上游的IntermediateResultPartition连接起来</span>
            <span class="token comment">// 连接策略有两种：DistributionPattern.POINTWISE（点对点连接）和DistributionPattern.ALL_TO_ALL（全连接）</span>
            <span class="token comment">// 只有FORWARD方式下，分发模式才是POINTWISE，否则均为ALL_TO_ALL</span>
            <span class="token class-name">EdgeManagerBuildUtil</span><span class="token punctuation">.</span><span class="token function">connectVertexToResult</span><span class="token punctuation">(</span>
                <span class="token keyword">this</span><span class="token punctuation">,</span>                           <span class="token comment">// vertex</span>
                ires<span class="token punctuation">,</span>                           <span class="token comment">// intermediateResult</span>
                edge<span class="token punctuation">.</span>distributionPattern<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// distributionPattern</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">EdgeManagerBuildUtil</span> <span class="token punctuation">{</span>

    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">connectVertexToResult</span><span class="token punctuation">(</span>
        <span class="token class-name">ExecutionJobVertex</span> vertex<span class="token punctuation">,</span>
        <span class="token class-name">IntermediateResult</span> intermediateResult<span class="token punctuation">,</span>
        <span class="token class-name">DistributionPattern</span> distributionPattern<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">switch</span> <span class="token punctuation">(</span>distributionPattern<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token constant">POINTWISE</span><span class="token operator">:</span>
                <span class="token function">connectPointwise</span><span class="token punctuation">(</span>vertex<span class="token punctuation">.</span>taskVertices<span class="token punctuation">,</span> intermediateResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">ALL_TO_ALL</span><span class="token operator">:</span>
                <span class="token function">connectAllToAll</span><span class="token punctuation">(</span>vertex<span class="token punctuation">.</span>taskVertices<span class="token punctuation">,</span> intermediateResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 全连接策略下游的ExecutionEdge与上游的所有IntermediateResultPartition建立连接，消费其产生的数据，一般全连接的情况意味着数据在Shuffle</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">connectAllToAll</span><span class="token punctuation">(</span><span class="token class-name">ExecutionVertex</span><span class="token punctuation">[</span><span class="token punctuation">]</span> taskVertices<span class="token punctuation">,</span> <span class="token class-name">IntermediateResult</span> intermediateResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建ConsumedPartitionGroup</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IntermediateResultPartitionID</span><span class="token punctuation">></span></span> consumedPartitions <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>intermediateResult<span class="token punctuation">.</span>partitions<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">IntermediateResultPartition</span><span class="token operator">::</span><span class="token function">getPartitionId</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ConsumedPartitionGroup</span> consumedPartitionGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsumedPartitionGroup</span><span class="token punctuation">(</span>consumedPartitions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 向EdgeManager注册ConsumedPartitionGroup</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">IntermediateResultPartitionID</span> partitionId <span class="token operator">:</span> group<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            intermediateResult<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>graph<span class="token punctuation">.</span>edgeManager<span class="token punctuation">.</span>consumedPartitionsById
                <span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>partitionId<span class="token punctuation">,</span> ignore <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>partitionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 为ExecutionVertex添加consumer</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ExecutionVertex</span> ev <span class="token operator">:</span> taskVertices<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ev.addConsumedPartitionGroup(consumedPartitionGroup);</span>
            ev<span class="token punctuation">.</span>jobVertex<span class="token punctuation">.</span>graph<span class="token punctuation">.</span>edgeManager<span class="token punctuation">.</span>vertexConsumedPartitions
                <span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>executionVertexId<span class="token punctuation">,</span> id <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>consumedPartitionGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 创建ConsumerVertexGroup</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExecutionVertexID</span><span class="token punctuation">></span></span> consumerVertices <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>taskVertices<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">ExecutionVertex</span><span class="token operator">::</span><span class="token function">getID</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ConsumerVertexGroup</span> consumerVertexGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsumerVertexGroup</span><span class="token punctuation">(</span>consumerVertices<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 为中间结果分区添加consumer，即 关联到ExecutionEdge上</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">IntermediateResultPartition</span> partition <span class="token operator">:</span> intermediateResult<span class="token punctuation">.</span>partitions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            partition<span class="token punctuation">.</span>edgeManager<span class="token punctuation">.</span>partitionConsumers
                <span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>partition<span class="token punctuation">.</span>partitionId<span class="token punctuation">,</span> id <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>consumerVertexGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 点对点连接策略用来连接当前ExecutionVertex与上游IntermediateResultPartition，连接一共分3种情况：</span>
    <span class="token comment">// 1. 并发Task数与上游结果分区数相等，则进行一对一连接</span>
    <span class="token comment">// 2. 并发Task数小于上游结果分区数，则进行多对一连接</span>
    <span class="token comment">// 3. 并发Task数大于上游结果分区数，则进行一对多连接</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">connectPointwise</span><span class="token punctuation">(</span><span class="token class-name">ExecutionVertex</span><span class="token punctuation">[</span><span class="token punctuation">]</span> taskVertices<span class="token punctuation">,</span> <span class="token class-name">IntermediateResult</span> intermediateResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 上游结果分区数</span>
        <span class="token keyword">int</span> sourceCount <span class="token operator">=</span> intermediateResult<span class="token punctuation">.</span>partitions<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token comment">// 并发Task数</span>
        <span class="token keyword">int</span> targetCount <span class="token operator">=</span> taskVertices<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>sourceCount <span class="token operator">==</span> targetCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ExecutionVertex与IntermediateResultPartition进行一对一连接</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> sourceCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">ExecutionVertex</span> executionVertex <span class="token operator">=</span> taskVertices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token class-name">IntermediateResultPartition</span> partition <span class="token operator">=</span> intermediateResult<span class="token punctuation">.</span>partitions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

                <span class="token class-name">ConsumerVertexGroup</span> consumerVertexGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsumerVertexGroup</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span>executionVertex<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                partition<span class="token punctuation">.</span>edgeManager<span class="token punctuation">.</span>partitionConsumers
                    <span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>partition<span class="token punctuation">.</span>partitionId<span class="token punctuation">,</span> id <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>consumerVertexGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name">ConsumedPartitionGroup</span> consumedPartitionGroup <span class="token operator">=</span> <span class="token class-name">ConsumedPartitionGroup</span><span class="token punctuation">.</span><span class="token function">fromSinglePartition</span><span class="token punctuation">(</span>partition<span class="token punctuation">.</span>partitionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                intermediateResult<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>graph<span class="token punctuation">.</span>edgeManager<span class="token punctuation">.</span>consumedPartitionsById
                    <span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>partition<span class="token punctuation">.</span>partitionId<span class="token punctuation">,</span> ignore <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>consumedPartitionGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
                executionVertex<span class="token punctuation">.</span>jobVertex<span class="token punctuation">.</span>graph<span class="token punctuation">.</span>edgeManager<span class="token punctuation">.</span>vertexConsumedPartitions
                    <span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>executionVertex<span class="token punctuation">.</span>executionVertexId<span class="token punctuation">,</span> id <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>consumedPartitionGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sourceCount <span class="token operator">></span> targetCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> targetCount<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">ExecutionVertex</span> executionVertex <span class="token operator">=</span> taskVertices<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token class-name">ConsumerVertexGroup</span> consumerVertexGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsumerVertexGroup</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span>executionVertex<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">int</span> start <span class="token operator">=</span> index <span class="token operator">*</span> sourceCount <span class="token operator">/</span> targetCount<span class="token punctuation">;</span>
                <span class="token keyword">int</span> end <span class="token operator">=</span> <span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> sourceCount <span class="token operator">/</span> targetCount<span class="token punctuation">;</span>

                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IntermediateResultPartitionID</span><span class="token punctuation">></span></span> consumedPartitions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> start<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> end<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">IntermediateResultPartition</span> partition <span class="token operator">=</span> intermediateResult<span class="token punctuation">.</span>partitions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    partition<span class="token punctuation">.</span>edgeManager<span class="token punctuation">.</span>partitionConsumers
                        <span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>partition<span class="token punctuation">.</span>partitionId<span class="token punctuation">,</span> id <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>consumerVertexGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    consumedPartitions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>partition<span class="token punctuation">.</span>partitionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token class-name">ConsumedPartitionGroup</span> consumedPartitionGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsumedPartitionGroup</span><span class="token punctuation">(</span>consumedPartitions<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">IntermediateResultPartitionID</span> partitionId <span class="token operator">:</span> consumedPartitionGroup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    intermediateResult<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>graph<span class="token punctuation">.</span>edgeManager<span class="token punctuation">.</span>consumedPartitionsById
                        <span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>partitionId<span class="token punctuation">,</span> ignore <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>consumedPartitionGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                executionVertex<span class="token punctuation">.</span>jobVertex<span class="token punctuation">.</span>graph<span class="token punctuation">.</span>edgeManager<span class="token punctuation">.</span>vertexConsumedPartitions
                    <span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>executionVertex<span class="token punctuation">.</span>executionVertexId<span class="token punctuation">,</span> id <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>consumedPartitionGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> partitionNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> partitionNum <span class="token operator">&lt;</span> sourceCount<span class="token punctuation">;</span> partitionNum<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token class-name">IntermediateResultPartition</span> partition <span class="token operator">=</span> intermediateResult<span class="token punctuation">.</span>partitions<span class="token punctuation">[</span>partitionNum<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token class-name">ConsumedPartitionGroup</span> consumedPartitionGroup <span class="token operator">=</span> <span class="token class-name">ConsumedPartitionGroup</span><span class="token punctuation">.</span><span class="token function">fromSinglePartition</span><span class="token punctuation">(</span>partition<span class="token punctuation">.</span>partitionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                intermediateResult<span class="token punctuation">.</span>producer<span class="token punctuation">.</span>graph<span class="token punctuation">.</span>edgeManager<span class="token punctuation">.</span>consumedPartitionsById
                    <span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>partition<span class="token punctuation">.</span>partitionId<span class="token punctuation">,</span> ignore <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>consumedPartitionGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">int</span> start <span class="token operator">=</span> <span class="token punctuation">(</span>partitionNum <span class="token operator">*</span> targetCount <span class="token operator">+</span> sourceCount <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> sourceCount<span class="token punctuation">;</span>
                <span class="token keyword">int</span> end <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>partitionNum <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> targetCount <span class="token operator">+</span> sourceCount <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> sourceCount<span class="token punctuation">;</span>

                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExecutionVertexID</span><span class="token punctuation">></span></span> consumers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> start<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> end<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">ExecutionVertex</span> executionVertex <span class="token operator">=</span> taskVertices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    executionVertex<span class="token punctuation">.</span>jobVertex<span class="token punctuation">.</span>graph<span class="token punctuation">.</span>edgeManager<span class="token punctuation">.</span>vertexConsumedPartitions
                        <span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>executionVertex<span class="token punctuation">.</span>executionVertexId<span class="token punctuation">,</span> id <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>consumedPartitionGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    consumers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>executionVertex<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token class-name">ConsumerVertexGroup</span> consumerVertexGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsumerVertexGroup</span><span class="token punctuation">(</span>consumers<span class="token punctuation">)</span><span class="token punctuation">;</span>
                partition<span class="token punctuation">.</span>edgeManager<span class="token punctuation">.</span>partitionConsumers
                    <span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>partition<span class="token punctuation">.</span>partitionId<span class="token punctuation">,</span> id <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>consumerVertexGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<h2 id="作业调度" style="position:relative;"><a href="#%E4%BD%9C%E4%B8%9A%E8%B0%83%E5%BA%A6" aria-label="作业调度 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>作业调度</h2>
<p>在作业调度阶段，调度器根据调度模式选择对应的调度策略，申请所需要的资源，将Task发布到TaskManager上，启动Task。</p>
<p>按照拓扑顺序为所有的ExecutionJobVertex分配资源，其中每一个ExecutionVertex都需要分配一个slot，ExecutionVertex的一次执行对应一个Execution，在分配资源的时候会依照SlotSharingGroup和CoLocationConstraint确定，分配的时候会考虑slot重用的情况。在所有的节点资源都获取成功后，会逐一调用Execution的deploy()来部署Execution，使用TaskDeploymentDescriptor来描述Execution，并提交到分配给该Execution的slot对应的 TaskManager，最终被分配给对应的TaskExecutor执行。</p>
<p>Dispatcher创建并启动JobMaster，JobMaster将JobGraph转换为ExecutionGraph，接着向ResourceManager申请Slot并调度任务到TaskManager。所有任务启动成功后，作业进入执行状态，消费数据（从外部数据源读取数据），执行业务逻辑，数据在物理执行图中流转，处理完毕后，写出到外部存储。具体步骤为：</p>
<ol>
<li>Dispatcher接收作业后（Per-Job模式下，Dispatcher直接从Container工作目录加载JobGraph文件，Session模式下，Dispatcher通过BlobServer接收客户端提交的JobGraph文件），根据JobGraph启动JobMaster，构建ExecutionGraph（JobGraph的并行化版本，调度层最核心的数据结构）</li>
<li>JobMaster开始执行ExecutionGraph，向ResourceManager申请资源</li>
<li>ResourceManager将资源请求加入等待请求队列，并通过心跳向YARN ResourceManager申请新的Container资源来启动TaskManager进程，如果有空闲Slot资源，SlotManager将其分配给等待请求队列中匹配的请求</li>
<li>YARN ApplicationMasterService接收到资源请求后，解析出新的资源请求并更新应用请求信息</li>
<li>YARN ResourceScheduler成功为该应用分配资源后更新应用信息，ApplicationMasterService接收到Flink JobManager的下一次心跳时返回新分配资源信息</li>
<li>Flink ResourceManager接收到新分配的Container资源后，准备好ContainerLauncherContext，然后向YARN NodeManager申请启动TaskManager进程，YARN NodeManager启动Container。ContainerLauncherContext生成TaskManager配置并上传至分布式存储，配置其他依赖和环境变量等</li>
<li>TaskManager进程加载并运行YarnTaskExecutorRunner（Flink TaskManager入口类），初始化完成后启动TaskExecutor（负责执行Task相关操作）</li>
<li>TaskExecutor启动后先向ResourceManager注册，成功后再向SlotManager汇报自己的Slot资源与状态。SlotManager接收到Slot空闲资源后主动触发Slot分配，从等待请求队列中选出合适的资源请求后，向TaskManager请求该Slot资源</li>
<li>TaskManager收到请求后检查该Slot是否可分配、Job是否已注册（没有则先注册再分配Slot）、检查通过后将Slot分配给JobMaster</li>
<li>JobMaster检查Slot分配是否重复，通过后通知Execution执行部署Task流程，向TaskExecutor提交Task，TaskExecutor启动新的线程运行Task</li>
</ol>
<div class='wrapper' markdown='block'>
<p><img src="https://www.plantuml.com/plantuml/svg/ZP3DJiCm48JlVehb1eTKufv3eQ3Ue29zWOspJQpOJkHT2oBQTqT9e_wGy7Fqp7ZqpIvPC4XqLgaRgSWHS4sYgovfebZZILMc823NIWUEN4w15TV6jnZGmKC8pVksChhsn0ptIXal57Qe2J9TKH4jXPVrL3M-p2IWKDd1fm80643ExktTe0OQz2ropQFK-ESFqb5CupD1eLM5lgIJkS4WfZTNZUVeCBUzTvW3UsqfO1zbXJbBG2sWBJAV8u_8f8xQ4-qmMZbP8_VC89v8wZ2MR4nB_LcBDohx0TEakhWRfFl5uXlCrGlIVP9CoDJCmcFLJybB-lINngjSN_ZtdbcM9Fd7poNv8Zhx1G00" alt="plantuml"></p>
</div>
<p>Flink调度实现中有以下重要组件：</p>
<ul>
<li>调度器：SchedulerNG接口及其实现类（SchedulerBase、DefaultScheduler），是Flink作业执行的核心组件，具备以下基本能力：
<ul>
<li>将JobGraph转换为ExecutionGraph</li>
<li>作业生命周期管理（发布、取消、停止），对外提供作业详细信息</li>
<li>Task生命周期管理（启动、取消、停止）</li>
<li>作业执行资源的申请、分配、释放</li>
<li>作业和Task的故障恢复</li>
</ul>
</li>
<li>调度策略：SchedulingStrategy接口及其实现类PipelinedRegionSchedulingStrategy，定义了四种调度行为。PipelinedRegionSchedulingStrategy以Pipelined Region（指ExecutionGraph中以Pipelined数据交换模式传递数据的Task集合）为粒度进行调度，一旦某个Pipelined Region获取了足够的Slot就可以部署它
<ul>
<li>startScheduling()：调度入口，触发调度器的调度行为</li>
<li>restartTasks()：重启执行失败的Task</li>
<li>onExecutionStateChange()：Execution状态发生改变时调用</li>
<li>onPartitionConsumable()：当中间结果分区中的数据可以消费时调用</li>
</ul>
</li>
</ul>
<div class='wrapper' markdown='block'>
<p><img src="https://www.plantuml.com/plantuml/svg/xPOnRy8m48Lt_uhh1aE6hWmHaIYLaDgXL5qwcUIQM3WsiY-5_FkAG8D374XGswaPdNVliyylkamjSKD5BjaTPPWZs3LId9M1BaWAXImJ2GBc6oeXnto5nZAx5ch33SyXCaPlNpCHhnLQ2_ViFGXXeLTFt18Qc43blj2hXnt61GcjHcF6OnAVdF0aP03Wb0KXBECCaqAYUNxyTZak2PMEnbL1xUE8gnVxnpKu-GcLBibmmhJijFLPEtMrng6uja48C_pWXQHw2p01BgMEEU5IQhAHIcQuaRfqY0tgkK53jNzQX224kiLxHdJWwHPxhiqPjK7scxJq7Qp0S_XMRO93QRxJUdgyvOBcsaHINkpoi4vVxVOR6i8TJ81C6LahKlM2LXScHW_Nt-k3XLVSQFOHvT87SFtiwzJgLllkrNUvhDUX-aIdYz2ngVQz3SpdJT-X9vb9bSD8oZ-AOjAL-z_8tqNOV-X-DdHUzoj3ge-tRv0rnp3ps7M06xFN_I5W_lhAtba-wQUeaYANNm00" alt="plantuml"></p>
</div>
<p>作业调度入口是JobMaster的startJobExecution()方法，PipelinedRegionSchedulingStrategy调度策略计算需要调度的SourceRegion，然后调用SchedulerOperations（实现类为DefaultScheduler）的allocateSlotsAndDeploy()方法申请Slot部署Task。DefaultScheduler调用ExecutionSlotAllocator的allocateSLotsFor()，对所有Execution异步获取Slot，申请到所需的Slot后，调用Execution的deploy()方法进行实际的部署，即将Task部署相关信息包装后通过TaskManagerGateway的submit()RPC接口发送到TaskManager上，实际调用TaskExecutor（TaskManager实现类）的submitTask()方法，这个方法创建Task并调用Task的startTaskThread()方法启动Task线程。</p>
<p>TaskManager从接收到的Task部署信息中获取Task执行所需要的信息，初始化Task，然后触发Task的执行，Task完成一系列的初始化动作后，进入Task执行阶段。在部署和执行过程中，TaskExecutor与JobManager保持交互，将Task的状态汇报给JobMaster，并接受JobMaster的Task管理操作。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/6f7d8014c4cabf1975ca8df53ad50be1/09262/deploy_task.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 44.93670886075949%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABC0lEQVR42n2SB27FQAhEff9L2nLvvTeih4QV/x8FCeFlYWZg7cgfNo6j1HUtRVFI13XSNM3Lp2mS67rkPE85jkOjufMJRrKqKlmWRb8B7/teQYZhUCLP8ySKIsnzXHPUbtumtS9AWGnY9/3JWcO6ro/TOM+zqgWIb2ogfgEyHhfYfd8aaSrLUnzflzRNJcsybSRHZC1xHCsx9w6qMBvBwAwQEhSgqm1bPaOKKcibIwRyh32FYagKALQmHMYgCHR/1EBKDk+SRM9EajGAHZiRyyjsj4dANY4K7mxvRgQxtSgiMjp9Cmjj8fzIJgkAZwCJv0dmItd1n5c3pwcRX78N4PZiqEahvart9T/7AR2iuA2+/3/aAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Task部署执行"
        title=""
        src="/static/6f7d8014c4cabf1975ca8df53ad50be1/f058b/deploy_task.png"
        srcset="/static/6f7d8014c4cabf1975ca8df53ad50be1/c26ae/deploy_task.png 158w,
/static/6f7d8014c4cabf1975ca8df53ad50be1/6bdcf/deploy_task.png 315w,
/static/6f7d8014c4cabf1975ca8df53ad50be1/f058b/deploy_task.png 630w,
/static/6f7d8014c4cabf1975ca8df53ad50be1/40601/deploy_task.png 945w,
/static/6f7d8014c4cabf1975ca8df53ad50be1/78612/deploy_task.png 1260w,
/static/6f7d8014c4cabf1975ca8df53ad50be1/09262/deploy_task.png 1896w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java">
<span class="token keyword">class</span> <span class="token class-name">JobMaster</span>
<span class="token punctuation">{</span>
    <span class="token class-name">SchedulerNG</span> schedulerNG<span class="token punctuation">;</span>  <span class="token comment">// 构造方法中初始化为DefaultScheduler对象</span>
    <span class="token class-name">RpcServer</span> rpcServer<span class="token punctuation">;</span>      <span class="token comment">// 继承自RpcEndpoint</span>
    <span class="token keyword">void</span> <span class="token function">startJobExecution</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// startJobMasterServices</span>
        slotPoolService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token function">getFencingToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getMainThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resourceManagerLeaderRetriever<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResourceManagerLeaderListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Starting execution of job '{}' ({}) under job master id {}."</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 开始调度</span>
        schedulerNG<span class="token punctuation">.</span><span class="token function">startScheduling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">PipelinedRegionSchedulingStrategy</span> <span class="token keyword">implements</span> <span class="token class-name">SchedulingStrategy</span> <span class="token punctuation">{</span>

    <span class="token class-name">SchedulerOperations</span> schedulerOperations<span class="token punctuation">;</span>  <span class="token comment">// 构造方法传入，DefaultScheduler对象</span>
    <span class="token class-name">SchedulingTopology</span> schedulingTopology<span class="token punctuation">;</span>    <span class="token comment">// 构造方法传入，值为executionGraph.schedulingTopology;</span>

    <span class="token keyword">void</span> <span class="token function">startScheduling</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取需要调度的Region</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SchedulingPipelinedRegion</span><span class="token punctuation">></span></span> sourceRegions <span class="token operator">=</span>
            <span class="token class-name">IterableUtils</span><span class="token punctuation">.</span><span class="token function">toStream</span><span class="token punctuation">(</span>schedulingTopology<span class="token punctuation">.</span>pipelinedRegions<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">isSourceRegion</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SchedulingPipelinedRegion</span><span class="token punctuation">></span></span> regionsSorted <span class="token operator">=</span>
            <span class="token class-name">SchedulingStrategyUtils</span><span class="token punctuation">.</span><span class="token function">sortPipelinedRegionsInTopologicalOrder</span><span class="token punctuation">(</span>schedulingTopology<span class="token punctuation">,</span> sourceRegions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConsumedPartitionGroup</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">></span></span> consumableStatusCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SchedulingPipelinedRegion</span> region <span class="token operator">:</span> regionsSorted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ExecutionVertexDeploymentOption记录需要调度的Task</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExecutionVertexDeploymentOption</span><span class="token punctuation">></span></span> vertexDeploymentOptions <span class="token operator">=</span>
                <span class="token class-name">SchedulingStrategyUtils</span><span class="token punctuation">.</span><span class="token function">createExecutionVertexDeploymentOptions</span><span class="token punctuation">(</span>
                    regionVerticesSorted<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>region<span class="token punctuation">)</span><span class="token punctuation">,</span>           <span class="token comment">// executionVertexId，需要部署的Task</span>
                    id <span class="token operator">-></span> deploymentOption<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// deploymentOption，表示任务数据可用时是否通知JobMaster，流处理为False</span>
            <span class="token comment">// 申请Slot部署Task</span>
            schedulerOperations<span class="token punctuation">.</span><span class="token function">allocateSlotsAndDeploy</span><span class="token punctuation">(</span>vertexDeploymentOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">DefaultScheduler</span> <span class="token keyword">extends</span> <span class="token class-name">SchedulerBase</span> <span class="token keyword">implements</span> <span class="token class-name">SchedulerOperations</span>
<span class="token punctuation">{</span>
    <span class="token class-name">ExecutionSlotAllocator</span> executionSlotAllocator<span class="token punctuation">;</span>   <span class="token comment">// 构造方法中初始化为SlotSharingExecutionSlotAllocator实例</span>
    <span class="token class-name">ComponentMainThreadExecutor</span> mainThreadExecutor<span class="token punctuation">;</span>  <span class="token comment">// 继承自SchedulerBase</span>
    <span class="token class-name">SchedulingStrategy</span> schedulingStrategy<span class="token punctuation">;</span>           <span class="token comment">// 构造方法中初始化为PipelinedRegionSchedulingStrategy实例</span>

    <span class="token keyword">void</span> <span class="token function">startScheduling</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Starting scheduling with scheduling strategy [{}]"</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        schedulingStrategy<span class="token punctuation">.</span><span class="token function">startScheduling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">allocateSlotsAndDeploy</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExecutionVertexDeploymentOption</span><span class="token punctuation">></span></span> executionVertexDeploymentOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// groupDeploymentOptionsByVertexId</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExecutionVertexID</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionVertexDeploymentOption</span><span class="token punctuation">></span></span> deploymentOptionsByVertex <span class="token operator">=</span>
            executionVertexDeploymentOptions<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span>
                    <span class="token class-name">ExecutionVertexDeploymentOption</span><span class="token operator">::</span><span class="token function">getExecutionVertexId</span><span class="token punctuation">,</span>
                    <span class="token class-name">Function</span><span class="token punctuation">.</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExecutionVertexID</span><span class="token punctuation">></span></span> verticesToDeploy <span class="token operator">=</span>
            executionVertexDeploymentOptions<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">ExecutionVertexDeploymentOption</span><span class="token operator">::</span><span class="token function">getExecutionVertexId</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExecutionVertexID</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionVertexVersion</span><span class="token punctuation">></span></span> requiredVersionByVertex <span class="token operator">=</span>
            executionVertexVersioner<span class="token punctuation">.</span><span class="token function">recordVertexModifications</span><span class="token punctuation">(</span>verticesToDeploy<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// transitionToScheduled，Task状态转为SCHEDULED</span>
        verticesToDeploy<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>executionVertexId <span class="token operator">-></span>
            executionGraph<span class="token punctuation">.</span>tasks        <span class="token comment">// Map&lt;JobVertexID, ExecutionJobVertex></span>
                <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>executionVertexId<span class="token punctuation">.</span>jobVertexId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span>taskVertices<span class="token punctuation">[</span>executionVertexId<span class="token punctuation">.</span>subtaskIndex<span class="token punctuation">]</span>
                <span class="token punctuation">.</span>currentExecution
                <span class="token punctuation">.</span><span class="token function">transitionState</span><span class="token punctuation">(</span><span class="token class-name">ExecutionState</span><span class="token punctuation">.</span><span class="token constant">SCHEDULED</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// allocateSlots，为指定Execution申请Slot</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SlotExecutionVertexAssignment</span><span class="token punctuation">></span></span> slotExecutionVertexAssignments <span class="token operator">=</span>
            executionSlotAllocator<span class="token punctuation">.</span><span class="token function">allocateSlotsFor</span><span class="token punctuation">(</span>
                executionVertexDeploymentOptions<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">ExecutionVertexDeploymentOption</span><span class="token operator">::</span><span class="token function">executionVertexId</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// createDeploymentHandles，DeploymentHandle实际是三元组(ExecutionVertexVersion, ExecutionVertexDeploymentOption, SlotExecutionVertexAssignment)，记录部署ExecutionVertex的必需信息</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DeploymentHandle</span><span class="token punctuation">></span></span> deploymentHandles <span class="token operator">=</span>
            slotExecutionVertexAssignments<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>slotExecutionVertexAssignment <span class="token operator">-></span> <span class="token punctuation">{</span>
                    <span class="token class-name">ExecutionVertexID</span> executionVertexId <span class="token operator">=</span> slotExecutionVertexAssignment<span class="token punctuation">.</span>executionVertexId<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DeploymentHandle</span><span class="token punctuation">(</span>
                        requiredVersionByVertex<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>executionVertexId<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        deploymentOptionsByVertex<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>executionVertexId<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        slotExecutionVertexAssignment<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// waitForAllSlotsAndDeploy</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span><span class="token punctuation">></span></span> resultFutures <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">DeploymentHandle</span> deploymentHandle <span class="token operator">:</span> deploymentHandles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> resultFuture <span class="token operator">=</span>
                deploymentHandle<span class="token punctuation">.</span>slotExecutionVertexAssignment<span class="token punctuation">.</span>logicalSlotFuture
                    <span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span><span class="token punctuation">(</span>logicalSlot<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
                        <span class="token comment">// assignResource</span>
                        executionGraph<span class="token punctuation">.</span>tasks
                            <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>executionVertexId<span class="token punctuation">.</span>jobVertexId<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span>taskVertices<span class="token punctuation">[</span>executionVertexId<span class="token punctuation">.</span>subtaskIndex<span class="token punctuation">]</span>
                            <span class="token punctuation">.</span>currentExecution
                            <span class="token punctuation">.</span><span class="token function">tryAssignResource</span><span class="token punctuation">(</span>logicalSlot<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> logicalSlot<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">thenCompose</span><span class="token punctuation">(</span>logicalSlot <span class="token operator">-></span> <span class="token punctuation">{</span>
                        <span class="token comment">// registerProducedPartitions</span>
                        <span class="token class-name">ExecutionVertexID</span> executionVertexId <span class="token operator">=</span> deploymentHandle<span class="token punctuation">.</span>requiredVertexVersion<span class="token punctuation">.</span>executionVertexId<span class="token punctuation">;</span>
                        <span class="token class-name">ExecutionVertex</span> executionVertex <span class="token operator">=</span> executionGraph<span class="token punctuation">.</span>tasks
                            <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>executionVertexId<span class="token punctuation">.</span>jobVertexId<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span>taskVertices<span class="token punctuation">[</span>executionVertexId<span class="token punctuation">.</span>subtaskIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token keyword">boolean</span> notifyPartitionDataAvailable <span class="token operator">=</span> deploymentHandle<span class="token punctuation">.</span>executionVertexDeploymentOption<span class="token punctuation">.</span>deploymentOption<span class="token punctuation">.</span>notifyPartitionDataAvailable<span class="token punctuation">;</span>

                        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> partitionRegistrationFuture <span class="token operator">=</span> executionVertex<span class="token punctuation">.</span>currentExecution
                            <span class="token punctuation">.</span><span class="token function">registerProducedPartitions</span><span class="token punctuation">(</span>
                                logicalSlot<span class="token punctuation">.</span>slotContext<span class="token punctuation">.</span>taskManagerLocation<span class="token punctuation">,</span>
                                notifyPartitionDataAvailable<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>partitionRegistrationFuture<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">ScheduledFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> timeoutFuture <span class="token operator">=</span> <span class="token class-name">Delayer</span><span class="token punctuation">.</span><span class="token function">delay</span><span class="token punctuation">(</span>
                                <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> mainThreadExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Timeout</span><span class="token punctuation">(</span>future<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                rpcTimeout<span class="token punctuation">.</span><span class="token function">toMilliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                            <span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">T</span> value<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timeoutFuture<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    timeoutFuture<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">return</span> partitionRegistrationFuture<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            resultFutures<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>resultFuture<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 申请到所有需要的Slot后，调用Execution的deploy()方法进行实际的部署</span>
        <span class="token class-name">FutureUtils</span><span class="token punctuation">.</span><span class="token function">waitForAll</span><span class="token punctuation">(</span>resultFutures<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">thenRun</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
                <span class="token comment">// deployAll</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">DeploymentHandle</span> deploymentHandle <span class="token operator">:</span> deploymentHandles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">SlotExecutionVertexAssignment</span> slotExecutionVertexAssignment <span class="token operator">=</span> deploymentHandle<span class="token punctuation">.</span><span class="token function">getSlotExecutionVertexAssignment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LogicalSlot</span><span class="token punctuation">></span></span> slotAssigned <span class="token operator">=</span> slotExecutionVertexAssignment<span class="token punctuation">.</span><span class="token function">getLogicalSlotFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">assert</span> slotAssigned<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    slotAssigned<span class="token punctuation">.</span><span class="token function">thenRun</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
                        <span class="token comment">// deployTask</span>
                        <span class="token class-name">ExecutionVertexID</span> executionVertexId <span class="token operator">=</span> deploymentHandle<span class="token punctuation">.</span>requiredVertexVersion<span class="token punctuation">.</span>executionVertexId<span class="token punctuation">;</span>
                        executionGraph<span class="token punctuation">.</span>tasks
                           <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>executionVertexId<span class="token punctuation">.</span>jobVertexId<span class="token punctuation">)</span>
                           <span class="token punctuation">.</span>taskVertices<span class="token punctuation">[</span>executionVertexId<span class="token punctuation">.</span>subtaskIndex<span class="token punctuation">]</span>
                           <span class="token punctuation">.</span>currentExecution
                           <span class="token punctuation">.</span><span class="token function">deploy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">SlotSharingExecutionSlotAllocator</span> <span class="token keyword">implements</span> <span class="token class-name">ExecutionSlotAllocator</span>
<span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SlotExecutionVertexAssignment</span><span class="token punctuation">></span></span> <span class="token function">allocateSlotsFor</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExecutionVertexID</span><span class="token punctuation">></span></span> executionVertexIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SharedSlotProfileRetriever</span> sharedSlotProfileRetriever <span class="token operator">=</span> sharedSlotProfileRetrieverFactory<span class="token punctuation">.</span><span class="token function">createFromBulk</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>executionVertexIds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExecutionSlotSharingGroup</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ExecutionVertexID</span><span class="token punctuation">></span><span class="token punctuation">></span></span> executionsByGroup <span class="token operator">=</span>
            executionVertexIds<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">groupingBy</span><span class="token punctuation">(</span>
                    slotSharingStrategy<span class="token operator">::</span><span class="token function">getExecutionSlotSharingGroup</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExecutionSlotSharingGroup</span><span class="token punctuation">,</span> <span class="token class-name">SharedSlot</span><span class="token punctuation">></span></span> slots <span class="token operator">=</span>
            executionsByGroup<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>group <span class="token operator">-></span> <span class="token function">getOrAllocateSharedSlot</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> sharedSlotProfileRetriever<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span>
                    <span class="token class-name">SharedSlot</span><span class="token operator">::</span><span class="token function">getExecutionSlotSharingGroup</span><span class="token punctuation">,</span>
                    <span class="token class-name">Function</span><span class="token punctuation">.</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExecutionVertexID</span><span class="token punctuation">,</span> <span class="token class-name">SlotExecutionVertexAssignment</span><span class="token punctuation">></span></span> assignments <span class="token operator">=</span>
            <span class="token function">allocateLogicalSlotsFromSharedSlots</span><span class="token punctuation">(</span>slots<span class="token punctuation">,</span> executionsByGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// we need to pass the slots map to the createBulk method instead of using the allocator's</span>
        <span class="token comment">// 'sharedSlots'</span>
        <span class="token comment">// because if any physical slots have already failed, their shared slots have been removed</span>
        <span class="token comment">// from the allocator's 'sharedSlots' by failed logical slots.</span>
        <span class="token class-name">SharingPhysicalSlotRequestBulk</span> bulk <span class="token operator">=</span> <span class="token function">createBulk</span><span class="token punctuation">(</span>slots<span class="token punctuation">,</span> executionsByGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
        bulkChecker<span class="token punctuation">.</span><span class="token function">schedulePendingRequestBulkTimeoutCheck</span><span class="token punctuation">(</span>bulk<span class="token punctuation">,</span> allocationTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> executionVertexIds<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>assignments<span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Execution</span> <span class="token keyword">implements</span> <span class="token class-name">LogicalSlot<span class="token punctuation">.</span>Payload</span>
<span class="token punctuation">{</span>
    <span class="token class-name">LogicalSlot</span> assignedResource<span class="token punctuation">;</span>
    <span class="token class-name">ExecutionVertex</span> vertex<span class="token punctuation">;</span>       <span class="token comment">// 任务对应的ExecutionVertex，构造时传入</span>

    <span class="token keyword">boolean</span> <span class="token function">tryAssignResource</span><span class="token punctuation">(</span><span class="token class-name">LogicalSlot</span> logicalSlot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// only allow to set the assigned resource in state SCHEDULED or CREATED</span>
        <span class="token keyword">assert</span> state <span class="token operator">==</span> <span class="token constant">SCHEDULED</span> <span class="token operator">||</span> state <span class="token operator">==</span> <span class="token constant">CREATED</span><span class="token punctuation">;</span>
        <span class="token keyword">assert</span> assignedResource <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        assignedResource <span class="token operator">=</span> logicalSlot<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logicalSlot<span class="token punctuation">.</span><span class="token function">tryAssignPayload</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">assert</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token constant">SCHEDULED</span> <span class="token operator">||</span> state <span class="token operator">==</span> <span class="token constant">CREATED</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>taskManagerLocationFuture<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            taskManagerLocationFuture<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>logicalSlot<span class="token punctuation">.</span><span class="token function">getTaskManagerLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            assignedAllocationID <span class="token operator">=</span> logicalSlot<span class="token punctuation">.</span><span class="token function">getAllocationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> <span class="token function">registerProducedPartitions</span><span class="token punctuation">(</span><span class="token class-name">TaskManagerLocation</span> location<span class="token punctuation">,</span> <span class="token keyword">boolean</span> notifyPartitionDataAvailable<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">ProducerDescriptor</span> producerDescriptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProducerDescriptor</span><span class="token punctuation">(</span>
            location<span class="token punctuation">.</span>resourceID<span class="token punctuation">,</span>
            attemptId<span class="token punctuation">,</span>
            location<span class="token punctuation">.</span>inetAddress<span class="token punctuation">,</span>
            location<span class="token punctuation">.</span>dataPort<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IntermediateResultPartition</span><span class="token punctuation">></span></span> partitions <span class="token operator">=</span> vertex<span class="token punctuation">.</span>resultPartitions<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">&lt;</span><span class="token class-name">ResultPartitionDeploymentDescriptor</span><span class="token punctuation">></span><span class="token punctuation">></span></span> partitionRegistrations <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>partitions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">IntermediateResultPartition</span> partition <span class="token operator">:</span> partitions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> numberOfSubpartitions <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConsumerVertexGroup</span><span class="token punctuation">></span></span> consumerVertexGroups <span class="token operator">=</span> partition<span class="token punctuation">.</span>edgeManager<span class="token punctuation">.</span>partitionConsumers
                <span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>partition<span class="token punctuation">.</span>partitionId<span class="token punctuation">,</span> id <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>consumerVertexGroups<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>consumerVertexGroups<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 当前一个分区只支持一个消费组</span>
                <span class="token keyword">assert</span> consumerVertexGroups<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span>
                numberOfSubpartitions <span class="token operator">=</span> consumerVertexGroups<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">IntermediateResult</span> result <span class="token operator">=</span> partition<span class="token punctuation">.</span>totalResult<span class="token punctuation">;</span>
            <span class="token class-name">PartitionDescriptor</span> partitionDescriptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PartitionDescriptor</span><span class="token punctuation">(</span>
                result<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
                partition<span class="token punctuation">.</span>totalResult<span class="token punctuation">.</span>partitionsAssigned<span class="token punctuation">,</span>
                partition<span class="token punctuation">.</span>partitionId<span class="token punctuation">,</span>
                result<span class="token punctuation">.</span>resultType<span class="token punctuation">,</span>
                numberOfSubpartitions<span class="token punctuation">,</span>
                result<span class="token punctuation">.</span>connectionIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> maxParallelism <span class="token operator">=</span> vertex<span class="token punctuation">.</span>jobVertex<span class="token punctuation">.</span>graph<span class="token punctuation">.</span>executionVerticesById
                <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>consumerVertexGroups<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>vertices<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>jobVertex<span class="token punctuation">.</span>parallelismInfo<span class="token punctuation">.</span>maxParallelism<span class="token punctuation">;</span>

            <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">ShuffleDescriptor</span><span class="token punctuation">></span></span> shuffleDescriptorFuture <span class="token operator">=</span>
                vertex<span class="token punctuation">.</span>jobVertex<span class="token punctuation">.</span>graph<span class="token punctuation">.</span>shuffleMaster
                    <span class="token punctuation">.</span><span class="token function">registerPartitionWithProducer</span><span class="token punctuation">(</span>
                        vertex<span class="token punctuation">.</span>jobVertex<span class="token punctuation">.</span>graph<span class="token punctuation">.</span>jobInformation<span class="token punctuation">.</span>jobId<span class="token punctuation">,</span>
                        partitionDescriptor<span class="token punctuation">,</span>
                        producerDescriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResultPartitionDeploymentDescriptor</span><span class="token punctuation">></span></span> partitionRegistration <span class="token operator">=</span>
                shuffleDescriptorFuture<span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>shuffleDescriptor <span class="token operator">-></span>
                    <span class="token keyword">new</span> <span class="token class-name">ResultPartitionDeploymentDescriptor</span><span class="token punctuation">(</span>
                        partitionDescriptor<span class="token punctuation">,</span>
                        shuffleDescriptor<span class="token punctuation">,</span>
                        maxParallelism<span class="token punctuation">,</span>
                        notifyPartitionDataAvailable<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            partitionRegistrations<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>partitionRegistration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">IntermediateResultPartitionID</span><span class="token punctuation">,</span> <span class="token class-name">ResultPartitionDeploymentDescriptor</span><span class="token punctuation">></span><span class="token punctuation">></span></span> completableFuture <span class="token operator">=</span>
            <span class="token class-name">FutureUtils</span><span class="token punctuation">.</span><span class="token function">combineAll</span><span class="token punctuation">(</span>partitionRegistrations<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>rpdds <span class="token operator">-></span> <span class="token punctuation">{</span>
                    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IntermediateResultPartitionID</span><span class="token punctuation">,</span> <span class="token class-name">ResultPartitionDeploymentDescriptor</span><span class="token punctuation">></span></span> producedPartitions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>partitions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    rpdds<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>rpdd <span class="token operator">-></span> producedPartitions<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>rpdd<span class="token punctuation">.</span>partitionDescriptor<span class="token punctuation">.</span>partitionId<span class="token punctuation">,</span> rpdd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> producedPartitions<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Executor</span> executor <span class="token operator">=</span> vertex<span class="token punctuation">.</span>jobVertex<span class="token punctuation">.</span>graph<span class="token punctuation">.</span>jobMasterMainThreadExecutor<span class="token punctuation">;</span>
        <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">IntermediateResultPartitionID</span><span class="token punctuation">,</span> <span class="token class-name">ResultPartitionDeploymentDescriptor</span><span class="token punctuation">></span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Void</span><span class="token punctuation">></span></span> applyFun <span class="token operator">=</span>
            <span class="token punctuation">(</span>producedPartitionsCache<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token constant">SCHEDULED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// startTrackingPartitions</span>
                    <span class="token class-name">JobMasterPartitionTracker</span> partitionTracker <span class="token operator">=</span> vertex<span class="token punctuation">.</span>jobVertex<span class="token punctuation">.</span>graph<span class="token punctuation">.</span>partitionTracker<span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ResultPartitionDeploymentDescriptor</span> partition <span class="token operator">:</span> producedPartitionsCache<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        partitionTracker<span class="token punctuation">.</span><span class="token function">startTrackingPartition</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>resourceID<span class="token punctuation">,</span> partition<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> completableFuture<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">?</span> completableFuture<span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>applyFun<span class="token punctuation">)</span>
            <span class="token operator">:</span> completableFuture<span class="token punctuation">.</span><span class="token function">thenApplyAsync</span><span class="token punctuation">(</span>applyFun<span class="token punctuation">,</span> executor<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">deploy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">LogicalSlot</span> slot <span class="token operator">=</span> assignedResource<span class="token punctuation">;</span>
        <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Deploying {} (attempt #{}) with attempt id {} to {} with allocation id {}"</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建Task部署描述信息，将IntermediateResultPartition转换为ResultPartition，Execution转换成InputChannelDeploymentDescriptor（执行时转换为InputGate）</span>
        <span class="token class-name">TaskDeploymentDescriptor</span> deployment <span class="token operator">=</span>
            <span class="token class-name">TaskDeploymentDescriptorFactory</span>
                <span class="token punctuation">.</span><span class="token function">fromExecutionVertex</span><span class="token punctuation">(</span>vertex<span class="token punctuation">,</span> attemptNumber<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">createDeploymentDescriptor</span><span class="token punctuation">(</span>
                    slot<span class="token punctuation">.</span>slotContext<span class="token punctuation">.</span>allocationId<span class="token punctuation">,</span>
                    taskRestore<span class="token punctuation">,</span>
                    producedPartitions<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        taskRestore <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">// TaskManager RPC接口</span>
        <span class="token class-name">TaskManagerGateway</span> taskManagerGateway <span class="token operator">=</span> slot<span class="token punctuation">.</span>slotContext<span class="token punctuation">.</span>taskManagerGateway<span class="token punctuation">;</span>
        <span class="token class-name">ComponentMainThreadExecutor</span> jobMasterMainThreadExecutor <span class="token operator">=</span> vertex<span class="token punctuation">.</span>jobVertex<span class="token punctuation">.</span>graph<span class="token punctuation">.</span>jobMasterMainThreadExecutor<span class="token punctuation">;</span>
        vertex<span class="token punctuation">.</span><span class="token function">notifyPendingDeployment</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 通知即将部署</span>
        <span class="token comment">// 通过异步回调方式，调用TaskManagerGateway的RPC通信接口将Task发送给TaskManager，避免Task部署描述信息过大导致主线程阻塞</span>
        <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> taskManagerGateway<span class="token punctuation">.</span><span class="token function">submitTask</span><span class="token punctuation">(</span>deployment<span class="token punctuation">,</span> rpcTimeout<span class="token punctuation">)</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">thenCompose</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token punctuation">.</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">whenRunAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> vertex<span class="token punctuation">.</span><span class="token function">notifyCompletedDeployment</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> jobMasterMainThreadExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 通知部署完成</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">RpcTaskManagerGateway</span> <span class="token keyword">implements</span> <span class="token class-name">TaskManagerGateway</span>
<span class="token punctuation">{</span>
    <span class="token class-name">TaskExecutorGateway</span> taskExecutorGateway<span class="token punctuation">;</span>
    <span class="token class-name">JobMasterId</span> jobMasterId<span class="token punctuation">;</span>
    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Acknowledge</span><span class="token punctuation">></span></span> <span class="token function">submitTask</span><span class="token punctuation">(</span><span class="token class-name">TaskDeploymentDescriptor</span> tdd<span class="token punctuation">,</span> <span class="token class-name">Time</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> taskExecutorGateway<span class="token punctuation">.</span><span class="token function">submitTask</span><span class="token punctuation">(</span>tdd<span class="token punctuation">,</span> jobMasterId<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">TaskExecutor</span> <span class="token keyword">implements</span> <span class="token class-name">TaskExecutorGateway</span> <span class="token punctuation">{</span>

    <span class="token class-name">TaskSlotTable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">></span></span> taskSlotTable<span class="token punctuation">;</span>
    <span class="token comment">// 创建Task并调用其startTaskThread()方法开始执行Task</span>
    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Acknowledge</span><span class="token punctuation">></span></span> <span class="token function">submitTask</span><span class="token punctuation">(</span><span class="token class-name">TaskDeploymentDescriptor</span> tdd<span class="token punctuation">,</span> <span class="token class-name">JobMasterId</span> jobMasterId<span class="token punctuation">,</span> <span class="token class-name">Time</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 创建Task，Task构造方法会根据输入参数创建InputGate、ResultPartition、ResultPartitionWriter等</span>
        <span class="token class-name">Task</span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Task</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Received task {} ({}), deploy into slot with allocation id {}."</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        taskSlotTable<span class="token punctuation">.</span><span class="token function">addTask</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动Task线程，执行Task中executingThread的start()方法，从而调用Task的run()方法</span>
        task<span class="token punctuation">.</span><span class="token function">startTaskThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span><span class="token class-name">Acknowledge</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Task</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">startTaskThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        executingThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 转换状态，CREATED -> DEPLOYING</span>
        <span class="token function">transitionState</span><span class="token punctuation">(</span><span class="token class-name">ExecutionState</span><span class="token punctuation">.</span><span class="token constant">CREATED</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionState</span><span class="token punctuation">.</span><span class="token constant">DEPLOYING</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Future</span><span class="token punctuation">&lt;</span><span class="token class-name">Path</span><span class="token punctuation">></span><span class="token punctuation">></span></span> distributedCacheEntries <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 加载Jar文件</span>
        <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Loading JAR files for task {}."</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userCodeClassLoader <span class="token operator">=</span> <span class="token function">createUserCodeClassloader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ExecutionConfig</span> executionConfig <span class="token operator">=</span> serializedExecutionConfig<span class="token punctuation">.</span><span class="token function">deserializeValue</span><span class="token punctuation">(</span>userCodeClassLoader<span class="token punctuation">.</span><span class="token function">asClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// setupPartitionsAndGates，初始化ResultPartition、InputGate，并注册ResultPartition</span>
        <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Registering task at network: {}."</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ResultPartitionWriter</span> partition <span class="token operator">:</span> consumableNotifyingPartitionWriters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            partition<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">InputGate</span> gate <span class="token operator">:</span> inputGates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            gate<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ResultPartitionWriter</span> partitionWriter <span class="token operator">:</span> consumableNotifyingPartitionWriters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            taskEventDispatcher<span class="token punctuation">.</span><span class="token function">registerPartition</span><span class="token punctuation">(</span>partitionWriter<span class="token punctuation">.</span><span class="token function">getPartitionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">TaskKvStateRegistry</span> kvStateRegistry <span class="token operator">=</span> kvStateService<span class="token punctuation">.</span><span class="token function">createKvStateTaskRegistry</span><span class="token punctuation">(</span>jobId<span class="token punctuation">,</span> <span class="token function">getJobVertexId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 初始化用户代码</span>
        <span class="token class-name">Environment</span> env <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        executingThread<span class="token punctuation">.</span><span class="token function">setContextClassLoader</span><span class="token punctuation">(</span>userCodeClassLoader<span class="token punctuation">.</span><span class="token function">asClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 加载业务逻辑执行代码，并传入RuntimeEnvironment</span>
        <span class="token comment">// loadAndInstantiateInvokable，invokable为通过反射创建的Operator实例（OneInputStreamTask、SourceStreamTask等），用户业务逻辑代码为它的userFuntion</span>
        <span class="token class-name">TaskInvokable</span> invokable <span class="token operator">=</span>
            <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>nameOfInvokableClass<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> userCodeClassLoader<span class="token punctuation">.</span><span class="token function">asClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                 <span class="token punctuation">.</span><span class="token function">asSubclass</span><span class="token punctuation">(</span><span class="token class-name">TaskInvokable</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                 <span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token class-name">Environment</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                 <span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>invokable <span class="token operator">=</span> invokable<span class="token punctuation">;</span>
        <span class="token comment">// 转换状态，DEPLOYING -> INITIALIZING</span>
        <span class="token function">transitionState</span><span class="token punctuation">(</span><span class="token class-name">ExecutionState</span><span class="token punctuation">.</span><span class="token constant">DEPLOYING</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionState</span><span class="token punctuation">.</span><span class="token constant">INITIALIZING</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        taskManagerActions<span class="token punctuation">.</span><span class="token function">updateTaskExecutionState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TaskExecutionState</span><span class="token punctuation">(</span>executionId<span class="token punctuation">,</span> <span class="token class-name">ExecutionState</span><span class="token punctuation">.</span><span class="token constant">INITIALIZING</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        executingThread<span class="token punctuation">.</span><span class="token function">setContextClassLoader</span><span class="token punctuation">(</span>userCodeClassLoader<span class="token punctuation">.</span><span class="token function">asClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动StreamTask执行</span>
        invokable<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 转换状态，INITIALIZING -> RUNNING</span>
        <span class="token function">transitionState</span><span class="token punctuation">(</span><span class="token class-name">ExecutionState</span><span class="token punctuation">.</span><span class="token constant">INITIALIZING</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionState</span><span class="token punctuation">.</span><span class="token constant">RUNNING</span><span class="token punctuation">)</span>
        taskManagerActions<span class="token punctuation">.</span><span class="token function">updateTaskExecutionState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TaskExecutionState</span><span class="token punctuation">(</span>executionId<span class="token punctuation">,</span> <span class="token class-name">ExecutionState</span><span class="token punctuation">.</span><span class="token constant">RUNNING</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 业务逻辑执行完毕</span>
        <span class="token comment">// 把尚未写出的数据统一Flush，如果失败的话，Task也会失败</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ResultPartitionWriter</span> partitionWriter <span class="token operator">:</span> consumableNotifyingPartitionWriters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>partitionWriter <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                partitionWriter<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 转换状态，RUNNING -> FINISHED</span>
        <span class="token function">transitionState</span><span class="token punctuation">(</span><span class="token class-name">ExecutionState</span><span class="token punctuation">.</span><span class="token constant">RUNNING</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionState</span><span class="token punctuation">.</span><span class="token constant">FINISHED</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>invokable <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">// 释放内存、占用的Cache等，并进入Final状态，停止监控</span>
        <span class="token function">releaseResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        memoryManager<span class="token punctuation">.</span><span class="token function">releaseAll</span><span class="token punctuation">(</span>invokable<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fileCache<span class="token punctuation">.</span><span class="token function">releaseJob</span><span class="token punctuation">(</span>jobId<span class="token punctuation">,</span> executionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        taskManagerActions<span class="token punctuation">.</span><span class="token function">updateTaskExecutionState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TaskExecutionState</span><span class="token punctuation">(</span>executionId<span class="token punctuation">,</span> executionState<span class="token punctuation">,</span> failureCause<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 以StreamTask为例</span>
<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">StreamTask</span><span class="token generics"><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">,</span> OP <span class="token keyword">extends</span> <span class="token class-name">StreamOperator</span><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">></span><span class="token punctuation">></span></span>
    <span class="token keyword">implements</span> <span class="token class-name">TaskInvokable</span><span class="token punctuation">,</span> <span class="token class-name">CheckpointableTask</span><span class="token punctuation">,</span> <span class="token class-name">CoordinatedTask</span>
<span class="token punctuation">{</span>
    <span class="token class-name">Environment</span> environment<span class="token punctuation">;</span>
    <span class="token class-name">MailboxProcessor</span> mailboxProcessor<span class="token punctuation">;</span>  <span class="token comment">// 基于MailBox单线程的执行模型，所有的并发操作都通过队列进行排队（Mailbox），单线程（Mailbox单线程）依次处理，构造方法中创建，其runMailboxLoop()方法循环执行提供的MailboxDefaultAction，这里为StreamTask的processInput()方法</span>
    <span class="token class-name">StreamInputProcessor</span> inputProcessor<span class="token punctuation">;</span>  <span class="token comment">// init()方法中初始化</span>
    <span class="token keyword">void</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Initializing {}."</span><span class="token punctuation">,</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        operatorChain <span class="token operator">=</span> environment<span class="token punctuation">.</span>taskStateManager<span class="token punctuation">.</span><span class="token function">isFinishedOnRestore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">FinishedOperatorChain</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> recordWriter<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">RegularOperatorChain</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> recordWriter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// getMainOperator</span>
        mainOperator <span class="token operator">=</span> operatorChain<span class="token punctuation">.</span>mainOperatorWrapper<span class="token punctuation">.</span>wrapped<span class="token punctuation">;</span>
        <span class="token comment">// 调用派生类的init()方法</span>
        <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Invoking {}"</span><span class="token punctuation">,</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> allGatesRecoveredFuture <span class="token operator">=</span> actionExecutor<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">restoreGates</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 循环执行processInput()</span>
        mailboxProcessor<span class="token punctuation">.</span><span class="token function">runMailboxLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ensureNotCanceled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channelIOExecutor<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        isRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<h2 id="作业执行" style="position:relative;"><a href="#%E4%BD%9C%E4%B8%9A%E6%89%A7%E8%A1%8C" aria-label="作业执行 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>作业执行</h2>
<p>在执行过程中上游Task结果写入ResultPartition，ResultPartition又分成ResultSubPartition，下游的Task通过InputGate与上游建立数据传输通道，InputGate中的InputChannel对应于ResultSubPartition，将数据交给Task执行。Task执行的时候，根据数据的不同类型（StreamRecord、Watermark、LatencyMarker）进行不同的处理逻辑，处理完后再交给下游的Task。</p>
<p>StreamTask处理数据入口是processInput()方法，内部调用StreamInputProcessor的processInput()方法，StreamInputProcessor实际将具体的数据读取工作交给了StreamTaskInput，当读取了完整的记录之后就开始向下游发送数据，在发送数据的过程中，调用算子进行数据的处理。</p>
<p>StreamInputProcessor是对StreamTask中读取数据行为的抽象，负责触发数据的读取，并交给算子处理，然后输出给下游。</p>
<ul>
<li>StreamOneInputProcessor：流输入处理器，用在OneInputStreamTask中，只有1个上游输入。核心方法是processInput()，该方法中调用StreamTaskInput的emit()方法触发数据的读取，将数据反序列化为StreamRecord，交给StreamTaskNetworkOutput，由其触发算子（StreamOperator）的处理，最终触发UDF的processElement()，执行用户在DataStream API中编写的用户逻辑，处理数据，然后交给下游。</li>
<li>StreamMultipleInputProcessor：双流输入处理器，用在TwoInputStreamTask中，有2个上游输入。</li>
</ul>
<p>StreamTaskInput是StreamTask中数据读取的抽象。</p>
<ul>
<li>StreamTaskNetworkInput：使用InputGate从上游任务读取数据</li>
<li>StreamTaskSourceInput：使用SourceFunction从外部数据源读取数据</li>
</ul>
<p>ResultSubPartitionView是对ResultSubPartition中读取数据、释放资源行为的抽象，getNextBuffer()是其最重要的方法，用来获取Buffer</p>
<ul>
<li>PipelinedSubpartitionView：用来读取PipelinedSubpartition中的数据</li>
<li>BoundedBlockingSubpartitionReader：用来读取BoundedBlockingSubpartition中的数据</li>
</ul>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">PipelinedSubpartitionView</span> <span class="token keyword">implements</span> <span class="token class-name">ResultSubpartitionView</span>
<span class="token punctuation">{</span>
    <span class="token class-name">PipelinedSubpartition</span> parent<span class="token punctuation">;</span>
    <span class="token class-name">BufferAvailabilityListener</span> availabilityListener<span class="token punctuation">;</span>

    <span class="token class-name">PipelinedSubpartitionView</span><span class="token punctuation">(</span>
        <span class="token class-name">PipelinedSubpartition</span> parent<span class="token punctuation">,</span>
        <span class="token class-name">BufferAvailabilityListener</span> listener<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token class-name">BufferAndBacklog</span> <span class="token function">getNextBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> parent<span class="token punctuation">.</span><span class="token function">pollBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">notifyDataAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        availabilityListener<span class="token punctuation">.</span><span class="token function">notifyDataAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<p>DataOutput是StreamTask中数据输出的抽象，调用算子相应方法处理各种数据流元素（StreamRecord、Watermark、WatermarkStatus、LatencyMarker），即 只负责将数据流元素交给算子来进行处理，实际的数据输出是在算子层面上执行的。有对应于单流输入和双流输入的两种实现（均为StreamTaskNetworkOutput），作为私有内部类定义在OneInputStreamTask和StreamMultipleInputProcessorFactory中。</p>
<div class='wrapper' markdown='block'>
<p><img src="https://www.plantuml.com/plantuml/svg/XP1BIyDG48Ntyol6NGkcuDekgaNSA88MN8ytOtB9VOIvSz5W_UzYKsAi8IxdVFCuSpP9IJHx1t2cDNl6rB2QkYjYLcS3GsrBHlQjTkZPlx0aI8qDBGbvl1A9RxlQcYPmIdW1O8Eol99Xt4Rds6WK_014HDFNYoLyZheUihPPJrfwSKVLEJwoYL8kBm-SlTLdKXPFqYocn2SbpMcCxaWvcEwUf67v1kFhmzmjvOfltjkORAZwys0SfOJRccpu8yQsiw6QPDSIgJIKT0134W0_eQptHN7y7euX7AHPItCGr_lLwjJk_mDpTdylw_rDlmuR3cNsxWi0" alt="plantuml"></p>
</div>
<p>Output负责算子向下游传递数据，定义了向下游发送StreamRecord、Watermark、LatencyMark的行为。</p>
<ul>
<li>WatermarkGaugeExposingOutput接口定义了统计Watermark监控指标计算行为，将最后一次发送给下游的Watermark作为其指标值，其实现类负责计算指标值（Flink Web UI中可视化StreamGraph的Watermark监控信息来源于此）</li>
<li>RecordWriterOutput：包装了RecordWriter，使用RecordWriter把数据交给数据交换层。RecordWriter用来在线程间、网络间实现数据序列化、写入</li>
<li>ChainingOutput &#x26; CopyingChainingOutput：用于OperatorChain内部算子之间数据传递，没有序列化，直接在调用下游算子的processElement()方法，节省了线程间的数据传送和网络间的数据传送开销</li>
<li>DirectedOutput &#x26; CopyingDirectedOutput：其他Output实现类的包装类，基于一组OutputSelector选择发送给某些下游Task</li>
<li>BroadcastingOutputCollector &#x26; CopyingBroadcastingOutputCollector：其他Output实现类的包装类，向所有下游Task广播数据</li>
<li>CountingOutput：其他Output实现类的包装类，没有任何业务逻辑属性，只是用来标记其他Output实现类向下游发送的数据元素个数，并作为监控指标反馈给Flink集群</li>
</ul>
<p>RecordWriter负责Task向下游传递数据，底层依赖于ResultPartitionWriter。RecordWriter中实现了数据分区语义，将开发时对数据分区API的调用转换成了实际的物理操作。RecordWriter调用SpaningRecordSerializer将StreamRecord（具体为StreamElement、Event）进行序列化，在调用BufferBuilder写入MemorySegment中（每个Task都有自己的LocalBufferPool，LocalBufferPool中包含了多个MemorySegment）</p>
<details>
<summary> 具体实现 </summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">OneInputStreamTask</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">,</span> OUT<span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">StreamTask</span><span class="token generics"><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">,</span> <span class="token class-name">OneInputStreamOperator</span><span class="token punctuation">&lt;</span>IN<span class="token punctuation">,</span> OUT<span class="token punctuation">></span><span class="token punctuation">></span></span>
<span class="token punctuation">{</span>
    <span class="token class-name">StreamConfig</span> configuration<span class="token punctuation">;</span>   <span class="token comment">// 继承自StreamTask</span>
    <span class="token comment">// invoke()中被调用</span>
    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> numberOfInputs <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getNumberOfNetworkInputs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>numberOfInputs <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">CheckpointedInputGate</span> inputGate <span class="token operator">=</span> <span class="token function">createCheckpointedInputGate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Counter</span> numRecordsIn <span class="token operator">=</span> <span class="token function">setupNumRecordsInCounter</span><span class="token punctuation">(</span>mainOperator<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// createDataOutput</span>
            <span class="token class-name">DataOutput</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">></span></span> output <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StreamTaskNetworkOutput</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>
                operatorChain<span class="token punctuation">.</span><span class="token function">getFinishedOnRestoreInputOrDefault</span><span class="token punctuation">(</span>mainOperator<span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token comment">// operator</span>
                inputWatermarkGauge<span class="token punctuation">,</span>    <span class="token comment">// watermarkGauge</span>
                numRecordsIn<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// createTaskInput</span>
            <span class="token class-name">StreamTaskInput</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">></span></span> input <span class="token operator">=</span> <span class="token function">createTaskInput</span><span class="token punctuation">(</span>inputGate<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">StreamConfig<span class="token punctuation">.</span>InputConfig</span><span class="token punctuation">[</span><span class="token punctuation">]</span> inputConfigs <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getInputs</span><span class="token punctuation">(</span><span class="token function">getUserCodeClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">StreamConfig<span class="token punctuation">.</span>InputConfig</span> inputConfig <span class="token operator">=</span> inputConfigs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">requiresSorting</span><span class="token punctuation">(</span>inputConfig<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                input <span class="token operator">=</span> <span class="token function">wrapWithSorted</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            inputProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StreamOneInputProcessor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> output<span class="token punctuation">,</span> operatorChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 继承自StreamTask，实现了任务的默认操作</span>
    <span class="token keyword">void</span> <span class="token function">processInput</span><span class="token punctuation">(</span><span class="token class-name">MailboxDefaultAction<span class="token punctuation">.</span>Controller</span> controller<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DataInputStatus</span> status <span class="token operator">=</span> inputProcessor<span class="token punctuation">.</span><span class="token function">processInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token constant">MORE_AVAILABLE</span><span class="token operator">:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>recordWriter<span class="token punctuation">.</span><span class="token function">isAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">NOTHING_AVAILABLE</span><span class="token operator">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">END_OF_RECOVERY</span><span class="token operator">:</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"We should not receive this event here."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">END_OF_DATA</span><span class="token operator">:</span>
                <span class="token function">endData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">END_OF_INPUT</span><span class="token operator">:</span>
                controller<span class="token punctuation">.</span><span class="token function">suspendDefaultAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mailboxProcessor<span class="token punctuation">.</span><span class="token function">suspend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">StreamTaskNetworkOutput</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">DataOutput</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">></span></span> <span class="token punctuation">{</span>
        <span class="token class-name">Input</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">></span></span> operator<span class="token punctuation">;</span>
        <span class="token comment">// 输出数据记录</span>
        <span class="token keyword">void</span> <span class="token function">emitRecord</span><span class="token punctuation">(</span><span class="token class-name">StreamRecord</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">></span></span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            operator<span class="token punctuation">.</span><span class="token function">setKeyContextElement</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
            operator<span class="token punctuation">.</span><span class="token function">processElement</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 输出水印</span>
        <span class="token keyword">void</span> <span class="token function">emitWatermark</span><span class="token punctuation">(</span><span class="token class-name">Watermark</span> watermark<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            watermarkGauge<span class="token punctuation">.</span><span class="token function">setCurrentWatermark</span><span class="token punctuation">(</span>watermark<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            operator<span class="token punctuation">.</span><span class="token function">processWatermark</span><span class="token punctuation">(</span>watermark<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 输出水印状态</span>
        <span class="token keyword">void</span> <span class="token function">emitWatermarkStatus</span><span class="token punctuation">(</span><span class="token class-name">WatermarkStatus</span> watermarkStatus<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            operator<span class="token punctuation">.</span><span class="token function">processWatermarkStatus</span><span class="token punctuation">(</span>watermarkStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 输出延迟标记</span>
        <span class="token keyword">void</span> <span class="token function">emitLatencyMarker</span><span class="token punctuation">(</span><span class="token class-name">LatencyMarker</span> latencyMarker<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            operator<span class="token punctuation">.</span><span class="token function">processLatencyMarker</span><span class="token punctuation">(</span>latencyMarker<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">StreamOneInputProcessor</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">StreamInputProcessor</span>
<span class="token punctuation">{</span>
    <span class="token class-name">StreamTaskInput</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">></span></span> input<span class="token punctuation">;</span>  <span class="token comment">// 构造方法中传入</span>
    <span class="token class-name">DataInputStatus</span> <span class="token function">processInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DataInputStatus</span> status <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">emitNext</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> <span class="token class-name">DataInputStatus</span><span class="token punctuation">.</span><span class="token constant">END_OF_DATA</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            endOfInputAware<span class="token punctuation">.</span><span class="token function">endInput</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">getInputIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            output <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FinishedDataOutput</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> <span class="token class-name">DataInputStatus</span><span class="token punctuation">.</span><span class="token constant">END_OF_RECOVERY</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>input <span class="token keyword">instanceof</span> <span class="token class-name">RecoverableStreamTaskInput</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                input <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RecoverableStreamTaskInput</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">></span></span><span class="token punctuation">)</span> input<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finishRecovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token class-name">DataInputStatus</span><span class="token punctuation">.</span><span class="token constant">MORE_AVAILABLE</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> status<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">StreamTaskNetworkInput</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span>
<span class="token punctuation">{</span>
    <span class="token comment">/**
     * 继承自AbstractStreamTaskNetworkInput
     **/</span>
    <span class="token class-name">R</span> currentRecordDeserializer<span class="token punctuation">;</span>
    <span class="token comment">// 从NetworkBuffer中读取完整的StreamRecord并触发处理</span>
    <span class="token class-name">DataInputStatus</span> <span class="token function">emitNext</span><span class="token punctuation">(</span><span class="token class-name">DataOutput</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> output<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 从反序列化器中获取数据流元素</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>currentRecordDeserializer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">RecordDeserializer<span class="token punctuation">.</span>DeserializationResult</span> result <span class="token operator">=</span> currentRecordDeserializer<span class="token punctuation">.</span><span class="token function">getNextRecord</span><span class="token punctuation">(</span>deserializationDelegate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>isBufferConsumed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    currentRecordDeserializer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 读取到完整数据记录之后，根据其类型进行不同的逻辑处理</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">isFullRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">processElement</span><span class="token punctuation">(</span>deserializationDelegate<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token class-name">DataInputStatus</span><span class="token punctuation">.</span><span class="token constant">MORE_AVAILABLE</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 通过InputGate获取数据</span>
            <span class="token class-name">BufferOrEvent</span> bufferOrEvent <span class="token operator">=</span> inputGate<span class="token punctuation">.</span><span class="token function">pollNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bufferOrEvent<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// processBuffer，处理Buffer</span>
                <span class="token function">processBuffer</span><span class="token punctuation">(</span>bufferOrEvent<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                lastChannel <span class="token operator">=</span> bufferOrEvent<span class="token punctuation">.</span>channelInfo<span class="token punctuation">;</span>
                currentRecordDeserializer <span class="token operator">=</span> recordDeserializers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>bufferOrEvent<span class="token punctuation">.</span><span class="token function">getChannelInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                currentRecordDeserializer<span class="token punctuation">.</span><span class="token function">setNextBuffer</span><span class="token punctuation">(</span>bufferOrEvent<span class="token punctuation">.</span><span class="token function">getBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// processEvent，处理Event</span>
                <span class="token class-name">AbstractEvent</span> event <span class="token operator">=</span> bufferOrEvent<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">EndOfData</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>checkpointedInputGate<span class="token punctuation">.</span><span class="token function">hasReceivedEndOfData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> <span class="token class-name">DataInputStatus</span><span class="token punctuation">.</span><span class="token constant">END_OF_DATA</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">EndOfPartitionEvent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">releaseDeserializer</span><span class="token punctuation">(</span>bufferOrEvent<span class="token punctuation">.</span><span class="token function">getChannelInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>checkpointedInputGate<span class="token punctuation">.</span><span class="token function">isFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> <span class="token class-name">DataInputStatus</span><span class="token punctuation">.</span><span class="token constant">END_OF_INPUT</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">EndOfChannelStateEvent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>checkpointedInputGate<span class="token punctuation">.</span><span class="token function">allChannelsRecovered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> <span class="token class-name">DataInputStatus</span><span class="token punctuation">.</span><span class="token constant">END_OF_RECOVERY</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token class-name">DataInputStatus</span><span class="token punctuation">.</span><span class="token constant">MORE_AVAILABLE</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 按照StreamElement的类型分别进行处理</span>
    <span class="token keyword">void</span> <span class="token function">processElement</span><span class="token punctuation">(</span><span class="token class-name">StreamElement</span> recordOrMark<span class="token punctuation">,</span> <span class="token class-name">DataOutput</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> output<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>recordOrMark<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">StreamRecord</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// emitRecord，对于数据记录（StreamRecord），触发算子执行业务逻辑</span>
            <span class="token class-name">StreamRecord</span> record <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StreamRecord</span><span class="token punctuation">)</span>recordOrMark<span class="token punctuation">;</span>
            output<span class="token punctuation">.</span>operator<span class="token punctuation">.</span><span class="token function">setKeyContextElement</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
            output<span class="token punctuation">.</span>operator<span class="token punctuation">.</span><span class="token function">processElement</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>recordOrMark<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Watermark</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 水印处理，向StatusWatermarkValve输入一个水印</span>
            statusWatermarkValve<span class="token punctuation">.</span><span class="token function">inputWatermark</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Watermark</span><span class="token punctuation">)</span>recordOrMark<span class="token punctuation">,</span> flattenedChannelIndices<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>lastChannel<span class="token punctuation">)</span><span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>recordOrMark<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">LatencyMarker</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// emitLatencyMarker，延迟标记处理，收到LatencyMarker直接交给下游</span>
            <span class="token comment">// LatencyMarker用来近似评估数据从读取到写出之间的延迟，但是并不包含计算的延迟</span>
            output<span class="token punctuation">.</span>operator<span class="token punctuation">.</span><span class="token function">processLatencyMarker</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">LatencyMarker</span><span class="token punctuation">)</span>recordOrMark<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>recordOrMark<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">WatermarkStatus</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 水印状态处理，向StatusWatermarkValve输入一个WatermarkStatus</span>
            statusWatermarkValve<span class="token punctuation">.</span><span class="token function">inputWatermarkStatus</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">WatermarkStatus</span><span class="token punctuation">)</span>recordOrMark<span class="token punctuation">,</span> flattenedChannelIndices<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>lastChannel<span class="token punctuation">)</span><span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">SingleInputGate</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 输入通道，通知InputGate有可用数据</span>
    <span class="token class-name">PrioritizedDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InputChannel</span><span class="token punctuation">></span></span> inputChannelsWithData<span class="token punctuation">;</span>

    <span class="token class-name">BufferOrEvent</span> <span class="token function">getNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">getNextBufferOrEvent</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">BufferOrEvent</span> <span class="token function">pollNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">getNextBufferOrEvent</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">BufferOrEvent</span> <span class="token function">getNextBufferOrEvent</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> blocking<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 从inputChannelsWithData中获取有数据可消费的InputChannel</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>inputChannelsWithData<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>blocking<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                inputChannelsWithData<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 非阻塞时直接返回空</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">InputChannel</span> inputChannel <span class="token operator">=</span> inputChannelsWithData<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        enqueuedInputChannelsWithData<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>inputChannel<span class="token punctuation">.</span><span class="token function">getChannelIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 从InputChannel获取数据，具体实现逻辑在其子类中</span>
        <span class="token comment">// LocalInputChannel用于本地线程间数据传递，从本进程的结果子分区获取数据</span>
        <span class="token comment">// RemoteInputChannel用于跨网络数据传递，从其他进程的结果子分区获取数据</span>
        <span class="token class-name">Buffer</span> buffer <span class="token operator">=</span> inputChannel<span class="token punctuation">.</span><span class="token function">getNextBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>buffer<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">isBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BufferOrEvent</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            event <span class="token operator">=</span> <span class="token class-name">EventSerializer</span><span class="token punctuation">.</span><span class="token function">fromBuffer</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BufferOrEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<h3 id="数据传递" style="position:relative;"><a href="#%E6%95%B0%E6%8D%AE%E4%BC%A0%E9%80%92" aria-label="数据传递 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>数据传递</h3>
<p>分布式计算中不同节点之间的传递数据一般有PULL模式和PUSH模式。Flink批执行模式采用PULL模式，将计算过程分成多个阶段，上游完全计算完毕之后，下游从上游拉取数据开始下一阶段计算，直到最终所有的阶段都计算完毕；Flink流执行模式采用PUSH模式，上游主动向下游推送数据，上下游之间采用生产者-消费者模式，下游收到数据触发计算，没有数据则进入等待状态。PUSH模式的数据处理过程成为流水线（Pipeline）。</p>
<p>对于数据记录（StreamRecord），会执行算子中用户编写的业务逻辑，在算子中处理完毕后通过Collector接口将数据交给下一个算子（或任务）进行计算。每一个StreamOperator都有一个Output（继承自Collector接口）成员，用于收集当前算子处理完的记录。</p>
<h4 id="同一task内算子间的数据传递" style="position:relative;"><a href="#%E5%90%8C%E4%B8%80task%E5%86%85%E7%AE%97%E5%AD%90%E9%97%B4%E7%9A%84%E6%95%B0%E6%8D%AE%E4%BC%A0%E9%80%92" aria-label="同一task内算子间的数据传递 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>同一Task内算子间的数据传递</h4>
<p>同一个OperatorChain中，上游算子处理数据，然后通过Collector接口直接调用下游算子的processElement()方法，在同一个线程内执行普通的Java方法。没有数据序列化、反序列化的过程，也没有线程切换。</p>
<p>OperatorChain的内部类ChainingOutput实现了WatermarkGaugeExposingOutput接口，它持有一个OneInputStreamOperator对象（input成员），即OperatorChain中当前算子的下游算子。当ChainingOutput接收到当前算子提交的数据时，将直接调用下游算子的processElement()方法。</p>
<p>通过在ChainingOutput中保存下游StreamOperator的引用，ChainingOutput直接将当前算子提交的数据对象的引用传递给下游算子。但是如果不允许对象重用（ExecutionConfig配置项objectReuse），则不会使用ChainingOutput，而是会使用CopyingChainingOutput（对记录进行复制后传递给下游算子）。</p>
<p>BroadcastingOutputCollector封装了一组Output, 即Output&#x3C;StreamRecord<T>>[] outputs, 在接收到StreamRecord时，会将消息提交到所有的内部所有的Output中。BroadcastingOutputCollector主要用在当前算子有多个下游算子的情况下。与此对应的还有一个 CopyingBroadcastingOutputCollector。</p>
<p>DirectedOutput基于OutputSelector<OUT>[] outputSelectors选择要转发的目标Output，主要是在split/select的情况下使用。与DirectedOutput对应的也有一个 CopyingDirectedOutput。</p>
<p>对于位于OperatorChain末尾的算子，它处理过的记录需要被其它Task消费，因此它的记录需要被写入 ResultPartition。Flink提供了RecordWriterOutput，它也实现了 WatermarkGaugeExposingOutput，但是它是通过RecordWriter输出接收到的消息记录。RecordWriter是ResultPartitionWriter的一层包装，提供了将记录序列化到Buffer中的功能。</p>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">ChainingOutput</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span>
    <span class="token keyword">implements</span> <span class="token class-name">WatermarkGaugeExposingOutput</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StreamRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span><span class="token punctuation">></span></span>
<span class="token punctuation">{</span>
    <span class="token class-name">Input</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> input<span class="token punctuation">;</span>         <span class="token comment">// 算子链内的下一个算子</span>
    <span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> outputTag<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">StreamRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>outputTag <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">pushToOperator</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">X</span><span class="token punctuation">></span></span> outputTag<span class="token punctuation">,</span> <span class="token class-name">StreamRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">X</span><span class="token punctuation">></span></span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果有OutputTag，则要求OutputTag匹配才会转发记录</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>outputTag<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>outputTag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">pushToOperator</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">X</span><span class="token punctuation">></span></span> <span class="token keyword">void</span> <span class="token function">pushToOperator</span><span class="token punctuation">(</span><span class="token class-name">StreamRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">X</span><span class="token punctuation">></span></span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StreamRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> castRecord <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StreamRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> record<span class="token punctuation">;</span>
        input<span class="token punctuation">.</span><span class="token function">setKeyContextElement</span><span class="token punctuation">(</span>castRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
        input<span class="token punctuation">.</span><span class="token function">processElement</span><span class="token punctuation">(</span>castRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<h4 id="不同task内算子间的数据传递" style="position:relative;"><a href="#%E4%B8%8D%E5%90%8Ctask%E5%86%85%E7%AE%97%E5%AD%90%E9%97%B4%E7%9A%84%E6%95%B0%E6%8D%AE%E4%BC%A0%E9%80%92" aria-label="不同task内算子间的数据传递 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>不同Task内算子间的数据传递</h4>
<p>不同Task内算子间的数据传递分为以下几个步骤：</p>
<ol>
<li>上游算子将数据记录交给RecordWriter，经过ChannelSelector选择下游节点后，找到对应的结果子分区</li>
<li>使用对应结果子分区的序列化器把数据序记录列化为二进制数据</li>
<li>将二进制数据写入结果子分区，此时数据已存入MemorySegment</li>
<li>单独的线程控制数据的flush速度，一旦触发flush，向下游TaskManager写入</li>
<li>下游TaskManager接收到数据后，将数据复制到MemorySegment中，然后通知InputChannel</li>
<li>有可用数据时，下游算子从阻塞醒来，从InputChannel取出二进制数据，再反序列化成数据记录，执行UDf</li>
</ol>
<p>同一TaskManager中的Task之间进行本地线程间的数据传递，即 通过本地内存进行数据传递，共享同一个BufferPool，通过wait/notifyAll来同步。具体为同一TaskManager中的Task会在同一个NetworkEnvironment中注册，在Network Buffer申请输入输出的独立LocalBuffer，LocalInputChannel实现了InputChannel接口和BufferAvailabilityListener接口，通过ResultPartitionManager创建和对应ResultSubparition关联的ResultSubparitionView，并以自身作为ResultSubparitionView的监听器，ResultSubparition有数据产出时，ResultSubparitionView会得到通知，同时LocalInputChannel的回调方法也会被调用。这样LocalInputChannel可以及时获取到数据的生产情况以便及时地消费数据。</p>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token comment">// LocalInputChannel用来进行同一TaskManager内Task之间的数据传递</span>
<span class="token keyword">class</span> <span class="token class-name">LocalInputChannel</span> <span class="token keyword">extends</span> <span class="token class-name">InputChannel</span> <span class="token keyword">implements</span> <span class="token class-name">BufferAvailabilityListener</span>
<span class="token punctuation">{</span>
    <span class="token class-name">ResultPartitionManager</span> partitionManager<span class="token punctuation">;</span> <span class="token comment">// 本地分区管理器</span>
    <span class="token class-name">ResultSubpartitionView</span> subpartitionView<span class="token punctuation">;</span> <span class="token comment">// 消费的结果子分区</span>

    <span class="token comment">// 通过ResultPartitionManager创建与对应ResultSubpartition相关联的ResultSubpartitionView</span>
    <span class="token keyword">void</span> <span class="token function">requestSubpartition</span><span class="token punctuation">(</span><span class="token keyword">int</span> subpartitionIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> retriggerRequest <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> notifyDataAvailable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>subpartitionView <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// createSubpartitionView</span>
            <span class="token comment">// 同一TaskManager内Task之间的数据传递不需要网络通信，通过ResultPartitionManager创建一个ResultSubpartitionView</span>
            <span class="token comment">// LocalInputChannel实现了BufferAvailabilityListener接口，在结果子分区可用时，notifyDataAvailable方法会被调用，将当前channel加到InputGate的可用Channel队列中</span>
            <span class="token class-name">ResultPartition</span> partition <span class="token operator">=</span> partitionManager<span class="token punctuation">.</span>registeredPartitions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>partitionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            subpartitionView <span class="token operator">=</span> partition<span class="token punctuation">.</span><span class="token function">createSubpartitionView</span><span class="token punctuation">(</span>subpartitionIndex<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 第二个参数为BufferAvailabilityListener</span>
            <span class="token comment">// notifyDataAvailable</span>
            inputGate<span class="token punctuation">.</span><span class="token function">notifyChannelNonEmpty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BufferAndAvailability</span><span class="token punctuation">></span></span> <span class="token function">getNextBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 实际调用对应ResultSubpartition的pollBuffer()方法</span>
        <span class="token class-name">BufferAndBacklog</span> next <span class="token operator">=</span> subpartitionView<span class="token punctuation">.</span><span class="token function">getNextBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Buffer</span> buffer <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channelStatePersister<span class="token punctuation">.</span><span class="token function">checkForBarrier</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        channelStatePersister<span class="token punctuation">.</span><span class="token function">maybePersist</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BufferAndAvailability</span><span class="token punctuation">(</span>
            buffer<span class="token punctuation">,</span>
            next<span class="token punctuation">.</span>nextDataType<span class="token punctuation">,</span>
            next<span class="token punctuation">.</span>buffersInBacklog<span class="token punctuation">,</span>
            next<span class="token punctuation">.</span>sequenceNumber<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 回调方法，ResultSubpartition通知InputChannel有可用数据</span>
    <span class="token keyword">void</span> <span class="token function">notifyDataAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// notifyChannelNonEmpty，继承自InputChannel</span>
        inputGate<span class="token punctuation">.</span><span class="token function">notifyChannelNonEmpty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">sendTaskEvent</span><span class="token punctuation">(</span><span class="token class-name">TaskEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        taskEventPublisher<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>partitionId<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 以PipelinedSubparitionView为例</span>
<span class="token keyword">class</span> <span class="token class-name">PipelinedSubpartitionView</span> <span class="token keyword">implements</span> <span class="token class-name">ResultSubpartitionView</span> <span class="token punctuation">{</span>
    <span class="token comment">// 对应的ResultSubpartition</span>
    <span class="token class-name">PipelinedSubpartition</span> parent<span class="token punctuation">;</span>
    <span class="token comment">// ResultSubpartitionView监听接口实现类，ResultSubpartition的消费者需要实现该接口监听ResultSubpartition的数据/事件可用消息</span>
    <span class="token class-name">BufferAvailabilityListener</span> availabilityListener<span class="token punctuation">;</span>
    <span class="token class-name">BufferAndBacklog</span> <span class="token function">getNextBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> parent<span class="token punctuation">.</span><span class="token function">pollBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">notifyDataAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        availabilityListener<span class="token punctuation">.</span><span class="token function">notifyDataAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">notifyPriorityEvent</span><span class="token punctuation">(</span><span class="token keyword">int</span> priorityBufferNumber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        availabilityListener<span class="token punctuation">.</span><span class="token function">notifyPriorityEvent</span><span class="token punctuation">(</span>priorityBufferNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 以PipelinedSubpartition为例</span>
<span class="token keyword">class</span> <span class="token class-name">PipelinedSubpartition</span> <span class="token keyword">extends</span> <span class="token class-name">ResultSubpartition</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 该结果子分区的所有Buffer</span>
    <span class="token class-name">PrioritizedDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BufferConsumerWithPartialRecordLength</span><span class="token punctuation">></span></span> buffers<span class="token punctuation">;</span>
    <span class="token comment">// 当前ResultSubpartition非Event Buffer数目</span>
    <span class="token keyword">int</span> buffersInBacklog<span class="token punctuation">;</span>
    <span class="token class-name">BufferAndBacklog</span> <span class="token function">pollBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Buffer</span> buffer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>buffers<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            flushRequested <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>buffers<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">BufferConsumerWithPartialRecordLength</span> bufferConsumerWithPartialRecordLength <span class="token operator">=</span> buffers<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">BufferConsumer</span> bufferConsumer <span class="token operator">=</span> bufferConsumerWithPartialRecordLength<span class="token punctuation">.</span>bufferConsumer<span class="token punctuation">;</span>
            buffer <span class="token operator">=</span> bufferConsumerWithPartialRecordLength<span class="token punctuation">.</span>bufferConsumer<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>buffers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 消费了所有可用数据时关闭flushRequested标志</span>
                flushRequested <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bufferConsumer<span class="token punctuation">.</span><span class="token function">isFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                buffers<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>bufferConsumer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">decreaseBuffersInBacklogUnsafe</span><span class="token punctuation">(</span>bufferConsumer<span class="token punctuation">.</span><span class="token function">isBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>bufferConsumer<span class="token punctuation">.</span>buffer<span class="token punctuation">.</span><span class="token function">isBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    buffersInBacklog<span class="token operator">--</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>receiverExclusiveBuffersPerChannel <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> bufferConsumer<span class="token punctuation">.</span><span class="token function">isFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            buffer<span class="token punctuation">.</span><span class="token function">recycleBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            buffer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bufferConsumer<span class="token punctuation">.</span><span class="token function">isFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">getDataType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBlockingUpstream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            isBlocked <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">updateStatistics</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BufferAndBacklog</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token function">getBuffersInBacklogUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">isDataAvailableUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">getNextBufferTypeUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token class-name">Buffer<span class="token punctuation">.</span>DataType</span><span class="token punctuation">.</span><span class="token constant">NONE</span><span class="token punctuation">,</span> sequenceNumber<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<p>不同TaskManager中的Task之间进行跨网络的数据传递，采用Netty框架通过Socket传递，通过PartitionRequestClient向上游Task所在TaskManager发起RPC请求，上游TaskManager收到请求后，读取ResultPartition管理的Buffer并返回给Client。</p>
<p>RemoteInputChannel请求远程的ResultSubpartition。创建一个PartitionRequestClient并通过Netty发送PartitionRequest请求，这时会附带当前InputChannel的ID和信用值，NettyClient会发起和相应ResultSubpartition所在Task的NettyServer的连接（后续所有的数据交换都在这个连接上进行）。两个Task之间只会建立一个连接，这个连接会在这两个Task上不同的RemoteInputChannel和ResultSubpartition之间进行复用。另外，Flink Buffer的实现类NetworkBuffer继承了Netty的AbstractReferenceCountedByteBuf，这样Netty可以直接使用Flink Buffer，避免了在Flink Buffer和Netty Buffer之间的数据拷贝。</p>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">RemoteInputChannel</span> <span class="token keyword">extends</span> <span class="token class-name">InputChannel</span> <span class="token punctuation">{</span>
    <span class="token comment">// 用于连接远程ResultSubpartition的ConnectionManager</span>
    <span class="token class-name">ConnectionManager</span> connectionManager<span class="token punctuation">;</span>
    <span class="token comment">// 创建TCP连接并请求ResultSubpartition的客户端</span>
    <span class="token class-name">PartitionRequestClient</span> partitionRequestClient<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">requestSubpartition</span><span class="token punctuation">(</span><span class="token keyword">int</span> subpartitionIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 通过ConnectionManager建立连接，创建PartitionRequestClient，并通过 PartitionRequestClient发起请求</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>partitionRequestClient <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"{}: Requesting REMOTE subpartition {} of partition {}. {}"</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            partitionRequestClient <span class="token operator">=</span> connectionManager<span class="token punctuation">.</span><span class="token function">createPartitionRequestClient</span><span class="token punctuation">(</span>connectionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            partitionRequestClient<span class="token punctuation">.</span><span class="token function">requestSubpartition</span><span class="token punctuation">(</span>partitionId<span class="token punctuation">,</span> subpartitionIndex<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">NettyConnectionManager</span> <span class="token keyword">implements</span> <span class="token class-name">ConnectionManager</span> <span class="token punctuation">{</span>
    <span class="token comment">// 建立和其它TaskManager NettyServer的连接，PartitionRequestClient中封装了netty channel和channel handler</span>
    <span class="token class-name">PartitionRequestClient</span> <span class="token function">createPartitionRequestClient</span><span class="token punctuation">(</span><span class="token class-name">ConnectionID</span> connectionId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> partitionRequestClientFactory<span class="token punctuation">.</span><span class="token function">createPartitionRequestClient</span><span class="token punctuation">(</span>connectionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">PartitionRequestClientFactory</span> <span class="token punctuation">{</span>
    <span class="token comment">// 和远程地址建立TCP连接并创建NettyPartitionRequestClient</span>
    <span class="token class-name">NettyPartitionRequestClient</span> <span class="token function">createPartitionRequestClient</span><span class="token punctuation">(</span><span class="token class-name">ConnectionID</span> connectionId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NettyPartitionRequestClient</span><span class="token punctuation">></span></span> newClientFuture <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NettyPartitionRequestClient</span><span class="token punctuation">></span></span> clientFuture <span class="token operator">=</span> clients<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>connectionId<span class="token punctuation">,</span> newClientFuture<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">NettyPartitionRequestClient</span> client<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>clientFuture <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// connect，建立连接</span>
                <span class="token class-name">Channel</span> channel <span class="token operator">=</span> nettyClient<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>connectionId<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">NetworkClientHandler</span> clientHandler <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">NetworkClientHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                client <span class="token operator">=</span> <span class="token class-name">NettyPartitionRequestClient</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> clientHandler<span class="token punctuation">,</span> connectionId<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                newClientFuture<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                client <span class="token operator">=</span> clientFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// client引用计数加1</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>client<span class="token punctuation">.</span>closeReferenceCounter<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> client<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// destroyPartitionRequestClient，移除创建的NettyPartitionRequestClient</span>
                <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NettyPartitionRequestClient</span><span class="token punctuation">></span></span> future <span class="token operator">=</span> clients<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>connectionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>future <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> future<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    future<span class="token punctuation">.</span><span class="token function">thenAccept</span><span class="token punctuation">(</span>futureClient <span class="token operator">-></span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>futureClient<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            clients<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>connectionId<span class="token punctuation">,</span> future<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">NettyPartitionRequestClient</span> <span class="token keyword">implements</span> <span class="token class-name">PartitionRequestClient</span> <span class="token punctuation">{</span>
    <span class="token class-name">NetworkClientHandler</span> clientHandler<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">requestSubpartition</span><span class="token punctuation">(</span>
        <span class="token class-name">ResultPartitionID</span> partitionId<span class="token punctuation">,</span>
        <span class="token keyword">int</span> subpartitionIndex<span class="token punctuation">,</span>
        <span class="token class-name">RemoteInputChannel</span> inputChannel<span class="token punctuation">,</span>
        <span class="token keyword">int</span> delayMs<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// checkNotClosed</span>
        <span class="token keyword">assert</span> <span class="token operator">!</span>closeReferenceCounter<span class="token punctuation">.</span><span class="token function">isDisposed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Requesting subpartition {} of partition {} with {} ms delay."</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 向NetworkClientHandler注册当前RemoteInputChannel</span>
        clientHandler<span class="token punctuation">.</span><span class="token function">addInputChannel</span><span class="token punctuation">(</span>inputChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// PartitionRequest封装了请求的ResultSubpartition信息，当前InputChannel的ID，以及初始信用值</span>
        <span class="token comment">// 一个Task的所有RemoteInputChannel的数据传输都通过该PartitionRequestClient处理</span>
        <span class="token class-name">PartitionRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PartitionRequest</span><span class="token punctuation">(</span>
            partitionId<span class="token punctuation">,</span>
            subpartitionIndex<span class="token punctuation">,</span>
            inputChannel<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
            inputChannel<span class="token punctuation">.</span>initialCredit<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 通过Netty发送请求</span>
        <span class="token class-name">ChannelFutureListener</span> listener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChannelFutureListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operationComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelFuture</span> future<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果请求发送失败，移除当前InputChannel</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>future<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    clientHandler<span class="token punctuation">.</span><span class="token function">removeInputChannel</span><span class="token punctuation">(</span>inputChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    inputChannel<span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name">ChannelFuture</span> f <span class="token operator">=</span> tcpChannel<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        f<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<p><strong>生产端处理流程</strong> 在网络通信中对应NettyServer。NettyServer有两个重要的 ChannelHandler，即PartitionRequestServerHandler和PartitionRequestQueue。PartitionRequestServerHandler负责处理消费端通过PartitionRequestClient发送的 PartitionRequest、AddCredit等请求。PartitionRequestQueue包含了一个读取数据的NetworkSequenceViewReader队列，它监听Netty Channel的可写入状态，一旦可以写入数据，就会从NetworkSequenceViewReader消费数据写入Netty Channel。</p>
<p>当NettyServer接收到PartitionRequest消息后，PartitionRequestServerHandler会创建一个NetworkSequenceViewReader对象，请求创建ResultSubpartitionView，并将 NetworkSequenceViewReader保存在PartitionRequestQueue中。PartitionRequestQueue 保存了所有请求消费数据的RemoteInputChannel和NetworkSequenceViewReader之间的映射关系，还保存了一个NetworkSequenceViewReader队列availableReaders，当一个NetworkSequenceViewReader中有数据可以被消费时，就会被加入到availableReaders队列中。</p>
<p>ResultSubpartitionView用来消费ResultSubpartition中的数据，并在ResultSubpartition 中有数据可用时获得提醒。NetworkSequenceViewReader相当于对ResultSubpartition的一层包装，它会按顺序为读取的每一个Buffer分配一个序列号，并记录接收数据的RemoteInputChannel。使用基于信用值的流量控制时，NetworkSequenceViewReader的具体实现对应为CreditBasedSequenceNumberingViewReader。CreditBasedSequenceNumberingViewReader同时还实现了BufferAvailabilityListener接口，因而可以作为PipelinedSubpartitionView的回调对象。</p>
<p>PartitionRequestQueue负责将ResultSubparition中的数据通过网络发送给RemoteInputChannel。PartitionRequestQueue会监听Netty Channel的可写入状态，当Channel可写入时，就会从availableReaders中取出NetworkSequenceViewReader，读取数据并写入网络。可写入状态是Netty通过水位线进行控制的，NettyServer在启动的时候会配置水位线，如果Netty输出缓冲中的字节数超过了高水位值，就会等到其降到低水位值以下才继续写入数据。通过水位线机制确保不往网络中写入太多数据。在基于信用值的流量控制算法中，每发送一个Buffer就会消耗一点信用值，在消费端有空闲Buffer时会发送AddCrdit消息。</p>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">PartitionRequestServerHandler</span>
<span class="token punctuation">{</span>
    <span class="token class-name">PartitionRequestQueue</span> outboundQueue<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">channelRead0</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">NettyMessage</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> msgClazz <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ResultSubpartitionRequest</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msgClazz <span class="token operator">==</span> <span class="token class-name">PartitionRequest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">PartitionRequest</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">PartitionRequest</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
            <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Read channel on {}: {}."</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">NetworkSequenceViewReader</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreditBasedSequenceNumberingViewReader</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>receiverId<span class="token punctuation">,</span> request<span class="token punctuation">.</span>credit<span class="token punctuation">,</span> outboundQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            reader<span class="token punctuation">.</span><span class="token function">requestSubpartitionView</span><span class="token punctuation">(</span>partitionProvider<span class="token punctuation">,</span> request<span class="token punctuation">.</span>partitionId<span class="token punctuation">,</span> request<span class="token punctuation">.</span>queueIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

            outboundQueue<span class="token punctuation">.</span><span class="token function">notifyReaderCreated</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>msgClazz <span class="token operator">==</span> <span class="token class-name">TaskEventRequest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Task events</span>
            <span class="token class-name">TaskEventRequest</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TaskEventRequest</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
            taskEventPublisher<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>partitionId<span class="token punctuation">,</span> request<span class="token punctuation">.</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>msgClazz <span class="token operator">==</span> <span class="token class-name">CancelPartitionRequest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">CancelPartitionRequest</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">CancelPartitionRequest</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
            outboundQueue<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>receiverId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>msgClazz <span class="token operator">==</span> <span class="token class-name">CloseRequest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            outboundQueue<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>msgClazz <span class="token operator">==</span> <span class="token class-name">AddCredit</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 增加Credit</span>
            <span class="token class-name">AddCredit</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AddCredit</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
            outboundQueue<span class="token punctuation">.</span><span class="token function">addCreditOrResumeConsumption</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>receiverId<span class="token punctuation">,</span> reader <span class="token operator">-></span> reader<span class="token punctuation">.</span><span class="token function">addCredit</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>credit<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>msgClazz <span class="token operator">==</span> <span class="token class-name">ResumeConsumption</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ResumeConsumption</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ResumeConsumption</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
            outboundQueue<span class="token punctuation">.</span><span class="token function">addCreditOrResumeConsumption</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>receiverId<span class="token punctuation">,</span> <span class="token class-name">NetworkSequenceViewReader</span><span class="token operator">::</span><span class="token function">resumeConsumption</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>msgClazz <span class="token operator">==</span> <span class="token class-name">AckAllUserRecordsProcessed</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">AckAllUserRecordsProcessed</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AckAllUserRecordsProcessed</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
            outboundQueue<span class="token punctuation">.</span><span class="token function">acknowledgeAllRecordsProcessed</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>receiverId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>msgClazz <span class="token operator">==</span> <span class="token class-name">NewBufferSize</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">NewBufferSize</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">NewBufferSize</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
            outboundQueue<span class="token punctuation">.</span><span class="token function">notifyNewBufferSize</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>receiverId<span class="token punctuation">,</span> request<span class="token punctuation">.</span>bufferSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">PartitionRequestQueue</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>
    <span class="token class-name">ChannelFutureListener</span> writeListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WriteAndFlushNextMessageIfPossibleListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 有数据可消费的NetworkSequenceViewReader</span>
    <span class="token class-name">ArrayDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NetworkSequenceViewReader</span><span class="token punctuation">></span></span> availableReaders <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 请求消费数据的RemoteInputChannel和NetworkSequenceViewReader之间的映射关系</span>
    <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InputChannelID</span><span class="token punctuation">,</span> <span class="token class-name">NetworkSequenceViewReader</span><span class="token punctuation">></span></span> allReaders <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 添加新的NetworkSequenceViewReader</span>
    <span class="token keyword">void</span> <span class="token function">notifyReaderCreated</span><span class="token punctuation">(</span><span class="token class-name">NetworkSequenceViewReader</span> reader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        allReaders<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>reader<span class="token punctuation">.</span>receiverId<span class="token punctuation">,</span> reader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 通知NetworkSequenceViewReader有数据可读取</span>
    <span class="token keyword">void</span> <span class="token function">notifyReaderNonEmpty</span><span class="token punctuation">(</span><span class="token class-name">NetworkSequenceViewReader</span> reader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 触发用户自定义事件</span>
        ctx<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> ctx<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fireUserEventTriggered</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">addCreditOrResumeConsumption</span><span class="token punctuation">(</span><span class="token class-name">InputChannelID</span> receiverId<span class="token punctuation">,</span> <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NetworkSequenceViewReader</span><span class="token punctuation">></span></span> operation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">NetworkSequenceViewReader</span> reader <span class="token operator">=</span> allReaders<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>receiverId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        operation<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">enqueueAvailableReader</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">userEventTriggered</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">NetworkSequenceViewReader</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// NetworkSequenceViewReader有数据可读取，加入队列中</span>
            <span class="token function">enqueueAvailableReader</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">NetworkSequenceViewReader</span><span class="token punctuation">)</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">InputChannelID</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Release partition view that get a cancel request.</span>
            <span class="token comment">// 对应RemoteInputChannel请求取消消费</span>
            <span class="token class-name">InputChannelID</span> toCancel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InputChannelID</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
            availableReaders<span class="token punctuation">.</span><span class="token function">removeIf</span><span class="token punctuation">(</span>reader <span class="token operator">-></span> reader<span class="token punctuation">.</span><span class="token function">getReceiverId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>toCancel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">NetworkSequenceViewReader</span> toRelease <span class="token operator">=</span> allReaders<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>toCancel<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>toRelease <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// releaseViewReader</span>
                toRelease<span class="token punctuation">.</span><span class="token function">setRegisteredAsAvailable</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                toRelease<span class="token punctuation">.</span><span class="token function">releaseAllResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span><span class="token function">fireUserEventTriggered</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">enqueueAvailableReader</span><span class="token punctuation">(</span><span class="token class-name">NetworkSequenceViewReader</span> reader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>reader<span class="token punctuation">.</span><span class="token function">isRegisteredAsAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">ResultSubpartitionView<span class="token punctuation">.</span>AvailabilityWithBacklog</span> availabilityWithBacklog <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">getAvailabilityAndBacklog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>availabilityWithBacklog<span class="token punctuation">.</span><span class="token function">isAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> backlog <span class="token operator">=</span> availabilityWithBacklog<span class="token punctuation">.</span><span class="token function">getBacklog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>backlog <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> reader<span class="token punctuation">.</span><span class="token function">needAnnounceBacklog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// announceBacklog</span>
                <span class="token class-name">NettyMessage<span class="token punctuation">.</span>BacklogAnnouncement</span> announcement <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NettyMessage<span class="token punctuation">.</span>BacklogAnnouncement</span><span class="token punctuation">(</span>backlog<span class="token punctuation">,</span> reader<span class="token punctuation">.</span><span class="token function">getReceiverId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>announcement<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ChannelFutureListener</span><span class="token punctuation">)</span> future <span class="token operator">-></span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>future<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token function">onChannelFutureFailure</span><span class="token punctuation">(</span>future<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">boolean</span> triggerWrite <span class="token operator">=</span> availableReaders<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// registerAvailableReader</span>
        availableReaders<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        reader<span class="token punctuation">.</span><span class="token function">setRegisteredAsAvailable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果这是队列中第一个元素，调用writeAndFlushNextMessageIfPossible发送数据</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>triggerWrite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">writeAndFlushNextMessageIfPossible</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 监听Netty Channel的可写入状态，当Channel可写入时，调用writeAndFlushNextMessageIfPossible发送数据</span>
    <span class="token keyword">void</span> <span class="token function">channelWritabilityChanged</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">writeAndFlushNextMessageIfPossible</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 从availableReaders队列中取出NetworkSequenceViewReader，读取数据并写入网络</span>
    <span class="token keyword">void</span> <span class="token function">writeAndFlushNextMessageIfPossible</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">BufferAndAvailability</span> next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// pollAvailableReader，取出一个NetworkSequenceViewReader</span>
            <span class="token class-name">NetworkSequenceViewReader</span> reader <span class="token operator">=</span> availableReaders<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>reader <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            reader<span class="token punctuation">.</span><span class="token function">setRegisteredAsAvailable</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            next <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">getNextBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 没有读到数据</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reader<span class="token punctuation">.</span><span class="token function">isReleased</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 还没有释放当前ResultSubpartition，继续处理下一个NetworkSequenceViewReader</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 读到数据时，NetworkSequenceViewReader还有更多数据时，继续加入队列</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">.</span><span class="token function">moreAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// registerAvailableReader</span>
                    availableReaders<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    reader<span class="token punctuation">.</span><span class="token function">setRegisteredAsAvailable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">BufferResponse</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferResponse</span><span class="token punctuation">(</span>
                    next<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    next<span class="token punctuation">.</span><span class="token function">getSequenceNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    reader<span class="token punctuation">.</span><span class="token function">getReceiverId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    next<span class="token punctuation">.</span><span class="token function">buffersInBacklog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 向client发送数据，发送成功后通过writeListener回调触发下一次发送</span>
                channel<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>writeListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">class</span> <span class="token class-name">WriteAndFlushNextMessageIfPossibleListener</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelFutureListener</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">void</span> <span class="token function">operationComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelFuture</span> future<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 发送成功，再次尝试写入</span>
                    <span class="token function">writeAndFlushNextMessageIfPossible</span><span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">RecordWriterOutput</span><span class="token generics"><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">></span></span>
<span class="token punctuation">{</span>
    <span class="token class-name">RecordWriter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SerializationDelegate</span><span class="token punctuation">&lt;</span><span class="token class-name">StreamElement</span><span class="token punctuation">></span><span class="token punctuation">></span></span> recordWriter<span class="token punctuation">;</span>
    <span class="token class-name">SerializationDelegate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StreamElement</span><span class="token punctuation">></span></span> serializationDelegate<span class="token punctuation">;</span>
    <span class="token class-name">OutputTag</span> outputTag<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">StreamRecord</span><span class="token generics"><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">></span></span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>outputTag <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">pushToRecordWriter</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">X</span><span class="token punctuation">></span></span> <span class="token keyword">void</span> <span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">X</span><span class="token punctuation">></span></span> outputTag<span class="token punctuation">,</span> <span class="token class-name">StreamRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">X</span><span class="token punctuation">></span></span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>outputTag<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>outputTag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">pushToRecordWriter</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">X</span><span class="token punctuation">></span></span> <span class="token keyword">void</span> <span class="token function">pushToRecordWriter</span><span class="token punctuation">(</span><span class="token class-name">StreamRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">X</span><span class="token punctuation">></span></span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        serializationDelegate<span class="token punctuation">.</span><span class="token function">setInstance</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
        recordWriter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>serializationDelegate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">RecordWriter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span>
<span class="token punctuation">{</span>
    <span class="token class-name">ResultPartitionWriter</span> targetPartition<span class="token punctuation">;</span>
    <span class="token comment">// 传递StreamRecord，各实现类负责具体逻辑</span>
    <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">emit</span><span class="token punctuation">(</span><span class="token class-name">T</span> record<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">emit</span><span class="token punctuation">(</span><span class="token class-name">T</span> record<span class="token punctuation">,</span> <span class="token keyword">int</span> targetSubpartition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        targetPartition<span class="token punctuation">.</span><span class="token function">emitRecord</span><span class="token punctuation">(</span>
            <span class="token function">serializeRecord</span><span class="token punctuation">(</span>serializer<span class="token punctuation">,</span> record<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// 序列化</span>
            targetSubpartition<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 单播</span>
<span class="token keyword">class</span> <span class="token class-name">ChannelSelectorRecordWriter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">RecordWriter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span>
<span class="token punctuation">{</span>
    <span class="token class-name">ChannelSelector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> channelSelector<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">emit</span><span class="token punctuation">(</span><span class="token class-name">T</span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 选路</span>
        <span class="token function">emit</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> channelSelector<span class="token punctuation">.</span><span class="token function">selectChannel</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 广播</span>
<span class="token keyword">class</span> <span class="token class-name">BroadcastRecordWriter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">RecordWriter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">emit</span><span class="token punctuation">(</span><span class="token class-name">T</span> record<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// broadcastEmit</span>
        targetPartition<span class="token punctuation">.</span><span class="token function">broadcastRecord</span><span class="token punctuation">(</span><span class="token function">serializeRecord</span><span class="token punctuation">(</span>serializer<span class="token punctuation">,</span> record<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<p><strong>消费端处理流程</strong> 在网络通信中对应NettyClient。NettyClient有个重要的ChannelHandler，NetworkClientHanlder（实现类为CreditBasedPartitionRequestClientHandler），CreditBasedPartitionRequestClientHandler负责接收服务端通过Netty Channel发送的数据，解析数据后交给对应的RemoteInputChannle进行处理。CreditBasedPartitionRequestClientHandler从网络中读取数据后交给 RemoteInputChannel，RemoteInputChannel会将接收到的加入队列中，并根据生产端的堆积申请floating buffer。一旦RemoteInputChannel申请到新的Buffer，就发送一条AddCredit消息通知生产者更新Credit。</p>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token comment">// 客户端读写网络消息的Channel Handler</span>
<span class="token keyword">interface</span> <span class="token class-name">NetworkClientHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelHandler</span>
<span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">addInputChannel</span><span class="token punctuation">(</span><span class="token class-name">RemoteInputChannel</span> inputChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">removeInputChannel</span><span class="token punctuation">(</span><span class="token class-name">RemoteInputChannel</span> inputChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RemoteInputChannel</span> <span class="token function">getInputChannel</span><span class="token punctuation">(</span><span class="token class-name">InputChannelID</span> inputChannelId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">cancelRequestFor</span><span class="token punctuation">(</span><span class="token class-name">InputChannelID</span> inputChannelId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">notifyCreditAvailable</span><span class="token punctuation">(</span><span class="token class-name">RemoteInputChannel</span> inputChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">notifyNewBufferSize</span><span class="token punctuation">(</span><span class="token class-name">RemoteInputChannel</span> inputChannel<span class="token punctuation">,</span> <span class="token keyword">int</span> bufferSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 精确一次Checkpoint后恢复数据消费</span>
    <span class="token keyword">void</span> <span class="token function">resumeConsumption</span><span class="token punctuation">(</span><span class="token class-name">RemoteInputChannel</span> inputChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 通知所有记录已处理</span>
    <span class="token keyword">void</span> <span class="token function">acknowledgeAllRecordsProcessed</span><span class="token punctuation">(</span><span class="token class-name">RemoteInputChannel</span> inputChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">NettyPartitionRequestClient</span> <span class="token keyword">implements</span> <span class="token class-name">PartitionRequestClient</span>
<span class="token punctuation">{</span>
    <span class="token class-name">NetworkClientHandler</span> clientHandler<span class="token punctuation">;</span>
    <span class="token comment">// 交给NetworkClientHandler处理</span>
    <span class="token keyword">void</span> <span class="token function">notifyCreditAvailable</span><span class="token punctuation">(</span><span class="token class-name">RemoteInputChannel</span> inputChannel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        clientHandler<span class="token punctuation">.</span><span class="token function">notifyCreditAvailable</span><span class="token punctuation">(</span>inputChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">CreditBasedPartitionRequestClientHandler</span>
     <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span>
     <span class="token keyword">implements</span> <span class="token class-name">NetworkClientHandler</span>
<span class="token punctuation">{</span>
    <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InputChannelID</span><span class="token punctuation">,</span> <span class="token class-name">RemoteInputChannel</span><span class="token punctuation">></span></span> inputChannels <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ArrayDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClientOutboundMessage</span><span class="token punctuation">></span></span> clientOutboundMessages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ChannelFutureListener</span> writeListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WriteAndFlushNextMessageIfPossibleListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">addInputChannel</span><span class="token punctuation">(</span><span class="token class-name">RemoteInputChannel</span> listener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        inputChannels<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>listener<span class="token punctuation">.</span><span class="token function">getInputChannelId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">removeInputChannel</span><span class="token punctuation">(</span><span class="token class-name">RemoteInputChannel</span> listener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        inputChannels<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>listener<span class="token punctuation">.</span><span class="token function">getInputChannelId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">RemoteInputChannel</span> <span class="token function">getInputChannel</span><span class="token punctuation">(</span><span class="token class-name">InputChannelID</span> inputChannelId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> inputChannels<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>inputChannelId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">cancelRequestFor</span><span class="token punctuation">(</span><span class="token class-name">InputChannelID</span> inputChannelId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NettyMessage<span class="token punctuation">.</span>CancelPartitionRequest</span><span class="token punctuation">(</span>inputChannelId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 有新的Credit</span>
    <span class="token keyword">void</span> <span class="token function">notifyCreditAvailable</span><span class="token punctuation">(</span><span class="token class-name">RemoteInputChannel</span> inputChannel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 触发自定义事件</span>
        ctx<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span>
            ctx<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fireUserEventTriggered</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AddCreditMessage</span><span class="token punctuation">(</span>inputChannel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">notifyNewBufferSize</span><span class="token punctuation">(</span><span class="token class-name">RemoteInputChannel</span> inputChannel<span class="token punctuation">,</span> <span class="token keyword">int</span> bufferSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span>
            ctx<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fireUserEventTriggered</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NewBufferSizeMessage</span><span class="token punctuation">(</span>inputChannel<span class="token punctuation">,</span> bufferSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">resumeConsumption</span><span class="token punctuation">(</span><span class="token class-name">RemoteInputChannel</span> inputChannel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span>
            ctx<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fireUserEventTriggered</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResumeConsumptionMessage</span><span class="token punctuation">(</span>inputChannel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">acknowledgeAllRecordsProcessed</span><span class="token punctuation">(</span><span class="token class-name">RemoteInputChannel</span> inputChannel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span>
            ctx<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fireUserEventTriggered</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AcknowledgeAllRecordsProcessedMessage</span><span class="token punctuation">(</span>inputChannel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// decodeMsg，解析消息</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> msgClazz <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>msgClazz <span class="token operator">==</span> <span class="token class-name">NettyMessage<span class="token punctuation">.</span>BufferResponse</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Buffer，正常数据</span>
            <span class="token class-name">NettyMessage<span class="token punctuation">.</span>BufferResponse</span> bufferOrEvent <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">NettyMessage<span class="token punctuation">.</span>BufferResponse</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
            <span class="token comment">// 获取对应的RemoteInputChannel</span>
            <span class="token class-name">RemoteInputChannel</span> inputChannel <span class="token operator">=</span> inputChannels<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>bufferOrEvent<span class="token punctuation">.</span>receiverId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>inputChannel <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> inputChannel<span class="token punctuation">.</span><span class="token function">isReleased</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果没有对应的RemoteInputChannel，则取消订阅</span>
                bufferOrEvent<span class="token punctuation">.</span><span class="token function">releaseBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">cancelRequestFor</span><span class="token punctuation">(</span>bufferOrEvent<span class="token punctuation">.</span>receiverId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// decodeBufferOrEvent，解析BufferOrEvent</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bufferOrEvent<span class="token punctuation">.</span><span class="token function">isBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> bufferOrEvent<span class="token punctuation">.</span>bufferSize <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                inputChannel<span class="token punctuation">.</span><span class="token function">onEmptyBuffer</span><span class="token punctuation">(</span>bufferOrEvent<span class="token punctuation">.</span>sequenceNumber<span class="token punctuation">,</span> bufferOrEvent<span class="token punctuation">.</span>backlog<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                inputChannel<span class="token punctuation">.</span><span class="token function">onBuffer</span><span class="token punctuation">(</span>bufferOrEvent<span class="token punctuation">.</span><span class="token function">getBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bufferOrEvent<span class="token punctuation">.</span>sequenceNumber<span class="token punctuation">,</span> bufferOrEvent<span class="token punctuation">.</span>backlog<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>msgClazz <span class="token operator">==</span> <span class="token class-name">NettyMessage<span class="token punctuation">.</span>ErrorResponse</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 错误消息</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>msgClazz <span class="token operator">==</span> <span class="token class-name">NettyMessage<span class="token punctuation">.</span>BacklogAnnouncement</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 累积数据消息</span>
            <span class="token class-name">NettyMessage<span class="token punctuation">.</span>BacklogAnnouncement</span> announcement <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">NettyMessage<span class="token punctuation">.</span>BacklogAnnouncement</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
            <span class="token class-name">RemoteInputChannel</span> inputChannel <span class="token operator">=</span> inputChannels<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>announcement<span class="token punctuation">.</span>receiverId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>inputChannel <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> inputChannel<span class="token punctuation">.</span><span class="token function">isReleased</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">cancelRequestFor</span><span class="token punctuation">(</span>announcement<span class="token punctuation">.</span>receiverId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            inputChannel<span class="token punctuation">.</span><span class="token function">onSenderBacklog</span><span class="token punctuation">(</span>announcement<span class="token punctuation">.</span>backlog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">userEventTriggered</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">ClientOutboundMessage</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 有新的Credit会触发</span>
            <span class="token keyword">boolean</span> triggerWrite <span class="token operator">=</span> clientOutboundMessages<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            clientOutboundMessages<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ClientOutboundMessage</span><span class="token punctuation">)</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>triggerWrite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">writeAndFlushNextMessageIfPossible</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span><span class="token function">fireUserEventTriggered</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">channelWritabilityChanged</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">writeAndFlushNextMessageIfPossible</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">writeAndFlushNextMessageIfPossible</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 从队列中取出RemoteInputChannel，发送消息</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ClientOutboundMessage</span> outboundMessage <span class="token operator">=</span> clientOutboundMessages<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>outboundMessage<span class="token punctuation">.</span>inputChannel<span class="token punctuation">.</span><span class="token function">isReleased</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Object</span> msg <span class="token operator">=</span> outboundMessage<span class="token punctuation">.</span><span class="token function">buildMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                channel<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>writeListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">class</span> <span class="token class-name">WriteAndFlushNextMessageIfPossibleListener</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelFutureListener</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operationComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelFuture</span> future<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">writeAndFlushNextMessageIfPossible</span><span class="token punctuation">(</span>future<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">RemoteInputChannel</span> <span class="token keyword">extends</span> <span class="token class-name">InputChannel</span>
<span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">onBuffer</span><span class="token punctuation">(</span><span class="token class-name">Buffer</span> buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> sequenceNumber<span class="token punctuation">,</span> <span class="token keyword">int</span> backlog<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> recycleBuffer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">// 序号需要匹配</span>
        <span class="token keyword">assert</span> expectedSequenceNumber <span class="token operator">==</span> sequenceNumber<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">getDataType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBlockingUpstream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">onBlockingUpstream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 加入receivedBuffers队列中</span>
        <span class="token keyword">boolean</span> wasEmpty <span class="token operator">=</span> receivedBuffers<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> firstPriorityEvent <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token class-name">SequenceBuffer</span> sequenceBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SequenceBuffer</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> sequenceNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DataType</span> dataType <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">getDataType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dataType<span class="token punctuation">.</span><span class="token function">hasPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            firstPriorityEvent <span class="token operator">=</span> <span class="token function">addPriorityBuffer</span><span class="token punctuation">(</span>sequenceBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            recycleBuffer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            receivedBuffers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>sequenceBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            recycleBuffer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dataType<span class="token punctuation">.</span><span class="token function">requiresAnnouncement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                firstPriorityEvent <span class="token operator">=</span> <span class="token function">addPriorityBuffer</span><span class="token punctuation">(</span><span class="token function">announce</span><span class="token punctuation">(</span>sequenceBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        channelStatePersister
            <span class="token punctuation">.</span><span class="token function">checkForBarrier</span><span class="token punctuation">(</span>sequenceBuffer<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>id <span class="token operator">-></span> id <span class="token operator">></span> lastBarrierId<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>id <span class="token operator">-></span> <span class="token punctuation">{</span>
                lastBarrierId <span class="token operator">=</span> id<span class="token punctuation">;</span>
                lastBarrierSequenceNumber <span class="token operator">=</span> sequenceBuffer<span class="token punctuation">.</span>sequenceNumber<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channelStatePersister<span class="token punctuation">.</span><span class="token function">maybePersist</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">++</span>expectedSequenceNumber<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>firstPriorityEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">notifyPriorityEvent</span><span class="token punctuation">(</span>sequenceNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 通知InputGate，当前Channel有新数据</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>wasEmpty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">notifyChannelNonEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 根据客户端的积压申请浮动缓存</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>backlog <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">onSenderBacklog</span><span class="token punctuation">(</span>backlog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>recycleBuffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            buffer<span class="token punctuation">.</span><span class="token function">recycleBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 获得生产端的backlog，即堆积的Buffer数量，如果bufferQueue中Buffer数量不足，就向LocalBufferPool请求浮动Buffer</span>
    <span class="token comment">// 获取新Buffer后，通知生产端有Credit可用</span>
    <span class="token keyword">void</span> <span class="token function">onSenderBacklog</span><span class="token punctuation">(</span><span class="token keyword">int</span> backlog<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// notifyBufferAvailable，需要的Buffer数量是backlog + initialCredit</span>
        numAvailableBuffers <span class="token operator">=</span> bufferManager<span class="token punctuation">.</span><span class="token function">requestFloatingBuffers</span><span class="token punctuation">(</span>backlog <span class="token operator">+</span> initialCredit<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>numAvailableBuffers <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> unannouncedCredit<span class="token punctuation">.</span><span class="token function">getAndAdd</span><span class="token punctuation">(</span>numAvailableBuffers<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// notifyCreditAvailable，请求了新浮动Buffer，要更新Credit</span>
            partitionRequestClient<span class="token punctuation">.</span><span class="token function">notifyCreditAvailable</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">notifyCreditAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 通知当前Channel有新Credit</span>
        partitionRequestClient<span class="token punctuation">.</span><span class="token function">notifyCreditAvailable</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// BufferManager用于InputChannel请求/回收独占Buffer或浮动Buffer</span>
<span class="token keyword">class</span> <span class="token class-name">BufferManager</span> <span class="token keyword">implements</span> <span class="token class-name">BufferListener</span>
<span class="token punctuation">{</span>
    <span class="token comment">// bufferQueue封装了独占Buffer和浮动Buffer</span>
    <span class="token class-name">AvailableBufferQueue</span> bufferQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AvailableBufferQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// BufferManager对象对应InputChannel</span>
    <span class="token class-name">InputChannel</span> inputChannel<span class="token punctuation">;</span>
    <span class="token comment">// InputChannel所需Buffer数目</span>
    <span class="token keyword">int</span> numRequiredBuffers<span class="token punctuation">;</span>

    <span class="token comment">// 基于所需数量从BufferPool中请求浮动Buffer，返回实际得到的数量，未完全满足时注册一个监听器</span>
    <span class="token keyword">int</span> <span class="token function">requestFloatingBuffers</span><span class="token punctuation">(</span><span class="token keyword">int</span> numRequired<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        numRequiredBuffers <span class="token operator">=</span> numRequired<span class="token punctuation">;</span>
        <span class="token keyword">int</span> numRequestedBuffers <span class="token operator">=</span> <span class="token function">tryRequestBuffers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> numRequestedBuffers<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// LocalBufferPool通知有Buffer可用</span>
    <span class="token keyword">boolean</span> <span class="token function">notifyBufferAvailable</span><span class="token punctuation">(</span><span class="token class-name">Buffer</span> buffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> numBuffers <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> isBufferUsed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        isWaitingForFloatingBuffers <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// 增加浮动Buffer</span>
        bufferQueue<span class="token punctuation">.</span><span class="token function">addFloatingBuffer</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        isBufferUsed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        numBuffers <span class="token operator">+=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token function">tryRequestBuffers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bufferQueue<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        inputChannel<span class="token punctuation">.</span><span class="token function">notifyBufferAvailable</span><span class="token punctuation">(</span>numBuffers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> isBufferUsed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> <span class="token function">tryRequestBuffers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> numRequestedBuffers <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">// 不停地请求新浮动Buffer</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>bufferQueue<span class="token punctuation">.</span><span class="token function">getAvailableBufferSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> numRequiredBuffers
            <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isWaitingForFloatingBuffers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">BufferPool</span> bufferPool <span class="token operator">=</span> inputChannel<span class="token punctuation">.</span>inputGate<span class="token punctuation">.</span><span class="token function">getBufferPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Buffer</span> buffer <span class="token operator">=</span> bufferPool<span class="token punctuation">.</span><span class="token function">requestBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 从BufferPool中请求到Buffer</span>
                bufferQueue<span class="token punctuation">.</span><span class="token function">addFloatingBuffer</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                numRequestedBuffers<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>bufferPool<span class="token punctuation">.</span><span class="token function">addBufferListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// BufferPool没有Buffer了，加一个监听，当LocalBufferPool中有新Buffer时会回调notifyBufferAvailable</span>
                isWaitingForFloatingBuffers <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> numRequestedBuffers<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<h3 id="反压" style="position:relative;"><a href="#%E5%8F%8D%E5%8E%8B" aria-label="反压 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>反压</h3>
<p>Flink 1.5重构了网络栈，引入了基于信用值的流量控制算法（Credit-based Flow Control）。之前所有InputChannel共享同一个本地缓冲池，重构网络栈后，Flink会为每一个InputChannel分配一批独占的缓冲（Exclusive Buffer），而本地缓冲池中的Buffer则作为浮动缓存（Floating Buffer），可以被所有InputChannel使用。基于信用值的流量控制算法主要思路是在接收端和发送端之间建立信用评级类似的机制，发送端向接收端发送的数据永远不会超过接收端的信用值大小（接收端空闲Buffer数目），这样就可以保证发送端不会向TCP连接中发送超出接收端缓冲区可用容量的数据，进而确保TaskManager之间的网络连接始终不会处于阻塞状态。具体机制为：</p>
<ul>
<li>接收端向发送端声明信用值X，表明它有X个空闲Buffer可以接收数据</li>
<li>发送端获得接收端信用值X，表明它可以向网络中发送X个Buffer</li>
<li>只有在接收端信用值大于0时发送端才发送Buffer，发送端每发送一个Buffer，接收端信用值也相应减1</li>
<li>由于CheckpointBarrier、EndOfPartitionEvent等事件可以被立即处理，因而事件可以立即发送，不受接收端信用值限制</li>
<li>发送端发送Buffer，同时把当前堆积的Buffer数量（backlog size）告知接收端，接收端根据发送端堆积的Buffer数量申请浮动Buffer</li>
</ul>
<p>基于信用值的流量控制可以有效改善网络的利用率，不会因为Buffer长时间停留在网络链路中导致所有Task都无法继续处理数据，也无法进行Checkpoint操作，潜在缺点是增加了上下游之间的通信成本（需要发送Credit和Backlog信息）。</p>
<h3 id="水印处理" style="position:relative;"><a href="#%E6%B0%B4%E5%8D%B0%E5%A4%84%E7%90%86" aria-label="水印处理 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>水印处理</h3>
<p>水印是流处理中的重要抽象，定义何时停止等待较早的事件（事件时间为t的水印代表t之前的事件都已经到达，水印之后时间戳&#x3C;=t的任何事件都被称为迟到事件），水印和记录（StreamRecord）一样是以StreamElement实例在算子间流转。</p>
<p>水印（Watermark）是一种用于度量事件时间进度的机制。处理时间语义下，系统可以根据内置时钟，使用定时触发器来固定间隔触发事件，而在事件时间语义下，由于事件时间与系统时间无关，需要水印（Watermark）来度量事件时间语义下数据流的进度。</p>
<p>对于水印（Watermark），查找对齐输入通道水印的最小值，如果比WatermarkValve的水印大，则更新WatermarkValve水印并交给下游。
水印处理过程保证单个输入通道和WatermarkValve的水印都是单调递增的。</p>
<p>WatermarkStatus用来标识输入流是活动状态（ACTIVE）还是闲置状态（IDLE），
当输入流处于闲置状态时，不会向下游发送数据或Watermark时，就向下游发送IDLE告知下游，依次向下传递，
当恢复向下游发送数据或水印前，首先发送ACTIVE告知下游。</p>
<p>WatermarkStatus变化在SourceFunction中产生，Source任务如果读取不到输入数据，则是IDLE状态，反之为Active状态。
当WatermarkValve的所有输入通道全部处于IDLE状态时，才认为这个WatermarkValve处于IDLE状态。</p>
<p>TODO: 水印
TODO: 水印传递
TODO: 空闲状态用途 <a href="https://www.jianshu.com/p/dd4f5761d8e8">https://www.jianshu.com/p/dd4f5761d8e8</a></p>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">StatusWatermarkValve</span> <span class="token punctuation">{</span>
    <span class="token comment">// 各个输入通道的状态数组</span>
    <span class="token comment">// InputChannelStatus记录输入通道的水印、状态（WatermarkStatus）以及水印是否对齐</span>
    <span class="token comment">// WatermarkStatus元素通知任务是否等待输入流中的水印，包含IDLE和ACTIVE两种状态</span>
    <span class="token comment">// 水印不对齐分两种情况：</span>
    <span class="token comment">// 1）WatermarkStatus为IDLE</span>
    <span class="token comment">// 2）WatermarkStatus为ACTIVE但是通道的水印未赶上WatermarkValve的水印</span>
    <span class="token class-name">InputChannelStatus</span><span class="token punctuation">[</span><span class="token punctuation">]</span> channelStatuses<span class="token punctuation">;</span>
    <span class="token keyword">long</span> lastOutputWatermark<span class="token punctuation">;</span>   <span class="token comment">// WatermarkValve上次发出的水印</span>
    <span class="token class-name">WatermarkStatus</span> lastOutputWatermarkStatus<span class="token punctuation">;</span>   <span class="token comment">// WatermarkValve上次发出的水印状态</span>

    <span class="token keyword">void</span> <span class="token function">inputWatermark</span><span class="token punctuation">(</span><span class="token class-name">Watermark</span> watermark<span class="token punctuation">,</span> <span class="token keyword">int</span> channelIndex<span class="token punctuation">,</span> <span class="token class-name">DataOutput</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> output<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 当对应输入通道或所有输入通道空闲时忽略水印</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastOutputWatermarkStatus<span class="token punctuation">.</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> channelStatuses<span class="token punctuation">[</span>channelIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>watermarkStatus<span class="token punctuation">.</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">long</span> watermarkMillis <span class="token operator">=</span> watermark<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 忽略早于该输入通道当前水印的水印</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>watermarkMillis <span class="token operator">></span> channelStatuses<span class="token punctuation">[</span>channelIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>watermark<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                channelStatuses<span class="token punctuation">[</span>channelIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>watermark <span class="token operator">=</span> watermarkMillis<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>channelStatuses<span class="token punctuation">[</span>channelIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>isWatermarkAligned
                        <span class="token operator">&amp;&amp;</span> watermarkMillis <span class="token operator">>=</span> lastOutputWatermark<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    channelStatuses<span class="token punctuation">[</span>channelIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>isWatermarkAligned <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 找到对齐输入通道中最小的水印，如果大于WatermarkValve的水印，则更新WatermarkValve的水印并向下游发送</span>
                <span class="token function">findAndOutputNewMinWatermarkAcrossAlignedChannels</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">findAndOutputNewMinWatermarkAcrossAlignedChannels</span><span class="token punctuation">(</span><span class="token class-name">DataOutput</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> output<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> newMinWatermark <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> hasAlignedChannels <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// 查找对齐通道水印的最小值</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">InputChannelStatus</span> channelStatus <span class="token operator">:</span> channelStatuses<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>channelStatus<span class="token punctuation">.</span>isWatermarkAligned<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                hasAlignedChannels <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                newMinWatermark <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>channelStatus<span class="token punctuation">.</span>watermark<span class="token punctuation">,</span> newMinWatermark<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 存在对齐通道且对齐通道水印最小值大于WatermarkValve水印时更新WatermarkValve水印并输出新水印</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hasAlignedChannels <span class="token operator">&amp;&amp;</span> newMinWatermark <span class="token operator">></span> lastOutputWatermark<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            lastOutputWatermark <span class="token operator">=</span> newMinWatermark<span class="token punctuation">;</span>
            output<span class="token punctuation">.</span><span class="token function">emitWatermark</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Watermark</span><span class="token punctuation">(</span>lastOutputWatermark<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">inputWatermarkStatus</span><span class="token punctuation">(</span><span class="token class-name">WatermarkStatus</span> watermarkStatus<span class="token punctuation">,</span> <span class="token keyword">int</span> channelIndex<span class="token punctuation">,</span> <span class="token class-name">DataOutput</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> output<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 仅当WatermarkStatus和对应输入通道的WatermakStatus不同时才进行处理</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>watermarkStatus<span class="token punctuation">.</span><span class="token function">isIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> channelStatuses<span class="token punctuation">[</span>channelIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>watermarkStatus<span class="token punctuation">.</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 处理输入通道由ACTIVE -> IDLE</span>
            <span class="token comment">// 输入通道置为IDLE，水印未对齐</span>
            channelStatuses<span class="token punctuation">[</span>channelIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>watermarkStatus <span class="token operator">=</span> <span class="token class-name">WatermarkStatus</span><span class="token punctuation">.</span><span class="token constant">IDLE</span><span class="token punctuation">;</span>
            channelStatuses<span class="token punctuation">[</span>channelIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>isWatermarkAligned <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">InputChannelStatus</span><span class="token punctuation">.</span><span class="token function">hasActiveChannels</span><span class="token punctuation">(</span>channelStatuses<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token comment">// 当WatermarkValve的所有输入通道都空闲时</span>
                <span class="token comment">// 将WatermarkValve的WatermarkStatus置为IDLE并输出</span>
                <span class="token comment">// 如果输入通道是最后一个变空闲且水印等于WatermarkValve水印</span>
                <span class="token comment">// 则查找所有通道水印最大值，大于WatermarkValve水印时更新WatermarkValve水印并输出</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>channelStatuses<span class="token punctuation">[</span>channelIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>watermark <span class="token operator">==</span> lastOutputWatermark<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">findAndOutputMaxWatermarkAcrossAllChannels</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                lastOutputWatermarkStatus <span class="token operator">=</span> <span class="token class-name">WatermarkStatus</span><span class="token punctuation">.</span><span class="token constant">IDLE</span><span class="token punctuation">;</span>
                output<span class="token punctuation">.</span><span class="token function">emitWatermarkStatus</span><span class="token punctuation">(</span>lastOutputWatermarkStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>channelStatuses<span class="token punctuation">[</span>channelIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>watermark <span class="token operator">==</span> lastOutputWatermark<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果输入通道不是最后一个变空闲且水印等于WatermarkValve水印</span>
                <span class="token comment">// 则查找对齐通道水印最小值，大于WatermarkValve水印时更新WatermarkValve水印并输出</span>
                <span class="token function">findAndOutputNewMinWatermarkAcrossAlignedChannels</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>watermarkStatus<span class="token punctuation">.</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> channelStatuses<span class="token punctuation">[</span>channelIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>watermarkStatus<span class="token punctuation">.</span><span class="token function">isIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 处理输入通道由IDLE -> ACTIVE</span>
            <span class="token comment">// 输入通道状态置为ACTIVE</span>
            channelStatuses<span class="token punctuation">[</span>channelIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>watermarkStatus <span class="token operator">=</span> <span class="token class-name">WatermarkStatus</span><span class="token punctuation">.</span><span class="token constant">ACTIVE</span><span class="token punctuation">;</span>

            <span class="token comment">// 通道水印大于WatermarkValve水印时则置为水印对齐</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>channelStatuses<span class="token punctuation">[</span>channelIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>watermark <span class="token operator">>=</span> lastOutputWatermark<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                channelStatuses<span class="token punctuation">[</span>channelIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>isWatermarkAligned <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// WatermarkValve之前处于IDLE时，置为ACTIVE并发出其状态</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lastOutputWatermarkStatus<span class="token punctuation">.</span><span class="token function">isIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                lastOutputWatermarkStatus <span class="token operator">=</span> <span class="token class-name">WatermarkStatus</span><span class="token punctuation">.</span><span class="token constant">ACTIVE</span><span class="token punctuation">;</span>
                output<span class="token punctuation">.</span><span class="token function">emitWatermarkStatus</span><span class="token punctuation">(</span>lastOutputWatermarkStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">findAndOutputMaxWatermarkAcrossAllChannels</span><span class="token punctuation">(</span><span class="token class-name">DataOutput</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> output<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> maxWatermark <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token constant">MIN_VALUE</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">InputChannelStatus</span> channelStatus <span class="token operator">:</span> channelStatuses<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            maxWatermark <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>channelStatus<span class="token punctuation">.</span>watermark<span class="token punctuation">,</span> maxWatermark<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>maxWatermark <span class="token operator">></span> lastOutputWatermark<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            lastOutputWatermark <span class="token operator">=</span> maxWatermark<span class="token punctuation">;</span>
            output<span class="token punctuation">.</span><span class="token function">emitWatermark</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Watermark</span><span class="token punctuation">(</span>lastOutputWatermark<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<h3 id="延迟标记处理" style="position:relative;"><a href="#%E5%BB%B6%E8%BF%9F%E6%A0%87%E8%AE%B0%E5%A4%84%E7%90%86" aria-label="延迟标记处理 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>延迟标记处理</h3>
<p>LatencyMarker用来近似评估数据从读取到写出之间的延迟，并不包含计算的延迟，算子收到LatencyMarker后直接交给下游。</p>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractInput</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">,</span> OUT<span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">Input</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">></span></span>
<span class="token punctuation">{</span>
    <span class="token class-name">AbstractStreamOperatorV2</span><span class="token generics"><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">></span></span> owner<span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">processLatencyMarker</span><span class="token punctuation">(</span><span class="token class-name">LatencyMarker</span> latencyMarker<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// reportOrForwardLatencyMarker</span>
        owner<span class="token punctuation">.</span>latencyStats<span class="token punctuation">.</span><span class="token function">reportLatency</span><span class="token punctuation">(</span>marker<span class="token punctuation">)</span><span class="token punctuation">;</span>
        owner<span class="token punctuation">.</span>output<span class="token punctuation">.</span><span class="token function">emitLatencyMarker</span><span class="token punctuation">(</span>marker<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<h2 id="checkpoint" style="position:relative;"><a href="#checkpoint" aria-label="checkpoint permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Checkpoint</h2>
<p>Checkpoint的触发，是通过MailboxExecutor提交一个Mail来实现的。</p>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">StreamTask</span><span class="token generics"><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">,</span> OP <span class="token keyword">extends</span> <span class="token class-name">StreamOperator</span><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">></span><span class="token punctuation">></span></span>
    <span class="token keyword">implements</span> <span class="token class-name">TaskInvokable</span><span class="token punctuation">,</span> <span class="token class-name">CheckpointableTask</span><span class="token punctuation">,</span> <span class="token class-name">CoordinatedTask</span>
<span class="token punctuation">{</span>
    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">></span></span> <span class="token function">triggerCheckpointAsync</span><span class="token punctuation">(</span><span class="token class-name">CheckpointMetaData</span> checkpointMetaData<span class="token punctuation">,</span> <span class="token class-name">CheckpointOptions</span> checkpointOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">></span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mainMailboxExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> noUnfinishedInputGates <span class="token operator">=</span>
                <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAllInputGates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">allMatch</span><span class="token punctuation">(</span><span class="token class-name">InputGate</span><span class="token operator">::</span><span class="token function">isFinished</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>noUnfinishedInputGates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// triggerCheckpointAsyncInMailbox</span>
                latestAsyncCheckpointStartDelayNanos <span class="token operator">=</span> <span class="token number">1_000_000</span> <span class="token operator">*</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> checkpointMetaData<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 非对齐</span>
                <span class="token class-name">CheckpointMetricsBuilder</span> checkpointMetrics <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CheckpointMetricsBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setAlignmentDurationNanos</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setBytesProcessedDuringAlignment</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setCheckpointStartDelayNanos</span><span class="token punctuation">(</span>latestAsyncCheckpointStartDelayNanos<span class="token punctuation">)</span><span class="token punctuation">;</span>

                subtaskCheckpointCoordinator<span class="token punctuation">.</span><span class="token function">initInputsCheckpoint</span><span class="token punctuation">(</span>checkpointMetaData<span class="token punctuation">.</span><span class="token function">getCheckpointId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> checkpointOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> success <span class="token operator">=</span> <span class="token function">performCheckpoint</span><span class="token punctuation">(</span>checkpointMetaData<span class="token punctuation">,</span> checkpointOptions<span class="token punctuation">,</span> checkpointMetrics<span class="token punctuation">)</span><span class="token punctuation">;</span>
                result<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// triggerUnfinishedChannelsCheckpoint</span>
                <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CheckpointBarrierHandler</span><span class="token punctuation">></span></span> checkpointBarrierHandler <span class="token operator">=</span> <span class="token function">getCheckpointBarrierHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">assert</span> checkpointBarrierHandler<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">CheckpointBarrier</span> barrier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CheckpointBarrier</span><span class="token punctuation">(</span>
                    checkpointMetaData<span class="token punctuation">.</span><span class="token function">getCheckpointId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    checkpointMetaData<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    checkpointOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">IndexedInputGate</span> inputGate <span class="token operator">:</span> <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAllInputGates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inputGate<span class="token punctuation">.</span><span class="token function">isFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">InputChannelInfo</span> channelInfo <span class="token operator">:</span> inputGate<span class="token punctuation">.</span><span class="token function">getUnfinishedChannels</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            checkpointBarrierHandler<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">processBarrier</span><span class="token punctuation">(</span>barrier<span class="token punctuation">,</span> channelInfo<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                result<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>                          <span class="token comment">// command</span>
        <span class="token string">"checkpoint %s with %s"</span><span class="token punctuation">,</span>    <span class="token comment">// descriptionFormat</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">boolean</span> <span class="token function">performCheckpoint</span><span class="token punctuation">(</span>
        <span class="token class-name">CheckpointMetaData</span> checkpointMetaData<span class="token punctuation">,</span>
        <span class="token class-name">CheckpointOptions</span> checkpointOptions<span class="token punctuation">,</span>
        <span class="token class-name">CheckpointMetricsBuilder</span> checkpointMetrics<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">CheckpointType</span> checkpointType <span class="token operator">=</span> checkpointOptions<span class="token punctuation">.</span><span class="token function">getCheckpointType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Starting checkpoint {} {} on task {}"</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            actionExecutor<span class="token punctuation">.</span><span class="token function">runThrowing</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>checkpointType<span class="token punctuation">.</span><span class="token function">isSynchronous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">setSynchronousSavepoint</span><span class="token punctuation">(</span>checkpointMetaData<span class="token punctuation">.</span><span class="token function">getCheckpointId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> checkpointType<span class="token punctuation">.</span><span class="token function">shouldDrain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">areCheckpointsWithFinishedTasksEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> endOfDataReceived
                    <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>finalCheckpointMinId <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>finalCheckpointMinId <span class="token operator">=</span> checkpointMetaData<span class="token punctuation">.</span><span class="token function">getCheckpointId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                subtaskCheckpointCoordinator<span class="token punctuation">.</span><span class="token function">checkpointState</span><span class="token punctuation">(</span>
                    checkpointMetaData<span class="token punctuation">,</span>
                    checkpointOptions<span class="token punctuation">,</span>
                    checkpointMetrics<span class="token punctuation">,</span>
                    operatorChain<span class="token punctuation">,</span>
                    finishedOperators<span class="token punctuation">,</span>
                    <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">isRunning</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            actionExecutor<span class="token punctuation">.</span><span class="token function">runThrowing</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
                <span class="token class-name">CancelCheckpointMarker</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CancelCheckpointMarker</span><span class="token punctuation">(</span>checkpointMetaData<span class="token punctuation">.</span><span class="token function">getCheckpointId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                recordWriter<span class="token punctuation">.</span><span class="token function">broadcastEvent</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">declineCheckpoint</span><span class="token punctuation">(</span><span class="token keyword">long</span> checkpointId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">declineCheckpoint</span><span class="token punctuation">(</span>checkpointId<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<p>Checkpoint完成或者放弃的通知也是提交到Mailbox中运行的</p>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">StreamTask</span><span class="token generics"><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">,</span> OP <span class="token keyword">extends</span> <span class="token class-name">StreamOperator</span><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">></span><span class="token punctuation">></span></span>
    <span class="token keyword">implements</span> <span class="token class-name">TaskInvokable</span><span class="token punctuation">,</span> <span class="token class-name">CheckpointableTask</span><span class="token punctuation">,</span> <span class="token class-name">CoordinatedTask</span>
<span class="token punctuation">{</span>
    <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> <span class="token function">notifyCheckpointOperation</span><span class="token punctuation">(</span><span class="token class-name">RunnableWithException</span> runnable<span class="token punctuation">,</span> <span class="token class-name">String</span> description<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mailboxProcessor
            <span class="token punctuation">.</span><span class="token function">getMailboxExecutor</span><span class="token punctuation">(</span><span class="token class-name">TaskMailbox</span><span class="token punctuation">.</span><span class="token constant">MAX_PRIORITY</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
                runnable<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                result<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                description<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<h2 id="处理时间定时器" style="position:relative;"><a href="#%E5%A4%84%E7%90%86%E6%97%B6%E9%97%B4%E5%AE%9A%E6%97%B6%E5%99%A8" aria-label="处理时间定时器 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>处理时间定时器</h2>
<p>对于处理时间定时器的触发</p>
<details>
<summary>具体实现</summary>
<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">StreamTask</span><span class="token generics"><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">,</span> OP <span class="token keyword">extends</span> <span class="token class-name">StreamOperator</span><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">></span><span class="token punctuation">></span></span>
    <span class="token keyword">implements</span> <span class="token class-name">TaskInvokable</span><span class="token punctuation">,</span> <span class="token class-name">CheckpointableTask</span><span class="token punctuation">,</span> <span class="token class-name">CoordinatedTask</span>
<span class="token punctuation">{</span>
    <span class="token class-name">ProcessingTimeServiceFactory</span> <span class="token function">getProcessingTimeServiceFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> mailboxExecutor <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">ProcessingTimeServiceImpl</span><span class="token punctuation">(</span>
            timerService<span class="token punctuation">,</span>
            callback <span class="token operator">-></span> <span class="token function">deferCallbackToMailbox</span><span class="token punctuation">(</span>mailboxExecutor<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">ProcessingTimeCallback</span> <span class="token function">deferCallbackToMailbox</span><span class="token punctuation">(</span><span class="token class-name">MailboxExecutor</span> mailboxExecutor<span class="token punctuation">,</span> <span class="token class-name">ProcessingTimeCallback</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> timestamp <span class="token operator">-></span> <span class="token punctuation">{</span>
            mailboxExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>
                <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token function">invokeProcessingTimeCallback</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">"Timer callback for %s @ %d"</span><span class="token punctuation">,</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">invokeProcessingTimeCallback</span><span class="token punctuation">(</span><span class="token class-name">ProcessingTimeCallback</span> callback<span class="token punctuation">,</span> <span class="token keyword">long</span> timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        callback<span class="token punctuation">.</span><span class="token function">onProcessingTime</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<div class="footnotes">
<hr>
<ol>
<li id="fn-1">未来将被AbstractStreamOperatorV2替代<a href="#fnref-1" class="footnote-backref">↩</a></li>
<li id="fn-2">YARN ResourceManager中的RPC服务组件，处理来自客户端的各种RPC请求，如查询YARN集群信息，提交、终止应用等<a href="#fnref-2" class="footnote-backref">↩</a></li>
<li id="fn-3">YARN ResourceManager内部管理应用生命周期的组件<a href="#fnref-3" class="footnote-backref">↩</a></li>
<li id="fn-4">ResourceManager状态存储服务用来保证ResourceManager重启、HA切换或发生故障后应用能够正常恢复<a href="#fnref-4" class="footnote-backref">↩</a></li>
<li id="fn-5">YARN ResourceManager可插拔资源调度器<a href="#fnref-5" class="footnote-backref">↩</a></li>
<li id="fn-6">AM&#x26;RM协议接口服务，处理来自AM的请求，主要包括注册和心跳<a href="#fnref-6" class="footnote-backref">↩</a></li>
<li id="fn-7">ApplicationMaster生命周期管理服务，负责启动或清理ApplicationMaster Container<a href="#fnref-7" class="footnote-backref">↩</a></li>
<li id="fn-8">与YARN ResourceManager保持通信，负责管理单个节点上的全部资源、Container生命周期、附属服务等，监控节点健康状态和Container资源使用<a href="#fnref-8" class="footnote-backref">↩</a></li>
<li id="fn-9">YARN NodeManager核心组件，管理所有Container的生命周期<a href="#fnref-9" class="footnote-backref">↩</a></li>
<li id="fn-10">资源本地化服务，负责Container所需资源的本地化，能够按照描述从HDFS上下载Container所需的文件资源，并尽量将它们分摊到各个磁盘上以防止出现访问热点<a href="#fnref-10" class="footnote-backref">↩</a></li>
<li id="fn-11">负责Container具体操作，包括启动、重启、恢复和清理等<a href="#fnref-11" class="footnote-backref">↩</a></li>
<li id="fn-12">不能使用StreamNode的id属性是因为这是一个从1开始的静态计数变量，多次提交可能得到不一样的值<a href="#fnref-12" class="footnote-backref">↩</a></li>
</ol>
</div></section><hr/><footer><div class="bio"><div data-gatsby-image-wrapper="" style="width:50px;height:50px" class="gatsby-image-wrapper bio-avatar"><div aria-hidden="true" data-placeholder-image="" style="opacity:1;transition:opacity 500ms linear;background-color:#080808;width:50px;height:50px;position:relative"></div><picture><source type="image/avif" data-srcset="/static/0e268a0c61e073203f25a3c89d8e0fbf/d4bf4/dd.avif 50w,/static/0e268a0c61e073203f25a3c89d8e0fbf/ee81f/dd.avif 100w" sizes="50px"/><source type="image/webp" data-srcset="/static/0e268a0c61e073203f25a3c89d8e0fbf/3faea/dd.webp 50w,/static/0e268a0c61e073203f25a3c89d8e0fbf/6a679/dd.webp 100w" sizes="50px"/><img data-gatsby-image-ssr="" layout="fixed" data-main-image="" style="opacity:0" sizes="50px" decoding="async" loading="lazy" data-src="/static/0e268a0c61e073203f25a3c89d8e0fbf/e5610/dd.png" data-srcset="/static/0e268a0c61e073203f25a3c89d8e0fbf/e5610/dd.png 50w,/static/0e268a0c61e073203f25a3c89d8e0fbf/e9b55/dd.png 100w" alt="Profile picture"/></picture><noscript><picture><source type="image/avif" srcSet="/static/0e268a0c61e073203f25a3c89d8e0fbf/d4bf4/dd.avif 50w,/static/0e268a0c61e073203f25a3c89d8e0fbf/ee81f/dd.avif 100w" sizes="50px"/><source type="image/webp" srcSet="/static/0e268a0c61e073203f25a3c89d8e0fbf/3faea/dd.webp 50w,/static/0e268a0c61e073203f25a3c89d8e0fbf/6a679/dd.webp 100w" sizes="50px"/><img data-gatsby-image-ssr="" layout="fixed" data-main-image="" style="opacity:0" sizes="50px" decoding="async" loading="lazy" src="/static/0e268a0c61e073203f25a3c89d8e0fbf/e5610/dd.png" srcSet="/static/0e268a0c61e073203f25a3c89d8e0fbf/e5610/dd.png 50w,/static/0e268a0c61e073203f25a3c89d8e0fbf/e9b55/dd.png 100w" alt="Profile picture"/></picture></noscript><script type="module">const t="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;if(t){const t=document.querySelectorAll("img[data-main-image]");for(let e of t){e.dataset.src&&(e.setAttribute("src",e.dataset.src),e.removeAttribute("data-src")),e.dataset.srcset&&(e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset"));const t=e.parentNode.querySelectorAll("source[data-srcset]");for(let e of t)e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset");e.complete&&(e.style.opacity=1,e.parentNode.parentNode.querySelector("[data-placeholder-image]").style.opacity=0)}}</script></div><p>Written by <strong>luuua</strong> <br/> <!-- -->圣人之道,吾性自足,不假外求.</p></div></footer></article><nav class="blog-post-nav"><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"><li></li><li><a rel="next" href="/Flink Checkpoint/">Flink检查点机制<!-- --> →</a></li></ul></nav></main><footer>© <!-- -->2024<!-- -->, Built with<!-- --> <a href="https://www.gatsbyjs.com">Gatsby</a></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/Flink Job/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-f7b3604226253ab7a148.js\"],\"component---src-pages-404-js\":[\"/component---src-pages-404-js-1da6b1b941d8c3c28fab.js\"],\"component---src-pages-index-js\":[\"/component---src-pages-index-js-69ffa5174bcc9ee3693e.js\"],\"component---src-pages-using-typescript-tsx\":[\"/component---src-pages-using-typescript-tsx-f2402f2b821fee928c62.js\"],\"component---src-templates-blog-post-js\":[\"/component---src-templates-blog-post-js-074fd55c7e9ac421df51.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="95fb1bdfc520a6d277a2";</script><script src="/webpack-runtime-81d90f9d79cf313f6569.js" async></script><script src="/framework-1e99f3a671b040f20568.js" async></script><script src="/app-f7b3604226253ab7a148.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>